\n\n========== FILE: ./.env.example ==========\n
# ====================
# DJANGO SETTINGS
# ====================
DEBUG=True
SECRET_KEY=your-secret-key-here
ALLOWED_HOSTS=localhost,127.0.0.1,yourdomain.com

# ====================
# DATABASE
# ====================
# For SQLite:
DATABASE_URL=sqlite:///db.sqlite3
# For PostgreSQL:
# DATABASE_URL=postgres://user:password@localhost:5432/dbname

# ====================
# AUTHENTICATION
# ====================
AUTH_USER_MODEL=accounts.User

# ====================
# MPESA CONFIGURATION
# ====================
MPESA_CONSUMER_KEY=your_consumer_key
MPESA_CONSUMER_SECRET=your_consumer_secret
MPESA_SHORTCODE=your_shortcode
MPESA_PASSKEY=your_passkey
MPESA_ENVIRONMENT=sandbox  # or 'production'
MPESA_CALLBACK_URL=https://yourdomain.com/payments/mpesa-callback/

# ====================
# EMAIL SETTINGS
# ====================
EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-app-password

# ====================
# SECURITY (Production)
# ====================
CSRF_COOKIE_SECURE=True
SESSION_COOKIE_SECURE=True
CSRF_TRUSTED_ORIGINS=https://yourdomain.com
SECURE_SSL_REDIRECT=True
SECURE_HSTS_SECONDS=31536000
\n\n========== FILE: ./accounts/admin.py ==========\n
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin
from django import forms
from django.utils.html import format_html
from django.db import models
from django.utils.translation import gettext_lazy as _
from unfold.admin import ModelAdmin
from unfold.forms import UserCreationForm, UserChangeForm
from .models import User
from django.contrib.auth.models import Permission 

class CustomUserCreationForm(UserCreationForm):
    """A form for creating new users with password confirmation."""
    password1 = forms.CharField(
        label='Password', 
        widget=forms.PasswordInput(attrs={'class': 'vTextField'})
    )
    password2 = forms.CharField(
        label='Password confirmation', 
        widget=forms.PasswordInput(attrs={'class': 'vTextField'})
    )

    class Meta:
        model = User
        fields = ('username', 'email', 'role', 'password1', 'password2')

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # Set role to student by default for easier student creation
        if 'role' in self.fields:
            self.fields['role'].initial = 'student'
    
    def clean_password2(self):
        password1 = self.cleaned_data.get("password1")
        password2 = self.cleaned_data.get("password2")
        if password1 and password2 and password1 != password2:
            raise forms.ValidationError("Passwords don't match")
        return password2

    def save(self, commit=True):
        user = super().save(commit=False)
        user.set_password(self.cleaned_data["password1"])
        if commit:
            user.save()
        return user

@admin.register(User)
class CustomUserAdmin(ModelAdmin):
    form = UserChangeForm
    add_form = CustomUserCreationForm
    
    list_display = ('username', 'email', 'first_name', 'last_name', 'role_display', 
                   'is_staff', 'is_active', 'last_login', 'date_joined')
    list_filter = ('role', 'is_staff', 'is_active', 'is_superuser', 'date_joined')
    search_fields = ('username', 'email', 'first_name', 'last_name')
    ordering = ('-date_joined',)
    readonly_fields = ('last_login', 'date_joined', 'profile_picture_preview')
    
    fieldsets = (
        (None, {'fields': ('username', 'password')}),
        (_('Personal Info'), {'fields': ('first_name', 'last_name', 'email', 'profile_picture', 'profile_picture_preview')}),
        (_('Role & Permissions'), {
            'fields': ('role', 'is_active', 'is_staff', 'is_superuser', 'groups', 'user_permissions'),
        }),
        (_('Important Dates'), {'fields': ('last_login', 'date_joined')}),
    )
    
    add_fieldsets = (
        (None, {
            'classes': ('wide',),
            'fields': ('username', 'email', 'password1', 'password2', 'role', 'profile_picture'),
        }),
        (_('Personal Info'), {
            'classes': ('wide',),
            'fields': ('first_name', 'last_name'),
        }),
        (_('Permissions'), {
            'classes': ('wide',),
            'fields': ('is_active', 'is_staff', 'is_superuser'),
        }),
    )
    
    actions = ['activate_users', 'deactivate_users', 'make_staff', 'remove_staff', 'make_student', 'make_teacher']
    
    @admin.display(description='Role', ordering='role')
    def role_display(self, obj):
        role_colors = {
            'admin': 'red',
            'teacher': 'blue',
            'student': 'green',
            'parent': 'yellow',
        }
        color = role_colors.get(obj.role, 'gray')
        return format_html(
            '<span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset" style="color: {}; background-color: {}20;">{}</span>',
            color, color, obj.get_role_display()
        )
    
    @admin.display(description='Profile Picture')
    def profile_picture_preview(self, obj):
        if obj.profile_picture:
            return format_html(
                '<img src="{}" style="max-height: 100px; max-width: 100px; border-radius: 5px;" />',
                obj.profile_picture.url
            )
        return _("No picture")
    
    @admin.action(description='Activate selected users')
    def activate_users(self, request, queryset):
        updated = queryset.update(is_active=True)
        self.message_user(request, f'{updated} users were successfully activated.')
    
    @admin.action(description='Deactivate selected users')
    def deactivate_users(self, request, queryset):
        updated = queryset.update(is_active=False)
        self.message_user(request, f'{updated} users were successfully deactivated.')
    
    @admin.action(description='Make selected users staff')
    def make_staff(self, request, queryset):
        updated = queryset.update(is_staff=True)
        self.message_user(request, f'{updated} users were granted staff status.')
    
    @admin.action(description='Remove staff status from selected users')
    def remove_staff(self, request, queryset):
        updated = queryset.update(is_staff=False)
        self.message_user(request, f'{updated} users had staff status removed.')
    
    # NEW ACTION: Set selected users as students
    @admin.action(description='Set selected users as students')
    def make_student(self, request, queryset):
        updated = queryset.update(role='student')
        self.message_user(request, f'{updated} users were set as students.')
    
    # NEW ACTION: Set selected users as teachers
    @admin.action(description='Set selected users as teachers')
    def make_teacher(self, request, queryset):
        updated = queryset.update(role='teacher')
        self.message_user(request, f'{updated} users were set as teachers.')
    
    list_per_page = 25
    date_hierarchy = 'date_joined'
    empty_value_display = '---'

# Register Permission model
admin.site.register(Permission)\n\n========== FILE: ./accounts/apps.py ==========\n
from django.apps import AppConfig

class AccountsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'accounts'
    
    def ready(self):
        import accounts.signals\n\n========== FILE: ./accounts/forms.py ==========\n
from django import forms
from django.contrib.auth.forms import AuthenticationForm

class LoginForm(AuthenticationForm):
    username = forms.CharField(widget=forms.TextInput(attrs={'class': 'form-control'}))
    password = forms.CharField(widget=forms.PasswordInput(attrs={'class': 'form-control'}))\n\n========== FILE: ./accounts/models.py ==========\n
from django.contrib.auth.models import AbstractUser
from django.db import models

class User(AbstractUser):
    ROLE_CHOICES = (
        ('admin', 'Admin'),
        ('teacher', 'Teacher'),
        ('student', 'Student'),
    )
    
    TEACHER_ROLE_CHOICES = (
        ('teacher', 'Regular Teacher'),
        ('deputy_principal', 'Deputy Principal'),
        ('hod', 'Head of Department'),
        ('sports_master', 'Sports Master'),
        ('academic_head', 'Academic Head'),
        ('discipline_master', 'Discipline Master'),
        ('activity_coordinator', 'Activity Coordinator'),
    )
    
    role = models.CharField(max_length=20, choices=ROLE_CHOICES)
    profile_picture = models.ImageField(upload_to='profile_pics/', null=True, blank=True)
    teacher_role = models.CharField(max_length=20, choices=TEACHER_ROLE_CHOICES, default='teacher', blank=True)
    
    def is_admin(self):
        return self.role == 'admin'
    
    def is_teacher(self):
        return self.role == 'teacher'
    
    def is_student(self):
        return self.role == 'student'
    
    def get_teacher_role_display_name(self):
        if self.is_teacher():
            for value, label in self.TEACHER_ROLE_CHOICES:
                if value == self.teacher_role:
                    return label
        return "Not a Teacher"
    
    # ADDED: Check if user has student profile
    def has_student_profile(self):
        """Check if user has a linked student profile"""
        return hasattr(self, 'student_profile')
    
    # ADDED: Check if user has teacher profile
    def has_teacher_profile(self):
        """Check if user has a linked teacher profile"""
        return hasattr(self, 'teacher_profile')
    
    # ADDED: Get student profile if exists
    def get_student_profile(self):
        """Get the student profile linked to this user"""
        if self.has_student_profile():
            return self.student_profile
        return None
    
    # ADDED: Get teacher profile if exists
    def get_teacher_profile(self):
        """Get the teacher profile linked to this user"""
        if self.has_teacher_profile():
            return self.teacher_profile
        return None\n\n========== FILE: ./accounts/password_utils.py ==========\n
import secrets
import string

def generate_password(length=8):
    """Generate a secure random password of specified length"""
    letters = string.ascii_letters
    digits = string.digits
    special_chars = '@$!%*?&'
    
    password = [
        secrets.choice(letters),
        secrets.choice(digits),
        secrets.choice(special_chars)
    ]
    
    all_chars = letters + digits + special_chars
    password += [secrets.choice(all_chars) for _ in range(length - 3)]
    
    secrets.SystemRandom().shuffle(password)
    return ''.join(password)\n\n========== FILE: ./accounts/signals.py ==========\n
from django.db.models.signals import post_save
from django.dispatch import receiver
from .models import User

# You can add signals here for automatic actions when users are created/updated\n\n========== FILE: ./accounts/templates/accounts/admin_dashboard.html ==========\n
{% extends 'accounts/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <!-- Welcome Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-2">Welcome back, {{ user.get_full_name|default:user.username }}! ðŸ‘‹</h1>
                            <p class="mb-0">Manage the school system and monitor all activities</p>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-light text-dark px-3 py-2">
                                <i class="fas fa-crown me-2"></i>
                                Admin Dashboard
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats Row -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Students
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ student_count|default:"0" }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-graduate fa-2x text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Total Teachers
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ teacher_count|default:"0" }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chalkboard-teacher fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Total Fee Balance
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                KES {{ total_balance|default:"0.00" }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-money-bill-wave fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Pending Payments
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ pending_payments|default:"0" }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Quick Actions Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center" 
                     style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <h6 class="m-0 font-weight-bold text-white">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4 mb-3">
                            <a href="{% url 'student_create' %}" 
                               class="btn btn-primary btn-lg w-100 py-3 d-flex align-items-center justify-content-center">
                                <i class="fas fa-user-plus fa-2x me-3"></i>
                                <div class="text-start">
                                    <div class="h6 mb-1">Add Student</div>
                                </div>
                            </a>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <a href="{% url 'teacher_create' %}" 
                               class="btn btn-success btn-lg w-100 py-3 d-flex align-items-center justify-content-center">
                                <i class="fas fa-user-tie fa-2x me-3"></i>
                                <div class="text-start">
                                    <div class="h6 mb-1">Add Teacher</div>
                                </div>
                            </a>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <a href="{% url 'student_list' %}" 
                               class="btn btn-info btn-lg w-100 py-3 d-flex align-items-center justify-content-center">
                                <i class="fas fa-users fa-2x me-3"></i>
                                <div class="text-start">
                                    <div class="h6 mb-1">View Students</div>
                                </div>
                            </a>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <a href="{% url 'fee_structure_list' %}" 
                               class="btn btn-warning btn-lg w-100 py-3 d-flex align-items-center justify-content-center">
                                <i class="fas fa-money-bill-wave fa-2x me-3"></i>
                                <div class="text-start">
                                    <div class="h6 mb-1">Manage Fees</div>
                                </div>
                            </a>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <a href="{% url 'student_performance_analytics' %}" 
                               class="btn btn-danger btn-lg w-100 py-3 d-flex align-items-center justify-content-center">
                                <i class="fas fa-chart-line fa-2x me-3"></i>
                                <div class="text-start">
                                    <div class="h6 mb-1">Analytics</div>
                                </div>
                            </a>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <a href="{% url 'admin:index' %}" 
                               class="btn btn-secondary btn-lg w-100 py-3 d-flex align-items-center justify-content-center">
                                <i class="fas fa-cogs fa-2x me-3"></i>
                                <div class="text-start">
                                    <div class="h6 mb-1">Admin Panel</div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Password Management Section -->
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center" 
         style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
        <h6 class="m-0 font-weight-bold text-white">
            <i class="fas fa-key me-2"></i>Password Management
        </h6>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-6 mb-3">
                <div class="card h-100 border-0 bg-light">
                    <div class="card-body text-center">
                        <i class="fas fa-user-graduate fa-2x text-primary mb-3"></i>
                        <h5>Student Passwords</h5>
                        <p class="text-muted small">View and manage student passwords</p>
                        <div class="mt-3">
                            <a href="{% url 'student_list' %}" 
                               class="btn btn-outline-primary btn-sm me-2">
                                All Students
                            </a>
                            <a href="{% url 'student_create' %}" 
                               class="btn btn-primary btn-sm">
                                <i class="fas fa-plus"></i> Add Student
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 mb-3">
                <div class="card h-100 border-0 bg-light">
                    <div class="card-body text-center">
                        <i class="fas fa-chalkboard-teacher fa-2x text-success mb-3"></i>
                        <h5>Teacher Passwords</h5>
                        <p class="text-muted small">View and manage teacher passwords</p>
                        <div class="mt-3">
                            <a href="{% url 'teacher_list' %}" 
                               class="btn btn-outline-success btn-sm me-2">
                                All Teachers
                            </a>
                            <a href="{% url 'teacher_create' %}" 
                               class="btn btn-success btn-sm">
                                <i class="fas fa-plus"></i> Add Teacher
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-warning mt-3">
            <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-shield-alt fa-2x text-warning"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <h6 class="alert-heading">Password Security</h6>
                    <p class="mb-0">
                        <strong>Auto-generated passwords:</strong> All new students receive 8-character auto-generated passwords.<br>
                        <strong>Teacher access:</strong> Teachers can view passwords for students in their classes.<br>
                        <strong>Admin access:</strong> You can view all passwords from the admin panel.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

            <!-- Performance Analytics Section -->
            <div class="card shadow mb-4">
                <div class="card-header py-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h6 class="m-0 font-weight-bold text-white">
                        <i class="fas fa-chart-line me-2"></i>Performance Analytics
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-bar fa-2x text-primary mb-3"></i>
                                    <h5>Student Performance</h5>
                                    <p class="text-muted small">Monitor overall academic performance</p>
                                    <a href="{% url 'student_performance_analytics' %}" 
                                       class="btn btn-outline-primary btn-sm">
                                        View Analytics
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body text-center">
                                    <i class="fas fa-balance-scale fa-2x text-info mb-3"></i>
                                    <h5>Term Comparison</h5>
                                    <p class="text-muted small">Compare performance across terms</p>
                                    <a href="{% url 'term_comparison_analytics' %}" 
                                       class="btn btn-outline-info btn-sm">
                                        Compare Terms
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info border-0 shadow-sm">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-lightbulb fa-2x text-info"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="alert-heading">Analytics Insight</h6>
                                <p class="mb-0">Use analytics tools to identify trends, track academic performance, and make data-driven decisions for school improvement.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- System Information Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h6 class="m-0 font-weight-bold text-white">
                        <i class="fas fa-info-circle me-2"></i>System Information
                    </h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="avatar-circle mb-3" 
                             style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                    border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;">
                            <span class="text-white h3">{{ user.get_full_name|first|upper|default:user.username|first|upper }}</span>
                        </div>
                        <h5 class="mb-1">{{ user.get_full_name|default:user.username }}</h5>
                        <p class="text-muted small">Administrator</p>
                    </div>
                    
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-sign-in-alt text-primary me-2"></i>Last Login</span>
                            <span>{{ user.last_login|date:"F d, Y H:i"|default:"Never" }}</span>
                        </div>
                        
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-calendar text-success me-2"></i>Joined</span>
                            <span>{{ user.date_joined|date:"F d, Y" }}</span>
                        </div>
                        
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-envelope text-info me-2"></i>Email</span>
                            <span>{{ user.email|default:"No email" }}</span>
                        </div>
                        
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-shield-alt text-warning me-2"></i>Role</span>
                            <span class="badge bg-warning">Administrator</span>
                        </div>
                    </div>
                </div>
            </div>
            

            <!-- Quick Links -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-dark text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-link me-2"></i>Quick Links
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'teacher_list' %}" 
                           class="btn btn-outline-primary">
                            <i class="fas fa-chalkboard-teacher me-2"></i>Manage Teachers
                        </a>

                        <a href="{% url 'teacher_passwords_view' %}" 
               class="btn btn-outline-danger">
                <i class="fas fa-key me-2"></i>Teacher Passwords
            </a>
            
            <a href="{% url 'student_list' %}" 
               class="btn btn-outline-info">
                <i class="fas fa-users me-2"></i>Student Passwords
            </a>
                        
                        <a href="{% url 'financial_report' %}" 
                           class="btn btn-outline-success">
                            <i class="fas fa-file-invoice-dollar me-2"></i>Financial Reports
                        </a>
                        
                        <a href="{% url 'student_fee_list' %}" 
                           class="btn btn-outline-info">
                            <i class="fas fa-wallet me-2"></i>Student Fees
                        </a>
                        
                        <a href="{% url 'generate_performance_trends' %}" 
                           class="btn btn-outline-warning">
                            <i class="fas fa-cogs me-2"></i>Generate Trends
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Features Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3" style="background: #f8bff8;">
                    <h6 class="m-0 font-weight-bold text-white">
                        <i class="fas fa-cogs me-2"></i>System Administration
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="feature-card text-center p-3 border rounded h-100">
                                <i class="fas fa-users fa-2x text-primary mb-3"></i>
                                <h6>User Management</h6>
                                <p class="text-muted small">Manage students, teachers, and accounts</p>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="feature-card text-center p-3 border rounded h-100">
                                <i class="fas fa-chart-line fa-2x text-success mb-3"></i>
                                <h6>Analytics</h6>
                                <p class="text-muted small">Track performance and generate reports</p>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="feature-card text-center p-3 border rounded h-100">
                                <i class="fas fa-money-bill-wave fa-2x text-info mb-3"></i>
                                <h6>Financial Management</h6>
                                <p class="text-muted small">Manage fees, payments, and finances</p>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="feature-card text-center p-3 border rounded h-100">
                                <i class="fas fa-cog fa-2x text-warning mb-3"></i>
                                <h6>System Configuration</h6>
                                <p class="text-muted small">Configure system settings and preferences</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-secondary mt-3">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-circle fa-2x"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="alert-heading mb-1">Full Administrative Access</h6>
                                <p class="mb-0">You have full administrative privileges to manage all aspects of the school system including user accounts, academic records, financial transactions, and system configuration.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        border-radius: 15px;
        border: none;
        transition: transform 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-5px);
    }
    
    .border-left-primary {
        border-left: 4px solid #4e73df !important;
    }
    
    .border-left-success {
        border-left: 4px solid #1cc88a !important;
    }
    
    .border-left-info {
        border-left: 4px solid #36b9cc !important;
    }
    
    .border-left-warning {
        border-left: 4px solid #f6c23e !important;
    }
    
    .feature-card {
        transition: all 0.3s ease;
    }
    
    .feature-card:hover {
        background: linear-gradient(135deg, #aebdfdd8 0%, #c393f3c4 100%);
        transform: scale(1.05);
    }
    
    .avatar-circle {
        border: 3px solid white;
        box-shadow: 0 4px 6px rgba(224, 218, 218, 0.97);
    }
    
    .btn-lg {
        border-radius: 10px;
        font-weight: 500;
    }
</style>
{% endblock %}\n\n========== FILE: ./accounts/templates/accounts/base.html ==========\n
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Elimu School Management System {% endblock %}</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #9f7aea 100%);
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.9);
            --text-muted-glass: rgba(255, 255, 255, 0.7);
            --card-bg: rgba(255, 255, 255, 0.15);
            --hover-bg: rgba(255, 255, 255, 0.25);
        }
        
        body {
            background: linear-gradient(135deg, #0f2fbb 0%, #764ba2 50%, #9f7aea 100%);
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-x: hidden;
            color: var(--text-primary);
        }
        
        /* Animated Crystal Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.15) 0%, transparent 30%),
                radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 35%),
                radial-gradient(circle at 40% 80%, rgba(255, 255, 255, 0.12) 0%, transparent 40%),
                radial-gradient(circle at 90% 20%, rgba(255, 255, 255, 0.08) 0%, transparent 45%);
            pointer-events: none;
            z-index: 0;
            animation: crystalShimmer 12s ease-in-out infinite;
        }
        
        @keyframes crystalShimmer {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        
        /* Floating particles */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 30% 40%, rgba(255,255,255,0.1) 2px, transparent 2px),
                radial-gradient(circle at 70% 60%, rgba(255,255,255,0.1) 3px, transparent 3px),
                radial-gradient(circle at 85% 25%, rgba(255,255,255,0.08) 1px, transparent 1px),
                radial-gradient(circle at 15% 80%, rgba(255,255,255,0.08) 2px, transparent 2px);
            background-size: 200px 200px;
            pointer-events: none;
            animation: floatParticles 20s linear infinite;
            opacity: 0.5;
        }
        
        @keyframes floatParticles {
            0% { transform: translateY(0) rotate(0deg); }
            100% { transform: translateY(-100px) rotate(10deg); }
        }
        
        .main-content {
            flex: 1 0 auto;
            position: relative;
            z-index: 1;
        }
        
        /* Glassmorphism Navbar */
        .navbar-custom {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            border-bottom: 1px solid var(--glass-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            padding: 0.5rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .navbar-brand-custom {
            color: var(--text-primary) !important;
            font-weight: 800;
            font-size: 1.8rem;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: 0.5px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.4s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.25);
        }
        
        .navbar-brand-custom i {
            font-size: 1.8rem;
            filter: drop-shadow(2px 4px 6px rgba(0, 0, 0, 0.2));
        }
        
        .navbar-custom .nav-link {
            color: var(--text-primary) !important;
            font-weight: 600;
            font-size: 1rem;
            margin: 0 3px;
            padding: 10px 18px !important;
            border-radius: 40px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(5px);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .navbar-custom .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .navbar-custom .nav-link:hover::before {
            left: 100%;
        }
        
        .navbar-custom .nav-link i {
            font-size: 1.2rem;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.2));
        }
        
        .navbar-custom .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid var(--glass-border);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .navbar-custom .nav-link.active {
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.4);
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .navbar-custom .nav-link.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .welcome-text {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1rem;
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 40px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            margin-right: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .welcome-text i {
            font-size: 1.1rem;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: linear-gradient(135deg, #ff6b6b, #ff4757);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(255, 71, 87, 0.4);
            border: 2px solid rgba(255,255,255,0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .logout-btn {
            background: rgba(220, 53, 69, 0.15) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            backdrop-filter: blur(10px);
            border-radius: 40px;
            padding: 10px 25px;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary) !important;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .logout-btn:hover {
            background: rgba(220, 53, 69, 0.25) !important;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
            border-color: rgba(255, 255, 255, 0.3) !important;
        }
        
        .content-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
            margin-bottom: 30px;
            padding: 30px;
            position: relative;
            overflow: hidden;
            color: var(--text-primary);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .content-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }
        
        .content-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 6s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            20% { left: 100%; }
            100% { left: 100%; }
        }
        
        .content-card h1, .content-card h2, .content-card h3 {
            color: var(--text-primary);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            font-weight: 700;
        }
        
        .alert-custom {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin: 15px 0;
            color: var(--text-primary);
            font-size: 1rem;
            padding: 15px 20px;
            border-left: 4px solid;
        }
        
        .alert-custom.alert-success { border-left-color: #10b981; }
        .alert-custom.alert-danger { border-left-color: #ef4444; }
        .alert-custom.alert-warning { border-left-color: #f59e0b; }
        .alert-custom.alert-info { border-left-color: #3b82f6; }
        
        .alert-custom .btn-close {
            filter: brightness(0) invert(1);
            opacity: 0.8;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-weight: bold;
            font-size: 1.2rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .dropdown-custom .dropdown-menu {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            padding: 10px;
            margin-top: 10px;
            animation: dropdownFade 0.3s ease;
        }
        
        @keyframes dropdownFade {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .dropdown-custom .dropdown-item {
            color: var(--text-primary);
            border-radius: 12px;
            padding: 10px 15px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .dropdown-custom .dropdown-item i {
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }
        
        .dropdown-custom .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
            backdrop-filter: blur(5px);
        }
        
        .dropdown-custom .dropdown-divider {
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            margin: 8px 0;
        }
        
        .floating-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(15px) saturate(180%);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            z-index: 1000;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.05); }
        }
        
        .floating-btn:hover {
            transform: scale(1.15) rotate(90deg);
            background: rgba(255, 255, 255, 0.35);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            animation: none;
        }
        
        .page-title {
            color: var(--text-primary);
            font-weight: 800;
            font-size: 2.2rem;
            margin-bottom: 25px;
            position: relative;
            padding-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .page-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, rgba(255,255,255,0.8), transparent);
            border-radius: 2px;
        }
        
        /* Modal Glassmorphism */
        .modal-content {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(30px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            color: var(--text-primary);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 30px 30px 0 0;
            padding: 20px 25px;
        }
        
        .modal-header .modal-title {
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        .modal-header .btn-close {
            filter: brightness(0) invert(1);
            opacity: 0.8;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px 25px;
        }
        
        .btn-glass {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px) saturate(180%);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 40px;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn-glass:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .btn-glass i {
            margin-right: 8px;
        }
        
        /* Form controls glassmorphism */
        .form-control, .form-select {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            padding: 10px 15px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        
        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .form-label {
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        /* Table glassmorphism */
        .table {
            color: var(--text-primary);
        }
        
        .table thead th {
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .table tbody tr {
            transition: all 0.3s ease;
        }
        
        .table tbody tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .table td, .table th {
            border-color: rgba(255, 255, 255, 0.1);
            padding: 12px 15px;
        }
        
        /* Card styles */
        .card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            color: var(--text-primary);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }
        
        .card-header {
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .card-body {
            padding: 20px;
        }
        
        /* Badge styles */
        .badge {
            padding: 6px 12px;
            border-radius: 30px;
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        .badge.bg-primary { background: rgba(102, 126, 234, 0.8) !important; }
        .badge.bg-success { background: rgba(16, 185, 129, 0.8) !important; }
        .badge.bg-danger { background: rgba(239, 68, 68, 0.8) !important; }
        .badge.bg-warning { background: rgba(245, 158, 11, 0.8) !important; }
        .badge.bg-info { background: rgba(59, 130, 246, 0.8) !important; }
        
        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .navbar-brand-custom { font-size: 1.5rem; }
            .navbar-custom .nav-link { padding: 8px 12px !important; font-size: 0.9rem; }
        }
        
        @media (max-width: 992px) {
            .navbar-custom .navbar-collapse {
                background: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(20px);
                padding: 20px;
                border-radius: 20px;
                margin-top: 15px;
            }
            
            .navbar-custom .nav-item {
                margin-bottom: 8px;
            }
            
            .welcome-text {
                margin: 10px 0;
                width: 100%;
                justify-content: center;
            }
            
            .content-card {
                padding: 20px;
                margin-top: 20px;
            }
            
            .page-title {
                font-size: 1.8rem;
            }
            
            .floating-btn {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
        }
        
        @media (max-width: 768px) {
            .navbar-brand-custom {
                font-size: 1.3rem;
                padding: 8px 15px;
            }
            
            .welcome-text {
                font-size: 0.9rem;
                padding: 6px 15px;
            }
            
            .logout-btn {
                padding: 8px 20px;
                font-size: 0.9rem;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            
            .content-card {
                padding: 15px;
            }
        }
        
        /* Loading animation */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-custom sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand-custom" href="{% url 'dashboard' %}">
                <i class="fas fa-graduation-cap"></i>
                <span class="d-none d-sm-inline">Elimu</span> SchoolAdmin
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon" style="filter: brightness(0) invert(1);"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                {% if user.is_authenticated %}
                <ul class="navbar-nav me-auto">
                    {% if user.is_admin %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" 
                           href="{% url 'dashboard' %}">
                            <i class="fas fa-tachometer-alt"></i> <span class="d-none d-lg-inline">My</span> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'admin:index' %}">
                            <i class="fas fa-cogs"></i> <span class="d-none d-lg-inline">Admin</span> Panel
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'student' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'student_list' %}">
                            <i class="fas fa-users"></i> Students
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'teacher' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'teacher_list' %}">
                            <i class="fas fa-chalkboard-teacher"></i> Teachers
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'teacher_passwords_view' in request.resolver_match.url_name %}active{% endif %}" 
                        href="{% url 'teacher_passwords_view' %}">
                            <i class="fas fa-key"></i> <span class="d-none d-lg-inline">Teacher</span> Passwords
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'fee' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'fee_structure_list' %}">
                            <i class="fas fa-money-bill-wave"></i> Fees
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'report' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'financial_report' %}">
                            <i class="fas fa-chart-bar"></i> Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'performance' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'student_performance_analytics' %}">
                            <i class="fas fa-chart-line"></i> Analytics
                        </a>
                    </li>
                    
                    {% elif user.is_teacher %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" 
                           href="{% url 'dashboard' %}">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'teacher_students' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'teacher_students' %}">
                            <i class="fas fa-user-graduate"></i> My Students
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'teacher_student_list' in request.resolver_match.url_name %}active{% endif %}" 
                        href="{% url 'teacher_student_list' %}">
                            <i class="fas fa-key"></i> <span class="d-none d-lg-inline">Student</span> Passwords
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'mark' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'mark_list' %}">
                            <i class="fas fa-clipboard-check"></i> Marks
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'performance' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'student_performance_analytics' %}">
                            <i class="fas fa-chart-line"></i> Performance
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'fee_summary' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'fee_summary' %}">
                            <i class="fas fa-money-bill"></i> Fee Summary
                        </a>
                    </li>
                    
                    {% elif user.is_student %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" 
                           href="{% url 'dashboard' %}">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'student_profile' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'student_profile' %}">
                            <i class="fas fa-user-circle"></i> My Profile
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'student_results' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'student_results' %}">
                            <i class="fas fa-file-alt"></i> My Results
                        </a>
                    </li>
                    <li class="nav-item">
                        {% if user.student and user.student.id %}
                        <a class="nav-link {% if 'student_performance_detail' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'student_performance_detail' user.student.id %}">
                            <i class="fas fa-chart-line"></i> Performance Trends
                        </a>
                        {% else %}
                        <a class="nav-link disabled" href="#" title="Student profile not available">
                            <i class="fas fa-chart-line"></i> Performance Trends
                        </a>
                        {% endif %}
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'student_financial_dashboard' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'student_financial_dashboard' %}">
                            <i class="fas fa-wallet"></i> My Finances
                        </a>
                    </li>
                    {% endif %}
                    
                    <li class="nav-item dropdown dropdown-custom">
                        <a class="nav-link dropdown-toggle" href="#" id="messagesDropdown" role="button" 
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-envelope"></i> <span class="d-none d-lg-inline">Messages</span>
                            {% if unread_count > 0 %}
                            <span class="notification-badge">{{ unread_count }}</span>
                            {% endif %}
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="messagesDropdown">
                            {% if user.is_admin or user.is_teacher %}
                            <li>
                                <a class="dropdown-item" href="{% url 'message_list' %}">
                                    <i class="fas fa-list"></i> All Messages
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'message_create' %}">
                                    <i class="fas fa-paper-plane"></i> Send Message
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'outbox' %}">
                                    <i class="fas fa-share-square"></i> Sent Messages
                                </a>
                            </li>
                            {% endif %}
                            <li>
                                <a class="dropdown-item" href="{% url 'inbox' %}">
                                    <i class="fas fa-inbox"></i> My Inbox
                                    {% if unread_count > 0 %}
                                    <span class="badge bg-danger float-end">{{ unread_count }}</span>
                                    {% endif %}
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'notification_list' %}">
                                    <i class="fas fa-bell"></i> Notifications
                                    {% if unread_count > 0 %}
                                    <span class="badge bg-danger float-end">{{ unread_count }}</span>
                                    {% endif %}
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
                
                <div class="navbar-nav align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="user-avatar me-3" data-bs-toggle="tooltip" title="{{ user.get_full_name|default:user.username }}">
                            {{ user.username|first|upper }}
                        </div>
                        <span class="welcome-text">
                            <i class="fas fa-user-circle"></i>
                            <span class="d-none d-md-inline">{{ user.username|truncatechars:12 }}</span>
                            <small class="d-none d-lg-inline" style="font-size: 0.85rem;">({{ user.get_role_display }})</small>
                        </span>
                    </div>
                    
                    <div class="dropdown dropdown-custom ms-3">
                        <button class="btn logout-btn dropdown-toggle" type="button" 
                                id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-cog"></i> <span class="d-none d-md-inline">Account</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li>
                                <a class="dropdown-item" href="{% url 'dashboard' %}">
                                    <i class="fas fa-home"></i> Dashboard
                                </a>
                            </li>
                            {% if user.is_student %}
                            <li>
                                <a class="dropdown-item" href="{% url 'student_profile' %}">
                                    <i class="fas fa-user"></i> My Profile
                                </a>
                            </li>
                            <li>
                                {% if user.student and user.student.id %}
                                <a class="dropdown-item" href="{% url 'student_performance_detail' user.student.id %}">
                                    <i class="fas fa-chart-line"></i> Performance Analysis
                                </a>
                                {% else %}
                                <a class="dropdown-item disabled" href="#">
                                    <i class="fas fa-chart-line"></i> Performance Analysis
                                </a>
                                {% endif %}
                            </li>
                            {% endif %}
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <form method="post" action="{% url 'logout' %}" class="dropdown-item p-0">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-link w-100 text-start dropdown-item" style="color: #ff6b6b !important;">
                                        <i class="fas fa-sign-out-alt"></i> Logout
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </div>
                {% else %}
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'login' %}">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </a>
                    </li>
                </ul>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Messages -->
    <div class="container mt-3">
        {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show alert-custom animate__animated animate__fadeInDown" role="alert">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        {% if message.tags == 'success' %}
                        <i class="fas fa-check-circle" style="font-size: 1.5rem;"></i>
                        {% elif message.tags == 'error' or message.tags == 'danger' %}
                        <i class="fas fa-exclamation-circle" style="font-size: 1.5rem;"></i>
                        {% elif message.tags == 'warning' %}
                        <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem;"></i>
                        {% else %}
                        <i class="fas fa-info-circle" style="font-size: 1.5rem;"></i>
                        {% endif %}
                    </div>
                    <div style="font-size: 1rem;">{{ message }}</div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        {% endif %}
    </div>

    <!-- Main Content -->
    <div class="container main-content">
        <div class="content-card animate__animated animate__fadeInUp">
            {% block content %}{% endblock %}
        </div>
    </div>

    <!-- Footer -->
    {% include 'includes/footer.html' %}

    <!-- Quick Actions Floating Button -->
    {% if user.is_authenticated %}
    <button class="floating-btn" data-bs-toggle="modal" data-bs-target="#quickActionsModal" data-bs-toggle="tooltip" title="Quick Actions">
        <i class="fas fa-bolt"></i>
    </button>
    
    <!-- Quick Actions Modal -->
    <div class="modal fade" id="quickActionsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-bolt me-2"></i> Quick Actions
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        {% if user.is_admin %}
                        <div class="col-6">
                            <a href="{% url 'student_list' %}" class="btn btn-glass w-100 py-3">
                                <i class="fas fa-user-plus fa-lg mb-2 d-block"></i>
                                <span>Add Student</span>
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{% url 'student_performance_analytics' %}" class="btn btn-glass w-100 py-3">
                                <i class="fas fa-chart-line fa-lg mb-2 d-block"></i>
                                <span>Analytics</span>
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if user.is_teacher %}
                        <div class="col-6">
                            <a href="{% url 'mark_create' %}" class="btn btn-glass w-100 py-3">
                                <i class="fas fa-edit fa-lg mb-2 d-block"></i>
                                <span>Enter Marks</span>
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{% url 'student_performance_analytics' %}" class="btn btn-glass w-100 py-3">
                                <i class="fas fa-chart-bar fa-lg mb-2 d-block"></i>
                                <span>Performance</span>
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if user.is_student %}
                        <div class="col-6">
                            <a href="{% url 'student_results' %}" class="btn btn-glass w-100 py-3">
                                <i class="fas fa-file-alt fa-lg mb-2 d-block"></i>
                                <span>Results</span>
                            </a>
                        </div>
                        <div class="col-6">
                            {% if user.student and user.student.id %}
                            <a href="{% url 'student_performance_detail' user.student.id %}" class="btn btn-glass w-100 py-3">
                                <i class="fas fa-chart-line fa-lg mb-2 d-block"></i>
                                <span>Trends</span>
                            </a>
                            {% else %}
                            <button class="btn btn-glass w-100 py-3 disabled" disabled>
                                <i class="fas fa-chart-line fa-lg mb-2 d-block"></i>
                                <span>Trends</span>
                            </button>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <div class="col-6">
                            <a href="{% url 'inbox' %}" class="btn btn-glass w-100 py-3">
                                <i class="fas fa-inbox fa-lg mb-2 d-block"></i>
                                <span>Inbox</span>
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{% url 'dashboard' %}" class="btn btn-glass w-100 py-3">
                                <i class="fas fa-home fa-lg mb-2 d-block"></i>
                                <span>Home</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl, {
                    placement: 'top',
                    trigger: 'hover'
                });
            });
            
            // Active link handling
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.navbar-nav .nav-link:not(.disabled)');
            
            navLinks.forEach(link => {
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                }
            });
            
            // Floating button animation
            const floatingBtn = document.querySelector('.floating-btn');
            if (floatingBtn) {
                floatingBtn.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.15) rotate(90deg)';
                });
                
                floatingBtn.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1) rotate(0deg)';
                });
            }
            
            // Handle disabled links
            const disabledLinks = document.querySelectorAll('.nav-link.disabled');
            disabledLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (this.title) {
                        const toast = new bootstrap.Toast(document.createElement('div'));
                        console.log(this.title);
                    }
                });
            });
            
            // Auto-hide alerts after 5 seconds
            setTimeout(function() {
                var alerts = document.querySelectorAll('.alert:not(.alert-permanent)');
                alerts.forEach(function(alert) {
                    var bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                });
            }, 5000);
            
            // Add smooth scroll to top
            floatingBtn?.addEventListener('click', function(e) {
                if (window.scrollY > 0) {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }
            });
        });
    </script>
</body>
</html>\n\n========== FILE: ./accounts/templates/accounts/dashboard.html ==========\n
{% comment %} <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}School Admin System{% endblock %}</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --dark-blue: #2c3e50;
            --light-blue: #3498db;
        }
        
        body {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar-custom {
            background: var(--primary-gradient);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 0.5rem 0;
        }
        
        .navbar-custom .nav-link {
            color: rgba(255,255,255,0.95) !important;
            font-weight: 500;
            margin: 0 2px;
            padding: 8px 16px !important;
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .navbar-custom .nav-link i {
            font-size: 1.1rem;
        }
        
        .navbar-custom .nav-link:hover {
            background: rgba(255,255,255,0.2);
            color: white !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,255,255,0.1);
        }
        
        .navbar-custom .nav-link.active {
            background: rgba(255,255,255,0.25);
            font-weight: 600;
        }
        
        .welcome-text {
            color: white;
            font-weight: 500;
            padding: 8px 16px;
            background: rgba(255,255,255,0.15);
            border-radius: 50px;
            margin-right: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--secondary-gradient);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .logout-btn {
            background: rgba(220,53,69,0.95) !important;
            border: none;
            border-radius: 50px;
            padding: 8px 24px;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logout-btn:hover {
            background: #dc3545 !important;
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 15px rgba(220,53,69,0.3);
        }
        
        .content-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            border: none;
            margin-top: 30px;
            padding: 40px;
            position: relative;
            overflow: hidden;
        }
        
        .content-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }
        
        .alert-custom {
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border-left: 4px solid;
        }
        
        .navbar-brand-custom {
            color: white !important;
            font-weight: 800;
            font-size: 1.8rem;
            padding: 0 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 10px 20px;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .navbar-brand-custom i {
            font-size: 1.5rem;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        .dropdown-custom .dropdown-menu {
            border-radius: 12px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            padding: 10px;
            margin-top: 10px;
        }
        
        .dropdown-custom .dropdown-item {
            border-radius: 8px;
            padding: 10px 15px;
            margin: 2px 0;
            transition: all 0.2s ease;
        }
        
        .dropdown-custom .dropdown-item:hover {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            transform: translateX(5px);
        }
        
        @media (max-width: 992px) {
            .navbar-custom .nav-item {
                margin-bottom: 5px;
            }
            
            .welcome-text {
                margin: 10px 0;
                width: 100%;
                text-align: center;
            }
            
            .content-card {
                padding: 25px;
                margin-top: 20px;
            }
            
            .navbar-nav {
                padding: 10px 0;
            }
        }
        
        .floating-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--success-gradient);
            color: white;
            border: none;
            box-shadow: 0 6px 20px rgba(67, 233, 123, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .floating-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 8px 25px rgba(67, 233, 123, 0.6);
        }
        
        .page-title {
            color: var(--dark-blue);
            font-weight: 700;
            margin-bottom: 25px;
            position: relative;
            padding-bottom: 15px;
        }
        
        .page-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 4px;
            background: var(--primary-gradient);
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-custom sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand-custom" href="{% url 'dashboard' %}">
                <i class="fas fa-graduation-cap"></i>
                SchoolAdmin
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon" style="filter: invert(1); font-size: 1.5rem;">â˜°</span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                {% if user.is_authenticated %}
                <ul class="navbar-nav me-auto">
                    {% if user.is_admin %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" 
                           href="{% url 'dashboard' %}">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'admin:index' %}">
                            <i class="fas fa-cogs"></i> Admin Panel
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'student' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'student_list' %}">
                            <i class="fas fa-users"></i> Students
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'teacher' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'teacher_list' %}">
                            <i class="fas fa-chalkboard-teacher"></i> Teachers
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'fee' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'fee_structure_list' %}">
                            <i class="fas fa-money-bill-wave"></i> Fees
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'report' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'financial_report' %}">
                            <i class="fas fa-chart-bar"></i> Reports
                        </a>
                    </li>
                    <!-- Performance Analytics -->
                    <li class="nav-item">
                        <a class="nav-link {% if 'performance' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'student_performance_analytics' %}">
                            <i class="fas fa-chart-line"></i> Analytics
                        </a>
                    </li>
                    
                    {% elif user.is_teacher %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" 
                           href="{% url 'dashboard' %}">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'teacher_students' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'teacher_students' %}">
                            <i class="fas fa-user-graduate"></i> My Students
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'mark' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'mark_list' %}">
                            <i class="fas fa-clipboard-check"></i> Marks
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'performance' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'student_performance_analytics' %}">
                            <i class="fas fa-chart-line"></i> Performance
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'fee_summary' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'fee_summary' %}">
                            <i class="fas fa-money-bill"></i> Fee Summary
                        </a>
                    </li>
                    
                    {% elif user.is_student %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" 
                           href="{% url 'dashboard' %}">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'student_profile' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'student_profile' %}">
                            <i class="fas fa-user-circle"></i> My Profile
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'student_results' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'student_results' %}">
                            <i class="fas fa-file-alt"></i> My Results
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'student_performance_detail' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'student_performance_detail' user.student.id %}">
                            <i class="fas fa-chart-line"></i> Performance Trends
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'student_financial_dashboard' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'student_financial_dashboard' %}">
                            <i class="fas fa-wallet"></i> My Finances
                        </a>
                    </li>
                    {% endif %}
                    
                    <!-- Common Links for All Users -->
                    <li class="nav-item dropdown dropdown-custom">
                        <a class="nav-link dropdown-toggle" href="#" id="messagesDropdown" role="button" 
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-envelope"></i> Messages
                            {% if unread_count > 0 %}
                            <span class="notification-badge">{{ unread_count }}</span>
                            {% endif %}
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="messagesDropdown">
                            {% if user.is_admin or user.is_teacher %}
                            <li>
                                <a class="dropdown-item" href="{% url 'message_list' %}">
                                    <i class="fas fa-list"></i> All Messages
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'message_create' %}">
                                    <i class="fas fa-paper-plane"></i> Send Message
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'outbox' %}">
                                    <i class="fas fa-share-square"></i> Sent Messages
                                </a>
                            </li>
                            {% endif %}
                            <li>
                                <a class="dropdown-item" href="{% url 'inbox' %}">
                                    <i class="fas fa-inbox"></i> Inbox
                                    {% if unread_count > 0 %}
                                    <span class="badge bg-danger float-end">{{ unread_count }}</span>
                                    {% endif %}
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'notification_list' %}">
                                    <i class="fas fa-bell"></i> Notifications
                                    {% if unread_count > 0 %}
                                    <span class="badge bg-danger float-end">{{ unread_count }}</span>
                                    {% endif %}
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
                
                <div class="navbar-nav align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="user-avatar me-2">
                            {{ user.username|first|upper }}
                        </div>
                        <span class="welcome-text">
                            <i class="fas fa-user"></i>
                            {{ user.username }} 
                            <small>({{ user.get_role_display }})</small>
                        </span>
                    </div>
                    
                    <div class="dropdown dropdown-custom ms-3">
                        <button class="btn btn-danger logout-btn dropdown-toggle" type="button" 
                                id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-sign-out-alt"></i> {{ user.username|truncatechars:8 }}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li>
                                <a class="dropdown-item" href="{% url 'dashboard' %}">
                                    <i class="fas fa-home"></i> Dashboard
                                </a>
                            </li>
                            {% if user.is_student %}
                            <li>
                                <a class="dropdown-item" href="{% url 'student_profile' %}">
                                    <i class="fas fa-user"></i> My Profile
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'student_performance_detail' user.student.id %}">
                                    <i class="fas fa-chart-line"></i> Performance Analysis
                                </a>
                            </li>
                            {% endif %}
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <form method="post" action="{% url 'logout' %}" class="dropdown-item p-0">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-link text-danger w-100 text-start">
                                        <i class="fas fa-sign-out-alt"></i> Logout
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </div>
                {% else %}
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'login' %}">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </a>
                    </li>
                </ul>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Messages -->
    <div class="container mt-3">
        {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show alert-custom" role="alert">
                <div class="d-flex align-items-center">
                    {% if message.tags == 'success' %}
                    <i class="fas fa-check-circle me-2" style="font-size: 1.2rem;"></i>
                    {% elif message.tags == 'error' or message.tags == 'danger' %}
                    <i class="fas fa-exclamation-circle me-2" style="font-size: 1.2rem;"></i>
                    {% elif message.tags == 'warning' %}
                    <i class="fas fa-exclamation-triangle me-2" style="font-size: 1.2rem;"></i>
                    {% else %}
                    <i class="fas fa-info-circle me-2" style="font-size: 1.2rem;"></i>
                    {% endif %}
                    <div>{{ message }}</div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        {% endif %}
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="content-card animate__animated animate__fadeInUp">
            {% block content %}{% endblock %}
        </div>
    </div>

    <!-- Quick Actions Floating Button -->
    {% if user.is_authenticated %}
    <button class="floating-btn" data-bs-toggle="modal" data-bs-target="#quickActionsModal">
        <i class="fas fa-bolt"></i>
    </button>
    
    <!-- Quick Actions Modal -->
    <div class="modal fade" id="quickActionsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--primary-gradient); color: white;">
                    <h5 class="modal-title">
                        <i class="fas fa-bolt me-2"></i> Quick Actions
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        {% if user.is_admin %}
                        <div class="col-6">
                            <a href="{% url 'student_list' %}" class="btn btn-outline-primary w-100">
                                <i class="fas fa-user-plus"></i> Add Student
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{% url 'student_performance_analytics' %}" class="btn btn-outline-success w-100">
                                <i class="fas fa-chart-line"></i> View Analytics
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if user.is_teacher %}
                        <div class="col-6">
                            <a href="{% url 'mark_create' %}" class="btn btn-outline-primary w-100">
                                <i class="fas fa-edit"></i> Enter Marks
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{% url 'student_performance_analytics' %}" class="btn btn-outline-success w-100">
                                <i class="fas fa-chart-bar"></i> Performance
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if user.is_student %}
                        <div class="col-6">
                            <a href="{% url 'student_results' %}" class="btn btn-outline-primary w-100">
                                <i class="fas fa-file-alt"></i> View Results
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{% url 'student_performance_detail' user.student.id %}" class="btn btn-outline-success w-100">
                                <i class="fas fa-chart-line"></i> Trends
                            </a>
                        </div>
                        {% endif %}
                        
                        <div class="col-6">
                            <a href="{% url 'inbox' %}" class="btn btn-outline-info w-100">
                                <i class="fas fa-inbox"></i> Check Inbox
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-home"></i> Go Home
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Animate.css for animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <script>
        // Add active class to current page link
        document.addEventListener('DOMContentLoaded', function() {
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.navbar-nav .nav-link');
            
            navLinks.forEach(link => {
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                }
            });
            
            // Floating button animation
            const floatingBtn = document.querySelector('.floating-btn');
            if (floatingBtn) {
                floatingBtn.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.1) rotate(90deg)';
                });
                
                floatingBtn.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1) rotate(0deg)';
                });
            }
        });
    </script>
</body>
</html> {% endcomment %}\n\n========== FILE: ./accounts/templates/accounts/login.html ==========\n
{% extends 'accounts/base.html' %}

{% block title %}Login - School Admin{% endblock %}

{% block content %}
<h2>Login to School Admin System</h2>
<form method="post">
    {% csrf_token %}
    <div style="margin-bottom: 10px;">
        <label for="id_username">Username:</label>
        {{ form.username }}
    </div>
    <div style="margin-bottom: 10px;">
        <label for="id_password">Password:</label>
        {{ form.password }}
    </div>
    <button type="submit" style="padding: 10px 20px; background-color: #4CAF50; color: white; border: none; cursor: pointer;">Login</button>
</form>
<p style="margin-top: 20px;">
    <strong>Note:</strong> Students cannot create accounts. Please use credentials provided by admin.
</p>
{% endblock %}\n\n========== FILE: ./accounts/templates/accounts/student_dashboard.html ==========\n
{% extends 'accounts/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <!-- Welcome Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-2">Welcome back, {{ user.get_full_name|default:user.username }}! ðŸ‘‹</h1>
                            <p class="mb-0">Track your academic journey and performance trends</p>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-light text-dark px-3 py-2">
                                <i class="fas fa-user-graduate me-2"></i>
                                Student Dashboard
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats Row -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                My Class
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {% if student_profile %}
                                {{ student_profile.grade }}-{{ student_profile.section }}
                                {% else %}
                                N/A
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-school fa-2x text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Admission Number
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {% if student_profile %}
                                {{ student_profile.admission_number }}
                                {% else %}
                                N/A
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-id-card fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Overall Average
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ overall_average|default:"--" }}%
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Unread Notifications
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ unread_count }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-bell fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Performance Analytics Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center" 
                     style="background: linear-gradient(135deg, #15e45a 0%, #28f06b 100%);">
                    <h6 class="m-0 font-weight-bold text-white">
                        <i class="fas fa-chart-line me-2"></i>Performance Analytics
                    </h6>
                    {% if student_id %}
                    <a href="{% url 'student_performance_detail' student_id %}" 
                       class="btn btn-light btn-sm">
                        View Detailed Analysis <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        {% if student_id %}
                        <p class="text-muted">Track your academic progress across terms</p>
                        
                        <!-- Performance Summary -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card bg-light border-0">
                                    <div class="card-body text-center">
                                        <h5 class="text-primary">{{ subjects_count|default:"0" }}</h5>
                                        <small class="text-muted">Subjects Enrolled</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card bg-light border-0">
                                    <div class="card-body text-center">
                                        <h5 class="text-success">{{ overall_average|default:"--" }}%</h5>
                                        <small class="text-muted">Overall Average</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Student profile not found. Analytics unavailable.
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if student_id %}
                    <!-- Quick Performance Stats -->
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body text-center">
                                    <i class="fas fa-trophy fa-2x text-warning mb-3"></i>
                                    <h5>Performance Trends</h5>
                                    <p class="text-muted small">See how you're improving over time</p>
                                    <a href="{% url 'student_performance_detail' student_id %}" 
                                       class="btn btn-outline-primary btn-sm">
                                        View Trends
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body text-center">
                                    <i class="fas fa-balance-scale fa-2x text-info mb-3"></i>
                                    <h5>Subject Analysis</h5>
                                    <p class="text-muted small">Identify strengths & weaknesses</p>
                                    <a href="{% url 'student_results' %}" 
                                       class="btn btn-outline-info btn-sm">
                                        View Subjects
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Personal Info Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h6 class="m-0 font-weight-bold text-white">
                        <i class="fas fa-user-circle me-2"></i>My Information
                    </h6>
                </div>
                <div class="card-body">
                    {% if student_profile %}
                    <div class="text-center mb-4">
                        <div class="avatar-circle mb-3" 
                             style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                    border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;">
                            <span class="text-white h3">{{ user.get_full_name|first|upper|default:user.username|first|upper }}</span>
                        </div>
                        <h5 class="mb-1">{{ user.get_full_name|default:user.username }}</h5>
                        <p class="text-muted small">{{ student_profile.admission_number|default:"No admission number" }}</p>
                    </div>
                    
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-graduation-cap text-primary me-2"></i>Class</span>
                            <span class="badge bg-primary">{{ student_profile.grade }}-{{ student_profile.section }}</span>
                        </div>
                        
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-id-badge text-success me-2"></i>Admission No.</span>
                            <span class="text-success">{{ student_profile.admission_number }}</span>
                        </div>
                        
                        {% if student_profile.date_of_birth %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-birthday-cake text-info me-2"></i>Date of Birth</span>
                            <span>{{ student_profile.date_of_birth }}</span>
                        </div>
                        {% endif %}
                        
                        {% if student_profile.parent_phone %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-phone text-warning me-2"></i>Parent Contact</span>
                            <span>{{ student_profile.parent_phone }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Student profile not found. Please contact administration.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Features Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3" style="background: #2c3e50;">
                    <h6 class="m-0 font-weight-bold text-white">
                        <i class="fas fa-graduation-cap me-2"></i>Student Access Features
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="feature-card text-center p-3 border rounded h-100">
                                <i class="fas fa-user fa-2x text-primary mb-3"></i>
                                <h6>Personal Profile</h6>
                                <p class="text-muted small">View and manage your personal information</p>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="feature-card text-center p-3 border rounded h-100">
                                <i class="fas fa-chart-line fa-2x text-success mb-3"></i>
                                <h6>Performance Analytics</h6>
                                <p class="text-muted small">
                                    {% if student_id %}
                                    Track trends and academic progress
                                    {% else %}
                                    Available with student profile
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="feature-card text-center p-3 border rounded h-100">
                                <i class="fas fa-file-alt fa-2x text-info mb-3"></i>
                                <h6>Academic Results</h6>
                                <p class="text-muted small">Access marks, grades, and reports</p>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="feature-card text-center p-3 border rounded h-100">
                                <i class="fas fa-wallet fa-2x text-warning mb-3"></i>
                                <h6>Financial Dashboard</h6>
                                <p class="text-muted small">Monitor fees and payments</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        border-radius: 15px;
        border: none;
        transition: transform 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-5px);
    }
    
    .border-left-primary {
        border-left: 4px solid #4e73df !important;
    }
    
    .border-left-success {
        border-left: 4px solid #1cc88a !important;
    }
    
    .border-left-info {
        border-left: 4px solid #36b9cc !important;
    }
    
    .border-left-warning {
        border-left: 4px solid #f6c23e !important;
    }
    
    .feature-card {
        transition: all 0.3s ease;
    }
    
    .feature-card:hover {
        background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        transform: scale(1.05);
    }
    
    .avatar-circle {
        border: 3px solid white;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}\n\n========== FILE: ./accounts/templates/accounts/teacher_dashboard.html ==========\n
{% extends 'accounts/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <!-- Welcome Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-2">Welcome back, {{ user.get_full_name|default:user.username }}! ðŸ‘‹</h1>
                            <p class="mb-0">Manage your classes, students, and academic activities</p>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-light text-dark px-3 py-2">
                                <i class="fas fa-chalkboard-teacher me-2"></i>
                                Teacher Dashboard
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats Row -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Assigned Subjects
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {% if user.teacher_profile.subjects %}
                                {{ user.teacher_profile.subjects }}
                                {% else %}
                                Not assigned
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-book fa-2x text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Assigned Classes
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {% if user.teacher_profile.classes %}
                                {{ user.teacher_profile.classes }}
                                {% else %}
                                Not assigned
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-school fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                My Students
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ student_count|default:"0" }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-graduate fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Unread Notifications
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ unread_count }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-bell fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Performance Analytics Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center" 
                     style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <h6 class="m-0 font-weight-bold text-white">
                        <i class="fas fa-chart-line me-2"></i>Performance Analytics
                    </h6>
                    <a href="{% url 'student_performance_analytics' %}" 
                       class="btn btn-light btn-sm">
                        View Analytics <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <p class="text-muted">Monitor student performance and track academic progress</p>
                    </div>
                    
                    <!-- Quick Performance Stats -->
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-line fa-2x text-primary mb-3"></i>
                                    <h5>Student Analytics</h5>
                                    <p class="text-muted small">Track student performance trends</p>
                                    <a href="{% url 'student_performance_analytics' %}" 
                                       class="btn btn-outline-primary btn-sm">
                                        View Analytics
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body text-center">
                                    <i class="fas fa-balance-scale fa-2x text-info mb-3"></i>
                                    <h5>Term Comparison</h5>
                                    <p class="text-muted small">Compare performance across terms</p>
                                    <a href="{% url 'term_comparison_analytics' %}" 
                                       class="btn btn-outline-info btn-sm">
                                        Compare Terms
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Student Password Access Section -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center" 
                            style="background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);">
                            <h6 class="m-0 font-weight-bold text-white">
                                <i class="fas fa-key me-2"></i>Student Password Access
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-info-circle fa-2x"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="alert-heading mb-2">Password Viewing Access</h6>
                                        <p class="mb-2">
                                            As a teacher of the following classes: 
                                            <strong>{{ user.teacher_profile.classes|default:"Not assigned" }}</strong>, 
                                            you can view passwords for students in your assigned classes.
                                        </p>
                                        <p class="mb-0">
                                            <strong>Note:</strong> All student passwords are auto-generated 8-character codes.
                                        </p>
                                    </div>
                                </div>
                            </div>
        
                            <div class="text-center">
                                <a href="{% url 'teacher_student_list' %}" 
                                class="btn btn-primary btn-lg px-5 py-3">
                                    <i class="fas fa-key me-2"></i>
                                    View Student Passwords
                                    <small class="d-block mt-1">Access passwords for your students</small>
                                </a>
                            </div>
                        </div>
                    </div>
                    <!-- Call to Action -->
                    <div class="alert alert-info border-0 shadow-sm">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-lightbulb fa-2x text-info"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="alert-heading">Analytics Insight</h6>
                                <p class="mb-0">Use analytics tools to identify students needing attention, track class performance trends, and make data-driven teaching decisions.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Marks Management Section -->
            <div class="card shadow mb-4">
                <div class="card-header py-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h6 class="m-0 font-weight-bold text-white">
                        <i class="fas fa-clipboard-check me-2"></i>Marks Management
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <a href="{% url 'mark_list' %}" 
                               class="btn btn-primary btn-lg w-100 py-3 d-flex align-items-center justify-content-center">
                                <i class="fas fa-list fa-2x me-3"></i>
                                <div class="text-start">
                                    <div class="h5 mb-1">View All Marks</div>
                                    <small class="opacity-75">Browse and manage student marks</small>
                                </div>
                            </a>
                        </div>
                        
                        <div class="col-md-6">
                            <a href="{% url 'mark_create' %}" 
                               class="btn btn-success btn-lg w-100 py-3 d-flex align-items-center justify-content-center">
                                <i class="fas fa-plus-circle fa-2x me-3"></i>
                                <div class="text-start">
                                    <div class="h5 mb-1">Add New Marks</div>
                                    <small class="opacity-75">Enter marks for students</small>
                                </div>
                            </a>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <div class="alert alert-light border">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-info-circle text-primary"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-2">Marks Management Features</h6>
                                    <ul class="mb-0">
                                        <li>Enter marks for students in your classes</li>
                                        <li>Update marks for continuous assessment and exams</li>
                                        <li>View all marks you have entered</li>
                                        <li>Track student performance trends</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Teacher Information Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h6 class="m-0 font-weight-bold text-white">
                        <i class="fas fa-user-tie me-2"></i>My Information
                    </h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="avatar-circle mb-3" 
                             style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                    border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;">
                            <span class="text-white h3">{{ user.get_full_name|first|upper|default:user.username|first|upper }}</span>
                        </div>
                        <h5 class="mb-1">{{ user.get_full_name|default:user.username }}</h5>
                        <p class="text-muted small">{{ user.email|default:"No email" }}</p>
                    </div>
                    
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-book text-primary me-2"></i>Subjects</span>
                            <span class="badge bg-primary">
                                {% if user.teacher_profile.subjects %}
                                {{ user.teacher_profile.subjects }}
                                {% else %}
                                Not assigned
                                {% endif %}
                            </span>
                        </div>
                        
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-school text-success me-2"></i>Classes</span>
                            <span class="text-success">
                                {% if user.teacher_profile.classes %}
                                {{ user.teacher_profile.classes }}
                                {% else %}
                                Not assigned
                                {% endif %}
                            </span>
                        </div>
                        
                        {% if user.teacher_profile.phone %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-phone text-info me-2"></i>Phone</span>
                            <span>{{ user.teacher_profile.phone }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-dark text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'teacher_students' %}" 
                           class="btn btn-primary btn-lg">
                            <i class="fas fa-user-graduate me-2"></i>My Students
                        </a>
                         <a href="{% url 'teacher_student_list' %}" 
                            class="btn btn-danger btn-lg">
                                <i class="fas fa-key me-2"></i>Student Passwords
                            </a>
                        <a href="{% url 'student_create' %}" 
                           class="btn btn-success btn-lg">
                            <i class="fas fa-user-plus me-2"></i>Add Student
                        </a>
                        
                        <a href="{% url 'student_performance_analytics' %}" 
                           class="btn btn-info btn-lg">
                            <i class="fas fa-chart-line me-2"></i>Performance Analytics
                        </a>
                        
                        <a href="{% url 'fee_summary' %}" 
                           class="btn btn-warning btn-lg">
                            <i class="fas fa-money-bill me-2"></i>Fee Summary
                        </a>
                    </div>
                    
                    <div class="mt-4">
                        <div class="alert alert-light border">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-graduation-cap text-primary"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <small class="text-muted">
                                        As a teacher, you can manage students, track performance, and monitor academic progress.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Features Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3" style="background: #2c3e50;">
                    <h6 class="m-0 font-weight-bold text-white">
                        <i class="fas fa-tasks me-2"></i>Teacher Responsibilities
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="feature-card text-center p-3 border rounded h-100">
                                <i class="fas fa-user-graduate fa-2x text-primary mb-3"></i>
                                <h6>Student Management</h6>
                                <p class="text-muted small">View and manage students in your classes</p>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="feature-card text-center p-3 border rounded h-100">
                                <i class="fas fa-chart-line fa-2x text-success mb-3"></i>
                                <h6>Performance Analytics</h6>
                                <p class="text-muted small">Track student performance trends</p>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="feature-card text-center p-3 border rounded h-100">
                                <i class="fas fa-clipboard-check fa-2x text-info mb-3"></i>
                                <h6>Marks Management</h6>
                                <p class="text-muted small">Enter and update student marks</p>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="feature-card text-center p-3 border rounded h-100">
                                <i class="fas fa-money-bill fa-2x text-warning mb-3"></i>
                                <h6>Fee Monitoring</h6>
                                <p class="text-muted small">Monitor student fee payments</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-secondary mt-3">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-circle fa-2x"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="alert-heading mb-1">Teacher Access</h6>
                                <p class="mb-0">As a teacher, you have access to manage academic activities, track student performance, update student information, and monitor student progress in your assigned classes.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        border-radius: 15px;
        border: none;
        transition: transform 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-5px);
    }
    
    .border-left-primary {
        border-left: 4px solid #4e73df !important;
    }
    
    .border-left-success {
        border-left: 4px solid #1cc88a !important;
    }
    
    .border-left-info {
        border-left: 4px solid #36b9cc !important;
    }
    
    .border-left-warning {
        border-left: 4px solid #f6c23e !important;
    }
    
    .feature-card {
        transition: all 0.3s ease;
    }
    
    .feature-card:hover {
        background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        transform: scale(1.05);
    }
    
    .avatar-circle {
        border: 3px solid white;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .btn-lg {
        border-radius: 10px;
        font-weight: 500;
    }
</style>
{% endblock %}\n\n========== FILE: ./accounts/templates/includes/footer.html ==========\n
<!-- Enhanced Minimal Footer with Glassmorphism -->
<footer class="footer mt-auto py-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: relative; overflow: hidden;">
    <!-- Subtle Animated Background Elements -->
    <div class="position-absolute w-100 h-100" style="top: 0; left: 0; z-index: 0; opacity: 0.1;">
        <div class="position-absolute rounded-circle" style="width: 150px; height: 150px; background: white; top: -50px; right: -50px;"></div>
        <div class="position-absolute rounded-circle" style="width: 100px; height: 100px; background: white; bottom: -30px; left: -30px;"></div>
    </div>
    
    <div class="container-fluid px-4" style="position: relative; z-index: 1;">
        <!-- Compact Footer Grid -->
        <div class="row g-2 align-items-center">
            <!-- Brand & Copyright - Left -->
            <div class="col-lg-4 col-md-12 text-lg-start text-center mb-2 mb-lg-0">
                <div class="d-flex align-items-center justify-content-lg-start justify-content-center">
                    <div class="bg-white bg-opacity-20 p-2 rounded-3 me-2" style="backdrop-filter: blur(5px); background: rgba(255,255,255,0.15);">
                        <i class="fas fa-graduation-cap fa-lg text-white"></i>
                    </div>
                    <div>
                        <span class="fw-semibold text-white" style="font-size: 1rem;">SchoolAdmin Pro</span>
                        <p class="mb-0 text-white-50 small" style="font-size: 0.75rem;">&copy; {% now "Y" %} All rights reserved</p>
                    </div>
                </div>
            </div>
            
            <!-- Quick Links - Center -->
            <div class="col-lg-4 col-md-6 text-center mb-2 mb-md-0">
                <div class="d-flex flex-wrap justify-content-center gap-2">
                    <a href="{% url 'dashboard' %}" class="text-white text-decoration-none small px-3 py-2 rounded-pill hover-bg-light" style="font-size: 0.85rem; backdrop-filter: blur(5px); background: rgba(255,255,255,0.1);">
                        <i class="fas fa-home me-1"></i>Dashboard
                    </a>
                    {% if user.is_authenticated %}
                    <a href="{% url 'inbox' %}" class="text-white text-decoration-none small px-3 py-2 rounded-pill hover-bg-light" style="font-size: 0.85rem; backdrop-filter: blur(5px); background: rgba(255,255,255,0.1);">
                        <i class="fas fa-envelope me-1"></i>Messages
                    </a>
                    <a href="{% url 'notification_list' %}" class="text-white text-decoration-none small px-3 py-2 rounded-pill hover-bg-light" style="font-size: 0.85rem; backdrop-filter: blur(5px); background: rgba(255,255,255,0.1);">
                        <i class="fas fa-bell me-1"></i>Alerts
                    </a>
                    {% endif %}
                </div>
            </div>
            
            <!-- Social & Support - Right -->
            <div class="col-lg-4 col-md-6 text-lg-end text-center">
                <div class="d-flex flex-wrap align-items-center justify-content-lg-end justify-content-center gap-2">
                    <!-- Contact Icons -->
                    <a href="#" class="text-white text-decoration-none small px-3 py-2 rounded-pill hover-bg-light" style="font-size: 0.85rem; backdrop-filter: blur(5px); background: rgba(255,255,255,0.1);" data-bs-toggle="tooltip" title="Call Support">
                        <i class="fas fa-phone-alt me-1"></i>+254 702 496 196
                    </a>
                    
                    <!-- Social Icons - Compact -->
                    <div class="d-flex gap-1">
                        <a href="#" class="text-white text-decoration-none d-flex align-items-center justify-content-center rounded-circle hover-scale" 
                           style="width: 32px; height: 32px; backdrop-filter: blur(5px); background: rgba(255,255,255,0.15); font-size: 0.9rem;" 
                           data-bs-toggle="tooltip" title="Twitter">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="#" class="text-white text-decoration-none d-flex align-items-center justify-content-center rounded-circle hover-scale" 
                           style="width: 32px; height: 32px; backdrop-filter: blur(5px); background: rgba(255,255,255,0.15); font-size: 0.9rem;" 
                           data-bs-toggle="tooltip" title="Facebook">
                            <i class="fab fa-facebook-f"></i>
                        </a>
                        <a href="#" class="text-white text-decoration-none d-flex align-items-center justify-content-center rounded-circle hover-scale" 
                           style="width: 32px; height: 32px; backdrop-filter: blur(5px); background: rgba(255,255,255,0.15); font-size: 0.9rem;" 
                           data-bs-toggle="tooltip" title="LinkedIn">
                            <i class="fab fa-linkedin-in"></i>
                        </a>
                        <a href="#" class="text-white text-decoration-none d-flex align-items-center justify-content-center rounded-circle hover-scale" 
                           style="width: 32px; height: 32px; backdrop-filter: blur(5px); background: rgba(255,255,255,0.15); font-size: 0.9rem;" 
                           data-bs-toggle="tooltip" title="Email">
                            <i class="fas fa-envelope"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Minimal Bottom Links (Hidden on very small screens) -->
        <div class="row mt-2 d-none d-sm-flex">
            <div class="col-12">
                <div class="d-flex flex-wrap justify-content-center gap-3 small text-white-50" style="font-size: 0.7rem;">
                    <a href="#" class="text-white-50 text-decoration-none hover-text-white">Privacy</a>
                    <span>â€¢</span>
                    <a href="#" class="text-white-50 text-decoration-none hover-text-white">Terms</a>
                    <span>â€¢</span>
                    <a href="#" class="text-white-50 text-decoration-none hover-text-white">Support</a>
                    <span>â€¢</span>
                    <span>Version 2.0.0</span>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- Alternative Compact Version for Role-Specific Resources (Hidden by default) -->
{% if user.is_authenticated %}
<div class="compact-resources d-none">
    <!-- This section is hidden and can be conditionally displayed if needed -->
    <div class="container-fluid px-4 py-2 bg-dark bg-opacity-25">
        <div class="row">
            <div class="col-12">
                <div class="d-flex flex-wrap justify-content-center gap-3 small">
                    {% if user.is_student %}
                    <a href="{% url 'student_results' %}" class="text-white-50 text-decoration-none hover-text-white">
                        <i class="fas fa-file-alt me-1"></i>Results
                    </a>
                    <a href="{% url 'student_financial_dashboard' %}" class="text-white-50 text-decoration-none hover-text-white">
                        <i class="fas fa-wallet me-1"></i>Fees
                    </a>
                    {% endif %}
                    
                    {% if user.is_teacher %}
                    <a href="{% url 'mark_list' %}" class="text-white-50 text-decoration-none hover-text-white">
                        <i class="fas fa-clipboard-check me-1"></i>Marks
                    </a>
                    {% endif %}
                    
                    {% if user.is_admin %}
                    <a href="{% url 'financial_report' %}" class="text-white-50 text-decoration-none hover-text-white">
                        <i class="fas fa-chart-pie me-1"></i>Reports
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
    /* Minimal Footer Styles */
    .footer {
        backdrop-filter: blur(10px);
        border-top: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    /* Hover Effects */
    .hover-bg-light {
        transition: all 0.3s ease;
    }
    
    .hover-bg-light:hover {
        background: rgba(255,255,255,0.25) !important;
        transform: translateY(-2px);
    }
    
    .hover-scale {
        transition: all 0.3s ease;
    }
    
    .hover-scale:hover {
        transform: scale(1.1);
        background: rgba(255,255,255,0.3) !important;
    }
    
    .hover-text-white {
        transition: color 0.3s ease;
    }
    
    .hover-text-white:hover {
        color: white !important;
        text-decoration: underline !important;
    }
    
    /* Background Utilities */
    .bg-opacity-20 {
        --bs-bg-opacity: 0.2;
    }
    
    .text-white-50 {
        color: rgba(255,255,255,0.7) !important;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .footer .row > div {
            margin-bottom: 0.5rem;
        }
        
        .footer .d-flex {
            flex-wrap: wrap;
        }
        
        .rounded-circle {
            width: 28px !important;
            height: 28px !important;
        }
        
        .footer .small {
            font-size: 0.75rem !important;
        }
    }
    
    @media (max-width: 576px) {
        .footer .container-fluid {
            padding-left: 0.75rem !important;
            padding-right: 0.75rem !important;
        }
        
        .footer .py-3 {
            padding-top: 0.75rem !important;
            padding-bottom: 0.75rem !important;
        }
        
        .hover-bg-light {
            padding: 0.25rem 0.75rem !important;
        }
    }
    
    /* Animation for subtle background elements */
    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }
    
    .footer .position-absolute.rounded-circle {
        animation: float 6s ease-in-out infinite;
    }
    
    .footer .position-absolute.rounded-circle:nth-child(2) {
        animation-delay: -2s;
        animation-duration: 8s;
    }
    
    /* Tooltip customization */
    [data-bs-toggle="tooltip"] {
        cursor: pointer;
    }
    
    /* Compact mode adjustments */
    .compact-resources {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    /* Ensure footer stays at bottom */
    .footer.mt-auto {
        margin-top: auto !important;
    }
    
    /* Smooth transitions */
    .footer * {
        transition: all 0.2s ease;
    }
</style>

<!-- Initialize tooltips -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                placement: 'top',
                trigger: 'hover'
            });
        });
    });
</script>\n\n========== FILE: ./accounts/tests.py ==========\n
from django.test import TestCase

# Create your tests here.
\n\n========== FILE: ./accounts/urls.py ==========\n
from django.urls import path
from . import views

urlpatterns = [
    path('', views.login_view, name='login'),
    path('login/', views.login_view, name='login'),
    path('logout/', views.logout_view, name='logout'),
    path('dashboard/', views.dashboard, name='dashboard'),
]\n\n========== FILE: ./accounts/views.py ==========\n
from django.shortcuts import render, redirect
from django.contrib.auth import login, authenticate, logout
from django.contrib.auth.decorators import login_required
from django.contrib import messages 
from .forms import LoginForm
from school_messages.models import Notification
from marks.models import Mark
from students.models import Student
from teachers.models import Teacher

def login_view(request):
    """Handle user login"""
    if request.user.is_authenticated:
        # Redirect based on user role for better UX
        if request.user.is_admin():
            messages.info(request, 'Welcome back, Administrator!')
        elif request.user.is_teacher():
            messages.info(request, 'Welcome back, Teacher!')
        elif request.user.is_student():
            messages.info(request, 'Welcome back, Student!')
        return redirect('dashboard')
    
    if request.method == 'POST':
        form = LoginForm(request, data=request.POST)
        if form.is_valid():
            username = form.cleaned_data.get('username')
            password = form.cleaned_data.get('password')
            user = authenticate(username=username, password=password)
            
            if user is not None:
                if user.is_active:
                    login(request, user)
                    
                    # Custom welcome messages based on role
                    if user.is_admin():
                        messages.success(request, f'Welcome Administrator {user.username}!')
                    elif user.is_teacher():
                        messages.success(request, f'Welcome Teacher {user.username}!')
                    elif user.is_student():
                        messages.success(request, f'Welcome Student {user.username}!')
                    else:
                        messages.success(request, f'Welcome back, {user.username}!')
                    
                    return redirect('dashboard')
                else:
                    messages.error(request, 'Your account is inactive. Please contact administration.')
            else:
                messages.error(request, 'Invalid username or password.')
        else:
            messages.error(request, 'Please correct the errors below.')
    else:
        form = LoginForm()
    
    return render(request, 'accounts/login.html', {'form': form})

@login_required
def logout_view(request):
    """Handle user logout"""
    username = request.user.username
    logout(request)
    messages.info(request, f'Goodbye {username}! You have been logged out successfully.')
    return redirect('login')

@login_required
def dashboard(request):
    """Main dashboard view - shows different content based on user role"""
    user = request.user
    
    # Get unread notifications count
    unread_count = Notification.objects.filter(user=user, is_read=False).count()
    
    # Initialize context variables
    context = {
        'user': user,
        'unread_count': unread_count,
        'has_student_profile': False,
        'has_teacher_profile': False,
        'dashboard_title': 'Dashboard',
    }
    
    # STUDENT DASHBOARD DATA
    if user.is_student():
        context['dashboard_title'] = 'Student Dashboard'
        
        if user.has_student_profile():
            try:
                student_profile = user.get_student_profile()
                context['has_student_profile'] = True
                context['student_profile'] = student_profile
                context['student_id'] = student_profile.id
                
                # Student's class information
                context['grade_section'] = f"{student_profile.grade}{student_profile.section}"
                context['admission_number'] = student_profile.admission_number
                
                # Get student's subjects
                if student_profile.subjects:
                    subjects_list = [s.strip() for s in student_profile.subjects.split(',')]
                    context['subjects_list'] = subjects_list
                    context['subjects_count'] = len(subjects_list)
                
                # Get academic performance data
                marks = Mark.objects.filter(student=student_profile)
                
                if marks.exists():
                    # Calculate overall average
                    total_score = sum(mark.total_score for mark in marks)
                    average_score = total_score / marks.count()
                    context['overall_average'] = round(average_score, 2)
                    
                    # Get latest term marks
                    latest_marks = marks.order_by('-academic_year', '-term')
                    if latest_marks.exists():
                        latest_term = latest_marks.first()
                        context['latest_term'] = f"{latest_term.term} {latest_term.academic_year}"
                        
                        # Calculate latest term average
                        term_marks = marks.filter(
                            term=latest_term.term, 
                            academic_year=latest_term.academic_year
                        )
                        if term_marks.exists():
                            term_total = sum(mark.total_score for mark in term_marks)
                            term_average = term_total / term_marks.count()
                            context['latest_term_average'] = round(term_average, 2)
                    
                    # Count subjects with marks
                    subjects_with_marks = marks.values('subject').distinct().count()
                    context['subjects_with_marks'] = subjects_with_marks
                    
                    # Get grade distribution
                    grade_counts = {
                        'A': marks.filter(grade='A').count(),
                        'B': marks.filter(grade='B').count(),
                        'C': marks.filter(grade='C').count(),
                        'D': marks.filter(grade='D').count(),
                        'E': marks.filter(grade='E').count(),
                        'F': marks.filter(grade='F').count(),
                    }
                    context['grade_counts'] = grade_counts
                    
                    # Calculate pass rate (A-E are passing grades)
                    total_marks = marks.count()
                    passing_marks = marks.filter(grade__in=['A', 'B', 'C', 'D', 'E']).count()
                    if total_marks > 0:
                        context['pass_rate'] = round((passing_marks / total_marks) * 100, 1)
                    
                else:
                    context['no_marks_message'] = 'No academic records available yet.'
                    context['overall_average'] = 'N/A'
                
            except Exception as e:
                context['error_message'] = 'Error loading student data. Please try again later.'
                print(f"Error in student dashboard: {e}")
        else:
            context['warning_message'] = 'Student profile not found. Please contact administration.'
            messages.warning(request, 'Student profile not found. Please contact administration.')
    
    # TEACHER DASHBOARD DATA
    elif user.is_teacher():
        context['dashboard_title'] = 'Teacher Dashboard'
        
        if user.has_teacher_profile():
            try:
                teacher_profile = user.get_teacher_profile()
                context['has_teacher_profile'] = True
                context['teacher_profile'] = teacher_profile
                
                # Teacher's professional information
                context['department'] = teacher_profile.department
                context['employee_id'] = teacher_profile.employee_id
                context['qualification'] = teacher_profile.qualification
                context['experience'] = teacher_profile.experience
                
                # Get assigned subjects
                assigned_subjects = teacher_profile.assigned_subjects.all()
                context['assigned_subjects'] = assigned_subjects
                context['assigned_subjects_count'] = assigned_subjects.count()
                
                # Get classes taught
                if teacher_profile.classes:
                    classes_list = [c.strip() for c in teacher_profile.classes.split(',')]
                    context['classes_taught'] = classes_list
                    context['classes_count'] = len(classes_list)
                
                # Get subjects taught
                if teacher_profile.subjects:
                    subjects_list = [s.strip() for s in teacher_profile.subjects.split(',')]
                    context['subjects_taught'] = subjects_list
                    context['subjects_taught_count'] = len(subjects_list)
                
                # Get teacher's marks given (for statistics)
                marks_given = teacher_profile.marks_given.all()
                context['marks_given_count'] = marks_given.count()
                
                # Get recent marks given
                recent_marks = marks_given.order_by('-date_entered')[:10]
                context['recent_marks'] = recent_marks
                
            except Exception as e:
                context['error_message'] = 'Error loading teacher data. Please try again later.'
                print(f"Error in teacher dashboard: {e}")
        else:
            context['warning_message'] = 'Teacher profile not found. Please contact administration.'
            messages.warning(request, 'Teacher profile not found. Please contact administration.')
    
    # ADMIN DASHBOARD DATA
    elif user.is_admin():
        context['dashboard_title'] = 'Admin Dashboard'
        
        try:
            # System statistics
            total_students = Student.objects.count()
            total_teachers = Teacher.objects.count()
            total_users = user.__class__.objects.count()
            active_users = user.__class__.objects.filter(is_active=True).count()
            
            context['total_students'] = total_students
            context['total_teachers'] = total_teachers
            context['total_users'] = total_users
            context['active_users'] = active_users
            
            # Get recent student registrations
            recent_students = Student.objects.select_related('user').order_by('-created_at')[:5]
            context['recent_students'] = recent_students
            
            # Get recent teacher registrations
            recent_teachers = Teacher.objects.select_related('user').order_by('-created_at')[:5]
            context['recent_teachers'] = recent_teachers
            
            # Get users by role
            student_users = user.__class__.objects.filter(role='student').count()
            teacher_users = user.__class__.objects.filter(role='teacher').count()
            admin_users = user.__class__.objects.filter(role='admin').count()
            
            context['student_users'] = student_users
            context['teacher_users'] = teacher_users
            context['admin_users'] = admin_users
            
            # Get system alerts (placeholder for future features)
            context['system_alerts'] = []
            
        except Exception as e:
            context['error_message'] = 'Error loading system statistics.'
            print(f"Error in admin dashboard: {e}")
    
    # FALLBACK FOR OTHER ROLES
    else:
        context['dashboard_title'] = 'User Dashboard'
        context['info_message'] = 'Welcome to your dashboard.'
    
    # Determine template based on user role
    if user.is_admin():
        template = 'accounts/admin_dashboard.html'
    elif user.is_teacher():
        template = 'accounts/teacher_dashboard.html'
    elif user.is_student():
        template = 'accounts/student_dashboard.html'
    else:
        template = 'accounts/dashboard.html'
    
    return render(request, template, context)\n\n========== FILE: ./accounts/__init__.py ==========\n
\n\n========== FILE: ./manage.py ==========\n
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'school_a.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()\n\n========== FILE: ./marks/admin.py ==========\n
# marks/admin.py
from django.contrib import admin
from unfold.admin import ModelAdmin
from .models import Subject, Mark, StudentReport, PerformanceTrend

@admin.register(Subject)
class SubjectAdmin(ModelAdmin):
    list_display = ('name', 'code', 'get_category_display', 'description_short')
    list_filter = ('category',)
    search_fields = ('name', 'code', 'description')
    ordering = ('name',)
    
    def description_short(self, obj):
        return obj.description[:50] + '...' if len(obj.description) > 50 else obj.description
    description_short.short_description = 'Description'

@admin.register(Mark)
class MarkAdmin(ModelAdmin):
    list_display = ('student_info', 'subject_name', 'term_year', 'total_score', 'grade_display', 'teacher_name')
    list_filter = ('grade', 'term', 'academic_year', 'subject')
    search_fields = (
        'student__user__username', 
        'student__user__first_name', 
        'student__user__last_name',
        'subject__name',
        'teacher__user__username'
    )
    readonly_fields = ('total_score', 'grade', 'date_entered', 'last_modified')
    fieldsets = (
        ('Student Information', {
            'fields': ('student', 'teacher', 'subject')
        }),
        ('Assessment Scores', {
            'fields': ('cat1_score', 'cat2_score', 'main_exam_score')
        }),
        ('Term Information', {
            'fields': ('term', 'academic_year')
        }),
        ('Calculated Fields', {
            'fields': ('total_score', 'grade'),
            'classes': ('collapse',)
        }),
        ('Additional Information', {
            'fields': ('comments',)
        }),
        ('Timestamps', {
            'fields': ('date_entered', 'last_modified'),
            'classes': ('collapse',)
        }),
    )
    
    def student_info(self, obj):
        return f"{obj.student.user.get_full_name()} ({obj.student.admission_number})"
    student_info.short_description = 'Student'
    
    def subject_name(self, obj):
        return obj.subject.name
    subject_name.short_description = 'Subject'
    
    def term_year(self, obj):
        return f"{obj.term} {obj.academic_year}"
    term_year.short_description = 'Term/Year'
    
    def grade_display(self, obj):
        return obj.get_grade_display()
    grade_display.short_description = 'Grade'
    
    def teacher_name(self, obj):
        return obj.teacher.user.get_full_name() if obj.teacher else 'N/A'
    teacher_name.short_description = 'Teacher'

@admin.register(StudentReport)
class StudentReportAdmin(ModelAdmin):
    list_display = ('student_info', 'term_year', 'average_score', 'overall_grade_display', 'class_position_info', 'date_created_display')
    list_filter = ('term', 'academic_year', 'overall_grade')
    search_fields = (
        'student__user__username',
        'student__user__first_name',
        'student__user__last_name',
        'teacher_comment',
        'principal_comment'
    )
    readonly_fields = ('date_created', 'date_modified')
    fieldsets = (
        ('Student Information', {
            'fields': ('student',)
        }),
        ('Term Information', {
            'fields': ('term', 'academic_year')
        }),
        ('Performance Metrics', {
            'fields': (
                'average_score', 'overall_grade', 
                'class_position', 'total_students',
                'days_present', 'total_days'
            )
        }),
        ('Comments', {
            'fields': ('teacher_comment', 'principal_comment'),
            'classes': ('wide',)
        }),
        ('Timestamps', {
            'fields': ('date_created', 'date_modified'),
            'classes': ('collapse',)
        }),
    )
    
    def student_info(self, obj):
        return f"{obj.student.user.get_full_name()} ({obj.student.admission_number})"
    student_info.short_description = 'Student'
    
    def term_year(self, obj):
        return f"{obj.term} {obj.academic_year}"
    term_year.short_description = 'Term/Year'
    
    def overall_grade_display(self, obj):
        return obj.get_overall_grade_display()
    overall_grade_display.short_description = 'Overall Grade'
    
    def class_position_info(self, obj):
        return f"{obj.class_position}/{obj.total_students}"
    class_position_info.short_description = 'Position'
    
    def date_created_display(self, obj):
        return obj.date_created.strftime('%Y-%m-%d')
    date_created_display.short_description = 'Created'

@admin.register(PerformanceTrend)
class PerformanceTrendAdmin(ModelAdmin):
    list_display = ('student_name_display', 'term_year', 'current_average', 'trend_display', 'performance_level_display', 'date_generated_display')
    list_filter = ('trend', 'trend_direction', 'academic_year', 'term')
    search_fields = (
        'student__user__username',
        'student__user__first_name',
        'student__user__last_name',
        'analysis_summary',
        'recommendations'
    )
    readonly_fields = (
        'date_generated', 'last_updated', 
        'score_change', 'percentage_change', 'pass_rate',
        'current_term_average', 'previous_term_average', 'overall_average'
    )
    fieldsets = (
        ('Student Information', {
            'fields': ('student', 'term', 'academic_year')
        }),
        ('Performance Metrics', {
            'fields': (
                'current_term_average', 'previous_term_average', 'overall_average',
                'score_change', 'percentage_change'
            )
        }),
        ('Trend Analysis', {
            'fields': ('trend', 'trend_direction')
        }),
        ('Subject Analysis', {
            'fields': (
                'strongest_subject', 'strongest_subject_score',
                'weakest_subject', 'weakest_subject_score',
                'most_improved_subject', 'improvement_amount'
            ),
            'classes': ('collapse',)
        }),
        ('Grade Distribution', {
            'fields': (
                'grade_a_count', 'grade_b_count', 'grade_c_count',
                'grade_d_count', 'grade_e_count', 'grade_f_count',
                'subjects_passed', 'total_subjects', 'pass_rate'
            ),
            'classes': ('collapse',)
        }),
        ('Analysis & Recommendations', {
            'fields': (
                'strengths', 'weaknesses', 'analysis_summary',
                'recommendations', 'action_items'
            ),
            'classes': ('wide',)
        }),
        ('Metadata', {
            'fields': ('is_active', 'generated_by', 'date_generated', 'last_updated'),
            'classes': ('collapse',)
        }),
    )
    
    def student_name_display(self, obj):
        return obj.student_name if hasattr(obj, 'student_name') else obj.student.user.get_full_name()
    student_name_display.short_description = 'Student'
    
    def term_year(self, obj):
        return f"{obj.term} {obj.academic_year}"
    term_year.short_description = 'Term/Year'
    
    def current_average(self, obj):
        return f"{obj.current_term_average:.1f}"
    current_average.short_description = 'Avg Score'
    
    def trend_display(self, obj):
        icon, label = obj.trend_indicator
        return f"{icon} {label}"
    trend_display.short_description = 'Trend'
    
    def performance_level_display(self, obj):
        return obj.performance_level if hasattr(obj, 'performance_level') else 'N/A'
    performance_level_display.short_description = 'Level'
    
    def date_generated_display(self, obj):
        return obj.date_generated.strftime('%Y-%m-%d')
    date_generated_display.short_description = 'Generated'
    
    # Custom actions
    actions = ['regenerate_analysis', 'mark_as_inactive']
    
    @admin.action(description='Regenerate trend analysis')
    def regenerate_analysis(self, request, queryset):
        from .analytics import StudentPerformanceAnalyzer
        
        updated_count = 0
        for trend in queryset:
            analyzer = StudentPerformanceAnalyzer()
            analysis = analyzer.generate_trend_analysis(trend.student.id)
            if analysis:
                updated_count += 1
        
        self.message_user(request, f'Regenerated analysis for {updated_count} trend records.')
    
    @admin.action(description='Mark selected as inactive')
    def mark_as_inactive(self, request, queryset):
        updated = queryset.update(is_active=False)
        self.message_user(request, f'Marked {updated} trend records as inactive.')\n\n========== FILE: ./marks/analytics.py ==========\n
# marks/analytics.py
from django.db.models import Avg, Count, Sum, Q, F
from django.utils import timezone
from datetime import datetime
from .models import Mark, Student, Subject, PerformanceTrend

class StudentPerformanceAnalyzer:
    def __init__(self, student_id=None):
        self.student_id = student_id
    
    def get_student_term_performance(self, student, term, year):
        """Get student performance for specific term"""
        marks = Mark.objects.filter(
            student=student,
            term=term,
            academic_year=year
        ).select_related('subject')
        
        if not marks.exists():
            return None
        
        # Calculate statistics
        average_score = marks.aggregate(avg=Avg('total_score'))['avg']
        grade_distribution = marks.values('grade').annotate(count=Count('id')).order_by('grade')
        
        # Subject-wise performance
        subject_scores = {}
        for mark in marks:
            subject_scores[mark.subject.name] = {
                'score': float(mark.total_score),
                'grade': mark.grade,
                'grade_label': mark.get_performance_label()
            }
        
        return {
            'term': term,
            'year': year,
            'average_score': float(average_score),
            'total_subjects': marks.count(),
            'grade_distribution': list(grade_distribution),
            'subject_scores': subject_scores
        }
    
    def compare_term_performance(self, student, current_term_data, previous_term_data):
        """Compare performance between two terms"""
        if not current_term_data or not previous_term_data:
            return None
        
        current_avg = current_term_data['average_score']
        previous_avg = previous_term_data['average_score']
        
        # Calculate percentage change
        if previous_avg > 0:
            percentage_change = ((current_avg - previous_avg) / previous_avg) * 100
        else:
            percentage_change = 0
        
        # Determine trend
        if percentage_change > 5:
            trend = 'improving'
            trend_direction = 'positive'
        elif percentage_change < -5:
            trend = 'declining'
            trend_direction = 'negative'
        else:
            trend = 'stable'
            trend_direction = 'neutral'
        
        # Compare subject performance
        subject_comparison = {}
        for subject_name, current_data in current_term_data['subject_scores'].items():
            prev_data = previous_term_data['subject_scores'].get(subject_name)
            if prev_data:
                subject_change = current_data['score'] - prev_data['score']
                subject_comparison[subject_name] = {
                    'current_score': current_data['score'],
                    'previous_score': prev_data['score'],
                    'change': subject_change,
                    'percentage_change': (subject_change / prev_data['score'] * 100) if prev_data['score'] > 0 else 0,
                    'current_grade': current_data['grade'],
                    'previous_grade': prev_data['grade']
                }
        
        # Find strongest/weakest subjects
        if subject_comparison:
            strongest_subject = max(subject_comparison.items(), key=lambda x: x[1]['current_score'])[0]
            weakest_subject = min(subject_comparison.items(), key=lambda x: x[1]['current_score'])[0]
            most_improved = max(subject_comparison.items(), key=lambda x: x[1]['change'])[0]
        else:
            strongest_subject = weakest_subject = most_improved = None
        
        return {
            'current_term': current_term_data,
            'previous_term': previous_term_data,
            'average_change': current_avg - previous_avg,
            'percentage_change': percentage_change,
            'trend': trend,
            'trend_direction': trend_direction,
            'subject_comparison': subject_comparison,
            'strongest_subject': strongest_subject,
            'weakest_subject': weakest_subject,
            'most_improved_subject': most_improved
        }
    
    def generate_trend_analysis(self, student_id, terms=None):
        """Generate comprehensive trend analysis for a student"""
        try:
            student = Student.objects.get(id=student_id)
        except Student.DoesNotExist:
            return None
        
        # Get all marks for the student
        all_marks = Mark.objects.filter(student=student).order_by('academic_year', 'term')
        
        if not all_marks.exists():
            return None
        
        # Group by term and year
        term_performances = {}
        for mark in all_marks:
            key = f"{mark.term} {mark.academic_year}"
            if key not in term_performances:
                term_performances[key] = []
            term_performances[key].append(mark)
        
        # Calculate performance for each term
        performances = []
        term_keys = sorted(term_performances.keys())
        
        for i, term_key in enumerate(term_keys):
            marks = term_performances[term_key]
            avg_score = sum(m.total_score for m in marks) / len(marks)
            
            performance = {
                'term_key': term_key,
                'term': marks[0].term,
                'year': marks[0].academic_year,
                'average_score': float(avg_score),
                'subject_count': len(marks),
                'subjects': {m.subject.name: float(m.total_score) for m in marks},
                'grades': {m.subject.name: m.grade for m in marks}
            }
            
            performances.append(performance)
        
        # Generate comparisons
        comparisons = []
        for i in range(1, len(performances)):
            current = performances[i]
            previous = performances[i-1]
            
            comparison = self.compare_term_performance(student, current, previous)
            if comparison:
                comparisons.append({
                    'comparison': comparison,
                    'current_term': current['term_key'],
                    'previous_term': previous['term_key']
                })
        
        # Overall analysis
        if len(performances) >= 2:
            first_term = performances[0]['average_score']
            last_term = performances[-1]['average_score']
            overall_change = last_term - first_term
            overall_percentage = (overall_change / first_term * 100) if first_term > 0 else 0
            
            if overall_percentage > 10:
                overall_trend = 'Significantly Improving'
            elif overall_percentage > 0:
                overall_trend = 'Gradually Improving'
            elif overall_percentage < -10:
                overall_trend = 'Significantly Declining'
            elif overall_percentage < 0:
                overall_trend = 'Gradually Declining'
            else:
                overall_trend = 'Stable'
        else:
            overall_change = 0
            overall_percentage = 0
            overall_trend = 'Insufficient Data'
        
        return {
            'student': student,
            'performances': performances,
            'comparisons': comparisons,
            'overall_change': overall_change,
            'overall_percentage': overall_percentage,
            'overall_trend': overall_trend,
            'has_multiple_terms': len(performances) > 1
        }\n\n========== FILE: ./marks/apps.py ==========\n
from django.apps import AppConfig


class MarksConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'marks'
\n\n========== FILE: ./marks/forms.py ==========\n
from django import forms
from .models import Mark, Subject, StudentReport
from students.models import Student
from teachers.models import Teacher

class SubjectForm(forms.ModelForm):
    class Meta:
        model = Subject
        fields = ['name', 'code', 'category', 'description']
        widgets = {
            'name': forms.TextInput(attrs={'class': 'form-control'}),
            'code': forms.TextInput(attrs={'class': 'form-control'}),
            'category': forms.Select(attrs={'class': 'form-control'}),
            'description': forms.Textarea(attrs={'class': 'form-control', 'rows': 3}),
        }

class MarkForm(forms.ModelForm):
    class Meta:
        model = Mark
        fields = [
            'student', 'subject', 'cat1_score', 'cat2_score', 
            'main_exam_score', 'term', 'academic_year', 'comments'
        ]
        widgets = {
            'student': forms.Select(attrs={'class': 'form-control'}),
            'subject': forms.Select(attrs={'class': 'form-control'}),
            'cat1_score': forms.NumberInput(attrs={'class': 'form-control', 'step': '0.01'}),
            'cat2_score': forms.NumberInput(attrs={'class': 'form-control', 'step': '0.01'}),
            'main_exam_score': forms.NumberInput(attrs={'class': 'form-control', 'step': '0.01'}),
            'term': forms.Select(choices=[
                ('Term 1', 'Term 1'),
                ('Term 2', 'Term 2'),
                ('Term 3', 'Term 3'),
                ('Term 4', 'Term 4'),
            ], attrs={'class': 'form-control'}),
            'academic_year': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'e.g., 2024'}),
            'comments': forms.Textarea(attrs={'class': 'form-control', 'rows': 3}),
        }
    
    def __init__(self, *args, **kwargs):
        teacher = kwargs.pop('teacher', None)
        super().__init__(*args, **kwargs)
        
        if teacher:
            # Filter students based on teacher's classes
            self.fields['student'].queryset = Student.objects.filter(
                grade__in=teacher.get_classes_list()
            )

class MarkUpdateForm(forms.ModelForm):
    class Meta:
        model = Mark
        fields = ['cat1_score', 'cat2_score', 'main_exam_score', 'comments']
        widgets = {
            'cat1_score': forms.NumberInput(attrs={'class': 'form-control', 'step': '0.01'}),
            'cat2_score': forms.NumberInput(attrs={'class': 'form-control', 'step': '0.01'}),
            'main_exam_score': forms.NumberInput(attrs={'class': 'form-control', 'step': '0.01'}),
            'comments': forms.Textarea(attrs={'class': 'form-control', 'rows': 3}),
        }

class StudentReportForm(forms.ModelForm):
    class Meta:
        model = StudentReport
        fields = [
            'student', 'term', 'academic_year', 'average_score',
            'overall_grade', 'class_position', 'total_students',
            'teacher_comment', 'principal_comment',
            'days_present', 'total_days'
        ]
        widgets = {
            'student': forms.Select(attrs={'class': 'form-control'}),
            'term': forms.Select(choices=[
                ('Term 1', 'Term 1'),
                ('Term 2', 'Term 2'),
                ('Term 3', 'Term 3'),
                ('Term 4', 'Term 4'),
            ], attrs={'class': 'form-control'}),
            'academic_year': forms.TextInput(attrs={'class': 'form-control'}),
            'average_score': forms.NumberInput(attrs={'class': 'form-control', 'step': '0.01'}),
            'overall_grade': forms.Select(choices=Mark.GRADE_CHOICES, attrs={'class': 'form-control'}),
            'class_position': forms.NumberInput(attrs={'class': 'form-control'}),
            'total_students': forms.NumberInput(attrs={'class': 'form-control'}),
            'teacher_comment': forms.Textarea(attrs={'class': 'form-control', 'rows': 3}),
            'principal_comment': forms.Textarea(attrs={'class': 'form-control', 'rows': 3}),
            'days_present': forms.NumberInput(attrs={'class': 'form-control'}),
            'total_days': forms.NumberInput(attrs={'class': 'form-control'}),
        }\n\n========== FILE: ./marks/management/commands/load_subjects.py ==========\n
from django.core.management.base import BaseCommand
from marks.models import Subject

class Command(BaseCommand):
    help = 'Loads initial subject data'
    
    def handle(self, *args, **kwargs):
        subjects = [
            # Humanities
            {'name': 'History', 'code': 'HIST101', 'category': 'humanities'},
            {'name': 'Geography', 'code': 'GEOG101', 'category': 'humanities'},
            {'name': 'Religious Education', 'code': 'RE101', 'category': 'humanities'},
            {'name': 'Life Skills', 'code': 'LIFE101', 'category': 'humanities'},
            {'name': 'Business Studies', 'code': 'BUS101', 'category': 'humanities'},
            
            # Creative Arts
            {'name': 'Music', 'code': 'MUS101', 'category': 'creative_arts'},
            {'name': 'Art and Design', 'code': 'ART101', 'category': 'creative_arts'},
            {'name': 'Creative Arts', 'code': 'CREA101', 'category': 'creative_arts'},
            
            # Technical Subjects
            {'name': 'Computer Studies', 'code': 'COMP101', 'category': 'technical'},
            {'name': 'Technical Drawing', 'code': 'TECH101', 'category': 'technical'},
            {'name': 'Agriculture', 'code': 'AGRI101', 'category': 'technical'},
            
            # Sciences
            {'name': 'Mathematics', 'code': 'MATH101', 'category': 'sciences'},
            {'name': 'Physics', 'code': 'PHYS101', 'category': 'sciences'},
            {'name': 'Chemistry', 'code': 'CHEM101', 'category': 'sciences'},
            {'name': 'Biology', 'code': 'BIO101', 'category': 'sciences'},
            
            # Languages
            {'name': 'English', 'code': 'ENG101', 'category': 'languages'},
            {'name': 'Kiswahili', 'code': 'KIS101', 'category': 'languages'},
            {'name': 'French', 'code': 'FREN101', 'category': 'languages'},
        ]
        
        for subject_data in subjects:
            subject, created = Subject.objects.get_or_create(
                code=subject_data['code'],
                defaults=subject_data
            )
            if created:
                self.stdout.write(self.style.SUCCESS(f'Created subject: {subject.name}'))
            else:
                self.stdout.write(self.style.WARNING(f'Subject already exists: {subject.name}'))
        
        self.stdout.write(self.style.SUCCESS('Successfully loaded all subjects'))\n\n========== FILE: ./marks/management/commands/__init__.py ==========\n
\n\n========== FILE: ./marks/management/__init__.py ==========\n
\n\n========== FILE: ./marks/models.py ==========\n
from django.db import models
from students.models import Student
# Remove: from teachers.models import Teacher
from django.core.validators import MinValueValidator, MaxValueValidator
from django.db.models import Avg, Sum, Count

class Subject(models.Model):
    SUBJECT_CATEGORIES = (
        ('humanities', 'Humanities'),
        ('creative_arts', 'Creative Arts'),
        ('technical', 'Technical Subjects'),
        ('sciences', 'Sciences'),
        ('languages', 'Languages'),
    )
    
    name = models.CharField(max_length=100)
    code = models.CharField(max_length=20, unique=True)
    category = models.CharField(max_length=20, choices=SUBJECT_CATEGORIES)
    description = models.TextField(blank=True)
    
    def __str__(self):
        return f"{self.name} ({self.code})"
    
    class Meta:
        ordering = ['category', 'name']

class Mark(models.Model):
    GRADE_CHOICES = (
        ('A', 'A (Excellent)'),
        ('B', 'B (Very Good)'),
        ('C', 'C (Good)'),
        ('D', 'D (Satisfactory)'),
        ('E', 'E (Sufficient)'),
        ('F', 'F (Fail)'),
    )
    
    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='marks')
    subject = models.ForeignKey(Subject, on_delete=models.CASCADE)
    # Use string reference instead of direct import
    teacher = models.ForeignKey('teachers.Teacher', on_delete=models.SET_NULL, null=True, related_name='marks_given')
    
    # Marks components
    cat1_score = models.DecimalField(max_digits=5, decimal_places=2, validators=[MinValueValidator(0), MaxValueValidator(100)], null=True, blank=True)
    cat2_score = models.DecimalField(max_digits=5, decimal_places=2, validators=[MinValueValidator(0), MaxValueValidator(100)], null=True, blank=True)
    main_exam_score = models.DecimalField(max_digits=5, decimal_places=2, validators=[MinValueValidator(0), MaxValueValidator(100)])
    
    # Calculated fields
    total_score = models.DecimalField(max_digits=5, decimal_places=2, validators=[MinValueValidator(0), MaxValueValidator(100)])
    grade = models.CharField(max_length=1, choices=GRADE_CHOICES)
    
    term = models.CharField(max_length=20)  # e.g., "Term 1 2024"
    academic_year = models.CharField(max_length=20)
    
    comments = models.TextField(blank=True)
    date_entered = models.DateField(auto_now_add=True)
    last_modified = models.DateField(auto_now=True)
    
    class Meta:
        ordering = ['-academic_year', 'term', 'student']
        unique_together = ['student', 'subject', 'term', 'academic_year']
    
    def save(self, *args, **kwargs):
        # Calculate total score (CAT1: 20%, CAT2: 20%, Main Exam: 60%)
        cat1 = self.cat1_score or 0
        cat2 = self.cat2_score or 0
        main_exam = self.main_exam_score or 0
        
        self.total_score = (cat1 * 0.2) + (cat2 * 0.2) + (main_exam * 0.6)
        
        # Determine grade
        if self.total_score >= 80:
            self.grade = 'A'
        elif self.total_score >= 70:
            self.grade = 'B'
        elif self.total_score >= 60:
            self.grade = 'C'
        elif self.total_score >= 50:
            self.grade = 'D'
        elif self.total_score >= 40:
            self.grade = 'E'
        else:
            self.grade = 'F'
        
        super().save(*args, **kwargs)
    
    def __str__(self):
        return f"{self.student} - {self.subject} - {self.total_score}% ({self.grade})"

class StudentReport(models.Model):
    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='reports')
    term = models.CharField(max_length=20)
    academic_year = models.CharField(max_length=20)
    
    # Overall performance
    average_score = models.DecimalField(max_digits=5, decimal_places=2, validators=[MinValueValidator(0), MaxValueValidator(100)])
    overall_grade = models.CharField(max_length=1, choices=Mark.GRADE_CHOICES)
    class_position = models.PositiveIntegerField()
    total_students = models.PositiveIntegerField()
    
    # Comments
    teacher_comment = models.TextField(blank=True)
    principal_comment = models.TextField(blank=True)
    
    # Attendance
    days_present = models.PositiveIntegerField(default=0)
    total_days = models.PositiveIntegerField(default=0)
    
    date_created = models.DateTimeField(auto_now_add=True)
    date_modified = models.DateTimeField(auto_now=True)
    
    def __str__(self):
        return f"{self.student} - {self.term} {self.academic_year}"
    
    class Meta:
        ordering = ['-academic_year', 'term', 'student']


    # Add this at the end of marks/models.py, before the closing of the file

class PerformanceTrend(models.Model):
    TREND_CHOICES = (
        ('improving', 'Improving'),
        ('declining', 'Declining'),
        ('stable', 'Stable'),
        ('fluctuating', 'Fluctuating'),
        ('significant_improvement', 'Significant Improvement'),
        ('significant_decline', 'Significant Decline'),
        ('gradual_improvement', 'Gradual Improvement'),
        ('gradual_decline', 'Gradual Decline'),
    )
    
    TREND_DIRECTION_CHOICES = (
        ('positive', 'Positive'),
        ('negative', 'Negative'),
        ('neutral', 'Neutral'),
    )
    
    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='performance_trends')
    term = models.CharField(max_length=20)
    academic_year = models.CharField(max_length=20)
    
    # Performance metrics
    current_term_average = models.DecimalField(max_digits=5, decimal_places=2)
    previous_term_average = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)
    overall_average = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)
    
    # Trend analysis
    trend = models.CharField(max_length=30, choices=TREND_CHOICES, default='stable')
    trend_direction = models.CharField(max_length=10, choices=TREND_DIRECTION_CHOICES, default='neutral')
    
    # Change metrics
    score_change = models.DecimalField(max_digits=6, decimal_places=2, null=True, blank=True, 
                                       help_text="Absolute change in average score")
    percentage_change = models.DecimalField(max_digits=6, decimal_places=2, null=True, blank=True,
                                           help_text="Percentage change from previous term")
    
    # Subject analysis
    strongest_subject = models.ForeignKey(Subject, on_delete=models.SET_NULL, null=True, blank=True, 
                                         related_name='as_strongest_subject')
    strongest_subject_score = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)
    
    weakest_subject = models.ForeignKey(Subject, on_delete=models.SET_NULL, null=True, blank=True,
                                       related_name='as_weakest_subject')
    weakest_subject_score = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)
    
    most_improved_subject = models.ForeignKey(Subject, on_delete=models.SET_NULL, null=True, blank=True,
                                             related_name='as_most_improved')
    improvement_amount = models.DecimalField(max_digits=6, decimal_places=2, null=True, blank=True)
    
    # Performance indicators
    subjects_passed = models.PositiveIntegerField(default=0)
    total_subjects = models.PositiveIntegerField(default=0)
    pass_rate = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)
    
    # Grade distribution
    grade_a_count = models.PositiveIntegerField(default=0)
    grade_b_count = models.PositiveIntegerField(default=0)
    grade_c_count = models.PositiveIntegerField(default=0)
    grade_d_count = models.PositiveIntegerField(default=0)
    grade_e_count = models.PositiveIntegerField(default=0)
    grade_f_count = models.PositiveIntegerField(default=0)
    
    # Analysis and recommendations
    strengths = models.TextField(blank=True, help_text="Key strengths observed")
    weaknesses = models.TextField(blank=True, help_text="Areas needing improvement")
    analysis_summary = models.TextField(blank=True, help_text="Overall performance analysis")
    
    recommendations = models.TextField(blank=True, help_text="Recommendations for improvement")
    action_items = models.TextField(blank=True, help_text="Specific action items")
    
    # Metadata
    is_active = models.BooleanField(default=True)
    generated_by = models.ForeignKey('accounts.User', on_delete=models.SET_NULL, null=True, blank=True)
    date_generated = models.DateTimeField(auto_now_add=True)
    last_updated = models.DateTimeField(auto_now=True)
    
    class Meta:
        ordering = ['-academic_year', 'term', 'student']
        unique_together = ['student', 'term', 'academic_year']
        verbose_name = "Performance Trend"
        verbose_name_plural = "Performance Trends"
        indexes = [
            models.Index(fields=['student', 'trend']),
            models.Index(fields=['student', 'academic_year']),
            models.Index(fields=['trend_direction', 'date_generated']),
        ]
    
    def __str__(self):
        return f"{self.student.full_name} - {self.term} {self.academic_year} ({self.get_trend_display()})"
    
    @property
    def student_name(self):
        return self.student.full_name
    
    @property
    def performance_level(self):
        """Determine performance level based on average score"""
        if self.current_term_average >= 80:
            return 'Excellent'
        elif self.current_term_average >= 70:
            return 'Very Good'
        elif self.current_term_average >= 60:
            return 'Good'
        elif self.current_term_average >= 50:
            return 'Satisfactory'
        elif self.current_term_average >= 40:
            return 'Sufficient'
        else:
            return 'Needs Improvement'
    
    @property
    def trend_indicator(self):
        """Get trend indicator with icon"""
        indicators = {
            'improving': ('ðŸ“ˆ', 'Improving'),
            'declining': ('ðŸ“‰', 'Declining'),
            'stable': ('âž¡ï¸', 'Stable'),
            'fluctuating': ('ðŸ“Š', 'Fluctuating'),
            'significant_improvement': ('ðŸš€', 'Significant Improvement'),
            'significant_decline': ('âš ï¸', 'Significant Decline'),
            'gradual_improvement': ('â†—ï¸', 'Gradual Improvement'),
            'gradual_decline': ('â†˜ï¸', 'Gradual Decline'),
        }
        return indicators.get(self.trend, ('âž¡ï¸', 'Stable'))
    
    @property
    def trend_color(self):
        """Get CSS class for trend color"""
        if self.trend_direction == 'positive':
            return 'text-success'
        elif self.trend_direction == 'negative':
            return 'text-danger'
        else:
            return 'text-secondary'
    
    @property
    def trend_badge_class(self):
        """Get Bootstrap badge class for trend"""
        if self.trend_direction == 'positive':
            return 'badge bg-success'
        elif self.trend_direction == 'negative':
            return 'badge bg-danger'
        else:
            return 'badge bg-secondary'
    
    def calculate_pass_rate(self):
        """Calculate pass rate based on subjects passed"""
        if self.total_subjects > 0:
            self.pass_rate = (self.subjects_passed / self.total_subjects) * 100
        else:
            self.pass_rate = 0
    
    def update_from_marks(self, marks_queryset):
        """Update trend data from marks queryset"""
        if not marks_queryset.exists():
            return False
        
        # Calculate average score
        avg_score = marks_queryset.aggregate(avg=Avg('total_score'))['avg']
        self.current_term_average = avg_score or 0
        
        # Count subjects and passed subjects
        self.total_subjects = marks_queryset.count()
        self.subjects_passed = marks_queryset.filter(grade__in=['A', 'B', 'C', 'D', 'E']).count()
        
        # Calculate pass rate
        self.calculate_pass_rate()
        
        # Count grades
        self.grade_a_count = marks_queryset.filter(grade='A').count()
        self.grade_b_count = marks_queryset.filter(grade='B').count()
        self.grade_c_count = marks_queryset.filter(grade='C').count()
        self.grade_d_count = marks_queryset.filter(grade='D').count()
        self.grade_e_count = marks_queryset.filter(grade='E').count()
        self.grade_f_count = marks_queryset.filter(grade='F').count()
        
        # Find strongest and weakest subjects
        subject_scores = {}
        for mark in marks_queryset.select_related('subject'):
            subject_scores[mark.subject] = mark.total_score
        
        if subject_scores:
            strongest = max(subject_scores.items(), key=lambda x: x[1])
            weakest = min(subject_scores.items(), key=lambda x: x[1])
            
            self.strongest_subject = strongest[0]
            self.strongest_subject_score = strongest[1]
            self.weakest_subject = weakest[0]
            self.weakest_subject_score = weakest[1]
        
        self.save()
        return True
    
    def compare_with_previous(self, previous_trend):
        """Compare with previous term trend"""
        if not previous_trend:
            return
        
        self.previous_term_average = previous_trend.current_term_average
        
        # Calculate changes
        self.score_change = self.current_term_average - previous_trend.current_term_average
        
        if previous_trend.current_term_average > 0:
            self.percentage_change = (self.score_change / previous_trend.current_term_average) * 100
        else:
            self.percentage_change = 0
        
        # Determine trend direction
        if self.percentage_change > 10:
            self.trend = 'significant_improvement'
            self.trend_direction = 'positive'
        elif self.percentage_change > 2:
            self.trend = 'gradual_improvement'
            self.trend_direction = 'positive'
        elif self.percentage_change > -2:
            self.trend = 'stable'
            self.trend_direction = 'neutral'
        elif self.percentage_change > -10:
            self.trend = 'gradual_decline'
            self.trend_direction = 'negative'
        else:
            self.trend = 'significant_decline'
            self.trend_direction = 'negative'
        
        # Generate analysis
        self.generate_analysis(previous_trend)
        self.save()
    
    def generate_analysis(self, previous_trend=None):
        """Generate analysis and recommendations"""
        analysis_parts = []
        recommendation_parts = []
        
        # Performance level analysis
        performance_level = self.performance_level
        analysis_parts.append(f"Performance Level: {performance_level}")
        
        # Trend analysis
        if self.trend_direction == 'positive':
            analysis_parts.append(f"Performance is improving ({self.percentage_change:+.1f}% change)")
        elif self.trend_direction == 'negative':
            analysis_parts.append(f"Performance needs attention ({self.percentage_change:+.1f}% change)")
        else:
            analysis_parts.append("Performance is stable")
        
        # Subject analysis
        if self.strongest_subject:
            analysis_parts.append(f"Strongest subject: {self.strongest_subject.name} ({self.strongest_subject_score}%)")
            recommendation_parts.append(f"Maintain excellence in {self.strongest_subject.name}")
        
        if self.weakest_subject:
            analysis_parts.append(f"Area needing improvement: {self.weakest_subject.name} ({self.weakest_subject_score}%)")
            recommendation_parts.append(f"Focus on improving {self.weakest_subject.name}")
        
        # Pass rate analysis
        if self.pass_rate >= 80:
            analysis_parts.append(f"Excellent pass rate: {self.pass_rate:.1f}%")
        elif self.pass_rate >= 60:
            analysis_parts.append(f"Good pass rate: {self.pass_rate:.1f}%")
        else:
            analysis_parts.append(f"Pass rate needs improvement: {self.pass_rate:.1f}%")
            recommendation_parts.append("Increase focus on subjects with lower grades")
        
        # Grade distribution analysis
        if self.grade_a_count > 0:
            analysis_parts.append(f"Achieved {self.grade_a_count} A grade(s)")
        
        if self.grade_f_count > 0:
            analysis_parts.append(f"Has {self.grade_f_count} subject(s) requiring attention")
            recommendation_parts.append("Seek additional help for subjects with F grades")
        
        # Overall recommendations
        if self.trend_direction == 'positive':
            recommendation_parts.append("Continue current study habits and routines")
        elif self.trend_direction == 'negative':
            recommendation_parts.append("Review and adjust study strategies")
            recommendation_parts.append("Consider seeking tutoring for challenging subjects")
        
        recommendation_parts.append("Regularly review progress and set achievable goals")
        
        self.analysis_summary = "\n".join(analysis_parts)
        self.recommendations = "\n".join(recommendation_parts)
        
        # Generate action items
        action_items = []
        if self.trend_direction == 'negative':
            action_items.append("Schedule meeting with subject teachers")
            action_items.append("Create weekly study plan")
            action_items.append("Join study groups for challenging subjects")
        else:
            action_items.append("Set higher academic goals")
            action_items.append("Participate in advanced topics")
            action_items.append("Help peers who are struggling")
        
        if self.grade_f_count > 0:
            action_items.append("Request extra classes for failed subjects")
        
        self.action_items = "\n".join(action_items)\n\n========== FILE: ./marks/templates/marks/analytics_dashboard.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<div class="container mt-4">
    <h2><i class="fas fa-chart-line"></i> Student Performance Analytics</h2>
    
    <div class="row mt-4">
        <!-- Overall Stats -->
        <div class="col-md-3">
            <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                    <h5 class="card-title">Total Students</h5>
                    <h2>{{ total_students }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success mb-3">
                <div class="card-body">
                    <h5 class="card-title">Total Marks Records</h5>
                    <h2>{{ total_marks }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info mb-3">
                <div class="card-body">
                    <h5 class="card-title">Terms Analyzed</h5>
                    <h2>{{ term_stats|length }}</h2>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Top Performers -->
    <div class="card mt-4">
        <div class="card-header">
            <h4><i class="fas fa-trophy"></i> Top 5 Performers</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Student</th>
                            <th>Average Score</th>
                            <th>Subjects</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for performer in top_performers %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ performer.student.full_name }}</td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-success" role="progressbar" 
                                         style="width: {{ performer.average_score }}%;">
                                        {{ performer.average_score|floatformat:1 }}%
                                    </div>
                                </div>
                            </td>
                            <td>{{ performer.total_subjects }}</td>
                            <td>
                                <a href="{% url 'student_performance_detail' performer.student.id %}" 
                                   class="btn btn-sm btn-info">View Details</a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">No performance data available</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Term Statistics -->
    <div class="card mt-4">
        <div class="card-header">
            <h4><i class="fas fa-calendar-alt"></i> Term Performance Statistics</h4>
        </div>
        <div class="card-body">
            <div class="row">
                {% for stat in term_stats %}
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">{{ stat.term }} {{ stat.year }}</h5>
                            <p class="card-text">
                                Average Score: <strong>{{ stat.average_score|floatformat:1 }}%</strong><br>
                                Total Records: {{ stat.total_marks }}
                            </p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="card mt-4">
        <div class="card-header">
            <h4><i class="fas fa-bolt"></i> Quick Actions</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <a href="{% url 'term_comparison_analytics' %}" class="btn btn-primary btn-block">
                        <i class="fas fa-balance-scale"></i> Compare Terms
                    </a>
                </div>
                <div class="col-md-4">
                    <a href="{% url 'generate_performance_trends' %}" class="btn btn-success btn-block">
                        <i class="fas fa-cogs"></i> Generate Trends
                    </a>
                </div>
                <div class="col-md-4">
                    <a href="{% url 'mark_list' %}" class="btn btn-info btn-block">
                        <i class="fas fa-list"></i> View All Marks
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}\n\n========== FILE: ./marks/templates/marks/generate_trends.html ==========\n
{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Generate Performance Trends{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="card mb-4">
                <div class="card-header pb-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">Generate Performance Trends</h5>
                            <p class="text-sm mb-0">
                                Generate and analyze performance trends for all students
                            </p>
                        </div>
                        <div>
                            <a href="{% url 'student_performance_analytics' %}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-arrow-left me-1"></i> Back to Analytics
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Information Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2 text-info"></i>
                        About Performance Trends
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-chart-line fa-2x"></i>
                            </div>
                            <div class="ms-3">
                                <h5 class="alert-heading">What are Performance Trends?</h5>
                                <p>
                                    Performance trends analyze student performance over multiple terms to identify:
                                </p>
                                <ul>
                                    <li><strong>Improving Performance:</strong> Students showing consistent improvement</li>
                                    <li><strong>Declining Performance:</strong> Students needing immediate attention</li>
                                    <li><strong>Stable Performance:</strong> Students maintaining consistent grades</li>
                                    <li><strong>Fluctuating Performance:</strong> Students with inconsistent results</li>
                                </ul>
                                <p class="mb-0">
                                    This analysis helps in creating personalized recommendations for each student.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div class="row mt-4">
                        <div class="col-md-3">
                            <div class="card border-start border-success border-4">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-sm mb-0">Total Students</h6>
                                            <h4 class="font-weight-bolder mb-0">{{ total_students }}</h4>
                                        </div>
                                        <div class="icon icon-shape bg-gradient-success shadow text-center border-radius-md">
                                            <i class="fas fa-users text-lg opacity-10"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-start border-info border-4">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-sm mb-0">With Marks Data</h6>
                                            <h4 class="font-weight-bolder mb-0">{{ students_with_marks }}</h4>
                                        </div>
                                        <div class="icon icon-shape bg-gradient-info shadow text-center border-radius-md">
                                            <i class="fas fa-chart-bar text-lg opacity-10"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-start border-warning border-4">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-sm mb-0">Multiple Terms</h6>
                                            <h4 class="font-weight-bolder mb-0">{{ students_multiple_terms }}</h4>
                                        </div>
                                        <div class="icon icon-shape bg-gradient-warning shadow text-center border-radius-md">
                                            <i class="fas fa-calendar-alt text-lg opacity-10"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-start border-primary border-4">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-sm mb-0">Trends Generated</h6>
                                            <h4 class="font-weight-bolder mb-0">{{ trends_generated }}</h4>
                                        </div>
                                        <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                                            <i class="fas fa-tasks text-lg opacity-10"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Generation Form -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-cogs me-2 text-primary"></i>
                        Generate Trends
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                            </div>
                            <div class="ms-3">
                                <h5 class="alert-heading">Important Information</h5>
                                <p class="mb-0">
                                    <strong>Note:</strong> This process will analyze performance data for all students
                                    and generate trend reports. The analysis may take a few moments depending on the
                                    amount of data. Existing trend reports will be updated.
                                </p>
                            </div>
                        </div>
                    </div>

                    <form method="post" class="mt-4">
                        {% csrf_token %}
                        
                        <!-- Options -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Academic Year</label>
                                    <select name="academic_year" class="form-select">
                                        <option value="">All Years</option>
                                        {% for year in academic_years %}
                                            <option value="{{ year }}">{{ year }}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">Filter by specific academic year (optional)</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Term</label>
                                    <select name="term" class="form-select">
                                        <option value="">All Terms</option>
                                        <option value="Term 1">Term 1</option>
                                        <option value="Term 2">Term 2</option>
                                        <option value="Term 3">Term 3</option>
                                    </select>
                                    <small class="form-text text-muted">Filter by specific term (optional)</small>
                                </div>
                            </div>
                        </div>

                        <!-- Analysis Options -->
                        <div class="mb-4">
                            <h6 class="mb-3">Analysis Options</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="include_recommendations" id="include_recommendations" checked>
                                <label class="form-check-label" for="include_recommendations">
                                    Include personalized recommendations
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="update_existing" id="update_existing" checked>
                                <label class="form-check-label" for="update_existing">
                                    Update existing trend reports
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="send_notifications" id="send_notifications">
                                <label class="form-check-label" for="send_notifications">
                                    Send notifications to teachers (for significant changes)
                                </label>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between mt-4">
                            <div>
                                <a href="{% url 'student_performance_analytics' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i> Cancel
                                </a>
                            </div>
                            <div>
                                <button type="button" class="btn btn-info me-2" id="previewBtn">
                                    <i class="fas fa-eye me-1"></i> Preview Sample
                                </button>
                                <button type="submit" class="btn btn-primary" id="generateBtn">
                                    <i class="fas fa-play me-1"></i> Generate Trends
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Progress Section (hidden by default) -->
                <div class="card-footer" id="progressSection" style="display: none;">
                    <h6 class="mb-3">Generation Progress</h6>
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="progressBar" role="progressbar" style="width: 0%" 
                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            <span id="progressText">0%</span>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status" id="loadingSpinner">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 mb-0" id="progressMessage">
                            Starting trend generation...
                        </p>
                    </div>
                </div>
            </div>

            <!-- Sample Preview Modal -->
            <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Sample Trend Analysis</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                This is a sample of what the trend analysis will generate.
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Sample Student Analysis</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Student Information</h6>
                                            <p><strong>Name:</strong> John Doe<br>
                                            <strong>Class:</strong> Form 4<br>
                                            <strong>Student ID:</strong> STD001</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Performance Trend</h6>
                                            <span class="badge bg-success">Improving</span>
                                            <p><strong>Average Score:</strong> 78.5%<br>
                                            <strong>Change:</strong> +12.3%</p>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <h6>Term-wise Performance</h6>
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Term</th>
                                                    <th>Average Score</th>
                                                    <th>Grade</th>
                                                    <th>Trend</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>Term 1 2024</td>
                                                    <td>72.3%</td>
                                                    <td>B</td>
                                                    <td>Stable</td>
                                                </tr>
                                                <tr>
                                                    <td>Term 2 2024</td>
                                                    <td>78.5%</td>
                                                    <td>A-</td>
                                                    <td class="text-success">Improving</td>
                                                </tr>
                                                <tr>
                                                    <td>Term 3 2024</td>
                                                    <td>81.2%</td>
                                                    <td>A</td>
                                                    <td class="text-success">Improving</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <h6>Recommendations</h6>
                                        <ul>
                                            <li>Continue with current study habits</li>
                                            <li>Focus on maintaining consistency in Mathematics</li>
                                            <li>Consider advanced topics in Science</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Preview button
    const previewBtn = document.getElementById('previewBtn');
    const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
    
    if (previewBtn) {
        previewBtn.addEventListener('click', function() {
            previewModal.show();
        });
    }
    
    // Form submission with progress
    const form = document.querySelector('form');
    const generateBtn = document.getElementById('generateBtn');
    const progressSection = document.getElementById('progressSection');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressMessage = document.getElementById('progressMessage');
    const loadingSpinner = document.getElementById('loadingSpinner');
    
    if (form && generateBtn) {
        generateBtn.addEventListener('click', function(e) {
            // Show progress section
            progressSection.style.display = 'block';
            
            // Scroll to progress section
            progressSection.scrollIntoView({ behavior: 'smooth' });
            
            // Simulate progress (this would be replaced with actual AJAX calls)
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                progressBar.style.width = progress + '%';
                progressText.textContent = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(interval);
                    progressMessage.textContent = 'Trend generation complete!';
                    loadingSpinner.style.display = 'none';
                } else if (progress >= 70) {
                    progressMessage.textContent = 'Generating recommendations...';
                } else if (progress >= 40) {
                    progressMessage.textContent = 'Analyzing performance data...';
                } else {
                    progressMessage.textContent = 'Collecting student data...';
                }
            }, 500);
        });
    }
    
    // Add form validation
    form.addEventListener('submit', function(e) {
        const confirmed = confirm('Are you sure you want to generate performance trends? This may take a few moments.');
        if (!confirmed) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}\n\n========== FILE: ./marks/templates/marks/mark_detail.html ==========\n
\n\n========== FILE: ./marks/templates/marks/mark_form.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<h2>{{ title }}</h2>

<form method="post" style="max-width: 600px;">
    {% csrf_token %}
    
    {% for field in form %}
    <div style="margin-bottom: 15px;">
        <label for="{{ field.id_for_label }}" style="display: block; margin-bottom: 5px;">
            {{ field.label }}:
        </label>
        {{ field }}
        {% if field.errors %}
            <div style="color: red; font-size: 12px;">{{ field.errors }}</div>
        {% endif %}
        {% if field.help_text %}
            <div style="color: #666; font-size: 12px;">{{ field.help_text }}</div>
        {% endif %}
    </div>
    {% endfor %}
    
    <div style="margin-top: 20px;">
        <button type="submit" style="background-color: #4CAF50; color: white; padding: 10px 20px; border: none; cursor: pointer; margin-right: 10px;">Save</button>
        <a href="{% url 'mark_list' %}" style="background-color: #757575; color: white; padding: 10px 20px; text-decoration: none;">Cancel</a>
    </div>
</form>
{% endblock %}\n\n========== FILE: ./marks/templates/marks/mark_list.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<h2>{% if user.is_admin %}All Marks{% else %}My Entered Marks{% endif %}</h2>

{% if user.is_teacher %}
<a href="{% url 'mark_create' %}" style="background-color: #4CAF50; color: white; padding: 10px 15px; text-decoration: none; display: inline-block; margin-bottom: 20px;">Add New Marks</a>
{% endif %}

<table style="width: 100%; border-collapse: collapse;">
    <thead>
        <tr style="background-color: #f2f2f2;">
            <th style="border: 1px solid #ddd; padding: 8px;">Student</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Subject</th>
            <th style="border: 1px solid #ddd; padding: 8px;">CAT1</th>
            <th style="border: 1px solid #ddd; padding: 8px;">CAT2</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Main Exam</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Total</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Grade</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Term</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Teacher</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for mark in marks %}
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ mark.student.user.get_full_name }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ mark.subject.name }}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">{{ mark.cat1_score|default:"-" }}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">{{ mark.cat2_score|default:"-" }}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">{{ mark.main_exam_score }}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: center; font-weight: bold;">{{ mark.total_score }}%</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                <span style="
                    display: inline-block;
                    padding: 2px 8px;
                    border-radius: 3px;
                    color: white;
                    {% if mark.grade == 'A' %}background-color: #4CAF50;
                    {% elif mark.grade == 'B' %}background-color: #8BC34A;
                    {% elif mark.grade == 'C' %}background-color: #FFC107;
                    {% elif mark.grade == 'D' %}background-color: #FF9800;
                    {% elif mark.grade == 'E' %}background-color: #FF5722;
                    {% else %}background-color: #f44336;
                    {% endif %}
                ">
                    {{ mark.grade }}
                </span>
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ mark.term }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ mark.teacher.user.get_full_name|default:"-" }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                {% if user.is_admin or user == mark.teacher.user %}
                    <a href="{% url 'mark_update' mark.pk %}" style="background-color: #FF9800; color: white; padding: 5px 10px; text-decoration: none; margin-right: 5px;">Edit</a>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="10" style="border: 1px solid #ddd; padding: 8px; text-align: center;">No marks found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}\n\n========== FILE: ./marks/templates/marks/student_performance_detail.html ==========\n
{% extends 'accounts/base.html' %}
{% load custom_filters %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-user-graduate"></i> 
            Performance Analysis: {{ student.full_name }}
        </h2>
        <a href="{% url 'student_performance_analytics' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Analytics
        </a>
    </div>
    
    <!-- Overall Trend Card -->
    <div class="card mb-4">
        <div class="card-header bg-{% if analysis.overall_percentage > 0 %}success{% elif analysis.overall_percentage < 0 %}danger{% else %}info{% endif %} text-white">
            <h4 class="mb-0">Overall Performance Trend</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 text-center">
                    <div class="display-4">
                        {{ analysis.overall_percentage|floatformat:1 }}%
                    </div>
                    <p class="text-muted">Overall Change</p>
                </div>
                <div class="col-md-4 text-center">
                    <div class="display-4">
                        {% if analysis.overall_percentage > 0 %}+{% endif %}{{ analysis.overall_change|floatformat:1 }}
                    </div>
                    <p class="text-muted">Points Change</p>
                </div>
                <div class="col-md-4 text-center">
                    <div class="display-4">
                        {{ analysis.overall_trend }}
                    </div>
                    <p class="text-muted">Trend Status</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Term-by-Term Performance -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>Term-by-Term Performance</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="thead-light">
                        <tr>
                            <th>Term</th>
                            <th>Average Score</th>
                            <th>Subjects</th>
                            <th>Performance Level</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for perf in analysis.performances %}
                        <tr>
                            <td>{{ perf.term }} {{ perf.year }}</td>
                            <td>
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar 
                                        {% if perf.average_score >= 80 %}bg-success
                                        {% elif perf.average_score >= 60 %}bg-info
                                        {% elif perf.average_score >= 40 %}bg-warning
                                        {% else %}bg-danger{% endif %}" 
                                        role="progressbar" 
                                        style="width: {{ perf.average_score }}%;">
                                        {{ perf.average_score|floatformat:1 }}%
                                    </div>
                                </div>
                            </td>
                            <td>{{ perf.subject_count }}</td>
                            <td>
                                <span class="badge 
                                    {% if perf.average_score >= 80 %}bg-success
                                    {% elif perf.average_score >= 60 %}bg-info
                                    {% elif perf.average_score >= 40 %}bg-warning
                                    {% else %}bg-danger{% endif %}">
                                    {% if perf.average_score >= 80 %}Excellent
                                    {% elif perf.average_score >= 60 %}Good
                                    {% elif perf.average_score >= 40 %}Average
                                    {% else %}Needs Improvement{% endif %}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" 
                                        onclick="showSubjectDetails('{{ perf.term_key }}')">
                                    View Subjects
                                </button>
                            </td>
                        </tr>
                        <!-- Subject Details (hidden by default) -->
                        <tr id="details-{{ perf.term_key }}" style="display: none;">
                            <td colspan="5">
                                <h6>Subject-wise Performance:</h6>
                                <div class="row">
                                    {% for subject_name, score in perf.subjects.items %}
                                    <div class="col-md-3 mb-2">
                                        <div class="card">
                                            <div class="card-body p-2">
                                                <small class="d-block">{{ subject_name }}</small>
                                                <strong>{{ score|floatformat:1 }}%</strong>
                                                <span class="badge bg-secondary float-end">
                                                    {{ perf.grades|get_item:subject_name }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Term Comparisons -->
    {% if analysis.has_comparisons %}
    <div class="card mb-4">
        <div class="card-header">
            <h4>Term-to-Term Comparisons</h4>
        </div>
        <div class="card-body">
            {% for comp in analysis.comparisons %}
            <div class="comparison-card mb-3 p-3 border rounded">
                <h5>
                    {{ comp.current_term }} vs {{ comp.previous_term }}
                    <span class="badge float-end 
                        {% if comp.comparison.trend == 'improving' %}bg-success
                        {% elif comp.comparison.trend == 'declining' %}bg-danger
                        {% else %}bg-info{% endif %}">
                        {{ comp.comparison.trend|title }}
                    </span>
                </h5>
                
                <div class="row mt-3">
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 
                                {% if comp.comparison.percentage_change > 0 %}text-success
                                {% elif comp.comparison.percentage_change < 0 %}text-danger
                                {% else %}text-info{% endif %}">
                                {% if comp.comparison.percentage_change > 0 %}+{% endif %}
                                {{ comp.comparison.percentage_change|floatformat:1 }}%
                            </div>
                            <small class="text-muted">Percentage Change</small>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4">{{ comp.comparison.current_term.average_score|floatformat:1 }}%</div>
                            <small class="text-muted">Current Term Average</small>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4">{{ comp.comparison.previous_term.average_score|floatformat:1 }}%</div>
                            <small class="text-muted">Previous Term Average</small>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4">
                                {% if comp.comparison.strongest_subject %}
                                {{ comp.comparison.strongest_subject }}
                                {% else %}N/A{% endif %}
                            </div>
                            <small class="text-muted">Strongest Subject</small>
                        </div>
                    </div>
                </div>
                
                <!-- Subject Improvements -->
                {% if comp.comparison.subject_comparison %}
                <div class="mt-3">
                    <h6>Subject Performance Changes:</h6>
                    <div class="row">
                        {% for subject_name, data in comp.comparison.subject_comparison.items %}
                        {% if data.change != 0 %}
                        <div class="col-md-4 mb-2">
                            <div class="card {% if data.change > 0 %}border-success{% else %}border-danger{% endif %}">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between">
                                        <small>{{ subject_name }}</small>
                                        <span class="badge 
                                            {% if data.change > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if data.change > 0 %}+{% endif %}{{ data.change|floatformat:1 }}
                                        </span>
                                    </div>
                                    <div class="d-flex justify-content-between mt-1">
                                        <small class="text-muted">{{ data.previous_score|floatformat:1 }}% â†’</small>
                                        <small class="text-muted">{{ data.current_score|floatformat:1 }}%</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Recommendations -->
    <div class="card">
        <div class="card-header bg-warning">
            <h4 class="mb-0"><i class="fas fa-lightbulb"></i> Recommendations</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h5>For Improvement:</h5>
                    <ul>
                        {% if analysis.overall_percentage < 0 %}
                        <li>Focus on improving performance in weakest subjects</li>
                        <li>Consider additional tutoring or study groups</li>
                        <li>Review study habits and time management</li>
                        {% else %}
                        <li>Maintain current study routines</li>
                        <li>Continue focusing on strong subjects</li>
                        <li>Set higher goals for next term</li>
                        {% endif %}
                    </ul>
                </div>
                <div class="col-md-6">
                    <h5>Next Steps:</h5>
                    <ul>
                        <li>Schedule meeting with teachers for feedback</li>
                        <li>Create personalized study plan</li>
                        <li>Track progress weekly</li>
                        <li>Set specific academic goals</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showSubjectDetails(termKey) {
    var element = document.getElementById('details-' + termKey);
    if (element.style.display === 'none') {
        element.style.display = 'table-row';
    } else {
        element.style.display = 'none';
    }
}
</script>

<style>
.comparison-card {
    background-color: #f8f9fa;
    border-left: 4px solid #007bff;
}
.progress {
    background-color: #e9ecef;
}
.progress-bar {
    transition: width 0.6s ease;
}
.badge {
    font-size: 0.8em;
}
</style>
{% endblock %}\n\n========== FILE: ./marks/templates/marks/student_results.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<h2>My Academic Results</h2>

<div style="background-color: #e8f5e9; padding: 20px; border-radius: 5px; margin-bottom: 30px;">
    <h3>Student Information</h3>
    <p><strong>Name:</strong> {{ student.user.get_full_name }}</p>
    <p><strong>Admission Number:</strong> {{ student.admission_number }}</p>
    <p><strong>Class:</strong> {{ student.grade }}-{{ student.section }}</p>
    
    <div style="display: flex; gap: 20px; margin-top: 15px;">
        <div style="background-color: white; padding: 15px; border-radius: 5px; flex: 1;">
            <h4 style="margin-top: 0;">Overall Performance</h4>
            <p><strong>Average Score:</strong> <span style="font-size: 24px; font-weight: bold;">{{ average_score|floatformat:2 }}%</span></p>
            <p><strong>Subjects Taken:</strong> {{ total_subjects }}</p>
            <p><strong>Subjects Passed:</strong> {{ passed_subjects }}</p>
        </div>
    </div>
</div>

<h3>Subject Marks</h3>
<table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
    <thead>
        <tr style="background-color: #f2f2f2;">
            <th style="border: 1px solid #ddd; padding: 8px;">Subject</th>
            <th style="border: 1px solid #ddd; padding: 8px;">CAT1</th>
            <th style="border: 1px solid #ddd; padding: 8px;">CAT2</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Main Exam</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Total Score</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Grade</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Term/Year</th>
        </tr>
    </thead>
    <tbody>
        {% for mark in marks %}
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ mark.subject.name }}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">{{ mark.cat1_score|default:"-" }}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">{{ mark.cat2_score|default:"-" }}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">{{ mark.main_exam_score }}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: center; font-weight: bold;">{{ mark.total_score }}%</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                <span style="
                    display: inline-block;
                    padding: 2px 8px;
                    border-radius: 3px;
                    color: white;
                    {% if mark.grade == 'A' %}background-color: #4CAF50;
                    {% elif mark.grade == 'B' %}background-color: #8BC34A;
                    {% elif mark.grade == 'C' %}background-color: #FFC107;
                    {% elif mark.grade == 'D' %}background-color: #FF9800;
                    {% elif mark.grade == 'E' %}background-color: #FF5722;
                    {% else %}background-color: #f44336;
                    {% endif %}
                ">
                    {{ mark.grade }}
                </span>
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ mark.term }} {{ mark.academic_year }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="7" style="border: 1px solid #ddd; padding: 8px; text-align: center;">No marks recorded yet.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if reports %}
<h3>Term Reports</h3>
{% for report in reports %}
<div style="background-color: #f9f9f9; padding: 20px; border-radius: 5px; margin-bottom: 20px;">
    <h4>{{ report.term }} {{ report.academic_year }} Report</h4>
    <div style="display: flex; gap: 20px;">
        <div style="flex: 1;">
            <p><strong>Average Score:</strong> {{ report.average_score }}%</p>
            <p><strong>Overall Grade:</strong> {{ report.get_overall_grade_display }}</p>
            <p><strong>Class Position:</strong> {{ report.class_position }}/{{ report.total_students }}</p>
            <p><strong>Attendance:</strong> {{ report.days_present }}/{{ report.total_days }} days</p>
        </div>
        <div style="flex: 2;">
            <p><strong>Teacher's Comment:</strong><br>{{ report.teacher_comment|linebreaks }}</p>
            {% if report.principal_comment %}
            <p><strong>Principal's Comment:</strong><br>{{ report.principal_comment|linebreaks }}</p>
            {% endif %}
        </div>
    </div>
</div>
{% endfor %}
{% endif %}

<div style="background-color: #fff3e0; padding: 15px; border-radius: 5px; margin-top: 20px;">
    <p><strong>Note:</strong> As a student, you can only view your marks. You cannot edit or manipulate any results.</p>
    <p>If you notice any discrepancies, please contact your teacher or the school administration.</p>
</div>
{% endblock %}\n\n========== FILE: ./marks/templates/marks/term_comparison.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<div class="container mt-4">
    <h2><i class="fas fa-balance-scale"></i> Term Comparison Analytics</h2>
    
    <div class="card mt-4">
        <div class="card-header">
            <h4>Compare Two Terms</h4>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-5">
                    <label class="form-label">Select First Term</label>
                    <select name="term1" class="form-select">
                        <option value="">-- Select Term --</option>
                        {% for term in terms %}
                        <option value="{{ term.term }}|{{ term.academic_year }}" 
                                {% if selected_term1 == term.term|add:"|"|add:term.academic_year %}selected{% endif %}>
                            {{ term.term }} {{ term.academic_year }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-5">
                    <label class="form-label">Select Second Term</label>
                    <select name="term2" class="form-select">
                        <option value="">-- Select Term --</option>
                        {% for term in terms %}
                        <option value="{{ term.term }}|{{ term.academic_year }}" 
                                {% if selected_term2 == term.term|add:"|"|add:term.academic_year %}selected{% endif %}>
                            {{ term.term }} {{ term.academic_year }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-compare"></i> Compare
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    {% if comparison_data %}
    <div class="card mt-4">
        <div class="card-header bg-info text-white">
            <h4 class="mb-0">Comparison Results</h4>
        </div>
        <div class="card-body">
            <div class="row text-center mb-4">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5>{{ comparison_data.term1.term }} {{ comparison_data.term1.year }}</h5>
                            <div class="display-4 
                                {% if comparison_data.percentage_change < 0 %}text-success{% endif %}">
                                {{ comparison_data.term1.average|floatformat:1 }}%
                            </div>
                            <small class="text-muted">Average Score</small>
                            <p class="mt-2">{{ comparison_data.term1.count }} records</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 d-flex align-items-center justify-content-center">
                    <div class="text-center">
                        <div class="display-4 
                            {% if comparison_data.percentage_change > 0 %}text-success
                            {% elif comparison_data.percentage_change < 0 %}text-danger
                            {% else %}text-info{% endif %}">
                            {% if comparison_data.difference > 0 %}+{% endif %}
                            {{ comparison_data.difference|floatformat:1 }}
                        </div>
                        <div class="h4 
                            {% if comparison_data.percentage_change > 0 %}text-success
                            {% elif comparison_data.percentage_change < 0 %}text-danger
                            {% else %}text-info{% endif %}">
                            {% if comparison_data.percentage_change > 0 %}+{% endif %}
                            {{ comparison_data.percentage_change|floatformat:1 }}%
                        </div>
                        <small class="text-muted">Change</small>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5>{{ comparison_data.term2.term }} {{ comparison_data.term2.year }}</h5>
                            <div class="display-4 
                                {% if comparison_data.percentage_change > 0 %}text-success{% endif %}">
                                {{ comparison_data.term2.average|floatformat:1 }}%
                            </div>
                            <small class="text-muted">Average Score</small>
                            <p class="mt-2">{{ comparison_data.term2.count }} records</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Trend Indicator -->
            <div class="text-center mt-3">
                {% if comparison_data.percentage_change > 5 %}
                <div class="alert alert-success">
                    <i class="fas fa-arrow-up"></i> 
                    <strong>Significant Improvement:</strong> 
                    Performance improved by {{ comparison_data.percentage_change|floatformat:1 }}%
                </div>
                {% elif comparison_data.percentage_change > 0 %}
                <div class="alert alert-info">
                    <i class="fas fa-arrow-up"></i> 
                    <strong>Slight Improvement:</strong> 
                    Performance improved by {{ comparison_data.percentage_change|floatformat:1 }}%
                </div>
                {% elif comparison_data.percentage_change < -5 %}
                <div class="alert alert-danger">
                    <i class="fas fa-arrow-down"></i> 
                    <strong>Significant Decline:</strong> 
                    Performance declined by {{ comparison_data.percentage_change|stringformat:"+.1f"|slice:"1:" }}%
                </div>
                {% elif comparison_data.percentage_change < 0 %}
                <div class="alert alert-warning">
                    <i class="fas fa-arrow-down"></i> 
                    <strong>Slight Decline:</strong> 
                   Performance declined by {{ comparison_data.percentage_change|stringformat:"+.1f"|slice:"1:" }}%
                </div>
                {% else %}
                <div class="alert alert-secondary">
                    <i class="fas fa-equals"></i> 
                    <strong>Stable Performance:</strong> 
                    No significant change in performance
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}\n\n========== FILE: ./marks/tests.py ==========\n
from django.test import TestCase

# Create your tests here.
\n\n========== FILE: ./marks/urls.py ==========\n
from django.urls import path
from . import views

urlpatterns = [
    # Subject management (admin only)
    path('subjects/', views.subject_list, name='subject_list'),
    path('subjects/create/', views.subject_create, name='subject_create'),
    
    # Marks management
    path('', views.mark_list, name='mark_list'),
    path('create/', views.mark_create, name='mark_create'),
    path('<int:pk>/update/', views.mark_update, name='mark_update'),
    
    # Student results
    path('results/', views.student_results, name='student_results'),
    
    # Reports
    path('reports/create/', views.student_report_create, name='report_create'),

     # Analytics and trends
    path('analytics/student-performance/', views.student_performance_analytics, name='student_performance_analytics'),
    path('analytics/student/<int:student_id>/', views.student_performance_detail, name='student_performance_detail'),
    path('analytics/term-comparison/', views.term_comparison_analytics, name='term_comparison_analytics'),
    path('analytics/generate-trends/', views.generate_performance_trends, name='generate_performance_trends'),
]\n\n========== FILE: ./marks/views.py ==========\n
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required, user_passes_test
from django.contrib import messages  # Change from school_messages to messages
from django.db.models import Avg, Sum
from .models import Mark, Subject, StudentReport
from .forms import MarkForm, MarkUpdateForm, SubjectForm, StudentReportForm
from students.models import Student
from teachers.models import Teacher
from django.http import JsonResponse
from .analytics import StudentPerformanceAnalyzer

def is_admin(user):
    return user.is_authenticated and user.is_admin()

def is_teacher(user):
    return user.is_authenticated and user.is_teacher()

@login_required
@user_passes_test(is_admin)
def subject_list(request):
    subjects = Subject.objects.all()
    return render(request, 'marks/subject_list.html', {'subjects': subjects})

@login_required
@user_passes_test(is_admin)
def subject_create(request):
    if request.method == 'POST':
        form = SubjectForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, 'Subject created successfully!')
            return redirect('subject_list')
    else:
        form = SubjectForm()
    return render(request, 'marks/subject_form.html', {'form': form, 'title': 'Add Subject'})

@login_required
def mark_list(request):
    if request.user.is_admin():
        marks = Mark.objects.all()
    elif request.user.is_teacher():
        try:
            teacher = Teacher.objects.get(user=request.user)
            marks = Mark.objects.filter(
                student__grade__in=teacher.get_classes_list()
            )
        except Teacher.DoesNotExist:
            marks = Mark.objects.none()
    else:
        marks = Mark.objects.none()
    
    return render(request, 'marks/mark_list.html', {'marks': marks})

@login_required
@user_passes_test(is_teacher)
def mark_create(request):
    try:
        teacher = Teacher.objects.get(user=request.user)
    except Teacher.DoesNotExist:
        messages.error(request, 'Teacher profile not found.')
        return redirect('dashboard')
    
    if request.method == 'POST':
        form = MarkForm(request.POST, teacher=teacher)
        if form.is_valid():
            mark = form.save(commit=False)
            mark.teacher = teacher
            mark.save()
            messages.success(request, f'Marks for {mark.student} added successfully!')
            return redirect('mark_list')
    else:
        form = MarkForm(teacher=teacher)
    
    return render(request, 'marks/mark_form.html', {'form': form, 'title': 'Add Marks'})

@login_required
@user_passes_test(is_teacher)
def mark_update(request, pk):
    mark = get_object_or_404(Mark, pk=pk)
    
    # Check if teacher can edit this mark
    if request.user != mark.teacher.user and not request.user.is_admin():
        messages.error(request, 'You are not authorized to edit these marks.')
        return redirect('mark_list')
    
    if request.method == 'POST':
        form = MarkUpdateForm(request.POST, instance=mark)
        if form.is_valid():
            form.save()
            messages.success(request, 'Marks updated successfully!')
            return redirect('mark_list')
    else:
        form = MarkUpdateForm(instance=mark)
    
    return render(request, 'marks/mark_form.html', {'form': form, 'title': 'Update Marks'})

@login_required
def student_results(request):
    if request.user.is_student():
        try:
            student = Student.objects.get(user=request.user)
            marks = Mark.objects.filter(student=student)
            
            # Calculate statistics
            if marks.exists():
                average_score = marks.aggregate(Avg('total_score'))['total_score__avg']
                total_subjects = marks.count()
                passed_subjects = marks.filter(grade__in=['A', 'B', 'C', 'D', 'E']).count()
            else:
                average_score = 0
                total_subjects = 0
                passed_subjects = 0
            
            # Get reports
            reports = StudentReport.objects.filter(student=student)
            
            return render(request, 'marks/student_results.html', {
                'student': student,
                'marks': marks,
                'average_score': average_score,
                'total_subjects': total_subjects,
                'passed_subjects': passed_subjects,
                'reports': reports,
            })
        except Student.DoesNotExist:
            messages.error(request, 'Student profile not found.')
            return redirect('dashboard')
    else:
        messages.error(request, 'Access denied.')
        return redirect('dashboard')

@login_required
@user_passes_test(is_admin)
def student_report_create(request):
    if request.method == 'POST':
        form = StudentReportForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, 'Student report created successfully!')
            return redirect('dashboard')
    else:
        form = StudentReportForm()
    
    return render(request, 'marks/report_form.html', {'form': form, 'title': 'Create Student Report'})

@login_required
def student_performance_analytics(request):
    """Main analytics dashboard"""
    if not (request.user.is_admin() or request.user.is_teacher()):
        messages.error(request, 'Access denied.')
        return redirect('dashboard')
    
    students = Student.objects.all()
    analyzer = StudentPerformanceAnalyzer()
    
    # Get top performers
    top_performers = []
    for student in students[:10]:  # Limit to 10 for performance
        marks = Mark.objects.filter(student=student)
        if marks.exists():
            avg = marks.aggregate(Avg('total_score'))['total_score__avg']
            top_performers.append({
                'student': student,
                'average_score': avg,
                'total_subjects': marks.count()
            })
    
    # Sort by average score
    top_performers.sort(key=lambda x: x['average_score'] or 0, reverse=True)
    
    # Get term-wise statistics
    term_stats = []
    terms = Mark.objects.values('term', 'academic_year').distinct().order_by('-academic_year', 'term')
    
    for term in terms[:5]:  # Last 5 terms
        term_marks = Mark.objects.filter(
            term=term['term'],
            academic_year=term['academic_year']
        )
        if term_marks.exists():
            avg = term_marks.aggregate(Avg('total_score'))['total_score__avg']
            term_stats.append({
                'term': term['term'],
                'year': term['academic_year'],
                'average_score': avg,
                'total_marks': term_marks.count()
            })
    
    return render(request, 'marks/analytics_dashboard.html', {
        'top_performers': top_performers[:5],
        'term_stats': term_stats,
        'total_students': students.count(),
        'total_marks': Mark.objects.count()
    })

@login_required
def student_performance_detail(request, student_id):
    """Detailed performance analysis for a specific student"""
    if not (request.user.is_admin() or request.user.is_teacher() or 
           (request.user.is_student() and str(request.user.student.id) == str(student_id))):
        messages.error(request, 'Access denied.')
        return redirect('dashboard')
    
    analyzer = StudentPerformanceAnalyzer(student_id)
    analysis = analyzer.generate_trend_analysis(student_id)
    
    if not analysis:
        messages.warning(request, 'Insufficient data for performance analysis.')
        return redirect('student_results')
    
    return render(request, 'marks/student_performance_detail.html', {
        'analysis': analysis,
        'student': analysis['student'],
        'has_comparisons': len(analysis['comparisons']) > 0
    })

@login_required
def term_comparison_analytics(request):
    """Compare performance across terms"""
    if not (request.user.is_admin() or request.user.is_teacher()):
        messages.error(request, 'Access denied.')
        return redirect('dashboard')
    
    terms = Mark.objects.values('term', 'academic_year').distinct().order_by('-academic_year', 'term')
    selected_term1 = request.GET.get('term1')
    selected_term2 = request.GET.get('term2')
    
    comparison_data = None
    if selected_term1 and selected_term2:
        # Parse terms
        term1_parts = selected_term1.split('|')
        term2_parts = selected_term2.split('|')
        
        if len(term1_parts) == 2 and len(term2_parts) == 2:
            term1, year1 = term1_parts
            term2, year2 = term2_parts
            
            # Get marks for both terms
            marks_term1 = Mark.objects.filter(term=term1, academic_year=year1)
            marks_term2 = Mark.objects.filter(term=term2, academic_year=year2)
            
            if marks_term1.exists() and marks_term2.exists():
                avg1 = marks_term1.aggregate(Avg('total_score'))['total_score__avg']
                avg2 = marks_term2.aggregate(Avg('total_score'))['total_score__avg']
                
                comparison_data = {
                    'term1': {'term': term1, 'year': year1, 'average': avg1, 'count': marks_term1.count()},
                    'term2': {'term': term2, 'year': year2, 'average': avg2, 'count': marks_term2.count()},
                    'difference': avg2 - avg1,
                    'percentage_change': ((avg2 - avg1) / avg1 * 100) if avg1 > 0 else 0
                }
    
    return render(request, 'marks/term_comparison.html', {
        'terms': terms,
        'comparison_data': comparison_data,
        'selected_term1': selected_term1,
        'selected_term2': selected_term2
    })

@login_required
@user_passes_test(lambda u: u.is_admin())
def generate_performance_trends(request):
    """Generate and save performance trends for all students"""
    from .models import PerformanceTrend  # Import the model
    
    if request.method == 'POST':
        analyzer = StudentPerformanceAnalyzer()
        students = Student.objects.all()
        generated_count = 0
        
        # Get filters from form
        academic_year = request.POST.get('academic_year')
        term = request.POST.get('term')
        
        for student in students:
            # Apply filters if specified - call with correct number of arguments
            analysis = analyzer.generate_trend_analysis(student.id)
            
            # Apply filters manually after getting analysis
            if analysis and analysis['has_multiple_terms']:
                # Filter by academic year if specified
                if academic_year:
                    # Check if student has marks in the specified year
                    has_marks_in_year = Mark.objects.filter(
                        student=student, 
                        academic_year=academic_year
                    ).exists()
                    if not has_marks_in_year:
                        continue
                
                # Filter by term if specified
                if term:
                    # Check if student has marks in the specified term
                    has_marks_in_term = Mark.objects.filter(
                        student=student,
                        term=term
                    ).exists()
                    if not has_marks_in_term:
                        continue
                
                # Save or update trend analysis
                try:
                    # Check if trend already exists
                    trend, created = PerformanceTrend.objects.update_or_create(
                        student=student,
                        term=analysis['latest_term'],
                        academic_year=analysis['latest_year'],
                        defaults={
                            'average_score': analysis['average_scores'][-1] if analysis['average_scores'] else 0,
                            'previous_average': analysis['average_scores'][-2] if len(analysis['average_scores']) > 1 else None,
                            'trend': analysis['trend'],
                            'percentage_change': analysis.get('percentage_change', 0),
                            'strongest_subject': analysis.get('strongest_subject'),
                            'weakest_subject': analysis.get('weakest_subject'),
                            'most_improved_subject': analysis.get('most_improved_subject'),
                            'analysis': analysis.get('analysis_text', ''),
                            'recommendations': analysis.get('recommendations', '')
                        }
                    )
                    generated_count += 1
                except Exception as e:
                    print(f"Error generating trend for {student}: {e}")
        
        messages.success(request, f'Generated performance trends for {generated_count} students.')
        return redirect('student_performance_analytics')
    
    # GET request - show form
    # Get statistics for display
    total_students = Student.objects.count()
    
    # Count students with marks
    students_with_marks = Student.objects.filter(marks__isnull=False).distinct().count()
    
    # Count students with multiple terms
    students_multiple_terms = 0
    for student in Student.objects.all():
        term_count = Mark.objects.filter(student=student).values('term', 'academic_year').distinct().count()
        if term_count > 1:
            students_multiple_terms += 1
    
    # Count existing trends
    trends_generated = PerformanceTrend.objects.count()
    
    # Get unique academic years
    academic_years = Mark.objects.values_list('academic_year', flat=True).distinct().order_by('-academic_year')
    
    return render(request, 'marks/generate_trends.html', {
        'total_students': total_students,
        'students_with_marks': students_with_marks,
        'students_multiple_terms': students_multiple_terms,
        'trends_generated': trends_generated,
        'academic_years': academic_years,
    })\n\n========== FILE: ./marks/__init__.py ==========\n
\n\n========== FILE: ./payments/admin.py ==========\n
from django.contrib import admin
from unfold.admin import ModelAdmin
from .models import FeeStructure, StudentFee, Payment, AdditionalCharge, PaymentReceipt

@admin.register(FeeStructure)
class FeeStructureAdmin(ModelAdmin):
    list_display = ('name', 'grade', 'term', 'academic_year', 'total_fee', 'is_active')
    list_filter = ('grade', 'term', 'academic_year', 'is_active')
    search_fields = ('name', 'description', 'academic_year')
    readonly_fields = ('created_at', 'updated_at')
    fieldsets = (
        ('Basic Information', {
            'fields': ('name', 'description', 'grade', 'term', 'academic_year', 'is_active')
        }),
        ('Fee Breakdown', {
            'fields': (
                'tuition_fee', 'boarding_fee', 'activity_fee', 'exam_fee',
                'library_fee', 'medical_fee', 'sports_fee', 'development_fee'
            )
        }),
        ('Additional Charges', {
            'fields': ('other_charges', 'late_payment_fee')
        }),
        ('Timestamps', {
            'fields': ('created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )
    
    def total_fee(self, obj):
        return f"Ksh {obj.total_fee:,.2f}"
    total_fee.short_description = 'Total Fee'

@admin.register(StudentFee)
class StudentFeeAdmin(ModelAdmin):
    list_display = ('student', 'fee_structure', 'amount_due', 'amount_paid', 'balance', 'is_paid', 'due_date')
    list_filter = ('fee_structure__grade', 'fee_structure__term', 'is_paid', 'due_date')
    search_fields = ('student__user__username', 'student__admission_number', 'student__user__first_name', 'student__user__last_name')
    readonly_fields = ('amount_due', 'balance', 'is_paid', 'created_at', 'updated_at')
    fieldsets = (
        ('Student Information', {
            'fields': ('student', 'fee_structure')
        }),
        ('Payment Information', {
            'fields': ('amount_paid', 'additional_charges', 'penalty_charges', 'due_date', 'paid_date')
        }),
        ('Calculated Fields', {
            'fields': ('amount_due', 'balance', 'is_paid'),
            'classes': ('collapse',)
        }),
        ('Timestamps', {
            'fields': ('created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )
    
    def amount_due_formatted(self, obj):
        return f"Ksh {obj.amount_due:,.2f}"
    amount_due_formatted.short_description = 'Amount Due'
    
    def amount_paid_formatted(self, obj):
        return f"Ksh {obj.amount_paid:,.2f}"
    amount_paid_formatted.short_description = 'Amount Paid'
    
    def balance_formatted(self, obj):
        return f"Ksh {obj.balance:,.2f}"
    balance_formatted.short_description = 'Balance'

@admin.register(Payment)
class PaymentAdmin(ModelAdmin):
    list_display = ('student', 'amount', 'payment_method', 'status', 'payment_date', 'confirmed_by')
    list_filter = ('payment_method', 'status', 'payment_date', 'confirmed_by')
    search_fields = ('student__user__username', 'student__admission_number', 'transaction_id', 'mpesa_code', 'receipt_number')
    readonly_fields = ('payment_date', 'created_at', 'updated_at')
    fieldsets = (
        ('Payment Information', {
            'fields': ('student_fee', 'student', 'amount', 'payment_method', 'status')
        }),
        ('Transaction Details', {
            'fields': ('transaction_id', 'receipt_number', 'mpesa_code', 'phone_number', 'description')
        }),
        ('Confirmation', {
            'fields': ('confirmed_by', 'confirmed_at')
        }),
        ('Timestamps', {
            'fields': ('payment_date', 'created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )
    
    def amount_formatted(self, obj):
        return f"Ksh {obj.amount:,.2f}"
    amount_formatted.short_description = 'Amount'

@admin.register(AdditionalCharge)
class AdditionalChargeAdmin(ModelAdmin):
    list_display = ('student', 'charge_type', 'amount', 'is_paid', 'due_date', 'added_by')
    list_filter = ('charge_type', 'is_paid', 'due_date', 'added_by')
    search_fields = ('student__user__username', 'student__admission_number', 'description')
    readonly_fields = ('created_at', 'updated_at')
    fieldsets = (
        ('Charge Information', {
            'fields': ('student', 'charge_type', 'description', 'amount')
        }),
        ('Payment Status', {
            'fields': ('is_paid', 'due_date', 'paid_date')
        }),
        ('Administration', {
            'fields': ('added_by',)
        }),
        ('Timestamps', {
            'fields': ('created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )
    
    def amount_formatted(self, obj):
        return f"Ksh {obj.amount:,.2f}"
    amount_formatted.short_description = 'Amount'

@admin.register(PaymentReceipt)
class PaymentReceiptAdmin(ModelAdmin):
    list_display = ('receipt_number', 'payment', 'generated_at')
    list_filter = ('generated_at',)
    search_fields = ('receipt_number', 'payment__transaction_id')
    readonly_fields = ('receipt_number', 'generated_at')
    fieldsets = (
        ('Receipt Information', {
            'fields': ('payment', 'receipt_number', 'pdf_file')
        }),
        ('Timestamps', {
            'fields': ('generated_at',),
            'classes': ('collapse',)
        }),
    )\n\n========== FILE: ./payments/apps.py ==========\n
from django.apps import AppConfig

class PaymentsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'payments'
    
    def ready(self):
        # Import signals when the app is ready
        import payments.signals\n\n========== FILE: ./payments/forms.py ==========\n
from django import forms
from .models import FeeStructure, StudentFee, AdditionalCharge, Payment
from students.models import Student
import datetime

class FeeStructureForm(forms.ModelForm):
    class Meta:
        model = FeeStructure
        fields = [
            'name', 'description', 'grade', 'term', 'academic_year',
            'tuition_fee', 'boarding_fee', 'activity_fee', 'exam_fee',
            'library_fee', 'medical_fee', 'sports_fee', 'development_fee',
            'other_charges', 'late_payment_fee', 'is_active'
        ]
        widgets = {
            'description': forms.Textarea(attrs={'rows': 3}),
            'academic_year': forms.TextInput(attrs={'placeholder': 'e.g., 2024'}),
        }

class StudentFeeForm(forms.ModelForm):
    student = forms.ModelChoiceField(
        queryset=Student.objects.all(),
        widget=forms.Select(attrs={'class': 'form-control'})
    )
    
    class Meta:
        model = StudentFee
        fields = ['student', 'fee_structure', 'additional_charges', 'penalty_charges', 'due_date']
        widgets = {
            'due_date': forms.DateInput(attrs={'type': 'date'}),
            'additional_charges': forms.NumberInput(attrs={'step': '0.01'}),
            'penalty_charges': forms.NumberInput(attrs={'step': '0.01'}),
        }

class AdditionalChargeForm(forms.ModelForm):
    class Meta:
        model = AdditionalCharge
        fields = ['student', 'charge_type', 'description', 'amount', 'due_date']
        widgets = {
            'description': forms.Textarea(attrs={'rows': 3}),
            'due_date': forms.DateInput(attrs={'type': 'date'}),
            'amount': forms.NumberInput(attrs={'step': '0.01'}),
        }

class MpesaPaymentForm(forms.Form):
    phone_number = forms.CharField(
        max_length=15,
        required=True,
        widget=forms.TextInput(attrs={
            'placeholder': '2547XXXXXXXX',
            'pattern': '^254[0-9]{9}$'
        })
    )
    amount = forms.DecimalField(
        max_digits=10,
        decimal_places=2,
        required=True,
        widget=forms.NumberInput(attrs={'step': '0.01'})
    )
    description = forms.CharField(
        required=False,
        widget=forms.Textarea(attrs={'rows': 2, 'placeholder': 'Optional payment description'})
    )
    
    def clean_phone_number(self):
        phone = self.cleaned_data['phone_number']
        if not phone.startswith('254'):
            raise forms.ValidationError("Phone number must start with 254")
        if len(phone) != 12:
            raise forms.ValidationError("Phone number must be 12 digits (254XXXXXXXXX)")
        return phone

class PaymentForm(forms.ModelForm):
    class Meta:
        model = Payment
        fields = ['student_fee', 'amount', 'payment_method', 'description']
        widgets = {
            'description': forms.Textarea(attrs={'rows': 2}),
            'amount': forms.NumberInput(attrs={'step': '0.01'}),
        }
    
    def __init__(self, *args, **kwargs):
        user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)
        
        if user and user.is_student():
            try:
                student = Student.objects.get(user=user)
                self.fields['student_fee'].queryset = StudentFee.objects.filter(student=student)
            except Student.DoesNotExist:
                self.fields['student_fee'].queryset = StudentFee.objects.none()\n\n========== FILE: ./payments/management/commands/load_fee_structures.py ==========\n
from django.core.management.base import BaseCommand
from payments.models import FeeStructure
from datetime import datetime, timedelta

class Command(BaseCommand):
    help = 'Loads initial fee structure data'
    
    def handle(self, *args, **kwargs):
        fee_structures = [
            {
                'name': 'Form 1 Term 1 Fees 2024',
                'description': 'Form 1 First Term Fees for 2024 Academic Year',
                'grade': 'form1',
                'term': 'term1',
                'academic_year': '2024',
                'tuition_fee': 25000.00,
                'boarding_fee': 35000.00,
                'activity_fee': 5000.00,
                'exam_fee': 2000.00,
                'library_fee': 1000.00,
                'medical_fee': 3000.00,
                'sports_fee': 2000.00,
                'development_fee': 5000.00,
                'other_charges': 3000.00,
                'late_payment_fee': 1000.00,
                'is_active': True,
            },
            {
                'name': 'Form 2 Term 1 Fees 2024',
                'description': 'Form 2 First Term Fees for 2024 Academic Year',
                'grade': 'form2',
                'term': 'term1',
                'academic_year': '2024',
                'tuition_fee': 24000.00,
                'boarding_fee': 34000.00,
                'activity_fee': 4500.00,
                'exam_fee': 2000.00,
                'library_fee': 1000.00,
                'medical_fee': 3000.00,
                'sports_fee': 2000.00,
                'development_fee': 5000.00,
                'other_charges': 3000.00,
                'late_payment_fee': 1000.00,
                'is_active': True,
            },
            {
                'name': 'Form 3 Term 1 Fees 2024',
                'description': 'Form 3 First Term Fees for 2024 Academic Year',
                'grade': 'form3',
                'term': 'term1',
                'academic_year': '2024',
                'tuition_fee': 26000.00,
                'boarding_fee': 36000.00,
                'activity_fee': 5500.00,
                'exam_fee': 2500.00,
                'library_fee': 1500.00,
                'medical_fee': 3500.00,
                'sports_fee': 2500.00,
                'development_fee': 6000.00,
                'other_charges': 3500.00,
                'late_payment_fee': 1500.00,
                'is_active': True,
            },
            {
                'name': 'Form 4 Term 1 Fees 2024',
                'description': 'Form 4 First Term Fees for 2024 Academic Year',
                'grade': 'form4',
                'term': 'term1',
                'academic_year': '2024',
                'tuition_fee': 28000.00,
                'boarding_fee': 38000.00,
                'activity_fee': 6000.00,
                'exam_fee': 3000.00,
                'library_fee': 2000.00,
                'medical_fee': 4000.00,
                'sports_fee': 3000.00,
                'development_fee': 7000.00,
                'other_charges': 4000.00,
                'late_payment_fee': 2000.00,
                'is_active': True,
            },
        ]
        
        for fee_data in fee_structures:
            fee, created = FeeStructure.objects.get_or_create(
                grade=fee_data['grade'],
                term=fee_data['term'],
                academic_year=fee_data['academic_year'],
                defaults=fee_data
            )
            if created:
                self.stdout.write(self.style.SUCCESS(f'Created fee structure: {fee.name}'))
            else:
                self.stdout.write(self.style.WARNING(f'Fee structure already exists: {fee.name}'))
        
        self.stdout.write(self.style.SUCCESS('Successfully loaded fee structures'))\n\n========== FILE: ./payments/management/commands/__init__.py ==========\n
\n\n========== FILE: ./payments/management/__init__.py ==========\n
\n\n========== FILE: ./payments/models.py ==========\n
from django.db import models
from students.models import Student
from django.core.validators import MinValueValidator
from decimal import Decimal

class FeeStructure(models.Model):
    TERM_CHOICES = (
        ('term1', 'Term 1'),
        ('term2', 'Term 2'),
        ('term3', 'Term 3'),
        ('term4', 'Term 4'),
    )
    
    GRADE_CHOICES = (
        ('form1', 'Form 1'),
        ('form2', 'Form 2'),
        ('form3', 'Form 3'),
        ('form4', 'Form 4'),
        ('form5', 'Form 5'),
        ('form6', 'Form 6'),
    )
    
    name = models.CharField(max_length=100)
    description = models.TextField(blank=True)
    grade = models.CharField(max_length=20, choices=GRADE_CHOICES)
    term = models.CharField(max_length=20, choices=TERM_CHOICES)
    academic_year = models.CharField(max_length=20)
    
    # Fee breakdown
    tuition_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    boarding_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    activity_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    exam_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    library_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    medical_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    sports_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    development_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    
    # Additional charges
    other_charges = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    late_payment_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        unique_together = ['grade', 'term', 'academic_year']
        ordering = ['academic_year', 'term', 'grade']
    
    def __str__(self):
        return f"{self.name} - {self.grade} {self.term} {self.academic_year}"
    
    @property
    def total_fee(self):
        total = sum([
            self.tuition_fee,
            self.boarding_fee,
            self.activity_fee,
            self.exam_fee,
            self.library_fee,
            self.medical_fee,
            self.sports_fee,
            self.development_fee,
            self.other_charges,
        ])
        return total

class StudentFee(models.Model):
    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='fees')
    fee_structure = models.ForeignKey(FeeStructure, on_delete=models.CASCADE, related_name='student_fees')
    
    # Payment status
    amount_due = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    amount_paid = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    balance = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    
    # Additional charges specific to student
    additional_charges = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    penalty_charges = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    
    # Payment status
    is_paid = models.BooleanField(default=False)
    due_date = models.DateField()
    paid_date = models.DateField(null=True, blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        ordering = ['-due_date', 'student']
        unique_together = ['student', 'fee_structure']
    
    def __str__(self):
        return f"{self.student} - {self.fee_structure} - Balance: {self.balance}"
    
    def save(self, *args, **kwargs):
        # Calculate total amount due
        total_fee = self.fee_structure.total_fee
        self.amount_due = total_fee + self.additional_charges + self.penalty_charges
        
        # Calculate balance
        self.balance = self.amount_due - self.amount_paid
        
        # Update payment status
        self.is_paid = self.balance <= 0
        
        super().save(*args, **kwargs)
    
    @property
    def total_charges(self):
        return self.additional_charges + self.penalty_charges

class Payment(models.Model):
    PAYMENT_METHOD_CHOICES = (
        ('mpesa', 'M-Pesa'),
        ('bank', 'Bank Transfer'),
        ('cash', 'Cash'),
        ('cheque', 'Cheque'),
        ('other', 'Other'),
    )
    
    PAYMENT_STATUS_CHOICES = (
        ('pending', 'Pending'),
        ('completed', 'Completed'),
        ('failed', 'Failed'),
        ('cancelled', 'Cancelled'),
    )
    
    student_fee = models.ForeignKey(StudentFee, on_delete=models.CASCADE, related_name='payments')
    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='payments')
    
    # Payment details
    amount = models.DecimalField(max_digits=10, decimal_places=2, validators=[MinValueValidator(Decimal('0.01'))])
    payment_method = models.CharField(max_length=20, choices=PAYMENT_METHOD_CHOICES, default='mpesa')
    payment_date = models.DateTimeField(auto_now_add=True)
    transaction_id = models.CharField(max_length=100, unique=True, blank=True)
    receipt_number = models.CharField(max_length=100, blank=True)
    
    # M-Pesa specific fields
    mpesa_code = models.CharField(max_length=50, blank=True)
    phone_number = models.CharField(max_length=15, blank=True)
    
    # Status
    status = models.CharField(max_length=20, choices=PAYMENT_STATUS_CHOICES, default='pending')
    description = models.TextField(blank=True)
    
    confirmed_by = models.ForeignKey('accounts.User', on_delete=models.SET_NULL, null=True, blank=True)
    confirmed_at = models.DateTimeField(null=True, blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        ordering = ['-payment_date']
    
    def __str__(self):
        return f"{self.student} - {self.amount} - {self.payment_method} - {self.status}"

class AdditionalCharge(models.Model):
    CHARGE_TYPE_CHOICES = (
        ('library', 'Library Fine'),
        ('damage', 'Damage Fee'),
        ('uniform', 'Uniform Fee'),
        ('book', 'Book Replacement'),
        ('sports', 'Sports Equipment'),
        ('trip', 'School Trip'),
        ('other', 'Other'),
    )
    
    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='additional_charges')
    charge_type = models.CharField(max_length=20, choices=CHARGE_TYPE_CHOICES)
    description = models.TextField()
    amount = models.DecimalField(max_digits=10, decimal_places=2, validators=[MinValueValidator(Decimal('0.01'))])
    
    # Status
    is_paid = models.BooleanField(default=False)
    due_date = models.DateField()
    paid_date = models.DateField(null=True, blank=True)
    
    added_by = models.ForeignKey('accounts.User', on_delete=models.SET_NULL, null=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        ordering = ['-due_date', 'student']
    
    def __str__(self):
        return f"{self.student} - {self.charge_type} - {self.amount}"

class PaymentReceipt(models.Model):
    payment = models.OneToOneField(Payment, on_delete=models.CASCADE, related_name='receipt')
    receipt_number = models.CharField(max_length=50, unique=True)
    generated_at = models.DateTimeField(auto_now_add=True)
    pdf_file = models.FileField(upload_to='receipts/', null=True, blank=True)
    
    def __str__(self):
        return f"Receipt {self.receipt_number} - {self.payment}"
    
    def generate_receipt_number(self):
        from datetime import datetime
        date_str = datetime.now().strftime('%Y%m%d')
        return f"RCPT-{date_str}-{self.id:06d}"
    
    def save(self, *args, **kwargs):
        if not self.receipt_number:
            self.receipt_number = self.generate_receipt_number()
        super().save(*args, **kwargs)\n\n========== FILE: ./payments/mpesa.py ==========\n
import requests
import base64
from datetime import datetime
from django.conf import settings
import json

class MpesaAPI:
    def __init__(self):
        self.consumer_key = settings.MPESA_CONFIG.get('CONSUMER_KEY', '')
        self.consumer_secret = settings.MPESA_CONFIG.get('CONSUMER_SECRET', '')
        self.shortcode = settings.MPESA_CONFIG.get('SHORTCODE', '')
        self.passkey = settings.MPESA_CONFIG.get('PASSKEY', '')
        self.callback_url = settings.MPESA_CONFIG.get('CALLBACK_URL', '')
        self.environment = settings.MPESA_CONFIG.get('ENVIRONMENT', 'sandbox')
        
        if self.environment == 'sandbox':
            self.base_url = 'https://sandbox.safaricom.co.ke'
        else:
            self.base_url = 'https://api.safaricom.co.ke'
        
        self.access_token = None
        self.token_expiry = None
    
    def get_access_token(self):
        """Get OAuth access token from Safaricom API"""
        try:
            url = f"{self.base_url}/oauth/v1/generate?grant_type=client_credentials"
            auth_string = f"{self.consumer_key}:{self.consumer_secret}"
            encoded_auth = base64.b64encode(auth_string.encode()).decode()
            
            headers = {
                'Authorization': f'Basic {encoded_auth}'
            }
            
            response = requests.get(url, headers=headers, timeout=30)
            
            if response.status_code == 200:
                data = response.json()
                self.access_token = data['access_token']
                self.token_expiry = datetime.now().timestamp() + data['expires_in']
                return self.access_token
            else:
                print(f"Token Error: {response.status_code} - {response.text}")
                return None
                
        except Exception as e:
            print(f"Token Exception: {str(e)}")
            return None
    
    def stk_push(self, phone_number, amount, account_reference, transaction_desc):
        """Initiate STK Push payment request"""
        try:
            if not self.access_token or datetime.now().timestamp() >= self.token_expiry:
                if not self.get_access_token():
                    return {'success': False, 'error': 'Failed to get access token'}
            
            url = f"{self.base_url}/mpesa/stkpush/v1/processrequest"
            
            timestamp = datetime.now().strftime('%Y%m%d%H%M%S')
            password = base64.b64encode(
                f"{self.shortcode}{self.passkey}{timestamp}".encode()
            ).decode()
            
            payload = {
                "BusinessShortCode": self.shortcode,
                "Password": password,
                "Timestamp": timestamp,
                "TransactionType": "CustomerPayBillOnline",
                "Amount": str(int(amount)),
                "PartyA": phone_number,
                "PartyB": self.shortcode,
                "PhoneNumber": phone_number,
                "CallBackURL": self.callback_url,
                "AccountReference": account_reference,
                "TransactionDesc": transaction_desc
            }
            
            headers = {
                'Authorization': f'Bearer {self.access_token}',
                'Content-Type': 'application/json'
            }
            
            response = requests.post(url, json=payload, headers=headers, timeout=30)
            
            if response.status_code == 200:
                data = response.json()
                if data.get('ResponseCode') == '0':
                    return {
                        'success': True,
                        'response_code': data.get('ResponseCode'),
                        'merchant_request_id': data.get('MerchantRequestID'),
                        'checkout_request_id': data.get('CheckoutRequestID'),
                        'response_description': data.get('ResponseDescription'),
                        'customer_message': data.get('CustomerMessage')
                    }
                else:
                    return {
                        'success': False,
                        'error': data.get('ResponseDescription', 'Payment request failed'),
                        'response_code': data.get('ResponseCode')
                    }
            else:
                return {
                    'success': False,
                    'error': f"HTTP {response.status_code}",
                    'details': response.text
                }
                
        except Exception as e:
            return {
                'success': False,
                'error': str(e)
            }
    
    def check_transaction_status(self, checkout_request_id):
        """Check status of a transaction"""
        try:
            if not self.access_token or datetime.now().timestamp() >= self.token_expiry:
                if not self.get_access_token():
                    return {'success': False, 'error': 'Failed to get access token'}
            
            url = f"{self.base_url}/mpesa/stkpushquery/v1/query"
            
            timestamp = datetime.now().strftime('%Y%m%d%H%M%S')
            password = base64.b64encode(
                f"{self.shortcode}{self.passkey}{timestamp}".encode()
            ).decode()
            
            payload = {
                "BusinessShortCode": self.shortcode,
                "Password": password,
                "Timestamp": timestamp,
                "CheckoutRequestID": checkout_request_id
            }
            
            headers = {
                'Authorization': f'Bearer {self.access_token}',
                'Content-Type': 'application/json'
            }
            
            response = requests.post(url, json=payload, headers=headers, timeout=30)
            
            if response.status_code == 200:
                data = response.json()
                return {
                    'success': True,
                    'data': data
                }
            else:
                return {
                    'success': False,
                    'error': f"HTTP {response.status_code}",
                    'details': response.text
                }
                
        except Exception as e:
            return {
                'success': False,
                'error': str(e)
            }
    
    def validate_callback_data(self, callback_data):
        """Validate M-Pesa callback data"""
        try:
            if not callback_data:
                return False, "Empty callback data"
            
            # Check required fields
            required_fields = ['Body', 'stkCallback']
            for field in required_fields:
                if field not in callback_data:
                    return False, f"Missing required field: {field}"
            
            stk_callback = callback_data['Body']['stkCallback']
            required_callback_fields = ['ResultCode', 'ResultDesc', 'CheckoutRequestID']
            
            for field in required_callback_fields:
                if field not in stk_callback:
                    return False, f"Missing required callback field: {field}"
            
            return True, "Valid callback data"
            
        except Exception as e:
            return False, f"Validation error: {str(e)}"
    
    def parse_callback_result(self, callback_data):
        """Parse callback result and extract payment details"""
        try:
            stk_callback = callback_data['Body']['stkCallback']
            
            result_code = stk_callback.get('ResultCode')
            result_desc = stk_callback.get('ResultDesc')
            checkout_request_id = stk_callback.get('CheckoutRequestID')
            
            # Extract payment details if successful
            mpesa_code = None
            amount = None
            phone_number = None
            
            if result_code == '0':
                callback_metadata = stk_callback.get('CallbackMetadata', {}).get('Item', [])
                
                for item in callback_metadata:
                    if item.get('Name') == 'MpesaReceiptNumber':
                        mpesa_code = item.get('Value')
                    elif item.get('Name') == 'Amount':
                        amount = item.get('Value')
                    elif item.get('Name') == 'PhoneNumber':
                        phone_number = item.get('Value')
            
            return {
                'success': result_code == '0',
                'result_code': result_code,
                'result_desc': result_desc,
                'checkout_request_id': checkout_request_id,
                'mpesa_code': mpesa_code,
                'amount': amount,
                'phone_number': phone_number
            }
            
        except Exception as e:
            return {
                'success': False,
                'error': f"Parse error: {str(e)}"
            }\n\n========== FILE: ./payments/signals.py ==========\n
from django.db.models.signals import post_save, pre_save
from django.dispatch import receiver
from django.utils import timezone
from .models import Payment, StudentFee, AdditionalCharge
from django.db.models import Sum

@receiver(post_save, sender=Payment)
def update_student_fee_on_payment(sender, instance, created, **kwargs):
    """
    Update student fee balance when a payment is saved
    """
    if instance.status == 'completed' and instance.student_fee:
        # Get the student fee
        student_fee = instance.student_fee
        
        # Recalculate total paid amount for this fee
        total_paid = Payment.objects.filter(
            student_fee=student_fee,
            status='completed'
        ).aggregate(total=Sum('amount'))['total'] or 0
        
        # Update the student fee
        student_fee.amount_paid = total_paid
        student_fee.save()
        
        # If the fee is now fully paid, update paid_date
        if student_fee.is_paid and not student_fee.paid_date:
            student_fee.paid_date = timezone.now().date()
            student_fee.save()

@receiver(post_save, sender=AdditionalCharge)
def update_student_fee_on_charge(sender, instance, created, **kwargs):
    """
    Update student fee when an additional charge is added
    """
    if created and not instance.is_paid:
        # Find the most recent active fee structure for the student
        student_fee = StudentFee.objects.filter(
            student=instance.student,
            fee_structure__is_active=True
        ).first()
        
        if student_fee:
            # Add the charge amount to the student fee
            student_fee.additional_charges += instance.amount
            student_fee.save()

@receiver(pre_save, sender=StudentFee)
def calculate_fee_totals(sender, instance, **kwargs):
    """
    Calculate fee totals before saving
    """
    if not instance.pk:  # New instance
        # Calculate initial amount due
        if instance.fee_structure:
            instance.amount_due = instance.fee_structure.total_fee + instance.additional_charges + instance.penalty_charges
            instance.balance = instance.amount_due - instance.amount_paid
            instance.is_paid = instance.balance <= 0

@receiver(post_save, sender=Payment)
def create_receipt_on_payment_completion(sender, instance, created, **kwargs):
    """
    Create a receipt when payment is completed
    """
    if instance.status == 'completed':
        # Check if receipt already exists
        from .models import PaymentReceipt
        receipt, created = PaymentReceipt.objects.get_or_create(
            payment=instance,
            defaults={'receipt_number': ''}
        )
        
        if created:
            # Generate receipt number if not already set
            if not receipt.receipt_number:
                receipt.save()  # This will trigger the receipt number generation

@receiver(post_save, sender=StudentFee)
def apply_late_payment_penalty(sender, instance, **kwargs):
    """
    Apply late payment penalty if due date has passed
    """
    if not instance.is_paid and instance.due_date < timezone.now().date():
        # Check if penalty already applied
        penalty_applied = AdditionalCharge.objects.filter(
            student=instance.student,
            charge_type='other',
            description__contains='Late payment penalty'
        ).exists()
        
        if not penalty_applied and instance.fee_structure.late_payment_fee > 0:
            # Apply late payment penalty
            AdditionalCharge.objects.create(
                student=instance.student,
                charge_type='other',
                description=f'Late payment penalty for {instance.fee_structure.term} {instance.fee_structure.academic_year}',
                amount=instance.fee_structure.late_payment_fee,
                due_date=instance.due_date,
                added_by=None  # System-generated
            )\n\n========== FILE: ./payments/templates/payments/additional_charge_form.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<h2>Add Additional Charge</h2>

<form method="post" style="max-width: 600px;">
    {% csrf_token %}
    
    {% for field in form %}
    <div style="margin-bottom: 15px;">
        <label for="{{ field.id_for_label }}" style="display: block; margin-bottom: 5px;">
            {{ field.label }}:
        </label>
        {{ field }}
        {% if field.errors %}
            <div style="color: red; font-size: 12px;">{{ field.errors }}</div>
        {% endif %}
        {% if field.help_text %}
            <div style="color: #666; font-size: 12px;">{{ field.help_text }}</div>
        {% endif %}
    </div>
    {% endfor %}
    
    <div style="margin-top: 20px;">
        <button type="submit" style="background-color: #4CAF50; color: white; padding: 10px 20px; border: none; cursor: pointer; margin-right: 10px;">Add Charge</button>
        <a href="{% url 'student_fee_list' %}" style="background-color: #757575; color: white; padding: 10px 20px; text-decoration: none;">Cancel</a>
    </div>
</form>

<div style="background-color: #fff3e0; padding: 15px; border-radius: 5px; margin-top: 30px;">
    <h4>Charge Types:</h4>
    <ul>
        <li><strong>Library Fine:</strong> For overdue books or lost library materials</li>
        <li><strong>Damage Fee:</strong> For damaged school property or equipment</li>
        <li><strong>Uniform Fee:</strong> For replacement of lost or damaged uniforms</li>
        <li><strong>Book Replacement:</strong> For lost or damaged textbooks</li>
        <li><strong>Sports Equipment:</strong> For lost or damaged sports gear</li>
        <li><strong>School Trip:</strong> For educational trips and excursions</li>
        <li><strong>Other:</strong> Any other miscellaneous charges</li>
    </ul>
    <p><strong>Note:</strong> Additional charges are automatically added to the student's current fee balance.</p>
</div>
{% endblock %}\n\n========== FILE: ./payments/templates/payments/assign_fee_form.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<h2>Assign Fee to Student</h2>

<form method="post" style="max-width: 600px;">
    {% csrf_token %}
    
    {% for field in form %}
    <div style="margin-bottom: 15px;">
        <label for="{{ field.id_for_label }}" style="display: block; margin-bottom: 5px;">
            {{ field.label }}:
        </label>
        {{ field }}
        {% if field.errors %}
            <div style="color: red; font-size: 12px;">{{ field.errors }}</div>
        {% endif %}
        {% if field.help_text %}
            <div style="color: #666; font-size: 12px;">{{ field.help_text }}</div>
        {% endif %}
    </div>
    {% endfor %}
    
    <!-- Initial Payment Field -->
    <div style="margin-bottom: 15px;">
        <label for="initial_payment" style="display: block; margin-bottom: 5px;">
            Initial Payment (Optional):
        </label>
        <input type="number" name="initial_payment" id="initial_payment" step="0.01" min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <small style="color: #666;">Enter any initial payment amount if applicable</small>
    </div>
    
    <div style="margin-top: 20px;">
        <button type="submit" style="background-color: #4CAF50; color: white; padding: 10px 20px; border: none; cursor: pointer; margin-right: 10px;">Assign Fee</button>
        <a href="{% url 'student_fee_list' %}" style="background-color: #757575; color: white; padding: 10px 20px; text-decoration: none;">Cancel</a>
    </div>
</form>

<div style="background-color: #e8f5e9; padding: 15px; border-radius: 5px; margin-top: 30px;">
    <h4>Instructions:</h4>
    <ol>
        <li>Select the student from the dropdown</li>
        <li>Choose the appropriate fee structure</li>
        <li>Add any additional or penalty charges if applicable</li>
        <li>Set the due date for payment</li>
        <li>Optionally enter any initial payment amount</li>
        <li>Click "Assign Fee" to save</li>
    </ol>
</div>
{% endblock %}\n\n========== FILE: ./payments/templates/payments/fee_structure_form.html ==========\n
{% extends 'accounts/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header Card -->
            <div class="card shadow-lg border-0 mb-4" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <div class="card-body text-white p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-2">
                                <i class="fas fa-money-bill-wave me-2"></i>{{ title }} Fee Structure
                            </h1>
                            <p class="mb-0 opacity-75">Configure and manage fee structures for different grades and terms</p>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-light text-success px-3 py-2 rounded-pill">
                                <i class="fas fa-calculator me-1"></i> Financial Setup
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Card -->
            <div class="card shadow-lg border-0 mb-4">
                <form method="post" class="p-4">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        {% for error in form.non_field_errors %}
                        {{ error }}
                        {% endfor %}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endif %}
                    
                    <div class="row g-4 mb-4">
                        <!-- Left Column - Basic Information -->
                        <div class="col-lg-6">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-header bg-light border-0">
                                    <h5 class="mb-0">
                                        <i class="fas fa-info-circle text-primary me-2"></i>Basic Information
                                    </h5>
                                </div>
                                <div class="card-body">
                                    {% for field in form %}
                                        {% if field.name in 'name,description,grade,term,academic_year,is_active' %}
                                        <div class="mb-3">
                                            <label for="{{ field.id_for_label }}" class="form-label fw-semibold">
                                                <i class="fas fa-{{ field.name|slice:'0:1'|lower }} me-1 text-primary"></i>
                                                {{ field.label }} {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                                            </label>
                                            {{ field }}
                                            {% if field.help_text %}
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>{{ field.help_text }}
                                            </div>
                                            {% endif %}
                                            {% if field.errors %}
                                            <div class="text-danger small mt-1">
                                                <i class="fas fa-exclamation-circle me-1"></i>{{ field.errors }}
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column - Main Fees -->
                        <div class="col-lg-6">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-header bg-light border-0">
                                    <h5 class="mb-0">
                                        <i class="fas fa-money-bill text-success me-2"></i>Main Fees
                                    </h5>
                                </div>
                                <div class="card-body">
                                    {% for field in form %}
                                        {% if field.name in 'tuition_fee,boarding_fee,activity_fee,exam_fee' %}
                                        <div class="mb-3">
                                            <label for="{{ field.id_for_label }}" class="form-label fw-semibold">
                                                <i class="fas fa-coins me-1 text-warning"></i>
                                                {{ field.label }}
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text bg-light">Ksh</span>
                                                {{ field }}
                                            </div>
                                            {% if field.errors %}
                                            <div class="text-danger small mt-1">
                                                <i class="fas fa-exclamation-circle me-1"></i>{{ field.errors }}
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Fees -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-light border-0">
                            <h5 class="mb-0">
                                <i class="fas fa-plus-circle text-info me-2"></i>Additional Fees
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-4">
                                {% for field in form %}
                                    {% if field.name in 'library_fee,medical_fee,sports_fee,development_fee,other_charges,late_payment_fee' %}
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ field.id_for_label }}" class="form-label fw-semibold">
                                                <i class="fas fa-file-invoice-dollar me-1 text-secondary"></i>
                                                {{ field.label }}
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text bg-light">Ksh</span>
                                                {{ field }}
                                            </div>
                                            {% if field.errors %}
                                            <div class="text-danger small mt-1">
                                                <i class="fas fa-exclamation-circle me-1"></i>{{ field.errors }}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="d-flex justify-content-between align-items-center mt-4 pt-4 border-top">
                        <div>
                            <a href="{% url 'fee_structure_list' %}" class="btn btn-outline-secondary px-4">
                                <i class="fas fa-arrow-left me-2"></i>Back to List
                            </a>
                            <button type="reset" class="btn btn-outline-warning ms-2">
                                <i class="fas fa-redo me-2"></i>Reset Form
                            </button>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-success btn-lg px-5">
                                <i class="fas fa-save me-2"></i>Save Fee Structure
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Summary Card (Only for Update) -->
            {% if title == 'Update' %}
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="card-body text-white p-4">
                    <h4 class="mb-4">
                        <i class="fas fa-chart-bar me-2"></i>Fee Structure Summary
                    </h4>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="p-3 bg-white bg-opacity-10 rounded">
                                <h6 class="mb-1 opacity-75">Total Fee</h6>
                                <h3 class="mb-0">Ksh {{ form.instance.total_fee|floatformat:2 }}</h3>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="p-3 bg-white bg-opacity-10 rounded">
                                <h6 class="mb-1 opacity-75">Status</h6>
                                <h3 class="mb-0">
                                    {% if form.instance.is_active %}
                                    <span class="badge bg-success px-3 py-2">Active</span>
                                    {% else %}
                                    <span class="badge bg-danger px-3 py-2">Inactive</span>
                                    {% endif %}
                                </h3>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="p-3 bg-white bg-opacity-10 rounded">
                                <h6 class="mb-1 opacity-75">Created</h6>
                                <h4 class="mb-0">{{ form.instance.created_at|date:"M d, Y" }}</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    select, input[type="text"], input[type="number"], textarea {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        transition: all 0.3s ease;
        background-color: #f8fafc;
    }
    
    select:focus, input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
        border-color: #43e97b;
        box-shadow: 0 0 0 3px rgba(67, 233, 123, 0.1);
        background-color: white;
        outline: none;
    }
    
    textarea {
        min-height: 100px;
        resize: vertical;
    }
    
    .input-group-text {
        background-color: #f8f9fa;
        border: 2px solid #e2e8f0;
        border-right: none;
        color: #495057;
        font-weight: 500;
    }
    
    .input-group .form-control {
        border-left: none;
    }
    
    .form-label {
        color: #2d3748;
        margin-bottom: 8px;
        font-weight: 600;
    }
    
    .form-check-input:checked {
        background-color: #43e97b;
        border-color: #43e97b;
    }
    
    .card {
        border-radius: 15px;
        overflow: hidden;
        transition: transform 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
    }
    
    .btn-success {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        border: none;
        border-radius: 10px;
        padding: 12px 30px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(67, 233, 123, 0.4);
    }
    
    .btn-outline-secondary {
        border-radius: 10px;
        padding: 10px 25px;
        font-weight: 500;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-calculate total fee
    const feeInputs = document.querySelectorAll('input[type="number"]');
    const totalFeeDisplay = document.querySelector('[data-total-fee]');
    
    function calculateTotalFee() {
        let total = 0;
        feeInputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            total += value;
        });
        
        if (totalFeeDisplay) {
            totalFeeDisplay.textContent = 'Ksh ' + total.toFixed(2);
        }
    }
    
    feeInputs.forEach(input => {
        input.addEventListener('input', calculateTotalFee);
    });
    
    // Initialize calculation
    calculateTotalFee();
});
</script>
{% endblock %}\n\n========== FILE: ./payments/templates/payments/fee_structure_list.html ==========\n
{% extends 'accounts/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-2">
                <i class="fas fa-money-bill-wave text-primary me-2"></i>Fee Structures
            </h1>
            <p class="text-muted mb-0">Manage and view all fee structures in the system</p>
        </div>
        <div>
            <a href="{% url 'fee_structure_create' %}" class="btn btn-primary">
                <i class="fas fa-plus-circle me-2"></i>Create New Fee Structure
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-left-primary shadow-sm h-100 py-3">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-semibold text-primary mb-1">
                                Total Structures
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">
                                {{ fee_structures.count }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-layer-group fa-2x text-primary opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card border-left-success shadow-sm h-100 py-3">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-semibold text-success mb-1">
                                Active Structures
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">
                                {{ fee_structures|length }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-success opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card border-left-info shadow-sm h-100 py-3">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-semibold text-info mb-1">
                                Average Fee
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">
                                {% with total=0 %}
                                    {% for fee in fee_structures %}
                                        {% widthratio fee.total_fee 1 1 as fee_total %}
                                        {{ fee_total|add:total }}
                                    {% endfor %}
                                {% endwith %}
                                Ksh
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calculator fa-2x text-info opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card border-left-warning shadow-sm h-100 py-3">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-semibold text-warning mb-1">
                                Academic Years
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">
                                {{ fee_structures|slice:":5"|length }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-alt fa-2x text-warning opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fee Structures Table -->
    <div class="card shadow-lg border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">
                                <i class="fas fa-signature me-2 text-primary"></i>Name
                            </th>
                            <th>
                                <i class="fas fa-graduation-cap me-2 text-primary"></i>Grade
                            </th>
                            <th>
                                <i class="fas fa-calendar me-2 text-primary"></i>Term
                            </th>
                            <th>
                                <i class="fas fa-calendar-alt me-2 text-primary"></i>Year
                            </th>
                            <th>
                                <i class="fas fa-money-bill me-2 text-primary"></i>Total Fee
                            </th>
                            <th>
                                <i class="fas fa-circle me-2 text-primary"></i>Status
                            </th>
                            <th class="pe-4">
                                <i class="fas fa-cog me-2 text-primary"></i>Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fee in fee_structures %}
                        <tr>
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="avatar-circle bg-primary bg-opacity-10 text-primary">
                                            <i class="fas fa-file-invoice-dollar"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0">{{ fee.name }}</h6>
                                        <small class="text-muted">{{ fee.description|truncatechars:30|default:"No description" }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-1">
                                    {{ fee.get_grade_display }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-info bg-opacity-10 text-info px-3 py-1">
                                    {{ fee.get_term_display }}
                                </span>
                            </td>
                            <td>
                                <span class="fw-medium">{{ fee.academic_year }}</span>
                            </td>
                            <td class="fw-bold text-end pe-3">
                                <span class="badge bg-success bg-opacity-10 text-success px-3 py-2">
                                    Ksh {{ fee.total_fee|floatformat:2 }}
                                </span>
                            </td>
                            <td>
                                {% if fee.is_active %}
                                <span class="badge bg-success px-3 py-1">
                                    <i class="fas fa-check-circle me-1"></i>Active
                                </span>
                                {% else %}
                                <span class="badge bg-danger px-3 py-1">
                                    <i class="fas fa-times-circle me-1"></i>Inactive
                                </span>
                                {% endif %}
                            </td>
                            <td class="pe-4">
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'fee_structure_update' fee.pk %}" 
                                       class="btn btn-outline-primary" 
                                       title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" 
                                            class="btn btn-outline-info"
                                            title="View Details"
                                            onclick="viewFeeDetails('{{ fee.id }}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button type="button" 
                                            class="btn btn-outline-success"
                                            title="Duplicate">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <div class="py-4">
                                    <i class="fas fa-file-invoice-dollar fa-3x text-muted mb-3"></i>
                                    <h4 class="text-muted">No Fee Structures Found</h4>
                                    <p class="text-muted">Create your first fee structure to get started</p>
                                    <a href="{% url 'fee_structure_create' %}" class="btn btn-primary mt-2">
                                        <i class="fas fa-plus-circle me-2"></i>Create First Structure
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    .avatar-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
    }
    
    .border-left-primary {
        border-left: 4px solid #4e73df !important;
    }
    
    .border-left-success {
        border-left: 4px solid #1cc88a !important;
    }
    
    .border-left-info {
        border-left: 4px solid #36b9cc !important;
    }
    
    .border-left-warning {
        border-left: 4px solid #f6c23e !important;
    }
    
    .table tbody tr:hover {
        background-color: rgba(102, 126, 234, 0.05);
        transform: scale(1.002);
        transition: all 0.2s ease;
    }
    
    .btn-group .btn {
        border-radius: 6px !important;
        margin-right: 2px;
    }
</style>

<script>
function viewFeeDetails(feeId) {
    // This would be expanded to show modal with fee details
    alert('Viewing details for fee structure ID: ' + feeId);
    // In production, you might want to load details via AJAX
}
</script>
{% endblock %}\n\n========== FILE: ./payments/templates/payments/fee_summary.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<h2>Fee Summary</h2>

{% if user.is_admin %}
<div style="background-color: #e8f5e9; padding: 20px; border-radius: 5px; margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
        <div>
            <h3 style="margin-top: 0;">School Financial Overview</h3>
            <p><strong>Total Students with Fees:</strong> {{ student_fees.count }}</p>
        </div>
        <div style="text-align: right;">
            <p><strong>Total Outstanding Balance:</strong></p>
            <p style="font-size: 24px; font-weight: bold; color: #f44336;">
                Ksh {{ total_balance|default:"0.00"|floatformat:2 }}
            </p>
        </div>
    </div>
</div>
{% elif user.is_teacher %}
<div style="background-color: #e3f2fd; padding: 20px; border-radius: 5px; margin-bottom: 20px;">
    <h3 style="margin-top: 0;">My Classes Fee Summary</h3>
    <p><strong>Teacher:</strong> {{ user.get_full_name }}</p>
    <p><strong>Classes:</strong> {{ user.teacher_profile.classes }}</p>
</div>
{% elif user.is_student %}
<div style="background-color: #fff3e0; padding: 20px; border-radius: 5px; margin-bottom: 20px;">
    <h3 style="margin-top: 0;">My Fee Summary</h3>
    <p><strong>Student:</strong> {{ user.get_full_name }}</p>
    <p>View your complete financial details in the Financial Dashboard</p>
</div>
{% endif %}

{% if student_fees %}
<table style="width: 100%; border-collapse: collapse;">
    <thead>
        <tr style="background-color: #f2f2f2;">
            {% if user.is_admin or user.is_teacher %}
            <th style="border: 1px solid #ddd; padding: 8px;">Student</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Admission No</th>
            {% endif %}
            <th style="border: 1px solid #ddd; padding: 8px;">Fee Structure</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Amount Due</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Amount Paid</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Balance</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
            {% if user.is_admin %}
            <th style="border: 1px solid #ddd; padding: 8px;">Actions</th>
            {% endif %}
        </tr>
    </thead>
    <tbody>
        {% for fee in student_fees %}
        <tr>
            {% if user.is_admin or user.is_teacher %}
            <td style="border: 1px solid #ddd; padding: 8px;">{{ fee.student.user.get_full_name }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ fee.student.admission_number }}</td>
            {% endif %}
            <td style="border: 1px solid #ddd; padding: 8px;">{{ fee.fee_structure.name }}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ fee.amount_due|floatformat:2 }}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ fee.amount_paid|floatformat:2 }}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">
                {% if fee.balance > 0 %}
                    <span style="color: #f44336; font-weight: bold;">Ksh {{ fee.balance|floatformat:2 }}</span>
                {% else %}
                    <span style="color: #4CAF50;">Paid</span>
                {% endif %}
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                {% if fee.is_paid %}
                    <span style="color: #4CAF50; font-weight: bold;">Paid</span>
                {% elif fee.balance > 0 %}
                    <span style="color: #FF9800;">Partial</span>
                {% else %}
                    <span style="color: #f44336;">Pending</span>
                {% endif %}
            </td>
            {% if user.is_admin %}
            <td style="border: 1px solid #ddd; padding: 8px;">
                <a href="{% url 'record_payment' %}?student={{ fee.student.id }}" style="background-color: #2196F3; color: white; padding: 5px 10px; text-decoration: none; margin-right: 5px;">Add Payment</a>
            </td>
            {% endif %}
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Summary Statistics -->
{% if user.is_admin or user.is_teacher %}
<div style="display: flex; gap: 20px; margin-top: 30px; flex-wrap: wrap;">
    <div style="background-color: #ffebee; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px;">
        <h4 style="margin-top: 0;">Payment Status</h4>
        <p><strong>Fully Paid:</strong> {{ fully_paid_count|default:"0" }}</p>
        <p><strong>Partially Paid:</strong> {{ partially_paid_count|default:"0" }}</p>
        <p><strong>Not Paid:</strong> {{ not_paid_count|default:"0" }}</p>
    </div>
    
    <div style="background-color: #e8f5e9; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px;">
        <h4 style="margin-top: 0;">Financial Summary</h4>
        <p><strong>Total Due:</strong> Ksh {{ total_due|default:"0.00"|floatformat:2 }}</p>
        <p><strong>Total Paid:</strong> Ksh {{ total_paid|default:"0.00"|floatformat:2 }}</p>
        <p><strong>Collection Rate:</strong> {{ collection_rate|default:"0"|floatformat:1 }}%</p>
    </div>
    
    <div style="background-color: #e3f2fd; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px;">
        <h4 style="margin-top: 0;">Actions</h4>
        {% if user.is_admin %}
            <a href="{% url 'student_fee_list' %}" style="display: block; background-color: #4CAF50; color: white; padding: 10px; text-decoration: none; text-align: center; margin-bottom: 10px;">
                Manage Fees
            </a>
            <a href="{% url 'payment_list' %}" style="display: block; background-color: #2196F3; color: white; padding: 10px; text-decoration: none; text-align: center;">
                View Payments
            </a>
        {% endif %}
    </div>
</div>
{% endif %}

{% else %}
<div style="background-color: #f5f5f5; padding: 40px; text-align: center; border-radius: 5px;">
    <h3>No Fee Data Available</h3>
    <p>
        {% if user.is_admin %}
            No student fees have been assigned yet.
            <a href="{% url 'student_fee_list' %}" style="color: #2196F3;">Assign fees to students</a>
        {% elif user.is_teacher %}
            No students in your classes have fee assignments.
        {% else %}
            No fee information available for your account.
        {% endif %}
    </p>
</div>
{% endif %}

<div style="background-color: #f9f9f9; padding: 15px; border-radius: 5px; margin-top: 30px;">
    <h4>Notes:</h4>
    <ul>
        {% if user.is_admin %}
            <li>This summary shows all student fee assignments</li>
            <li>Use the "Manage Fees" option for detailed fee management</li>
            <li>Collection rate = (Total Paid / Total Due) Ã— 100%</li>
        {% elif user.is_teacher %}
            <li>This summary shows fees for students in your classes only</li>
            <li>Contact the accounts office for detailed information</li>
        {% else %}
            <li>For detailed financial information, visit your Financial Dashboard</li>
            <li>Contact the accounts office for any fee-related queries</li>
        {% endif %}
    </ul>
</div>
{% endblock %}\n\n========== FILE: ./payments/templates/payments/financial_report.html ==========\n
{% extends 'accounts/base.html' %}
{% load static %}

{% block content %}
<h2>Financial Report</h2>

<!-- Date Filter -->
<div style="background-color: #f5f5f5; padding: 20px; border-radius: 5px; margin-bottom: 20px;">
    <h3 style="margin-top: 0;">Report Period</h3>
    <form method="get" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
        <div>
            <label for="from_date">From Date:</label>
            <input type="date" name="from_date" id="from_date" value="{{ from_date|date:'Y-m-d' }}" style="width: 100%; padding: 8px;">
        </div>
        <div>
            <label for="to_date">To Date:</label>
            <input type="date" name="to_date" id="to_date" value="{{ to_date|date:'Y-m-d' }}" style="width: 100%; padding: 8px;">
        </div>
        <div>
            <button type="submit" style="background-color: #2196F3; color: white; padding: 8px 20px; border: none; cursor: pointer;">Generate Report</button>
            <a href="{% url 'financial_report' %}" style="background-color: #757575; color: white; padding: 8px 20px; text-decoration: none; display: inline-block; margin-top: 5px;">Reset</a>
        </div>
    </form>
</div>

<!-- Summary Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div style="background-color: #e8f5e9; padding: 20px; border-radius: 5px;">
        <h4 style="margin-top: 0;">Total Payments (Period)</h4>
        <p style="font-size: 24px; font-weight: bold; color: #4CAF50;">
            Ksh {{ total_payments|floatformat:2 }}
        </p>
        <p>{{ payments.count }} transactions</p>
    </div>
    
    <div style="background-color: #e3f2fd; padding: 20px; border-radius: 5px;">
        <h4 style="margin-top: 0;">Total Fees Due</h4>
        <p style="font-size: 24px; font-weight: bold; color: #2196F3;">
            Ksh {{ total_due|floatformat:2 }}
        </p>
        <p>{{ student_fees.count }} students</p>
    </div>
    
    <div style="background-color: #e8fffd; padding: 20px; border-radius: 5px;">
        <h4 style="margin-top: 0;">Total Fees Paid</h4>
        <p style="font-size: 24px; font-weight: bold; color: #FF9800;">
            Ksh {{ total_paid_fees|floatformat:2 }}
        </p>
        <p>Collection rate</p>
    </div>
    
    <div style="background-color: #ffebee; padding: 20px; border-radius: 5px;">
        <h4 style="margin-top: 0;">Total Balance</h4>
        <p style="font-size: 24px; font-weight: bold; color: #f44336;">
            Ksh {{ total_balance|floatformat:2 }}
        </p>
        <p>Outstanding</p>
    </div>
</div>

<!-- Payment Methods Breakdown -->
<div style="background-color: #f9f9f9; padding: 20px; border-radius: 5px; margin-bottom: 30px;">
    <h3>Payment Methods Breakdown</h3>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background-color: #f2f2f2;">
                <th style="border: 1px solid #ddd; padding: 8px;">Payment Method</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Number of Payments</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Total Amount</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Percentage</th>
            </tr>
        </thead>
        <tbody>
            {% for method in payment_methods %}
            <tr>
                <td style="border: 1px solid #ddd; padding: 8px;">
                    {% if method.payment_method == 'mpesa' %}M-Pesa
                    {% elif method.payment_method == 'cash' %}Cash
                    {% elif method.payment_method == 'bank' %}Bank Transfer
                    {% elif method.payment_method == 'cheque' %}Cheque
                    {% else %}Other{% endif %}
                </td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">{{ method.count }}</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ method.total|floatformat:2 }}</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                    {{ method.total|floatformat:0|add:"0" }}{% widthratio method.total total_payments 100 as percentage %}{{ percentage|floatformat:1 }}%
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4" style="border: 1px solid #ddd; padding: 8px; text-align: center;">No payment data available</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Recent Payments -->
<div style="background-color: white; padding: 20px; border-radius: 5px; margin-bottom: 30px;">
    <h3>Recent Payments ({{ from_date|date:"M d, Y" }} to {{ to_date|date:"M d, Y" }})</h3>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background-color: #f2f2f2;">
                <th style="border: 1px solid #ddd; padding: 8px;">Date</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Student</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Amount</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Method</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Reference</th>
            </tr>
        </thead>
        <tbody>
            {% for payment in payments|slice:":10" %}
            <tr>
                <td style="border: 1px solid #ddd; padding: 8px;">{{ payment.payment_date|date:"M d, Y" }}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">{{ payment.student.user.get_full_name }}</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ payment.amount|floatformat:2 }}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">{{ payment.get_payment_method_display }}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">
                    <span style="color: #4CAF50; font-weight: bold;">{{ payment.get_status_display }}</span>
                </td>
                <td style="border: 1px solid #ddd; padding: 8px;">
                    {% if payment.transaction_id %}
                        <small>{{ payment.transaction_id|truncatechars:15 }}</small>
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" style="border: 1px solid #ddd; padding: 8px; text-align: center;">No payments in this period</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    {% if payments.count > 10 %}
    <p style="text-align: center; margin-top: 10px;">
        Showing 10 of {{ payments.count }} payments
        <a href="{% url 'payment_list' %}?from_date={{ from_date|date:'Y-m-d' }}&to_date={{ to_date|date:'Y-m-d' }}" style="color: #2196F3;">
            View All
        </a>
    </p>
    {% endif %}
</div>

<!-- Export Options -->
<div style="background-color: #f5f5f5; padding: 20px; border-radius: 5px;">
    <h3 style="margin-top: 0;">Export Report</h3>
    <div style="display: flex; gap: 10px;">
        <a href="#" style="background-color: #4CAF50; color: white; padding: 10px 20px; text-decoration: none;">
            Export as PDF
        </a>
        <a href="#" style="background-color: #2196F3; color: white; padding: 10px 20px; text-decoration: none;">
            Export as Excel
        </a>
        <button onclick="openPrintPreview()" style="background-color: #FF9800; color: white; padding: 10px 20px; border: none; cursor: pointer; text-decoration: none;">
            Print Report
        </button>
    </div>
</div>

<!-- Print Preview Modal -->
<div id="printPreviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; width: 80%; max-width: 900px; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
            <h3 style="margin: 0;">Print Preview</h3>
            <button onclick="closePrintPreview()" style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">Close</button>
        </div>
        
        <div id="printContent" style="background: white; padding: 20px;">
            <!-- Print content will be inserted here -->
        </div>
        
        <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #eee; text-align: center;">
            <button onclick="printReport()" style="background-color: #4CAF50; color: white; padding: 10px 30px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                <i class="fas fa-print"></i> Print Now
            </button>
            <button onclick="closePrintPreview()" style="background-color: #757575; color: white; padding: 10px 30px; border: none; border-radius: 5px; cursor: pointer;">
                Cancel
            </button>
        </div>
    </div>
</div>

<style>
    @media print {
        body * {
            visibility: hidden;
        }
        #printContent, #printContent * {
            visibility: visible;
        }
        #printContent {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
        .no-print {
            display: none !important;
        }
    }
    
    #printContent table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    
    #printContent th, #printContent td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    
    #printContent th {
        background-color: #f2f2f2;
        font-weight: bold;
    }
</style>

<script>
function openPrintPreview() {
    // Create print content
    const printContent = document.getElementById('printContent');
    const currentDate = new Date().toLocaleDateString();
    
    printContent.innerHTML = `
        <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #2c3e50; margin-bottom: 5px;">Sample School Financial Report</h1>
            <p style="color: #7f8c8d; margin-bottom: 10px;">Period: {{ from_date|date:"M d, Y" }} to {{ to_date|date:"M d, Y" }}</p>
            <p style="color: #7f8c8d; font-size: 12px;">Generated on: ${currentDate}</p>
            <hr style="margin: 20px 0;">
        </div>
        
        <div style="margin-bottom: 30px;">
            <h3 style="color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 5px;">Summary</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px;">
                    <strong>Total Payments</strong><br>
                    <span style="font-size: 20px; color: #27ae60;">Ksh {{ total_payments|floatformat:2 }}</span>
                </div>
                <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px;">
                    <strong>Total Fees Due</strong><br>
                    <span style="font-size: 20px; color: #3498db;">Ksh {{ total_due|floatformat:2 }}</span>
                </div>
                <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px;">
                    <strong>Total Paid</strong><br>
                    <span style="font-size: 20px; color: #f39c12;">Ksh {{ total_paid_fees|floatformat:2 }}</span>
                </div>
                <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px;">
                    <strong>Total Balance</strong><br>
                    <span style="font-size: 20px; color: #e74c3c;">Ksh {{ total_balance|floatformat:2 }}</span>
                </div>
            </div>
        </div>
        
        <div style="margin-bottom: 30px;">
            <h3 style="color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 5px;">Payment Methods</h3>
            <table>
                <thead>
                    <tr>
                        <th>Payment Method</th>
                        <th>Number of Payments</th>
                        <th>Total Amount</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for method in payment_methods %}
                    <tr>
                        <td>
                            {% if method.payment_method == 'mpesa' %}M-Pesa
                            {% elif method.payment_method == 'cash' %}Cash
                            {% elif method.payment_method == 'bank' %}Bank Transfer
                            {% elif method.payment_method == 'cheque' %}Cheque
                            {% else %}Other{% endif %}
                        </td>
                        <td style="text-align: center;">{{ method.count }}</td>
                        <td style="text-align: right;">Ksh {{ method.total|floatformat:2 }}</td>
                        <td style="text-align: center;">
                            {{ method.total|floatformat:0|add:"0" }}{% widthratio method.total total_payments 100 as percentage %}{{ percentage|floatformat:1 }}%
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" style="text-align: center;">No payment data available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div style="margin-bottom: 30px;">
            <h3 style="color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 5px;">Recent Payments</h3>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Student</th>
                        <th>Amount</th>
                        <th>Method</th>
                        <th>Status</th>
                        <th>Reference</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in payments|slice:":10" %}
                    <tr>
                        <td>{{ payment.payment_date|date:"M d, Y" }}</td>
                        <td>{{ payment.student.user.get_full_name }}</td>
                        <td style="text-align: right;">Ksh {{ payment.amount|floatformat:2 }}</td>
                        <td>{{ payment.get_payment_method_display }}</td>
                        <td>{{ payment.get_status_display }}</td>
                        <td>{% if payment.transaction_id %}{{ payment.transaction_id|truncatechars:15 }}{% else %}-{% endif %}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" style="text-align: center;">No payments in this period</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 50px; padding-top: 20px; border-top: 2px solid #ddd; text-align: center; font-size: 12px; color: #7f8c8d;">
            <p>--- End of Report ---</p>
            <p>Generated by: {{ request.user.get_full_name|default:request.user.username }}</p>
            <p>Sample School Financial System | Page 1 of 1</p>
        </div>
    `;
    
    // Show modal
    document.getElementById('printPreviewModal').style.display = 'block';
}

function closePrintPreview() {
    document.getElementById('printPreviewModal').style.display = 'none';
}

function printReport() {
    // Create a new window for printing
    const printWindow = window.open('', '_blank', 'width=900,height=600');
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Sample School Financial Report</title>
            <style>
                @media print {
                    @page {
                        margin: 20mm;
                    }
                    body {
                        font-family: Arial, sans-serif;
                        font-size: 12pt;
                        line-height: 1.5;
                        color: #000;
                    }
                    h1, h2, h3 {
                        color: #2c3e50;
                    }
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        margin: 15px 0;
                        font-size: 11pt;
                    }
                    th, td {
                        border: 1px solid #ddd;
                        padding: 8px;
                        text-align: left;
                    }
                    th {
                        background-color: #f2f2f2;
                        font-weight: bold;
                    }
                    .summary-cards {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 15px;
                        margin: 20px 0;
                    }
                    .card {
                        border: 1px solid #ddd;
                        padding: 15px;
                        border-radius: 5px;
                    }
                    .footer {
                        margin-top: 50px;
                        padding-top: 20px;
                        border-top: 2px solid #ddd;
                        text-align: center;
                        font-size: 10pt;
                        color: #666;
                    }
                }
                @media screen {
                    body {
                        padding: 20px;
                        font-family: Arial, sans-serif;
                    }
                }
            </style>
        </head>
        <body>
            ${document.getElementById('printContent').innerHTML}
        </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.focus();
    
    // Wait for content to load, then print
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 500);
    
    // Close the preview modal
    closePrintPreview();
}

// Close modal when clicking outside
document.getElementById('printPreviewModal').addEventListener('click', function(e) {
    if (e.target.id === 'printPreviewModal') {
        closePrintPreview();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closePrintPreview();
    }
});
</script>
{% endblock %}\n\n========== FILE: ./payments/templates/payments/make_payment.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<h2>Make Payment</h2>

<div style="display: flex; gap: 30px;">
    <div style="flex: 1; background-color: #f9f9f9; padding: 20px; border-radius: 5px;">
        <h3>Current Balance</h3>
        <p><strong>Student:</strong> {{ student.user.get_full_name }}</p>
        <p><strong>Admission No:</strong> {{ student.admission_number }}</p>
        <p><strong>Current Term:</strong> {{ current_fee.fee_structure.term }} {{ current_fee.fee_structure.academic_year }}</p>
        <p style="font-size: 24px; color: #f44336; font-weight: bold;">
            Balance Due: Ksh {{ current_fee.balance|floatformat:2 }}
        </p>
        
        <div style="background-color: #fff3e0; padding: 15px; border-radius: 5px; margin-top: 20px;">
            <h4>Payment Instructions</h4>
            <ol>
                <li>Enter your M-Pesa phone number (format: 2547XXXXXXXX)</li>
                <li>Enter the amount you wish to pay</li>
                <li>Click "Initiate Payment"</li>
                <li>Check your phone for STK Push prompt</li>
                <li>Enter your M-Pesa PIN to complete payment</li>
            </ol>
        </div>
    </div>
    
    <div style="flex: 1;">
        <h3>M-Pesa Payment</h3>
        <form method="post" style="max-width: 400px;">
            {% csrf_token %}
            
            <div style="margin-bottom: 15px;">
                <label for="id_phone_number">M-Pesa Phone Number:</label>
                {{ form.phone_number }}
                {% if form.phone_number.errors %}
                    <div style="color: red; font-size: 12px;">{{ form.phone_number.errors }}</div>
                {% endif %}
                <small style="color: #666;">Format: 2547XXXXXXXX (12 digits)</small>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label for="id_amount">Amount (Ksh):</label>
                {{ form.amount }}
                {% if form.amount.errors %}
                    <div style="color: red; font-size: 12px;">{{ form.amount.errors }}</div>
                {% endif %}
                <small style="color: #666;">Maximum: Ksh {{ current_fee.balance|floatformat:2 }}</small>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label for="id_description">Description (Optional):</label>
                {{ form.description }}
            </div>
            
            <div style="margin-top: 20px;">
                <button type="submit" style="background-color: #4CAF50; color: white; padding: 10px 20px; border: none; cursor: pointer; margin-right: 10px;">
                    Initiate Payment
                </button>
                <a href="{% url 'student_financial_dashboard' %}" style="background-color: #757575; color: white; padding: 10px 20px; text-decoration: none;">
                    Cancel
                </a>
            </div>
        </form>
        
        <div style="background-color: #e8f5e9; padding: 15px; border-radius: 5px; margin-top: 20px;">
            <h4>Alternative Payment Methods</h4>
            <p>You can also make payments through:</p>
            <ul>
                <li>Bank Transfer (Contact accounts office for details)</li>
                <li>Cash payment at school accounts office</li>
                <li>Cheque payment</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}\n\n========== FILE: ./payments/templates/payments/payment_history.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<h2>My Payment History</h2>

{% if payments %}
<!-- Summary -->
<div style="background-color: #e8f5e9; padding: 20px; border-radius: 5px; margin-bottom: 30px;">
    <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
        <div>
            <h3 style="margin-top: 0;">{{ student.user.get_full_name }}</h3>
            <p><strong>Admission Number:</strong> {{ student.admission_number }}</p>
            <p><strong>Total Payments Made:</strong> {{ payments.count }}</p>
        </div>
        <div style="text-align: right;">
            <p><strong>Total Amount Paid:</strong></p>
            <p style="font-size: 28px; font-weight: bold; color: #4CAF50;">
                Ksh {{ total_paid|default:"0.00"|floatformat:2 }}
            </p>
        </div>
    </div>
</div>

<!-- Payment List -->
<table style="width: 100%; border-collapse: collapse;">
    <thead>
        <tr style="background-color: #f2f2f2;">
            <th style="border: 1px solid #ddd; padding: 8px;">Date</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Term</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Amount</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Method</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Reference</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for payment in payments %}
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ payment.payment_date|date:"M d, Y" }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                {% if payment.student_fee %}
                    {{ payment.student_fee.fee_structure.term }} {{ payment.student_fee.fee_structure.academic_year }}
                {% else %}
                    -
                {% endif %}
            </td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right; font-weight: bold;">
                Ksh {{ payment.amount|floatformat:2 }}
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ payment.get_payment_method_display }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                <span style="
                    padding: 2px 8px;
                    border-radius: 3px;
                    color: white;
                    {% if payment.status == 'completed' %}background-color: #4CAF50;
                    {% elif payment.status == 'pending' %}background-color: #FF9800;
                    {% else %}background-color: #f44336;
                    {% endif %}
                ">
                    {{ payment.get_status_display }}
                </span>
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                {% if payment.transaction_id %}
                    <small>{{ payment.transaction_id|truncatechars:15 }}</small>
                {% elif payment.receipt_number %}
                    {{ payment.receipt_number }}
                {% else %}
                    -
                {% endif %}
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                {% if payment.status == 'completed' %}
                    <a href="#" style="background-color: #2196F3; color: white; padding: 5px 10px; text-decoration: none;">Receipt</a>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Statistics -->
<div style="display: flex; gap: 20px; margin-top: 30px; flex-wrap: wrap;">
    <div style="background-color: #e3f2fd; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px;">
        <h4 style="margin-top: 0;">By Payment Method</h4>
        <p><strong>M-Pesa:</strong> {{ mpesa_count|default:"0" }} payments</p>
        <p><strong>Cash:</strong> {{ cash_count|default:"0" }} payments</p>
        <p><strong>Bank:</strong> {{ bank_count|default:"0" }} payments</p>
    </div>
    
    <div style="background-color: #fff3e0; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px;">
        <h4 style="margin-top: 0;">Recent Activity</h4>
        <p><strong>Last Payment:</strong> {{ last_payment_date|date:"M d, Y"|default:"None" }}</p>
        <p><strong>Last Amount:</strong> Ksh {{ last_payment_amount|default:"0.00"|floatformat:2 }}</p>
    </div>
    
    <div style="background-color: #f3e5f5; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px;">
        <h4 style="margin-top: 0;">Summary</h4>
        <p><strong>Successful:</strong> {{ completed_count|default:"0" }}</p>
        <p><strong>Pending:</strong> {{ pending_count|default:"0" }}</p>
        <p><strong>Failed:</strong> {{ failed_count|default:"0" }}</p>
    </div>
</div>
{% else %}
<div style="background-color: #fff3e0; padding: 40px; text-align: center; border-radius: 5px;">
    <h3>No Payment History</h3>
    <p>You haven't made any payments yet.</p>
    {% if student %}
        <a href="{% url 'make_payment' %}" style="background-color: #4CAF50; color: white; padding: 10px 20px; text-decoration: none; display: inline-block; margin-top: 20px;">
            Make Your First Payment
        </a>
    {% endif %}
</div>
{% endif %}

<div style="background-color: #f5f5f5; padding: 15px; border-radius: 5px; margin-top: 30px;">
    <h4>Need Help?</h4>
    <p>If you notice any discrepancies in your payment history:</p>
    <ul>
        <li>Check with the accounts office for clarification</li>
        <li>Keep all your payment receipts for reference</li>
        <li>Report any issues within 7 days of payment</li>
    </ul>
</div>
{% endblock %}\n\n========== FILE: ./payments/templates/payments/payment_list.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<h2>All Payments</h2>

<!-- Filter Options -->
<div style="background-color: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
    <form method="get" style="display: flex; gap: 10px; align-items: center;">
        <div>
            <label for="status">Status:</label>
            <select name="status" id="status" style="padding: 5px;">
                <option value="">All</option>
                <option value="completed">Completed</option>
                <option value="pending">Pending</option>
                <option value="failed">Failed</option>
            </select>
        </div>
        <div>
            <label for="method">Method:</label>
            <select name="method" id="method" style="padding: 5px;">
                <option value="">All</option>
                <option value="mpesa">M-Pesa</option>
                <option value="cash">Cash</option>
                <option value="bank">Bank</option>
                <option value="cheque">Cheque</option>
            </select>
        </div>
        <button type="submit" style="background-color: #2196F3; color: white; padding: 5px 15px; border: none; cursor: pointer;">Filter</button>
        <a href="{% url 'payment_list' %}" style="background-color: #757575; color: white; padding: 5px 15px; text-decoration: none;">Clear</a>
    </form>
</div>

<table style="width: 100%; border-collapse: collapse;">
    <thead>
        <tr style="background-color: #f2f2f2;">
            <th style="border: 1px solid #ddd; padding: 8px;">Date</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Student</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Amount</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Method</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Transaction ID</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Confirmed By</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for payment in payments %}
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ payment.payment_date|date:"M d, Y H:i" }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ payment.student.user.get_full_name }}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">
                <strong>Ksh {{ payment.amount|floatformat:2 }}</strong>
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ payment.get_payment_method_display }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                <span style="
                    padding: 2px 8px;
                    border-radius: 3px;
                    color: white;
                    {% if payment.status == 'completed' %}background-color: #4CAF50;
                    {% elif payment.status == 'pending' %}background-color: #FF9800;
                    {% else %}background-color: #f44336;
                    {% endif %}
                ">
                    {{ payment.get_status_display }}
                </span>
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                {% if payment.transaction_id %}
                    <small>{{ payment.transaction_id|truncatechars:15 }}</small>
                {% else %}
                    -
                {% endif %}
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                {% if payment.confirmed_by %}
                    {{ payment.confirmed_by.username }}
                {% else %}
                    -
                {% endif %}
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                <a href="#" style="background-color: #2196F3; color: white; padding: 5px 10px; text-decoration: none; margin-right: 5px;">View</a>
                {% if payment.status == 'pending' %}
                    <a href="#" style="background-color: #4CAF50; color: white; padding: 5px 10px; text-decoration: none;">Confirm</a>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="8" style="border: 1px solid #ddd; padding: 8px; text-align: center;">No payments found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Summary Statistics -->
{% if payments %}
<div style="display: flex; gap: 20px; margin-top: 30px; flex-wrap: wrap;">
    <div style="background-color: #e8f5e9; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px;">
        <h4 style="margin-top: 0;">Total Payments</h4>
        <p style="font-size: 18px; font-weight: bold;">
            Ksh {{ total_amount|default:"0.00"|floatformat:2 }}
        </p>
    </div>
    <div style="background-color: #e3f2fd; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px;">
        <h4 style="margin-top: 0;">Completed</h4>
        <p style="font-size: 18px; font-weight: bold;">
            {{ completed_count|default:"0" }} payments
        </p>
    </div>
    <div style="background-color: #fff3e0; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px;">
        <h4 style="margin-top: 0;">Pending</h4>
        <p style="font-size: 18px; font-weight: bold;">
            {{ pending_count|default:"0" }} payments
        </p>
    </div>
</div>
{% endif %}
{% endblock %}\n\n========== FILE: ./payments/templates/payments/payment_receipt.html ==========\n
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Receipt</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .receipt-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
        }
        .school-name {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .receipt-title {
            font-size: 20px;
            color: #666;
            margin-top: 10px;
        }
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .detail-section {
            margin-bottom: 20px;
        }
        .detail-section h3 {
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .detail-label {
            font-weight: bold;
            color: #666;
        }
        .detail-value {
            color: #333;
        }
        .amount {
            font-size: 18px;
            font-weight: bold;
        }
        .paid {
            color: #4CAF50;
        }
        .pending {
            color: #FF9800;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            color: #666;
            font-size: 12px;
        }
        .watermark {
            position: absolute;
            opacity: 0.1;
            font-size: 120px;
            transform: rotate(-45deg);
            z-index: -1;
            color: #333;
        }
        @media print {
            body {
                background-color: white;
                padding: 0;
            }
            .receipt-container {
                box-shadow: none;
                padding: 0;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="receipt-container">
        <div class="watermark" style="top: 200px; left: 100px;">PAID</div>
        
        <div class="header">
            <div class="school-name">SCHOOL ADMINISTRATION SYSTEM</div>
            <div class="receipt-title">OFFICIAL PAYMENT RECEIPT</div>
            <div style="margin-top: 10px; color: #666;">
                Receipt Number: {{ receipt.receipt_number }}
            </div>
        </div>
        
        <div class="details-grid">
            <div class="detail-section">
                <h3>Student Information</h3>
                <div class="detail-row">
                    <span class="detail-label">Name:</span>
                    <span class="detail-value">{{ payment.student.user.get_full_name }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Admission No:</span>
                    <span class="detail-value">{{ payment.student.admission_number }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Grade:</span>
                    <span class="detail-value">{{ payment.student.grade }}-{{ payment.student.section }}</span>
                </div>
                {% if payment.student_fee %}
                <div class="detail-row">
                    <span class="detail-label">Term:</span>
                    <span class="detail-value">{{ payment.student_fee.fee_structure.term }} {{ payment.student_fee.fee_structure.academic_year }}</span>
                </div>
                {% endif %}
            </div>
            
            <div class="detail-section">
                <h3>Payment Details</h3>
                <div class="detail-row">
                    <span class="detail-label">Date:</span>
                    <span class="detail-value">{{ payment.payment_date|date:"F d, Y" }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Time:</span>
                    <span class="detail-value">{{ payment.payment_date|time:"H:i" }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Payment Method:</span>
                    <span class="detail-value">{{ payment.get_payment_method_display }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value {% if payment.status == 'completed' %}paid{% else %}pending{% endif %}">
                        {{ payment.get_status_display }}
                    </span>
                </div>
            </div>
        </div>
        
        <div class="detail-section">
            <h3>Payment Information</h3>
            <div class="detail-row">
                <span class="detail-label">Amount Paid:</span>
                <span class="detail-value amount">Ksh {{ payment.amount|floatformat:2 }}</span>
            </div>
            {% if payment.mpesa_code %}
            <div class="detail-row">
                <span class="detail-label">M-Pesa Code:</span>
                <span class="detail-value">{{ payment.mpesa_code }}</span>
            </div>
            {% endif %}
            {% if payment.transaction_id %}
            <div class="detail-row">
                <span class="detail-label">Transaction ID:</span>
                <span class="detail-value">{{ payment.transaction_id }}</span>
            </div>
            {% endif %}
            {% if payment.phone_number %}
            <div class="detail-row">
                <span class="detail-label">Phone Number:</span>
                <span class="detail-value">{{ payment.phone_number }}</span>
            </div>
            {% endif %}
            {% if payment.description %}
            <div class="detail-row">
                <span class="detail-label">Description:</span>
                <span class="detail-value">{{ payment.description }}</span>
            </div>
            {% endif %}
        </div>
        
        {% if payment.student_fee %}
        <div class="detail-section">
            <h3>Fee Balance Information</h3>
            <div class="detail-row">
                <span class="detail-label">Previous Balance:</span>
                <span class="detail-value">Ksh {{ previous_balance|default:"0.00"|floatformat:2 }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">This Payment:</span>
                <span class="detail-value">Ksh {{ payment.amount|floatformat:2 }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">New Balance:</span>
                <span class="detail-value amount">Ksh {{ new_balance|default:"0.00"|floatformat:2 }}</span>
            </div>
        </div>
        {% endif %}
        
        <div class="detail-section">
            <h3>School Information</h3>
            <div class="detail-row">
                <span class="detail-label">School Name:</span>
                <span class="detail-value">School Administration System</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Address:</span>
                <span class="detail-value">123 School Street, Education City</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Phone:</span>
                <span class="detail-value">+254 700 000 000</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Email:</span>
                <span class="detail-value">accounts@schoolsystem.edu</span>
            </div>
        </div>
        
        <div class="footer">
            <p>This is an official computer-generated receipt. No signature required.</p>
            <p>Please keep this receipt for your records.</p>
            <p>Generated on: {% now "F d, Y H:i" %}</p>
            <div class="no-print" style="margin-top: 20px;">
                <button onclick="window.print()" style="background-color: #2196F3; color: white; padding: 10px 20px; border: none; cursor: pointer; margin-right: 10px;">
                    Print Receipt
                </button>
                <button onclick="window.close()" style="background-color: #757575; color: white; padding: 10px 20px; border: none; cursor: pointer;">
                    Close Window
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // Auto-print option
        window.onload = function() {
            // Uncomment to auto-print
            // window.print();
        };
    </script>
</body>
</html>\n\n========== FILE: ./payments/templates/payments/payment_status.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<h2>Payment Status</h2>

<div style="max-width: 600px; margin: 0 auto;">
    <div style="background-color: #f9f9f9; padding: 30px; border-radius: 5px; text-align: center;">
        <!-- Status Icon -->
        <div style="font-size: 72px; margin-bottom: 20px;">
            {% if payment.status == 'completed' %}
                âœ…
            {% elif payment.status == 'pending' %}
                â³
            {% elif payment.status == 'failed' %}
                âŒ
            {% else %}
                â“
            {% endif %}
        </div>
        
        <h3>
            {% if payment.status == 'completed' %}
                Payment Successful!
            {% elif payment.status == 'pending' %}
                Payment Processing
            {% elif payment.status == 'failed' %}
                Payment Failed
            {% else %}
                Payment Status Unknown
            {% endif %}
        </h3>
        
        <!-- Payment Details -->
        <div style="background-color: white; padding: 20px; border-radius: 5px; margin: 20px 0; text-align: left;">
            <p><strong>Student:</strong> {{ student.user.get_full_name }}</p>
            <p><strong>Amount:</strong> Ksh {{ payment.amount|floatformat:2 }}</p>
            <p><strong>Payment Method:</strong> {{ payment.get_payment_method_display }}</p>
            <p><strong>Status:</strong> {{ payment.get_status_display }}</p>
            <p><strong>Date:</strong> {{ payment.payment_date|date:"M d, Y H:i" }}</p>
            
            {% if payment.mpesa_code %}
                <p><strong>M-Pesa Code:</strong> {{ payment.mpesa_code }}</p>
            {% endif %}
            
            {% if payment.receipt_number %}
                <p><strong>Receipt Number:</strong> {{ payment.receipt_number }}</p>
            {% endif %}
            
            {% if payment.description %}
                <p><strong>Description:</strong> {{ payment.description }}</p>
            {% endif %}
        </div>
        
        <!-- Status Message -->
        <div style="margin: 20px 0;">
            {% if payment.status == 'completed' %}
                <p style="color: #4CAF50; font-weight: bold;">
                    Your payment has been successfully processed. A receipt has been generated.
                </p>
            {% elif payment.status == 'pending' %}
                <p style="color: #FF9800; font-weight: bold;">
                    Your payment is being processed. Please check back in a few minutes.
                </p>
            {% elif payment.status == 'failed' %}
                <p style="color: #f44336; font-weight: bold;">
                    The payment could not be processed. Please try again or contact support.
                </p>
                <p>{{ payment.description }}</p>
            {% endif %}
        </div>
        
        <!-- Actions -->
        <div style="margin-top: 30px;">
            {% if payment.status == 'completed' %}
                <a href="#" style="background-color: #4CAF50; color: white; padding: 10px 20px; text-decoration: none; margin-right: 10px;">
                    Download Receipt
                </a>
            {% elif payment.status == 'pending' %}
                <a href="{% url 'payment_status' payment.id %}" style="background-color: #2196F3; color: white; padding: 10px 20px; text-decoration: none; margin-right: 10px;">
                    Refresh Status
                </a>
            {% endif %}
            
            <a href="{% url 'student_financial_dashboard' %}" style="background-color: #757575; color: white; padding: 10px 20px; text-decoration: none;">
                Back to Dashboard
            </a>
        </div>
    </div>
    
    <!-- Instructions -->
    <div style="background-color: #e3f2fd; padding: 15px; border-radius: 5px; margin-top: 20px;">
        <h4>Next Steps:</h4>
        <ul>
            {% if payment.status == 'completed' %}
                <li>Keep your receipt for future reference</li>
                <li>Your balance has been updated automatically</li>
                <li>Check your financial dashboard for updated balance</li>
            {% elif payment.status == 'pending' %}
                <li>Please wait a few minutes for processing</li>
                <li>Check your phone for M-Pesa confirmation if applicable</li>
                <li>Refresh this page to check updated status</li>
            {% elif payment.status == 'failed' %}
                <li>Check if you have sufficient funds</li>
                <li>Ensure your phone number is correct</li>
                <li>Try making the payment again</li>
                <li>Contact support if the issue persists</li>
            {% endif %}
        </ul>
    </div>
</div>
{% endblock %}\n\n========== FILE: ./payments/templates/payments/record_payment_form.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<h2>Record Manual Payment</h2>

<form method="post" style="max-width: 600px;">
    {% csrf_token %}
    
    {% for field in form %}
    <div style="margin-bottom: 15px;">
        <label for="{{ field.id_for_label }}" style="display: block; margin-bottom: 5px;">
            {{ field.label }}:
        </label>
        {{ field }}
        {% if field.errors %}
            <div style="color: red; font-size: 12px;">{{ field.errors }}</div>
        {% endif %}
        {% if field.help_text %}
            <div style="color: #666; font-size: 12px;">{{ field.help_text }}</div>
        {% endif %}
    </div>
    {% endfor %}
    
    <div style="margin-top: 20px;">
        <button type="submit" style="background-color: #4CAF50; color: white; padding: 10px 20px; border: none; cursor: pointer; margin-right: 10px;">Record Payment</button>
        <a href="{% url 'payment_list' %}" style="background-color: #757575; color: white; padding: 10px 20px; text-decoration: none;">Cancel</a>
    </div>
</form>

<div style="background-color: #e8f5e9; padding: 15px; border-radius: 5px; margin-top: 30px;">
    <h4>Payment Methods:</h4>
    <ul>
        <li><strong>M-Pesa:</strong> Mobile money payments</li>
        <li><strong>Bank Transfer:</strong> Direct bank transfers</li>
        <li><strong>Cash:</strong> Physical cash payments</li>
        <li><strong>Cheque:</strong> Check payments</li>
        <li><strong>Other:</strong> Any other payment method</li>
    </ul>
    <p><strong>Note:</strong> This form is for recording payments made outside the M-Pesa system.</p>
</div>
{% endblock %}\n\n========== FILE: ./payments/templates/payments/student_fee_list.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<h2>Student Fees Management</h2>

<div style="display: flex; gap: 10px; margin-bottom: 20px;">
    <a href="{% url 'assign_fee_to_student' %}" style="background-color: #4CAF50; color: white; padding: 10px 15px; text-decoration: none;">Assign Fee to Student</a>
    <a href="{% url 'add_additional_charge' %}" style="background-color: #FF9800; color: white; padding: 10px 15px; text-decoration: none;">Add Additional Charge</a>
    <a href="{% url 'record_payment' %}" style="background-color: #2196F3; color: white; padding: 10px 15px; text-decoration: none;">Record Payment</a>
</div>

<!-- Summary Statistics -->
<div style="display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap;">
    <div style="background-color: #ffebee; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px;">
        <h3 style="margin-top: 0;">Total Due</h3>
        <p style="font-size: 24px; font-weight: bold; color: #f44336;">Ksh {{ total_due|floatformat:2 }}</p>
    </div>
    <div style="background-color: #e8f5e9; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px;">
        <h3 style="margin-top: 0;">Total Paid</h3>
        <p style="font-size: 24px; font-weight: bold; color: #4CAF50;">Ksh {{ total_paid|floatformat:2 }}</p>
    </div>
    <div style="background-color: #fff3e0; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px;">
        <h3 style="margin-top: 0;">Total Balance</h3>
        <p style="font-size: 24px; font-weight: bold; color: #FF9800;">Ksh {{ total_balance|floatformat:2 }}</p>
    </div>
</div>

<table style="width: 100%; border-collapse: collapse;">
    <thead>
        <tr style="background-color: #f2f2f2;">
            <th style="border: 1px solid #ddd; padding: 8px;">Student</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Admission No</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Fee Structure</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Amount Due</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Amount Paid</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Balance</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Due Date</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for fee in student_fees %}
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ fee.student.user.get_full_name }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ fee.student.admission_number }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ fee.fee_structure.name }}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ fee.amount_due|floatformat:2 }}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ fee.amount_paid|floatformat:2 }}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">
                {% if fee.balance > 0 %}
                    <span style="color: #f44336; font-weight: bold;">Ksh {{ fee.balance|floatformat:2 }}</span>
                {% else %}
                    <span style="color: #4CAF50;">Paid</span>
                {% endif %}
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                {% if fee.is_paid %}
                    <span style="color: #4CAF50; font-weight: bold;">Paid</span>
                {% else %}
                    <span style="color: #f44336;">Pending</span>
                {% endif %}
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ fee.due_date }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                <a href="{% url 'record_payment' %}?student={{ fee.student.id }}" style="background-color: #2196F3; color: white; padding: 5px 10px; text-decoration: none; margin-right: 5px;">Add Payment</a>
                <a href="#" style="background-color: #FF9800; color: white; padding: 5px 10px; text-decoration: none;">View</a>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="9" style="border: 1px solid #ddd; padding: 8px; text-align: center;">No student fees found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}\n\n========== FILE: ./payments/templates/payments/student_financial_dashboard.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<h2>My Financial Dashboard</h2>

<div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px;">
    <!-- Summary Cards -->
    <div style="flex: 1; min-width: 300px; background-color: #e8f5e9; padding: 20px; border-radius: 5px;">
        <h3>Financial Summary</h3>
        <p><strong>Total Amount Due:</strong> <span style="font-size: 24px; color: #f44336;">Ksh {{ total_due|floatformat:2 }}</span></p>
        <p><strong>Total Amount Paid:</strong> <span style="font-size: 24px; color: #4CAF50;">Ksh {{ total_paid|floatformat:2 }}</span></p>
        <p><strong>Current Balance:</strong> <span style="font-size: 24px; color: #FF9800;">Ksh {{ total_balance|floatformat:2 }}</span></p>
    </div>
    
    <!-- Quick Actions -->
    <div style="flex: 1; min-width: 300px; background-color: #e3f2fd; padding: 20px; border-radius: 5px;">
        <h3>Quick Actions</h3>
        {% if current_fee and current_fee.balance > 0 %}
            <a href="{% url 'make_payment' %}" style="display: block; background-color: #4CAF50; color: white; padding: 10px; text-decoration: none; text-align: center; margin-bottom: 10px;">
                Make Payment (Balance: Ksh {{ current_fee.balance|floatformat:2 }})
            </a>
        {% endif %}
        <a href="{% url 'payment_history' %}" style="display: block; background-color: #2196F3; color: white; padding: 10px; text-decoration: none; text-align: center;">
            View Payment History
        </a>
    </div>
</div>

<!-- Current Fee Details -->
{% if current_fee %}
<div style="background-color: #fff3e0; padding: 20px; border-radius: 5px; margin-top: 20px;">
    <h3>Current Term Fees</h3>
    <p><strong>Term:</strong> {{ current_fee.fee_structure.term }} {{ current_fee.fee_structure.academic_year }}</p>
    <p><strong>Due Date:</strong> {{ current_fee.due_date }}</p>
    
    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Tuition Fee:</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ current_fee.fee_structure.tuition_fee|floatformat:2 }}</td>
        </tr>
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Boarding Fee:</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ current_fee.fee_structure.boarding_fee|floatformat:2 }}</td>
        </tr>
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Activity Fee:</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ current_fee.fee_structure.activity_fee|floatformat:2 }}</td>
        </tr>
        <tr style="background-color: #f9f9f9;">
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Subtotal:</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ current_fee.fee_structure.total_fee|floatformat:2 }}</td>
        </tr>
        {% if current_fee.additional_charges > 0 %}
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Additional Charges:</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ current_fee.additional_charges|floatformat:2 }}</td>
        </tr>
        {% endif %}
        {% if current_fee.penalty_charges > 0 %}
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Penalty Charges:</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ current_fee.penalty_charges|floatformat:2 }}</td>
        </tr>
        {% endif %}
        <tr style="background-color: #ffebee;">
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Total Amount Due:</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right; font-weight: bold;">Ksh {{ current_fee.amount_due|floatformat:2 }}</td>
        </tr>
        <tr style="background-color: #e8f5e9;">
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Amount Paid:</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ current_fee.amount_paid|floatformat:2 }}</td>
        </tr>
        <tr style="background-color: #fff3e0;">
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Balance:</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right; font-weight: bold;">
                {% if current_fee.balance > 0 %}
                    <span style="color: #f44336;">Ksh {{ current_fee.balance|floatformat:2 }}</span>
                {% else %}
                    <span style="color: #4CAF50;">PAID IN FULL</span>
                {% endif %}
            </td>
        </tr>
    </table>
</div>
{% endif %}

<!-- Additional Charges -->
{% if additional_charges %}
<div style="background-color: #ffebee; padding: 20px; border-radius: 5px; margin-top: 20px;">
    <h3>Pending Additional Charges</h3>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background-color: #f2f2f2;">
                <th style="border: 1px solid #ddd; padding: 8px;">Charge Type</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Description</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Amount</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Due Date</th>
            </tr>
        </thead>
        <tbody>
            {% for charge in additional_charges %}
            <tr>
                <td style="border: 1px solid #ddd; padding: 8px;">{{ charge.get_charge_type_display }}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">{{ charge.description }}</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ charge.amount|floatformat:2 }}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">{{ charge.due_date }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Recent Payments -->
{% if recent_payments %}
<div style="background-color: #f9f9f9; padding: 20px; border-radius: 5px; margin-top: 20px;">
    <h3>Recent Payments (Last 30 Days)</h3>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background-color: #f2f2f2;">
                <th style="border: 1px solid #ddd; padding: 8px;">Date</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Method</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Amount</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Description</th>
            </tr>
        </thead>
        <tbody>
            {% for payment in recent_payments %}
            <tr>
                <td style="border: 1px solid #ddd; padding: 8px;">{{ payment.payment_date|date:"M d, Y" }}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">{{ payment.get_payment_method_display }}</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ payment.amount|floatformat:2 }}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">
                    <span style="
                        padding: 2px 8px;
                        border-radius: 3px;
                        color: white;
                        {% if payment.status == 'completed' %}background-color: #4CAF50;
                        {% elif payment.status == 'pending' %}background-color: #FF9800;
                        {% else %}background-color: #f44336;
                        {% endif %}
                    ">
                        {{ payment.get_status_display }}
                    </span>
                </td>
                <td style="border: 1px solid #ddd; padding: 8px;">{{ payment.description|truncatechars:30 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div style="background-color: #e3f2fd; padding: 15px; border-radius: 5px; margin-top: 20px;">
    <p><strong>Note:</strong> All payments should be made through approved channels. Keep your payment receipts for reference.</p>
    <p>For any discrepancies in your balance or additional charges, please contact the accounts office.</p>
</div>
{% endblock %}\n\n========== FILE: ./payments/urls.py ==========\n
from django.urls import path
from . import views

urlpatterns = [
    # Admin views
    path('fee-structures/', views.fee_structure_list, name='fee_structure_list'),
    path('fee-structures/create/', views.fee_structure_create, name='fee_structure_create'),
    path('fee-structures/<int:pk>/update/', views.fee_structure_update, name='fee_structure_update'),
    
    path('student-fees/', views.student_fee_list, name='student_fee_list'),
    path('assign-fee/', views.assign_fee_to_student, name='assign_fee_to_student'),
    path('add-charge/', views.add_additional_charge, name='add_additional_charge'),
    path('record-payment/', views.record_payment, name='record_payment'),
    path('payments/', views.payment_list, name='payment_list'),
    
    # Student views
    path('my-finances/', views.student_financial_dashboard, name='student_financial_dashboard'),
    path('make-payment/', views.make_payment, name='make_payment'),
    path('payment-status/<int:payment_id>/', views.payment_status, name='payment_status'),
    path('payment-history/', views.payment_history, name='payment_history'),
    
    # M-Pesa callback
    path('mpesa-callback/', views.mpesa_callback, name='mpesa_callback'),
    
     # New URLs
    path('receipt/<int:payment_id>/', views.generate_receipt, name='generate_receipt'),
    path('download-receipt/<int:payment_id>/', views.download_receipt, name='download_receipt'),
    path('financial-report/', views.financial_report, name='financial_report'),
    
    # Common views
    path('fee-summary/', views.fee_summary, name='fee_summary'),
]\n\n========== FILE: ./payments/utils.py ==========\n
import random
import string
from datetime import datetime, timedelta
from decimal import Decimal
from django.utils import timezone
from django.db.models import Sum, Count, Q

from accounts import models
from .models import Payment, StudentFee, FeeStructure
from .models import PaymentReceipt
from .models import AdditionalCharge
from django.db.models import Avg
models.Count


def generate_transaction_id():
    """
    Generate a unique transaction ID
    Format: TXN-YYYYMMDD-XXXXXX (where XXXXXX is random alphanumeric)
    """
    date_str = datetime.now().strftime('%Y%m%d')
    random_str = ''.join(random.choices(string.ascii_uppercase + string.digits, k=6))
    return f"TXN-{date_str}-{random_str}"

def generate_receipt_number():
    """
    Generate a unique receipt number
    Format: RCPT-YYYYMMDD-XXXXXX (where XXXXXX is sequential number based on count)
    """
    date_str = datetime.now().strftime('%Y%m%d')
    
    # Get count of receipts for today
    today_start = timezone.now().replace(hour=0, minute=0, second=0, microsecond=0)
    today_count = PaymentReceipt.objects.filter(
        generated_at__gte=today_start
    ).count()
    
    sequential_num = str(today_count + 1).zfill(6)
    return f"RCPT-{date_str}-{sequential_num}"

def calculate_financial_summary(start_date=None, end_date=None):
    """
    Calculate financial summary for a given period
    """
    if not start_date:
        start_date = timezone.now().replace(day=1)  # Start of current month
    if not end_date:
        end_date = timezone.now()
    
    # Payment summary
    payments = Payment.objects.filter(
        payment_date__range=[start_date, end_date],
        status='completed'
    )
    
    total_payments = payments.aggregate(total=Sum('amount'))['total'] or Decimal('0.00')
    
    # Payment method breakdown
    payment_methods = payments.values('payment_method').annotate(
        total=Sum('amount'),
        count=Count('id')
    )
    
    # Student fee summary
    student_fees = StudentFee.objects.all()
    
    total_due = student_fees.aggregate(total=Sum('amount_due'))['total'] or Decimal('0.00')
    total_paid = student_fees.aggregate(total=Sum('amount_paid'))['total'] or Decimal('0.00')
    total_balance = student_fees.aggregate(total=Sum('balance'))['total'] or Decimal('0.00')
    
    # Payment status breakdown
    payment_status = {
        'completed': payments.filter(status='completed').count(),
        'pending': Payment.objects.filter(status='pending').count(),
        'failed': Payment.objects.filter(status='failed').count(),
    }
    
    # Fee structure summary
    fee_structures = FeeStructure.objects.filter(is_active=True)
    
    return {
        'period': {
            'start_date': start_date,
            'end_date': end_date
        },
        'payments': {
            'total': total_payments,
            'count': payments.count(),
            'methods': list(payment_methods),
            'status': payment_status
        },
        'fees': {
            'total_due': total_due,
            'total_paid': total_paid,
            'total_balance': total_balance,
            'collection_rate': (total_paid / total_due * 100) if total_due > 0 else 0,
            'student_count': student_fees.count(),
            'fully_paid': student_fees.filter(is_paid=True).count(),
            'partially_paid': student_fees.filter(is_paid=False, amount_paid__gt=0).count(),
            'not_paid': student_fees.filter(amount_paid=0).count(),
        },
        'fee_structures': {
            'active_count': fee_structures.count(),
            'total_fee_amount': sum(fs.total_fee for fs in fee_structures),
        }
    }

def send_payment_reminder(days_before=7):
    """
    Send payment reminders to students with upcoming due dates
    """
    today = timezone.now().date()
    reminder_date = today + timedelta(days=days_before)
    
    # Get student fees due on or before reminder date
    upcoming_fees = StudentFee.objects.filter(
        due_date__lte=reminder_date,
        due_date__gte=today,
        is_paid=False
    ).select_related('student__user')
    
    reminders = []
    
    for fee in upcoming_fees:
        reminder = {
            'student': fee.student,
            'fee_structure': fee.fee_structure,
            'due_date': fee.due_date,
            'balance': fee.balance,
            'days_until_due': (fee.due_date - today).days,
            'student_email': fee.student.user.email,
            'student_phone': fee.student.phone,
            'parent_phone': fee.student.parent_phone,
        }
        reminders.append(reminder)
    
    return reminders

def validate_mpesa_phone_number(phone_number):
    """
    Validate M-Pesa phone number format
    Expected format: 2547XXXXXXXX (12 digits starting with 254)
    """
    if not phone_number:
        return False
    
    # Remove any spaces or dashes
    phone = phone_number.strip().replace(' ', '').replace('-', '')
    
    # Check length and format
    if len(phone) != 12:
        return False
    
    if not phone.startswith('254'):
        return False
    
    # Check if the rest are digits
    if not phone[3:].isdigit():
        return False
    
    # Check if it starts with 2547 (Kenyan mobile)
    if not phone[3] == '7':
        return False
    
    return True

def format_currency(amount):
    """
    Format amount as currency string
    """
    if amount is None:
        return "Ksh 0.00"
    
    return f"Ksh {amount:,.2f}"

def get_student_financial_summary(student):
    """
    Get comprehensive financial summary for a student
    """
    # Get all student fees
    student_fees = StudentFee.objects.filter(student=student)
    
    # Get all payments
    payments = Payment.objects.filter(student=student).order_by('-payment_date')
    
    # Get additional charges
    additional_charges = AdditionalCharge.objects.filter(student=student, is_paid=False)
    
    # Calculate totals
    total_fees_assigned = student_fees.count()
    total_amount_due = student_fees.aggregate(total=Sum('amount_due'))['total'] or Decimal('0.00')
    total_amount_paid = student_fees.aggregate(total=Sum('amount_paid'))['total'] or Decimal('0.00')
    total_balance = student_fees.aggregate(total=Sum('balance'))['total'] or Decimal('0.00')
    
    # Get current active fee
    current_fee = student_fees.filter(fee_structure__is_active=True).first()
    
    # Calculate payment statistics
    payment_stats = {
        'total_payments': payments.count(),
        'total_paid': payments.filter(status='completed').aggregate(total=Sum('amount'))['total'] or Decimal('0.00'),
        'pending_payments': payments.filter(status='pending').count(),
        'last_payment_date': payments.filter(status='completed').first().payment_date if payments.filter(status='completed').exists() else None,
        'payment_methods': payments.values('payment_method').annotate(count=Count('id'), total=Sum('amount')),
    }
    
    # Calculate additional charges summary
    charges_summary = {
        'total_charges': additional_charges.count(),
        'total_amount': additional_charges.aggregate(total=Sum('amount'))['total'] or Decimal('0.00'),
        'by_type': additional_charges.values('charge_type').annotate(count=Count('id'), total=Sum('amount')),
    }
    
    return {
        'student': student,
        'summary': {
            'total_fees_assigned': total_fees_assigned,
            'total_amount_due': total_amount_due,
            'total_amount_paid': total_amount_paid,
            'total_balance': total_balance,
            'payment_completion': (total_amount_paid / total_amount_due * 100) if total_amount_due > 0 else 0,
        },
        'current_fee': current_fee,
        'payment_stats': payment_stats,
        'charges_summary': charges_summary,
        'recent_payments': payments[:5],  # Last 5 payments
        'outstanding_charges': additional_charges,
    }

def calculate_payment_statistics(start_date=None, end_date=None):
    """
    Calculate detailed payment statistics for reporting
    """
    if not start_date:
        start_date = timezone.now() - timedelta(days=30)  # Last 30 days
    if not end_date:
        end_date = timezone.now()
    
    # Daily payment totals
    daily_payments = Payment.objects.filter(
        payment_date__date__range=[start_date.date(), end_date.date()],
        status='completed'
    ).extra({'date': "date(payment_date)"}).values('date').annotate(
        total=Sum('amount'),
        count=Count('id')
    ).order_by('date')
    
    # Payment method distribution
    method_distribution = Payment.objects.filter(
        payment_date__range=[start_date, end_date],
        status='completed'
    ).values('payment_method').annotate(
        total=Sum('amount'),
        count=Count('id'),
        percentage=models.Count('id') * 100.0 / models.Count('id')
    )
    
    # Average payment amount
    avg_payment = Payment.objects.filter(
        payment_date__range=[start_date, end_date],
        status='completed'
    ).aggregate(avg=Avg('amount'))['avg'] or Decimal('0.00')
    
    # Largest payment
    largest_payment = Payment.objects.filter(
        payment_date__range=[start_date, end_date],
        status='completed'
    ).order_by('-amount').first()
    
    # Payment success rate
    total_attempts = Payment.objects.filter(
        payment_date__range=[start_date, end_date]
    ).count()
    
    successful_attempts = Payment.objects.filter(
        payment_date__range=[start_date, end_date],
        status='completed'
    ).count()
    
    success_rate = (successful_attempts / total_attempts * 100) if total_attempts > 0 else 0
    
    return {
        'period': {
            'start_date': start_date,
            'end_date': end_date,
            'days': (end_date.date() - start_date.date()).days
        },
        'daily_payments': list(daily_payments),
        'method_distribution': list(method_distribution),
        'statistics': {
            'average_payment': avg_payment,
            'largest_payment': largest_payment.amount if largest_payment else Decimal('0.00'),
            'largest_payment_student': largest_payment.student if largest_payment else None,
            'success_rate': success_rate,
            'total_attempts': total_attempts,
            'successful_attempts': successful_attempts,
            'failed_attempts': total_attempts - successful_attempts,
        }
    }\n\n========== FILE: ./payments/views.py ==========\n
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required, user_passes_test
from django.contrib import messages  # Change from school_messages to messages
from django.http import JsonResponse, HttpResponse
from django.views.decorators.csrf import csrf_exempt
from django.db.models import Sum, Q, Count
from django.utils import timezone
import json
from datetime import datetime, timedelta

from .models import FeeStructure, StudentFee, AdditionalCharge, Payment, PaymentReceipt
from .forms import (
    FeeStructureForm, StudentFeeForm, AdditionalChargeForm, 
    MpesaPaymentForm, PaymentForm
)
from .mpesa import MpesaAPI
from students.models import Student
from accounts.models import User

def is_admin(user):
    return user.is_authenticated and user.is_admin()

def is_student(user):
    return user.is_authenticated and user.is_student()

def is_teacher(user):
    return user.is_authenticated and user.is_teacher()

# ===== Admin Views =====

@login_required
@user_passes_test(is_admin)
def fee_structure_list(request):
    fee_structures = FeeStructure.objects.all()
    return render(request, 'payments/fee_structure_list.html', {'fee_structures': fee_structures})

@login_required
@user_passes_test(is_admin)
def fee_structure_create(request):
    if request.method == 'POST':
        form = FeeStructureForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, 'Fee structure created successfully!')
            return redirect('fee_structure_list')
    else:
        form = FeeStructureForm()
    return render(request, 'payments/fee_structure_form.html', {'form': form, 'title': 'Create Fee Structure'})

@login_required
@user_passes_test(is_admin)
def fee_structure_update(request, pk):
    fee_structure = get_object_or_404(FeeStructure, pk=pk)
    if request.method == 'POST':
        form = FeeStructureForm(request.POST, instance=fee_structure)
        if form.is_valid():
            form.save()
            messages.success(request, 'Fee structure updated successfully!')
            return redirect('fee_structure_list')
    else:
        form = FeeStructureForm(instance=fee_structure)
    return render(request, 'payments/fee_structure_form.html', {'form': form, 'title': 'Update Fee Structure'})

@login_required
@user_passes_test(is_admin)
def student_fee_list(request):
    student_fees = StudentFee.objects.all()
    total_due = student_fees.aggregate(Sum('amount_due'))['amount_due__sum'] or 0
    total_paid = student_fees.aggregate(Sum('amount_paid'))['amount_paid__sum'] or 0
    total_balance = student_fees.aggregate(Sum('balance'))['balance__sum'] or 0
    
    return render(request, 'payments/student_fee_list.html', {
        'student_fees': student_fees,
        'total_due': total_due,
        'total_paid': total_paid,
        'total_balance': total_balance,
    })

@login_required
@user_passes_test(is_admin)
def assign_fee_to_student(request):
    if request.method == 'POST':
        form = StudentFeeForm(request.POST)
        if form.is_valid():
            student_fee = form.save(commit=False)
            
            # Check if student already has this fee structure
            existing = StudentFee.objects.filter(
                student=student_fee.student,
                fee_structure=student_fee.fee_structure
            ).first()
            
            if existing:
                messages.warning(request, 'This student already has this fee structure assigned.')
                return redirect('student_fee_list')
            
            student_fee.save()
            
            # Create initial payment record if any amount is paid
            if request.POST.get('initial_payment'):
                try:
                    initial_amount = float(request.POST.get('initial_payment'))
                    if initial_amount > 0:
                        Payment.objects.create(
                            student_fee=student_fee,
                            student=student_fee.student,
                            amount=initial_amount,
                            payment_method='cash',
                            status='completed',
                            confirmed_by=request.user,
                            confirmed_at=timezone.now(),
                            description='Initial payment'
                        )
                        student_fee.amount_paid = initial_amount
                        student_fee.save()
                except ValueError:
                    pass
            
            messages.success(request, f'Fee assigned to {student_fee.student} successfully!')
            return redirect('student_fee_list')
    else:
        form = StudentFeeForm()
    
    return render(request, 'payments/assign_fee_form.html', {'form': form})

@login_required
@user_passes_test(is_admin)
def add_additional_charge(request):
    if request.method == 'POST':
        form = AdditionalChargeForm(request.POST)
        if form.is_valid():
            charge = form.save(commit=False)
            charge.added_by = request.user
            charge.save()
            
            # Update student's fee balance
            try:
                student_fee = StudentFee.objects.filter(
                    student=charge.student,
                    fee_structure__is_active=True
                ).latest('created_at')
                
                student_fee.additional_charges += charge.amount
                student_fee.save()
                
                messages.success(request, f'Additional charge added to {charge.student} successfully!')
                
            except StudentFee.DoesNotExist:
                messages.warning(request, 'No active fee structure found for this student.')
            
            return redirect('student_fee_list')
    else:
        form = AdditionalChargeForm()
    
    return render(request, 'payments/additional_charge_form.html', {'form': form})

@login_required
@user_passes_test(is_admin)
def record_payment(request):
    if request.method == 'POST':
        form = PaymentForm(request.POST, user=request.user)
        if form.is_valid():
            payment = form.save(commit=False)
            payment.status = 'completed'
            payment.confirmed_by = request.user
            payment.confirmed_at = timezone.now()
            payment.save()
            
            # Update student fee balance
            student_fee = payment.student_fee
            student_fee.amount_paid += payment.amount
            student_fee.save()
            
            # Generate receipt
            PaymentReceipt.objects.create(payment=payment)
            
            messages.success(request, f'Payment of {payment.amount} recorded successfully!')
            return redirect('payment_list')
    else:
        form = PaymentForm(user=request.user)
    
    return render(request, 'payments/record_payment_form.html', {'form': form})

@login_required
@user_passes_test(is_admin)
def payment_list(request):
    payments = Payment.objects.all()
    return render(request, 'payments/payment_list.html', {'payments': payments})

# ===== Student Views =====

@login_required
@user_passes_test(is_student)
def student_financial_dashboard(request):
    try:
        student = Student.objects.get(user=request.user)
        
        # Get current fee
        current_fee = StudentFee.objects.filter(
            student=student,
            fee_structure__is_active=True
        ).first()
        
        # Get all student fees
        all_fees = StudentFee.objects.filter(student=student)
        
        # Get payments
        payments = Payment.objects.filter(student=student).order_by('-payment_date')
        
        # Get additional charges
        additional_charges = AdditionalCharge.objects.filter(
            student=student,
            is_paid=False
        )
        
        # Calculate statistics
        total_due = all_fees.aggregate(Sum('amount_due'))['amount_due__sum'] or 0
        total_paid = all_fees.aggregate(Sum('amount_paid'))['amount_paid__sum'] or 0
        total_balance = all_fees.aggregate(Sum('balance'))['balance__sum'] or 0
        
        # Get recent payments (last 30 days)
        thirty_days_ago = timezone.now() - timedelta(days=30)
        recent_payments = payments.filter(payment_date__gte=thirty_days_ago)
        
        return render(request, 'payments/student_financial_dashboard.html', {
            'student': student,
            'current_fee': current_fee,
            'all_fees': all_fees,
            'payments': payments,
            'additional_charges': additional_charges,
            'total_due': total_due,
            'total_paid': total_paid,
            'total_balance': total_balance,
            'recent_payments': recent_payments,
        })
        
    except Student.DoesNotExist:
        messages.error(request, 'Student profile not found.')
        return redirect('dashboard')

@login_required
@user_passes_test(is_student)
def make_payment(request):
    try:
        student = Student.objects.get(user=request.user)
        
        # Get current fee
        current_fee = StudentFee.objects.filter(
            student=student,
            fee_structure__is_active=True
        ).first()
        
        if not current_fee:
            messages.error(request, 'No active fee structure found.')
            return redirect('student_financial_dashboard')
        
        if request.method == 'POST':
            form = MpesaPaymentForm(request.POST)
            if form.is_valid():
                phone_number = form.cleaned_data['phone_number']
                amount = form.cleaned_data['amount']
                description = form.cleaned_data['description']
                
                # Validate amount
                if amount > current_fee.balance:
                    messages.error(request, f'Amount cannot exceed balance of {current_fee.balance}.')
                    return redirect('make_payment')
                
                # Initialize M-Pesa API
                mpesa = MpesaAPI()
                
                # Generate account reference
                account_reference = f"{student.admission_number}-{datetime.now().strftime('%Y%m%d%H%M%S')}"
                
                # Initiate STK Push
                result = mpesa.stk_push(
                    phone_number=phone_number,
                    amount=amount,
                    account_reference=account_reference,
                    transaction_desc=f"School fees payment - {student.user.get_full_name()}"
                )
                
                if result['success']:
                    # Create pending payment record
                    payment = Payment.objects.create(
                        student_fee=current_fee,
                        student=student,
                        amount=amount,
                        payment_method='mpesa',
                        phone_number=phone_number,
                        status='pending',
                        transaction_id=result.get('checkout_request_id', ''),
                        description=description,
                    )
                    
                    messages.success(
                        request, 
                        f'Payment request sent to {phone_number}. '
                        f'Please check your phone to complete the payment.'
                    )
                    return redirect('payment_status', payment_id=payment.id)
                else:
                    messages.error(request, f'Payment initiation failed: {result.get("error", "Unknown error")}')
            
        else:
            form = MpesaPaymentForm()
        
        return render(request, 'payments/make_payment.html', {
            'form': form,
            'current_fee': current_fee,
            'student': student,
        })
        
    except Student.DoesNotExist:
        messages.error(request, 'Student profile not found.')
        return redirect('dashboard')

@login_required
@user_passes_test(is_student)
def payment_status(request, payment_id):
    payment = get_object_or_404(Payment, id=payment_id, student__user=request.user)
    
    # Check payment status
    if payment.status == 'pending' and payment.transaction_id:
        mpesa = MpesaAPI()
        result = mpesa.check_transaction_status(payment.transaction_id)
        
        if result['success'] and result['data'].get('ResultCode') == '0':
            payment.status = 'completed'
            payment.mpesa_code = result['data'].get('MpesaReceiptNumber')
            payment.receipt_number = result['data'].get('MpesaReceiptNumber')
            payment.save()
            
            # Update student fee
            student_fee = payment.student_fee
            student_fee.amount_paid += payment.amount
            student_fee.save()
            
            # Generate receipt
            PaymentReceipt.objects.create(payment=payment)
    
    return render(request, 'payments/payment_status.html', {
        'payment': payment,
        'student': payment.student,
    })

@login_required
@user_passes_test(is_student)
def payment_history(request):
    try:
        student = Student.objects.get(user=request.user)
        payments = Payment.objects.filter(student=student).order_by('-payment_date')
        
        return render(request, 'payments/payment_history.html', {
            'payments': payments,
            'student': student,
        })
        
    except Student.DoesNotExist:
        messages.error(request, 'Student profile not found.')
        return redirect('dashboard')

# ===== M-Pesa Callback View =====

@csrf_exempt
def mpesa_callback(request):
    """Handle M-Pesa callback"""
    if request.method == 'POST':
        try:
            data = json.loads(request.body)
            callback_data = data.get('Body', {}).get('stkCallback', {})
            
            checkout_request_id = callback_data.get('CheckoutRequestID')
            result_code = callback_data.get('ResultCode')
            result_desc = callback_data.get('ResultDesc')
            
            # Find the payment
            payment = Payment.objects.filter(
                transaction_id=checkout_request_id,
                status='pending'
            ).first()
            
            if payment:
                if result_code == '0':
                    # Payment successful
                    payment.status = 'completed'
                    payment.mpesa_code = callback_data.get('CallbackMetadata', {}).get('Item', [{}])[1].get('Value', '')
                    payment.receipt_number = callback_data.get('CallbackMetadata', {}).get('Item', [{}])[1].get('Value', '')
                    
                    # Update student fee
                    student_fee = payment.student_fee
                    student_fee.amount_paid += payment.amount
                    student_fee.save()
                    
                    # Generate receipt
                    PaymentReceipt.objects.create(payment=payment)
                    
                else:
                    # Payment failed
                    payment.status = 'failed'
                    payment.description = result_desc
                
                payment.save()
            
            return JsonResponse({'ResultCode': 0, 'ResultDesc': 'Success'})
            
        except Exception as e:
            return JsonResponse({'ResultCode': 1, 'ResultDesc': str(e)})
    
    return JsonResponse({'ResultCode': 1, 'ResultDesc': 'Invalid request method'})

# ===== Public Views =====

@login_required
def fee_summary(request):
    """Fee summary for all users"""
    if request.user.is_admin():
        student_fees = StudentFee.objects.all()
    elif request.user.is_teacher():
        try:
            teacher = request.user.teacher_profile
            classes = teacher.get_classes_list()
            student_fees = StudentFee.objects.filter(
                student__grade__in=classes
            )
        except:
            student_fees = StudentFee.objects.none()
    elif request.user.is_student():
        try:
            student = Student.objects.get(user=request.user)
            student_fees = StudentFee.objects.filter(student=student)
        except:
            student_fees = StudentFee.objects.none()
    else:
        student_fees = StudentFee.objects.none()
    
    return render(request, 'payments/fee_summary.html', {
        'student_fees': student_fees,
        'user': request.user,
    })


@login_required
def generate_receipt(request, payment_id):
    """Generate and display payment receipt"""
    payment = get_object_or_404(Payment, id=payment_id)
    
    # Check if user has permission to view this receipt
    if not (request.user.is_admin() or 
            (request.user.is_student() and payment.student.user == request.user)):
        messages.error(request, 'Access denied.')
        return redirect('dashboard')
    
    try:
        receipt = PaymentReceipt.objects.get(payment=payment)
    except PaymentReceipt.DoesNotExist:
        receipt = PaymentReceipt.objects.create(payment=payment)
    
    # Calculate balance information
    if payment.student_fee:
        previous_balance = payment.student_fee.balance + payment.amount
        new_balance = payment.student_fee.balance
    else:
        previous_balance = None
        new_balance = None
    
    return render(request, 'payments/payment_receipt.html', {
        'payment': payment,
        'receipt': receipt,
        'previous_balance': previous_balance,
        'new_balance': new_balance,
    })

@login_required
@user_passes_test(is_admin)
def financial_report(request):
    """Generate financial reports"""
    # Get date range from request or use default (current month)
    from_date = request.GET.get('from_date', timezone.now().replace(day=1).date())
    to_date = request.GET.get('to_date', timezone.now().date())
    
    # Convert string dates to date objects
    if isinstance(from_date, str):
        from_date = datetime.strptime(from_date, '%Y-%m-%d').date()
    if isinstance(to_date, str):
        to_date = datetime.strptime(to_date, '%Y-%m-%d').date()
    
    # Get payments in date range
    payments = Payment.objects.filter(
        payment_date__date__range=[from_date, to_date],
        status='completed'
    )
    
    # Calculate statistics
    total_payments = payments.aggregate(Sum('amount'))['amount__sum'] or 0
    
    # Group by payment method
    payment_methods = payments.values('payment_method').annotate(
        total=Sum('amount'),
        count=Count('id')
    )
    
    # Get student fee statistics
    student_fees = StudentFee.objects.all()
    total_due = student_fees.aggregate(Sum('amount_due'))['amount_due__sum'] or 0
    total_paid_fees = student_fees.aggregate(Sum('amount_paid'))['amount_paid__sum'] or 0
    total_balance = student_fees.aggregate(Sum('balance'))['balance__sum'] or 0
    
    return render(request, 'payments/financial_report.html', {
        'payments': payments,
        'total_payments': total_payments,
        'payment_methods': payment_methods,
        'student_fees': student_fees,
        'total_due': total_due,
        'total_paid_fees': total_paid_fees,
        'total_balance': total_balance,
        'from_date': from_date,
        'to_date': to_date,
    })

@login_required
def download_receipt(request, payment_id):
    """Download receipt as PDF"""
    payment = get_object_or_404(Payment, id=payment_id)
    
    # Check permissions
    if not (request.user.is_admin() or 
            (request.user.is_student() and payment.student.user == request.user)):
        messages.error(request, 'Access denied.')
        return redirect('dashboard')
    
    # In a real implementation, you would generate a PDF here
    # For now, redirect to the HTML receipt
    return redirect('generate_receipt', payment_id=payment_id)\n\n========== FILE: ./payments/__init__.py ==========\n
\n\n========== FILE: ./readme.md ==========\n
Here are Git Bash terminal commands to undo recent edits in your project:

## Option 1: Undo last 5-10 commits (if you've committed them)

```bash
# See last 10 commits first
git log --oneline -10

# Undo last 5 commits (keep changes locally)
git reset --soft HEAD~5

# Undo last 10 commits (keep changes locally)
git reset --soft HEAD~10

# Undo last 5 commits (DESTROY changes - careful!)
git reset --hard HEAD~5

# Undo last 10 commits (DESTROY changes - careful!)
git reset --hard HEAD~10
```

## Option 2: Undo uncommitted changes in specific files

```bash
# Check which files have changes
git status

# Undo changes in a specific file
git checkout -- path/to/file.py

# Undo changes in multiple specific files
git checkout -- accounts/templates/accounts/base.html
git checkout -- school_a/settings.py
git checkout -- marks/models.py

# Undo all uncommitted changes (careful!)
git checkout -- .

# Or use restore command (Git 2.23+)
git restore path/to/file.py
```

## Option 3: Stash changes temporarily

```bash
# Save all uncommitted changes to stash
git stash

# See list of stashes
git stash list

# Apply the last stash back
git stash pop

# Apply specific stash (stash@{2} means 3rd stash)
git stash apply stash@{2}

# Drop a stash (delete it)
git stash drop stash@{0}
```

## Option 4: Find and revert specific changes

```bash
# Find what changed in last 5 commits
git diff HEAD~5 HEAD

# Create a reverse patch for last 5 commits
git diff HEAD~5 HEAD > changes.patch
git apply -R changes.patch

# Interactive revert (choose which changes to undo)
git add -p
```

## Option 5: Reset to specific commit

```bash
# First, find the commit hash you want to go back to
git log --oneline --graph -20

# Copy the commit hash you want to return to
# Then reset to that commit (keeps changes)
git reset --soft <commit-hash>

# Or reset to that commit (destroys changes)
git reset --hard <commit-hash>
```

## Option 6: Safe approach - Create backup first

```bash
# Create a backup branch first (RECOMMENDED)
git branch backup-before-undo-$(date +%Y%m%d-%H%M%S)

# Check which branch you're on
git branch

# Now you can safely undo changes
git reset --soft HEAD~5

# If you mess up, go back to backup
git checkout backup-branch-name
```

## Option 7: Most likely what you need (undo recent file edits)

```bash
# 1. First, check what you changed recently
git status

# 2. If you want to undo ALL recent uncommitted changes:
git stash

# 3. Or selectively undo files:
git checkout -- accounts/templates/accounts/base.html
git checkout -- marks/views.py
git checkout -- marks/models.py

# 4. To see what you're about to undo:
git diff
```

## Option 8: Smart undo for specific number of edits

```bash
# Custom function to undo N edits
undo_edits() {
    if [ -z "$1" ]; then
        echo "Usage: undo_edits <number>"
        echo "Example: undo_edits 5"
        return 1
    fi
    
    echo "Creating backup branch..."
    git branch "backup-undo-$1-$(date +%s)"
    
    echo "Undoing last $1 commits..."
    git reset --soft HEAD~$1
    
    echo "Done! Changes are preserved locally."
    echo "Run 'git status' to see unstaged changes."
    echo "Run 'git reset --hard HEAD~$1' to DESTROY changes."
}

# Add this to your .bashrc or run directly
# Then use: undo_edits 5
```

## Quick Recovery Commands:

```bash
# If you accidentally did hard reset and want to recover:
git reflog
# Find the commit before the reset, then:
git reset --hard HEAD@{1}

# To completely discard all local changes and commits:
git fetch origin
git reset --hard origin/main  # or origin/master, origin/develop
```

## **SAFEST APPROACH - Step by step:**

```bash
# 1. First, make sure you don't lose work
git stash
# or
git add .
git commit -m "Backup before undo"

# 2. Check your recent history
git log --oneline -10

# 3. Decide how many commits to undo
# For 5 commits (keeps changes):
git reset --soft HEAD~5

# 4. Review what's left
git status

# 5. If you want to keep some changes, commit them:
git add .
git commit -m "Saved important changes"

# 6. If you want to discard everything:
git reset --hard
```

**Important:** Use `--soft` to keep your changes locally, use `--hard` only if you're sure you want to permanently delete changes. Always create a backup branch first!


accounts/base.html - UPDATE THIS LINE:
Find this line (around line 94):

html
{% if 'student_performance_detail' in request.resolver_match.url_name %}
Change to:

html
{% if student_id and 'student_performance_detail' in request.resolver_match.url_name %}
Find these lines (around lines 103-111):

html
<li class="nav-item">
    {% if user.student and user.student.id %}
    <a class="nav-link {% if 'student_performance_detail' in request.resolver_match.url_name %}active{% endif %}" 
       href="{% url 'student_performance_detail' user.student.id %}"
       title="View your performance trends and analytics">
        <i class="fas fa-chart-line"></i> Performance Trends
    </a>
    {% else %}
    <a class="nav-link disabled" href="#"
       title="Student profile not found. Please contact administration.">
        <i class="fas fa-chart-line"></i> Performance Trends
    </a>
    {% endif %}
</li>
Change to:

html
<li class="nav-item">
    {% if user.has_student_profile and user.student_profile.id %}
    <a class="nav-link {% if 'student_performance_detail' in request.resolver_match.url_name %}active{% endif %}" 
       href="{% url 'student_performance_detail' user.student_profile.id %}"
       title="View your performance trends and analytics">
        <i class="fas fa-chart-line"></i> Performance Trends
    </a>
    {% else %}
    <a class="nav-link disabled" href="#"
       title="Student profile not found. Please contact administration.">
        <i class="fas fa-chart-line"></i> Performance Trends
    </a>
    {% endif %}
</li>
Find this line (around line 254):

html
{% if user.student and user.student.id %}
Change to:

html
{% if user.has_student_profile and user.student_profile.id %}
Find this line (around line 271):

html
{% if user.student and user.student.id %}
Change to:

html
{% if user.has_student_profile and user.student_profile.id %}
















# **School Administration System - Project Overview**

## **ðŸŽ¯ What It Does**

This is a **comprehensive school management system** built with Django that handles:
- **Student management** (admissions, profiles, academic records)
- **Teacher management** (assignments, qualifications, classes)
- **Academic management** (subjects, marks, grading, reports)
- **Financial management** (fee structures, payments, M-Pesa integration)
- **Communication system** (messages, notifications, announcements)
- **Performance analytics** (trend analysis, reporting, dashboards)

## **ðŸ› ï¸ How It Works**

### **Architecture:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         School Administration System                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Frontend: Bootstrap 5 + Custom CSS + Font Awesome  â”‚
â”‚  Backend: Django 5.2 + Django Unfold (Admin Theme)  â”‚
â”‚  Database: SQLite3 (Development)                    â”‚
â”‚  Authentication: Custom User Model with 3 roles     â”‚
â”‚  Payment: M-Pesa API Integration                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Core Components:**

1. **Custom User Model** (`accounts.User`):
   - 3 roles: Admin, Teacher, Student
   - Role-based permissions and dashboards
   - Profile management for each role

2. **Multi-App Structure:**
   - `accounts`: Authentication & user management
   - `students`: Student profiles and management
   - `teachers`: Teacher profiles and management  
   - `marks`: Academic records and performance tracking
   - `payments`: Financial management with M-Pesa
   - `school_messages`: Communication system

3. **Database Design:**
   ```python
   User â†’ Student/Teacher (OneToOne)
   Student â†’ Marks (OneToMany)
   Teacher â†’ Subjects (ManyToMany)
   Subject â†’ Marks (ForeignKey)
   Student â†’ Payments (OneToMany)
   ```

## **âœ¨ Key Features & Functions**

### **1. User Role Features:**

#### **Admin Users:**
- âœ… Full system control
- âœ… Student/Teacher management
- âœ… Fee structure setup
- âœ… Financial reports
- âœ… Performance analytics dashboard
- âœ… System configuration
- âœ… Message broadcasting

#### **Teacher Users:**
- âœ… Class management
- âœ… Mark entry and editing
- âœ… Student performance tracking
- âœ… Communication with students
- âœ… Attendance tracking
- âœ… Grade analysis

#### **Student Users:**
- âœ… View academic results
- âœ… Performance trend analysis
- âœ… Fee payment tracking
- âœ… Message system
- âœ… Profile management
- âœ… Academic progress monitoring

### **2. Academic Management:**

#### **Marks System:**
- **CAT 1** (20%), **CAT 2** (20%), **Main Exam** (60%)
- **Automatic grade calculation** (A-F grading system)
- **Term-wise organization**
- **Subject categorization** (Sciences, Humanities, etc.)
- **Performance trend analysis**

#### **Performance Analytics:**
- **Student trend analysis** (improving/declining/stable)
- **Term comparison tools**
- **Subject-wise performance**
- **Automated report generation**
- **Visual dashboards**

### **3. Financial Management:**

#### **Payment System:**
- **Fee structure management**
- **M-Pesa integration** (Lipa Na M-Pesa)
- **Payment tracking**
- **Receipt generation**
- **Financial reports**
- **Payment reminders**

### **4. Communication System:**

#### **Messaging:**
- **Internal messaging** between users
- **Notifications system**
- **Holiday notices**
- **Announcements**
- **Read receipts**
- **Inbox/Outbox organization**

### **5. Reporting & Analytics:**

#### **Reports Generated:**
- **Student academic reports**
- **Class performance reports**
- **Financial statements**
- **Attendance reports**
- **Teacher performance**
- **System usage analytics**

## **ðŸš€ Technical Implementation**

### **Django Apps Structure:**
```
school_a_project/
â”œâ”€â”€ accounts/          # Authentication & users
â”œâ”€â”€ students/          # Student management
â”œâ”€â”€ teachers/          # Teacher management
â”œâ”€â”€ marks/            # Academic records
â”œâ”€â”€ payments/         # Financial system
â”œâ”€â”€ school_messages/  # Communication
â””â”€â”€ school_a/         # Main project settings
```

### **Key Models:**
- **`Student`**: Academic records, classes, parent info
- **`Teacher`**: Qualifications, subjects, classes taught
- **`Subject`**: Course catalog with categories
- **`Mark`**: Academic performance with auto-grading
- **`Payment`**: Financial transactions with M-Pesa
- **`Message`**: Communication between users
- **`PerformanceTrend`**: Analytics and trend tracking

### **Custom Features Implemented:**

1. **Dynamic Navigation**: Role-based menu system
2. **Auto-Grading**: Automatic grade calculation based on scores
3. **Performance Analysis**: Trend detection algorithms
4. **M-Pesa Integration**: Real-time payment processing
5. **Responsive Design**: Mobile-friendly interface
6. **Real-time Notifications**: Unread message counters
7. **Data Visualization**: Performance charts and graphs

## **ðŸ“Š Current Status**

### **âœ… Completed:**
- User authentication system
- Student/Teacher profiles
- Marks entry and calculation
- Basic financial management
- Messaging system
- Performance analytics
- Admin interface with Unfold
- Responsive frontend design
- Sample data population

### **ðŸ”„ In Progress:**
- Advanced analytics features
- M-Pesa production integration
- Report generation system
- Bulk operations
- Export functionalities

### **ðŸ“‹ Todo/Planned:**
- Attendance tracking system
- Exam scheduling
- Library management
- Inventory management
- Parent portal
- Mobile app
- API for third-party integrations

## **âš¡ Production Scaling Guide**

### **Phase 1: Immediate Production Deployment**

#### **1. Database Migration:**
```bash
# Switch from SQLite to PostgreSQL
pip install psycopg2-binary

# Update settings.py
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'school_db',
        'USER': 'school_user',
        'PASSWORD': 'secure_password',
        'HOST': 'localhost',
        'PORT': '5432',
    }
}
```

#### **2. Security Enhancements:**
```python
# In settings.py
DEBUG = False
ALLOWED_HOSTS = ['yourdomain.com', 'www.yourdomain.com']

# HTTPS settings
SECURE_SSL_REDIRECT = True
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True

# Production secret key
SECRET_KEY = os.getenv('SECRET_KEY', 'generate-strong-key-here')
```

#### **3. Static Files & Media:**
```python
# Use WhiteNoise for static files
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

# In production, use CDN or S3
# AWS S3 Configuration
AWS_ACCESS_KEY_ID = os.getenv('AWS_ACCESS_KEY_ID')
AWS_SECRET_ACCESS_KEY = os.getenv('AWS_SECRET_ACCESS_KEY')
AWS_STORAGE_BUCKET_NAME = 'school-system-bucket'
DEFAULT_FILE_STORAGE = 'storages.backends.s3boto3.S3Boto3Storage'
```

### **Phase 2: Performance Optimization**

#### **1. Caching:**
```python
# Redis caching
CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': 'redis://127.0.0.1:6379/1',
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        }
    }
}

# Session engine
SESSION_ENGINE = 'django.contrib.sessions.backends.cache'
SESSION_CACHE_ALIAS = 'default'
```

#### **2. Database Optimization:**
```python
# Add database indexes
class Meta:
    indexes = [
        models.Index(fields=['student', 'term']),
        models.Index(fields=['created_at']),
    ]

# Use database connection pooling
DATABASE_POOL_CLASS = 'sqlalchemy.pool.QueuePool'
```

#### **3. Async Tasks (Celery):**
```bash
# Install Celery
pip install celery redis

# Create celery.py
# Configure for background tasks:
# - Email sending
# - Report generation
# - Payment processing
# - Notification delivery
```

### **Phase 3: Scalability Enhancements**

#### **1. Load Balancing:**
```nginx
# Nginx configuration for load balancing
upstream school_app {
    server 127.0.0.1:8000;
    server 127.0.0.1:8001;
    server 127.0.0.1:8002;
}

server {
    listen 80;
    server_name yourdomain.com;
    
    location / {
        proxy_pass http://school_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

#### **2. Database Sharding Strategy:**
```python
# Student data by year/school
# Payments by term/year
# Messages by user groups
```

#### **3. Microservices Architecture (Future):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               API Gateway                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Auth Service  â”‚  Academic Service â”‚  Finance Serviceâ”‚
â”‚  User Service  â”‚  Messaging Serviceâ”‚  Analytics Serviceâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Phase 4: Monitoring & Maintenance**

#### **1. Monitoring Setup:**
```bash
# Install monitoring tools
pip install django-debug-toolbar
pip install sentry-sdk

# Configure Sentry for error tracking
import sentry_sdk
sentry_sdk.init(
    dsn="your-sentry-dsn",
    integrations=[DjangoIntegration()]
)
```

#### **2. Backup Strategy:**
```bash
# Automated database backups
0 2 * * * pg_dump school_db > /backups/school_$(date +\%Y\%m\%d).sql

# Media files backup to S3/Cloud Storage
0 3 * * * aws s3 sync /media s3://backup-bucket/media/
```

#### **3. Logging Configuration:**
```python
LOGGING = {
    'version': 1,
    'handlers': {
        'file': {
            'level': 'ERROR',
            'class': 'logging.FileHandler',
            'filename': '/var/log/django/errors.log',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['file'],
            'level': 'ERROR',
            'propagate': True,
        },
    },
}
```

### **Phase 5: Advanced Features**

#### **1. Mobile Application:**
```bash
# Use Django REST Framework for API
pip install djangorestframework
pip install django-cors-headers

# Create mobile API endpoints
# Use React Native/Flutter for mobile app
```

#### **2. Advanced Analytics:**
```python
# Machine learning for predictive analytics
pip install scikit-learn pandas

# Features:
# - Dropout prediction
# - Performance forecasting
# - Resource optimization
```

#### **3. Integration Ecosystem:**
```
Integrations to add:
- SMS Gateway (Twilio, Africa's Talking)
- Email Service (SendGrid, Mailgun)
- Government Education Portal APIs
- Payment Gateways (Stripe, PayPal)
- Cloud Storage (AWS S3, Google Cloud)
- Calendar Integration (Google Calendar)
```

## **ðŸ“ˆ Performance Metrics to Track**

1. **System Metrics:**
   - Response time (< 200ms)
   - Uptime (> 99.9%)
   - Concurrent users support
   - Database query performance

2. **Business Metrics:**
   - Student enrollment rate
   - Payment collection rate
   - Teacher-student ratio
   - System adoption rate

3. **User Metrics:**
   - Login frequency
   - Feature usage patterns
   - Support tickets
   - User satisfaction

## **ðŸ”§ Deployment Checklist**

### **Pre-Deployment:**
- [ ] Database migrated to PostgreSQL
- [ ] Environment variables configured
- [ ] SSL certificate installed
- [ ] Backup system in place
- [ ] Monitoring tools configured
- [ ] Load testing completed

### **Post-Deployment:**
- [ ] Regular security audits
- [ ] Performance monitoring
- [ ] User training conducted
- [ ] Support system established
- [ ] Regular updates scheduled

## **ðŸŽ¯ Success Indicators**

1. **Technical Success:**
   - System handles 1000+ concurrent users
   - 99.9% uptime
   - < 2 second page load times

2. **Business Success:**
   - 80%+ user adoption rate
   - 30% reduction in administrative tasks
   - Improved student performance tracking
   - Faster payment processing

3. **User Success:**
   - High satisfaction scores
   - Reduced manual errors
   - Improved communication
   - Easy access to information

## **ðŸš¨ Emergency Procedures**

1. **Database Recovery:**
   ```bash
   # Restore from backup
   psql school_db < backup_file.sql
   
   # Point-in-time recovery
   pg_restore --dbname=school_db backup_file.dump
   ```

2. **Rollback Procedure:**
   ```bash
   # Git-based rollback
   git checkout previous-stable-tag
   python manage.py migrate
   ```

3. **Disaster Recovery:**
   - Hot standby database
   - Geographic redundancy
   - Automated failover

## **ðŸ’¡ Pro Tips for Scaling**

1. **Start with:** PostgreSQL + Gunicorn + Nginx
2. **Add caching early:** Redis for sessions and frequently accessed data
3. **Use CDN:** For static assets to reduce server load
4. **Implement queueing:** Celery for background tasks
5. **Monitor everything:** Set up alerts for critical metrics
6. **Regular backups:** Automated and tested recovery procedures
7. **Security first:** Regular updates and security patches
8. **Document everything:** Especially custom business logic

This system is production-ready with the current features and can scale to support thousands of users with proper infrastructure planning. The modular design allows for easy addition of new features and integration with external systems.\n\n========== FILE: ./requirements.txt ==========\n
Django>=5.0
django-unfold>=0.18.0

# Optional dependencies
django-crispy-forms>=2.0
crispy-bootstrap5>=0.7
django-extensions>=3.2.0
django-import-export>=4.0.0
django-guardian>=2.4.0
Pillow>=10.0.0\n\n========== FILE: ./school_a/asgi.py ==========\n
import os
from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'school_a.settings')
application = get_asgi_application()\n\n========== FILE: ./school_a/settings.py ==========\n
"""
Django settings for school_a project.
"""

import os
from pathlib import Path
from dotenv import load_dotenv

# Load environment variables from .env file
load_dotenv()

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

# =============================================
# SECURITY SETTINGS
# =============================================

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = os.getenv(
    'SECRET_KEY', 
    'django-insecure-your-secret-key-here'
)

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = os.getenv('DEBUG', 'True').lower() in ('true', '1', 't')

# Parse ALLOWED_HOSTS from comma-separated string
allowed_hosts_str = os.getenv('ALLOWED_HOSTS', 'localhost,127.0.0.1')
ALLOWED_HOSTS = [host.strip() for host in allowed_hosts_str.split(',') if host.strip()]

# =============================================
# SECURITY MIDDLEWARE SETTINGS
# =============================================

# Security settings based on DEBUG mode
CSRF_COOKIE_SECURE = os.getenv('CSRF_COOKIE_SECURE', 'False').lower() in ('true', '1', 't')
SESSION_COOKIE_SECURE = os.getenv('SESSION_COOKIE_SECURE', 'False').lower() in ('true', '1', 't')
SESSION_COOKIE_HTTPONLY = True

# Parse CSRF_TRUSTED_ORIGINS from environment variable
csrf_origins_str = os.getenv('CSRF_TRUSTED_ORIGINS', 'http://localhost:8000,http://127.0.0.1:8000')
CSRF_TRUSTED_ORIGINS = [origin.strip() for origin in csrf_origins_str.split(',') if origin.strip()]

# Session settings
SESSION_COOKIE_AGE = 1209600  # 2 weeks in seconds
SESSION_EXPIRE_AT_BROWSER_CLOSE = False

# =============================================
# APPLICATION DEFINITION
# =============================================

INSTALLED_APPS = [
    # Core Django Unfold
    'unfold',
    
    # Django core apps
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    
    # Your project apps (CORRECTED - without .Config)
    'accounts',
    'students',
    'teachers',
    'marks',
    'payments',
    'school_messages',
]

MIDDLEWARE = [
    # Security middleware
    'django.middleware.security.SecurityMiddleware',
    
    # WhiteNoise for static files (optional - uncomment if using)
    # 'whitenoise.middleware.WhiteNoiseMiddleware',
    
    # Session management
    'django.contrib.sessions.middleware.SessionMiddleware',
    
    # Common functionality
    'django.middleware.common.CommonMiddleware',
    
    # CSRF protection
    'django.middleware.csrf.CsrfViewMiddleware',
    
    # Authentication
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    
    # Messages framework
    'django.contrib.messages.middleware.MessageMiddleware',
    
    # Clickjacking protection
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'school_a.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [os.path.join(BASE_DIR, 'templates')],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
                'django.template.context_processors.media',
            ],
        },
    },
]

WSGI_APPLICATION = 'school_a.wsgi.application'

# =============================================
# DATABASE
# =============================================

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

# =============================================
# PASSWORD VALIDATION
# =============================================

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]

# =============================================
# INTERNATIONALIZATION
# =============================================

LANGUAGE_CODE = 'en-us'

TIME_ZONE = os.getenv('TIME_ZONE', 'UTC')

USE_I18N = True

USE_TZ = True

# =============================================
# STATIC & MEDIA FILES
# =============================================

STATIC_URL = 'static/'
STATICFILES_DIRS = [os.path.join(BASE_DIR, 'static')]
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')

MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

# =============================================
# DEFAULT PRIMARY KEY
# =============================================

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# =============================================
# AUTHENTICATION
# =============================================

AUTH_USER_MODEL = 'accounts.User'

LOGIN_URL = 'login'
LOGIN_REDIRECT_URL = 'dashboard'
LOGOUT_REDIRECT_URL = 'login'

# =============================================
# M-PESA CONFIGURATION (from environment)
# =============================================

MPESA_CONFIG = {
    'CONSUMER_KEY': os.getenv('MPESA_CONSUMER_KEY', 'your_consumer_key_here'),
    'CONSUMER_SECRET': os.getenv('MPESA_CONSUMER_SECRET', 'your_consumer_secret_here'),
    'SHORTCODE': os.getenv('MPESA_SHORTCODE', 'your_shortcode_here'),
    'PASSKEY': os.getenv('MPESA_PASSKEY', 'your_passkey_here'),
    'CALLBACK_URL': os.getenv('MPESA_CALLBACK_URL', 'https://yourdomain.com/payments/mpesa-callback/'),
    'ENVIRONMENT': os.getenv('MPESA_ENVIRONMENT', 'sandbox'),  # 'sandbox' or 'production'
}

# =============================================
# EMAIL CONFIGURATION
# =============================================

EMAIL_BACKEND = os.getenv('EMAIL_BACKEND', 'django.core.mail.backends.console.EmailBackend')
EMAIL_HOST = os.getenv('EMAIL_HOST', 'localhost')
EMAIL_PORT = int(os.getenv('EMAIL_PORT', 25))
EMAIL_USE_TLS = os.getenv('EMAIL_USE_TLS', 'False').lower() in ('true', '1', 't')
EMAIL_HOST_USER = os.getenv('EMAIL_HOST_USER', '')
EMAIL_HOST_PASSWORD = os.getenv('EMAIL_HOST_PASSWORD', '')

# =============================================
# DJANGO UNFOLD CONFIGURATION - FIXED
# =============================================

UNFOLD = {
    "SITE_TITLE": os.getenv('UNFOLD_SITE_TITLE', 'School Admin System'),
    "SITE_HEADER": os.getenv('UNFOLD_SITE_HEADER', 'School Administration'),
    "SITE_URL": os.getenv('UNFOLD_SITE_URL', '/'),
    "SITE_SYMBOL": os.getenv('UNFOLD_SITE_SYMBOL', 'school'),
    "SHOW_HISTORY": True,
    "SHOW_VIEW_ON_SITE": True,
    
    # Custom CSS stylesheets
    "STYLES": [
        "/static/css/unfold-custom.css",  # Primary custom styles
        "/static/css/admin-overrides.css",  # Additional overrides
    ],
    
    # Custom JavaScript files
    "SCRIPTS": [
        "/static/js/unfold-custom.js",  # Custom JavaScript functionality
    ],
    
    "COLORS": {
        "primary": {
            "50": "250 245 255",
            "100": "243 232 255",
            "200": "233 213 255",
            "300": "216 180 254",
            "400": "192 132 252",
            "500": "168 85 247",
            "600": "147 51 234",
            "700": "126 34 206",
            "800": "107 33 168",
            "900": "88 28 135",
            "950": "59 7 100",
        },
    },
    "SIDEBAR": {
        "show_search": True,
        "show_all_applications": True,
        "navigation": [
            {
                "title": "Dashboard",
                "icon": "dashboard",
                "items": [  # FIXED: Changed from "link" to "items" array
                    {
                        "title": "Admin Dashboard",
                        "icon": "dashboard",
                        "link": "/admin/",
                    },
                ],
            },
            {
                "title": "Users",
                "icon": "people",
                "items": [
                    {
                        "title": "Students",
                        "icon": "school",
                        "link": "/admin/students/student/",
                    },
                    {
                        "title": "Teachers",
                        "icon": "person",
                        "link": "/admin/teachers/teacher/",
                    },
                    {
                        "title": "Administrators",
                        "icon": "admin_panel_settings",
                        "link": "/admin/accounts/user/",
                    },
                ],
            },
            {
                "title": "Academic",
                "icon": "book",
                "items": [
                    {
                        "title": "Subjects",
                        "icon": "subject",
                        "link": "/admin/marks/subject/",
                    },
                    {
                        "title": "Marks",
                        "icon": "grade",
                        "link": "/admin/marks/mark/",
                    },
                    {
                        "title": "Student Reports",
                        "icon": "description",
                        "link": "/admin/marks/studentreport/",
                    },
                    {
                        "title": "Performance Trends",
                        "icon": "trending_up",
                        "link": "/admin/marks/performancetrend/",
                    },
                ],
            },
            {
                "title": "Financial",
                "icon": "payments",
                "items": [
                    {
                        "title": "Fee Payments",
                        "icon": "payment",
                        "link": "/admin/payments/payment/",
                    },
                    {
                        "title": "Fee Structures",
                        "icon": "request_quote",
                        "link": "/admin/payments/feestructure/",
                    },
                ],
            },
            {
                "title": "Communication",
                "icon": "message",
                "items": [
                    {
                        "title": "Messages",
                        "icon": "email",
                        "link": "/admin/school_messages/message/",
                    },
                    {
                        "title": "Holiday Notices",
                        "icon": "event",
                        "link": "/admin/school_messages/holidaynotice/",
                    },
                    {
                        "title": "Notifications",
                        "icon": "notifications",
                        "link": "/admin/school_messages/notification/",
                    },
                ],
            },
            {
                "title": "Analytics",
                "icon": "analytics",
                "items": [  # FIXED: Changed from "link" to "items" array
                    {
                        "title": "Performance Analytics",
                        "icon": "trending_up",
                        "link": "/marks/analytics/student-performance/",
                        "permission": lambda request: request.user.is_staff,
                    },
                ],
            },
            {
                "title": "System",
                "icon": "settings",
                "items": [
                    {
                        "title": "Groups",
                        "icon": "group",
                        "link": "/admin/auth/group/",
                    },
                    {
                        "title": "Permissions",
                        "icon": "lock",
                        "link": "/admin/auth/permission/",
                    },
                ],
            },
        ],
    },
    
    # Version information
    "VERSION": "1.0.0",
    
    # REMOVE or COMMENT OUT TABS - it's causing conflicts
    # "TABS": [
    #     {
    #         "models": [
    #             "accounts.user",
    #             "auth.group",
    #         ],
    #         "items": [
    #             {
    #                 "title": "Users",
    #                 "link": "/admin/accounts/user/",
    #             },
    #             {
    #                 "title": "Groups",
    #                 "link": "/admin/auth/group/",
    #             },
    #         ],
    #     },
    # ],
}\n\n========== FILE: ./school_a/urls.py ==========\n
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('accounts.urls')),
    path('students/', include('students.urls')),
    path('teachers/', include('teachers.urls')),
    path('marks/', include('marks.urls')),
    path('payments/', include('payments.urls')),  # Added payments URLs
    path('messages/', include('school_messages.urls')),  # Keep URL as /messages/ but include school_messages.urls
]

if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)\n\n========== FILE: ./school_a/wsgi.py ==========\n
import os
from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'school_a.settings')
application = get_wsgi_application()\n\n========== FILE: ./school_a/__init__.py ==========\n
\n\n========== FILE: ./school_messages/admin.py ==========\n
from django.contrib import admin
from unfold.admin import ModelAdmin
from .models import Message, MessageRecipient, Notification, HolidayNotice, BroadcastSchedule

@admin.register(Message)
class MessageAdmin(ModelAdmin):
    list_display = ('subject', 'sender', 'message_type', 'priority', 'is_published', 'created_at')
    list_filter = ('message_type', 'priority', 'is_published', 'created_at')
    search_fields = ('subject', 'content', 'sender__username')
    readonly_fields = ('created_at', 'published_at')
    fieldsets = (
        ('Message Information', {
            'fields': ('sender', 'subject', 'content', 'message_type', 'priority')
        }),
        ('Recipients', {
            'fields': ('send_to_all', 'students', 'teachers')
        }),
        ('Status & Delivery', {
            'fields': ('is_published', 'requires_acknowledgement', 'attachments', 'tags')
        }),
        ('Timestamps', {
            'fields': ('created_at', 'scheduled_for', 'published_at'),
            'classes': ('collapse',)
        }),
    )

@admin.register(MessageRecipient)
class MessageRecipientAdmin(ModelAdmin):
    list_display = ('message', 'student', 'teacher', 'is_read', 'acknowledged', 'email_sent', 'sms_sent')
    list_filter = ('is_read', 'acknowledged', 'email_sent', 'sms_sent')
    search_fields = ('message__subject', 'student__user__username', 'teacher__user__username')
    readonly_fields = ('created_at', 'updated_at')

@admin.register(Notification)
class NotificationAdmin(ModelAdmin):
    list_display = ('user', 'title', 'notification_type', 'is_read', 'is_important', 'created_at')
    list_filter = ('notification_type', 'is_read', 'is_important', 'created_at')
    search_fields = ('user__username', 'title', 'message')
    readonly_fields = ('created_at',)

@admin.register(HolidayNotice)
class HolidayNoticeAdmin(ModelAdmin):
    list_display = ('title', 'start_date', 'end_date', 'school_reopens', 'is_active')
    list_filter = ('is_active', 'start_date', 'end_date')
    search_fields = ('title', 'description')
    readonly_fields = ('created_at', 'updated_at')
    fieldsets = (
        ('Holiday Information', {
            'fields': ('title', 'description', 'start_date', 'end_date', 'school_reopens')
        }),
        ('Notification Settings', {
            'fields': ('notify_students', 'notify_parents', 'notify_teachers')
        }),
        ('Additional Information', {
            'fields': ('important_notes', 'contact_person', 'contact_phone')
        }),
        ('Administration', {
            'fields': ('created_by', 'is_active')
        }),
        ('Timestamps', {
            'fields': ('created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )

@admin.register(BroadcastSchedule)
class BroadcastScheduleAdmin(ModelAdmin):
    list_display = ('message', 'frequency', 'scheduled_time', 'is_active', 'last_sent')
    list_filter = ('frequency', 'is_active')
    search_fields = ('message__subject',)
    readonly_fields = ('last_sent', 'next_send', 'created_at', 'updated_at')\n\n========== FILE: ./school_messages/apps.py ==========\n
from django.apps import AppConfig

class SchoolMessagesConfig(AppConfig):  # Changed class name
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'school_messages'  # Changed name\n\n========== FILE: ./school_messages/forms.py ==========\n
from django import forms
from .models import Message, HolidayNotice, BroadcastSchedule
from students.models import Student
from teachers.models import Teacher
from django.utils import timezone

class MessageForm(forms.ModelForm):
    class Meta:
        model = Message
        fields = [
            'subject', 'content', 'message_type', 'priority',
            'send_to_all', 'students', 'teachers',
            'requires_acknowledgement', 'attachments', 'tags'
        ]
        widgets = {
            'subject': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Enter message subject'}),
            'content': forms.Textarea(attrs={'class': 'form-control', 'rows': 6, 'placeholder': 'Enter message content'}),
            'students': forms.SelectMultiple(attrs={'class': 'form-control'}),
            'teachers': forms.SelectMultiple(attrs={'class': 'form-control'}),
            'tags': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'e.g., holiday, fees, exam'}),
        }
    
    def __init__(self, *args, **kwargs):
        user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)
        
        # If user is teacher, only show their students
        if user and user.is_teacher():
            try:
                teacher = Teacher.objects.get(user=user)
                student_list = []
                for class_name in teacher.get_classes_list():
                    students = Student.objects.filter(grade=class_name)
                    student_list.extend(students)
                self.fields['students'].queryset = Student.objects.filter(id__in=[s.id for s in student_list])
            except Teacher.DoesNotExist:
                self.fields['students'].queryset = Student.objects.none()

class HolidayNoticeForm(forms.ModelForm):
    class Meta:
        model = HolidayNotice
        fields = [
            'title', 'description', 'start_date', 'end_date',
            'school_reopens', 'important_notes',
            'contact_person', 'contact_phone',
            'notify_students', 'notify_parents', 'notify_teachers'
        ]
        widgets = {
            'start_date': forms.DateInput(attrs={'type': 'date', 'class': 'form-control'}),
            'end_date': forms.DateInput(attrs={'type': 'date', 'class': 'form-control'}),
            'school_reopens': forms.DateInput(attrs={'type': 'date', 'class': 'form-control'}),
            'description': forms.Textarea(attrs={'class': 'form-control', 'rows': 4}),
            'important_notes': forms.Textarea(attrs={'class': 'form-control', 'rows': 3}),
        }

class BroadcastScheduleForm(forms.ModelForm):
    class Meta:
        model = BroadcastSchedule
        fields = ['frequency', 'scheduled_time', 'start_date', 'end_date', 'is_active']
        widgets = {
            'scheduled_time': forms.TimeInput(attrs={'type': 'time', 'class': 'form-control'}),
            'start_date': forms.DateInput(attrs={'type': 'date', 'class': 'form-control'}),
            'end_date': forms.DateInput(attrs={'type': 'date', 'class': 'form-control'}),
        }

class QuickMessageForm(forms.Form):
    SUBJECT_CHOICES = (
        ('holiday', 'Holiday Notice'),
        ('fee_reminder', 'Fee Reminder'),
        ('exam_schedule', 'Exam Schedule'),
        ('event', 'School Event'),
        ('urgent', 'Urgent Notice'),
    )
    
    subject_type = forms.ChoiceField(choices=SUBJECT_CHOICES)
    custom_subject = forms.CharField(required=False, max_length=200)
    content = forms.CharField(widget=forms.Textarea(attrs={'rows': 4}))
    send_to = forms.ChoiceField(choices=[
        ('all_students', 'All Students'),
        ('all_teachers', 'All Teachers'),
        ('all_users', 'All Users'),
        ('specific', 'Specific Recipients')
    ])
    
    def clean(self):
        cleaned_data = super().clean()
        subject_type = cleaned_data.get('subject_type')
        custom_subject = cleaned_data.get('custom_subject')
        
        if subject_type == 'custom' and not custom_subject:
            raise forms.ValidationError("Custom subject is required when 'Custom' is selected.")
        
        return cleaned_data\n\n========== FILE: ./school_messages/models.py ==========\n
from django.db import models
from django.conf import settings
from django.utils import timezone
from datetime import datetime, timedelta  # ADD THIS IMPORT
from students.models import Student
from teachers.models import Teacher

class Message(models.Model):
    MESSAGE_TYPES = (
        ('announcement', 'Announcement'),
        ('holiday', 'Holiday Notice'),
        ('academic', 'Academic Update'),
        ('fee', 'Fee Reminder'),
        ('event', 'Event Information'),
        ('general', 'General Message'),
        ('urgent', 'Urgent Notice'),
    )
    
    PRIORITY_CHOICES = (
        ('low', 'Low'),
        ('normal', 'Normal'),
        ('high', 'High'),
        ('urgent', 'Urgent'),
    )
    
    sender = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name='sent_messages')
    subject = models.CharField(max_length=200)
    content = models.TextField()
    message_type = models.CharField(max_length=20, choices=MESSAGE_TYPES, default='general')
    priority = models.CharField(max_length=20, choices=PRIORITY_CHOICES, default='normal')
    
    # Recipient options
    send_to_all = models.BooleanField(default=False)
    students = models.ManyToManyField(Student, blank=True, related_name='received_messages')
    teachers = models.ManyToManyField(Teacher, blank=True, related_name='received_messages')
    
    # Status
    is_published = models.BooleanField(default=True)
    requires_acknowledgement = models.BooleanField(default=False)
    
    # Timestamps
    created_at = models.DateTimeField(auto_now_add=True)
    scheduled_for = models.DateTimeField(null=True, blank=True)
    published_at = models.DateTimeField(null=True, blank=True)
    
    # Metadata
    attachments = models.FileField(upload_to='message_attachments/', null=True, blank=True)
    tags = models.CharField(max_length=200, blank=True, help_text="Comma-separated tags")
    
    class Meta:
        ordering = ['-created_at']
    
    def __str__(self):
        return f"{self.subject} - {self.get_message_type_display()}"
    
    def save(self, *args, **kwargs):
        if self.is_published and not self.published_at:
            self.published_at = timezone.now()
        super().save(*args, **kwargs)
    
    @property
    def total_recipients(self):
        if self.send_to_all:
            return "All users"
        else:
            student_count = self.students.count()
            teacher_count = self.teachers.count()
            return student_count + teacher_count

class MessageRecipient(models.Model):
    message = models.ForeignKey(Message, on_delete=models.CASCADE, related_name='recipients')
    student = models.ForeignKey(Student, on_delete=models.CASCADE, null=True, blank=True)
    teacher = models.ForeignKey(Teacher, on_delete=models.CASCADE, null=True, blank=True)
    
    # Read status
    is_read = models.BooleanField(default=False)
    read_at = models.DateTimeField(null=True, blank=True)
    
    # Acknowledgment
    acknowledged = models.BooleanField(default=False)
    acknowledged_at = models.DateTimeField(null=True, blank=True)
    acknowledgement_note = models.TextField(blank=True)
    
    # Delivery
    email_sent = models.BooleanField(default=False)
    email_sent_at = models.DateTimeField(null=True, blank=True)
    sms_sent = models.BooleanField(default=False)
    sms_sent_at = models.DateTimeField(null=True, blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        unique_together = [['message', 'student'], ['message', 'teacher']]
    
    def __str__(self):
        recipient = self.student if self.student else self.teacher
        return f"{recipient} - {self.message.subject}"
    
    def mark_as_read(self):
        if not self.is_read:
            self.is_read = True
            self.read_at = timezone.now()
            self.save()
    
    def acknowledge(self, note=''):
        if not self.acknowledged:
            self.acknowledged = True
            self.acknowledged_at = timezone.now()
            self.acknowledgement_note = note
            self.save()


class HolidayNotice(models.Model):
    title = models.CharField(max_length=200)
    description = models.TextField()
    start_date = models.DateField()
    end_date = models.DateField()
    is_active = models.BooleanField(default=True)
    
    # Recipients
    notify_students = models.BooleanField(default=True)
    notify_parents = models.BooleanField(default=True)
    notify_teachers = models.BooleanField(default=True)
    
    # Additional info
    school_reopens = models.DateField()
    important_notes = models.TextField(blank=True)
    contact_person = models.CharField(max_length=100, blank=True)
    contact_phone = models.CharField(max_length=20, blank=True)
    
    created_by = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.SET_NULL, null=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        ordering = ['-start_date']
        verbose_name = "Holiday Notice"
        verbose_name_plural = "Holiday Notices"
    
    def __str__(self):
        return f"{self.title} ({self.start_date} to {self.end_date})"
    
    @property
    def duration_days(self):
        return (self.end_date - self.start_date).days + 1
    
    def is_current(self):
        today = timezone.now().date()
        return self.start_date <= today <= self.end_date
    
    @property
    def days_until_start(self):
        today = timezone.now().date()
        if today < self.start_date:
            return (self.start_date - today).days
        return 0
    
    @property
    def days_until_reopen(self):
        today = timezone.now().date()
        if today < self.school_reopens:
            return (self.school_reopens - today).days
        return 0


class Notification(models.Model):
    NOTIFICATION_TYPES = (
        ('message', 'New Message'),
        ('fee', 'Fee Reminder'),
        ('mark', 'Marks Posted'),
        ('holiday', 'Holiday Notice'),
        ('event', 'Upcoming Event'),
        ('system', 'System Update'),
    )
    
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name='notifications')
    
    # Relationship to the actual object (optional)
    message = models.ForeignKey(Message, on_delete=models.CASCADE, null=True, blank=True, related_name='notifications')
    holiday_notice = models.ForeignKey('HolidayNotice', on_delete=models.SET_NULL, null=True, blank=True)
    
    notification_type = models.CharField(max_length=20, choices=NOTIFICATION_TYPES)
    title = models.CharField(max_length=200)
    
    # Content fields - ADD default value
    content = models.TextField(default='No content available')  # ADD default
    short_content = models.CharField(max_length=100, blank=True)
    
    # Link for navigation
    link = models.CharField(max_length=200, blank=True)
    
    # Related object tracking (for generic relationships)
    related_object_id = models.PositiveIntegerField(null=True, blank=True)
    related_object_type = models.CharField(max_length=50, blank=True)
    
    # Status
    is_read = models.BooleanField(default=False)
    is_important = models.BooleanField(default=False)
    
    # Metadata
    created_at = models.DateTimeField(auto_now_add=True)
    expires_at = models.DateTimeField(null=True, blank=True)
    read_at = models.DateTimeField(null=True, blank=True)
    
    class Meta:
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['user', 'is_read', 'created_at']),
            models.Index(fields=['user', 'created_at']),
        ]
    
    def __str__(self):
        return f"{self.user.username} - {self.title}"
    
    def mark_as_read(self):
        if not self.is_read:
            self.is_read = True
            self.read_at = timezone.now()
            self.save()
    
    @property
    def is_expired(self):
        if self.expires_at:
            return timezone.now() > self.expires_at
        return False
    
    def get_absolute_url(self):
        if self.link:
            return self.link
        elif self.message:
            return f"/messages/{self.message.id}/"
        elif self.holiday_notice:
            return f"/messages/holidays/{self.holiday_notice.id}/"
        return "#"


class BroadcastSchedule(models.Model):
    FREQUENCY_CHOICES = (
        ('once', 'Once'),
        ('daily', 'Daily'),
        ('weekly', 'Weekly'),
        ('monthly', 'Monthly'),
    )
    
    message = models.OneToOneField(Message, on_delete=models.CASCADE, related_name='schedule')
    frequency = models.CharField(max_length=20, choices=FREQUENCY_CHOICES, default='once')
    scheduled_time = models.TimeField()
    start_date = models.DateField()
    end_date = models.DateField(null=True, blank=True)
    is_active = models.BooleanField(default=True)
    
    # Days of week (for weekly scheduling)
    monday = models.BooleanField(default=False)
    tuesday = models.BooleanField(default=False)
    wednesday = models.BooleanField(default=False)
    thursday = models.BooleanField(default=False)
    friday = models.BooleanField(default=False)
    saturday = models.BooleanField(default=False)
    sunday = models.BooleanField(default=False)
    
    last_sent = models.DateTimeField(null=True, blank=True)
    next_send = models.DateTimeField(null=True, blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        ordering = ['next_send', 'start_date']
        verbose_name = "Broadcast Schedule"
        verbose_name_plural = "Broadcast Schedules"
    
    def __str__(self):
        return f"{self.message.subject} - {self.frequency}"
    
    def calculate_next_send(self):
        """Calculate when to send next based on frequency"""
        now = timezone.now()
        
        if self.frequency == 'once':
            # Send once at start_date + scheduled_time
            next_date = datetime.combine(self.start_date, self.scheduled_time)
            self.next_send = timezone.make_aware(next_date)
        
        elif self.frequency == 'daily':
            # Send daily at scheduled_time
            next_date = now.date()
            next_time = datetime.combine(next_date, self.scheduled_time)
            next_datetime = timezone.make_aware(next_time)
            
            if next_datetime <= now:
                next_date += timedelta(days=1)
                next_time = datetime.combine(next_date, self.scheduled_time)
                next_datetime = timezone.make_aware(next_time)
            
            self.next_send = next_datetime
        
        elif self.frequency == 'weekly':
            # Send weekly on selected days
            # This is more complex - you'd need to find the next selected day
            pass
        
        elif self.frequency == 'monthly':
            # Send monthly on the same day of month
            pass
        
        self.save()
    
    def should_send_now(self):
        """Check if it's time to send the message"""
        if not self.is_active:
            return False
        
        now = timezone.now()
        
        # Check if within date range
        if self.end_date and now.date() > self.end_date:
            return False
        
        # Check if it's time to send
        if self.next_send and now >= self.next_send:
            return True
        
        return False\n\n========== FILE: ./school_messages/signals.py ==========\n
from django.db.models.signals import post_save
from django.dispatch import receiver
from django.utils import timezone
from .models import Message, HolidayNotice

@receiver(post_save, sender=Message)
def handle_message_post_save(sender, instance, created, **kwargs):
    """Handle actions after a message is saved"""
    if created and instance.is_published:
        # If message is published immediately, set published_at
        instance.published_at = timezone.now()
        instance.save(update_fields=['published_at'])

@receiver(post_save, sender=HolidayNotice)
def handle_holiday_notice_post_save(sender, instance, created, **kwargs):
    """Handle actions after a holiday notice is saved"""
    if created and instance.is_active:
        # Check if holiday is current or upcoming
        today = timezone.now().date()
        if instance.start_date <= today <= instance.end_date:
            # Holiday is current - create urgent notifications
            from .views import create_holiday_notifications
            create_holiday_notifications(instance)\n\n========== FILE: ./school_messages/templates/messages/holiday_form.html ==========\n
{% extends 'accounts/base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>{{ title }}
                        </h4>
                        <a href="{% url 'holiday_notice_list' %}" class="btn btn-light btn-sm">
                            <i class="fas fa-arrow-left me-1"></i>Back to Holidays
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Title and Description -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label">Title *</label>
                                    {{ form.title }}
                                    {% if form.title.errors %}
                                    <div class="text-danger small">{{ form.title.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label">Description *</label>
                                    {{ form.description }}
                                    {% if form.description.errors %}
                                    <div class="text-danger small">{{ form.description.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Date Range -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Holiday Dates</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Start Date *</label>
                                            {{ form.start_date }}
                                            {% if form.start_date.errors %}
                                            <div class="text-danger small">{{ form.start_date.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">End Date *</label>
                                            {{ form.end_date }}
                                            {% if form.end_date.errors %}
                                            <div class="text-danger small">{{ form.end_date.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">School Reopens *</label>
                                            {{ form.school_reopens }}
                                            {% if form.school_reopens.errors %}
                                            <div class="text-danger small">{{ form.school_reopens.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="alert alert-info mt-2">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <small>Make sure end date is after start date, and school reopens after end date.</small>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Contact Information (Optional)</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Contact Person</label>
                                            {{ form.contact_person }}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Contact Phone</label>
                                            {{ form.contact_phone }}
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="mb-3">
                                            <label class="form-label">Important Notes</label>
                                            {{ form.important_notes }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notification Settings -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Notification Settings</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check form-switch mb-3">
                                            {{ form.notify_students }}
                                            <label class="form-check-label" for="{{ form.notify_students.id_for_label }}">
                                                Notify Students
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check form-switch mb-3">
                                            {{ form.notify_parents }}
                                            <label class="form-check-label" for="{{ form.notify_parents.id_for_label }}">
                                                Notify Parents
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check form-switch mb-3">
                                            {{ form.notify_teachers }}
                                            <label class="form-check-label" for="{{ form.notify_teachers.id_for_label }}">
                                                Notify Teachers
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="alert alert-warning">
                                    <i class="fas fa-bell me-2"></i>
                                    <small>Selecting these options will send notifications to the respective groups when you save.</small>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                            <a href="{% url 'holiday_notice_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Save Holiday Notice
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Form styling */
    input[type="text"],
    input[type="date"],
    textarea,
    select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    input[type="text"]:focus,
    input[type="date"]:focus,
    textarea:focus,
    select:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .form-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #495057;
    }
    
    /* Form switch styling */
    .form-switch {
        padding-left: 2.5em;
    }
    
    .form-switch .form-check-input {
        width: 2em;
        margin-left: -2.5em;
        height: 1.2em;
    }
    
    /* Card styling */
    .card-header.bg-light {
        background-color: #f8f9fa !important;
        border-bottom: 1px solid #dee2e6;
    }
</style>
{% endblock %}\n\n========== FILE: ./school_messages/templates/messages/holiday_list.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<h2>Holiday Notices</h2>

<div style="display: flex; gap: 10px; margin-bottom: 20px;">
    <a href="{% url 'holiday_notice_create' %}" style="background-color: #4CAF50; color: white; padding: 10px 15px; text-decoration: none;">Create Holiday Notice</a>
    <a href="{% url 'message_list' %}" style="background-color: #2196F3; color: white; padding: 10px 15px; text-decoration: none;">Back to Messages</a>
</div>

<!-- Current Holidays -->
{% if current_holidays %}
<h3>Current Holidays</h3>
<div style="margin-bottom: 30px;">
    {% for holiday in current_holidays %}
    <div style="background-color: #fff8e1; border-left: 4px solid #FF9800; padding: 20px; margin-bottom: 15px; border-radius: 5px;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <h4 style="margin-top: 0; color: #333;">{{ holiday.title }}</h4>
                <p><strong>Duration:</strong> {{ holiday.start_date|date:"M d, Y" }} to {{ holiday.end_date|date:"M d, Y" }} ({{ holiday.duration_days }} days)</p>
                <p><strong>School Reopens:</strong> {{ holiday.school_reopens|date:"M d, Y" }}</p>
                <p>{{ holiday.description|truncatewords:50 }}</p>
            </div>
            <div>
                <span style="background-color: #FF9800; color: white; padding: 5px 10px; border-radius: 3px;">Current</span>
            </div>
        </div>
        <div style="margin-top: 15px;">
            <a href="{% url 'holiday_notice_detail' holiday.pk %}" style="background-color: #2196F3; color: white; padding: 5px 10px; text-decoration: none;">View Details</a>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Upcoming Holidays -->
{% if upcoming_holidays %}
<h3>Upcoming Holidays</h3>
<div style="margin-bottom: 30px;">
    {% for holiday in upcoming_holidays %}
    <div style="background-color: #e8f5e9; padding: 20px; margin-bottom: 15px; border-radius: 5px;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <h4 style="margin-top: 0; color: #333;">{{ holiday.title }}</h4>
                <p><strong>Starts:</strong> {{ holiday.start_date|date:"M d, Y" }}</p>
                <p><strong>Duration:</strong> {{ holiday.duration_days }} days</p>
                <p>{{ holiday.description|truncatewords:30 }}</p>
            </div>
            <div style="text-align: right;">
                <span style="background-color: #4CAF50; color: white; padding: 5px 10px; border-radius: 3px;">Upcoming</span>
                <p style="margin-top: 5px; color: #666;">
                    {{ holiday.start_date|timeuntil }} from now
                </p>
            </div>
        </div>
        <div style="margin-top: 15px;">
            <a href="{% url 'holiday_notice_detail' holiday.pk %}" style="background-color: #2196F3; color: white; padding: 5px 10px; text-decoration: none;">View Details</a>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Past Holidays -->
{% if past_holidays %}
<h3>Past Holidays</h3>
<div>
    {% for holiday in past_holidays %}
    <div style="background-color: #f5f5f5; padding: 15px; margin-bottom: 10px; border-radius: 5px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h4 style="margin-top: 0; color: #666;">{{ holiday.title }}</h4>
                <p style="color: #888; margin-bottom: 0;">
                    {{ holiday.start_date|date:"M d, Y" }} to {{ holiday.end_date|date:"M d, Y" }}
                </p>
            </div>
            <div>
                <span style="background-color: #9E9E9E; color: white; padding: 3px 8px; border-radius: 3px; font-size: 12px;">Past</span>
                <a href="{% url 'holiday_notice_detail' holiday.pk %}" style="color: #2196F3; text-decoration: none; margin-left: 10px;">View</a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{% if not current_holidays and not upcoming_holidays and not past_holidays %}
<div style="background-color: #f5f5f5; padding: 40px; text-align: center; border-radius: 5px;">
    <h3>No Holiday Notices</h3>
    <p>No holiday notices have been created yet.</p>
    <a href="{% url 'holiday_notice_create' %}" style="background-color: #4CAF50; color: white; padding: 10px 15px; text-decoration: none; display: inline-block; margin-top: 10px;">
        Create First Holiday Notice
    </a>
</div>
{% endif %}
{% endblock %}\n\n========== FILE: ./school_messages/templates/messages/inbox.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<h2>My Inbox</h2>

<div style="display: flex; gap: 10px; margin-bottom: 20px;">
    <a href="{% url 'message_list' %}" style="background-color: #4CAF50; color: white; padding: 10px 15px; text-decoration: none;">All Messages</a>
    <a href="{% url 'outbox' %}" style="background-color: #2196F3; color: white; padding: 10px 15px; text-decoration: none;">Outbox</a>
</div>

<!-- Unread Messages -->
{% if unread_messages %}
<h3>Unread Messages ({{ unread_count }})</h3>
<table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
    <thead>
        <tr style="background-color: #e6fbdb;">
            <th style="border: 1px solid #c5f4f7; padding: 8px;">Subject</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Sender</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Date</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Priority</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for item in unread_messages %}
        <tr style="background-color: #fff8e1;">
            <td style="border: 1px solid #ddd; padding: 8px;">
                <strong>{{ item.message.subject }}</strong>
                {% if item.message.requires_acknowledgement %}
                    <span style="background-color: #FF9800; color: white; padding: 2px 5px; border-radius: 3px; font-size: 12px; margin-left: 5px;">Requires Acknowledgement</span>
                {% endif %}
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ item.message.sender.username }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ item.message.created_at|date:"M d, Y" }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                <span style="
                    padding: 2px 8px;
                    border-radius: 3px;
                    color: white;
                    {% if item.message.priority == 'urgent' %}background-color: #f44336;
                    {% elif item.message.priority == 'high' %}background-color: #FF9800;
                    {% else %}background-color: #4CAF50;
                    {% endif %}
                ">
                    {{ item.message.get_priority_display }}
                </span>
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                <a href="{% url 'message_detail' item.message.pk %}" style="background-color: #2196F3; color: white; padding: 5px 10px; text-decoration: none;">Read</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

<!-- Read Messages -->
<h3>Read Messages</h3>
{% if read_messages %}
<table style="width: 100%; border-collapse: collapse;">
    <thead>
        <tr style="background-color: #b5c7fa;">
            <th style="border: 1px solid #ddd; padding: 8px;">Subject</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Sender</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Date</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Read Date</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for item in read_messages %}
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;">
                {{ item.message.subject }}
                {% if item.recipient and item.recipient.acknowledged %}
                    <span style="background-color: #4CAF50; color: white; padding: 2px 5px; border-radius: 3px; font-size: 12px; margin-left: 5px;">Acknowledged</span>
                {% endif %}
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ item.message.sender.username }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ item.message.created_at|date:"M d, Y" }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                {% if item.recipient and item.recipient.read_at %}
                    {{ item.recipient.read_at|date:"M d, Y H:i" }}
                {% else %}
                    -
                {% endif %}
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                <a href="{% url 'message_detail' item.message.pk %}" style="background-color: #757575; color: white; padding: 5px 10px; text-decoration: none;">View</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div style="background-color: #f9d2e4; padding: 40px; text-align: center; border-radius: 5px;">
    <p>No messages in your inbox.</p>
</div>
{% endif %}
{% endblock %}\n\n========== FILE: ./school_messages/templates/messages/message_create.html ==========\n
{% extends 'accounts/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header Card -->
            <div class="card shadow-lg border-0 mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-2">
                                <i class="fas fa-paper-plane me-2"></i>{{ title }}
                            </h1>
                            <p class="mb-0 opacity-75">Send messages to students, teachers, or the entire school</p>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-light text-primary px-3 py-2 rounded-pill">
                                <i class="fas fa-comment-alt me-1"></i> New Message
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Card -->
            <div class="card shadow-lg border-0">
                <div class="card-body p-0">
                    <form method="post" enctype="multipart/form-data" class="p-4" novalidate>
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            {% for error in form.non_field_errors %}
                            {{ error }}
                            {% endfor %}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endif %}
                        
                        <div class="row g-4 mb-4">
                            <!-- Left Column - Message Details -->
                            <div class="col-lg-6">
                                <div class="card h-100 border-0 shadow-sm">
                                    <div class="card-header bg-light border-0">
                                        <h5 class="mb-0">
                                            <i class="fas fa-edit text-primary me-2"></i>Message Details
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <!-- Subject -->
                                        <div class="mb-4">
                                            <label for="{{ form.subject.id_for_label }}" class="form-label fw-semibold">
                                                <i class="fas fa-heading me-1 text-primary"></i>Subject *
                                            </label>
                                            {{ form.subject }}
                                            {% if form.subject.errors %}
                                            <div class="text-danger small mt-1">
                                                <i class="fas fa-exclamation-circle me-1"></i>{{ form.subject.errors }}
                                            </div>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Message Type & Priority -->
                                        <div class="row mb-4">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="{{ form.message_type.id_for_label }}" class="form-label fw-semibold">
                                                        <i class="fas fa-tag me-1 text-info"></i>Message Type
                                                    </label>
                                                    {{ form.message_type }}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="{{ form.priority.id_for_label }}" class="form-label fw-semibold">
                                                        <i class="fas fa-exclamation me-1 text-warning"></i>Priority
                                                    </label>
                                                    {{ form.priority }}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Content -->
                                        <div class="mb-3">
                                            <label for="{{ form.content.id_for_label }}" class="form-label fw-semibold">
                                                <i class="fas fa-align-left me-1 text-success"></i>Content *
                                            </label>
                                            {{ form.content }}
                                            {% if form.content.errors %}
                                            <div class="text-danger small mt-1">
                                                <i class="fas fa-exclamation-circle me-1"></i>{{ form.content.errors }}
                                            </div>
                                            {% endif %}
                                            <div class="form-text">
                                                <i class="fas fa-lightbulb me-1"></i>Be clear and concise. You can use basic formatting.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right Column - Recipients -->
                            <div class="col-lg-6">
                                <div class="card h-100 border-0 shadow-sm">
                                    <div class="card-header bg-light border-0">
                                        <h5 class="mb-0">
                                            <i class="fas fa-users text-primary me-2"></i>Recipients
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <!-- Send to All -->
                                        <div class="mb-4">
                                            <div class="form-check form-switch mb-3">
                                                {{ form.send_to_all }}
                                                <label class="form-check-label fw-semibold" for="{{ form.send_to_all.id_for_label }}">
                                                    <i class="fas fa-globe me-1 text-primary"></i>Send to all users
                                                </label>
                                            </div>
                                            <div class="alert alert-info py-2 mb-0">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <small>If checked, message will be sent to all students and teachers automatically.</small>
                                            </div>
                                        </div>
                                        
                                        <!-- Specific Recipients -->
                                        <div id="specific-recipients" class="{% if form.send_to_all.value %}d-none{% endif %}">
                                            <!-- Students -->
                                            <div class="mb-4">
                                                <label for="{{ form.students.id_for_label }}" class="form-label fw-semibold">
                                                    <i class="fas fa-user-graduate me-1 text-success"></i>Select Students
                                                </label>
                                                {{ form.students }}
                                                <div class="form-text">
                                                    <i class="fas fa-mouse-pointer me-1"></i>Hold Ctrl/Cmd to select multiple students
                                                </div>
                                            </div>
                                            
                                            <!-- Teachers -->
                                            <div class="mb-3">
                                                <label for="{{ form.teachers.id_for_label }}" class="form-label fw-semibold">
                                                    <i class="fas fa-chalkboard-teacher me-1 text-warning"></i>Select Teachers
                                                </label>
                                                {{ form.teachers }}
                                                <div class="form-text">
                                                    <i class="fas fa-mouse-pointer me-1"></i>Hold Ctrl/Cmd to select multiple teachers
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Acknowledgement -->
                                        <div class="mt-4 pt-3 border-top">
                                            <div class="form-check form-switch">
                                                {{ form.requires_acknowledgement }}
                                                <label class="form-check-label fw-semibold" for="{{ form.requires_acknowledgement.id_for_label }}">
                                                    <i class="fas fa-check-circle me-1 text-danger"></i>Require acknowledgement
                                                </label>
                                            </div>
                                            <div class="form-text ms-4">
                                                <i class="fas fa-shield-alt me-1"></i>Recipients must confirm they have read this message
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Additional Information -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-light border-0">
                                <h5 class="mb-0">
                                    <i class="fas fa-plus-circle text-primary me-2"></i>Additional Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.tags.id_for_label }}" class="form-label fw-semibold">
                                                <i class="fas fa-tags me-1 text-info"></i>Tags
                                            </label>
                                            {{ form.tags }}
                                            <div class="form-text">
                                                <i class="fas fa-bolt me-1"></i>Comma-separated tags help organize messages
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.attachments.id_for_label }}" class="form-label fw-semibold">
                                                <i class="fas fa-paperclip me-1 text-secondary"></i>Attachment
                                            </label>
                                            {{ form.attachments }}
                                            <div class="form-text">
                                                <i class="fas fa-file me-1"></i>Optional file attachment (max 10MB)
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between align-items-center mt-4 pt-4 border-top">
                            <div>
                                <a href="{% url 'message_list' %}" class="btn btn-outline-secondary px-4">
                                    <i class="fas fa-arrow-left me-2"></i>Back to Messages
                                </a>
                                <button type="reset" class="btn btn-outline-warning ms-2">
                                    <i class="fas fa-redo me-2"></i>Reset Form
                                </button>
                            </div>
                            <div>
                                <button type="submit" class="btn btn-primary btn-lg px-5">
                                    <i class="fas fa-paper-plane me-2"></i>Send Message
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Form styling */
    select, textarea, input[type="text"], input[type="file"] {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        transition: all 0.3s ease;
        background-color: #f8fafc;
        font-size: 14px;
    }
    
    select:focus, textarea:focus, input[type="text"]:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background-color: white;
        outline: none;
    }
    
    textarea {
        min-height: 150px;
        resize: vertical;
    }
    
    select[multiple] {
        height: 150px;
        background-image: none;
    }
    
    /* Form labels */
    .form-label {
        color: #2d3748;
        margin-bottom: 8px;
        font-weight: 600;
    }
    
    /* Form switch styling */
    .form-switch .form-check-input {
        width: 3em;
        height: 1.5em;
        margin-right: 10px;
    }
    
    .form-switch .form-check-input:checked {
        background-color: #667eea;
        border-color: #667eea;
    }
    
    /* Cards */
    .card {
        border-radius: 15px;
        overflow: hidden;
        transition: transform 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
    }
    
    .card-header {
        padding: 1.25rem 1.5rem;
        background-color: #f8fafc !important;
        border-bottom: 2px solid #e2e8f0;
    }
    
    /* Buttons */
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 10px;
        padding: 12px 30px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    .btn-outline-secondary {
        border-radius: 10px;
        padding: 10px 25px;
        font-weight: 500;
    }
    
    /* Alert styling */
    .alert {
        border-radius: 10px;
        border: none;
    }
    
    .alert-info {
        background-color: #e0f2fe;
        color: #0369a1;
    }
    
    /* Responsive adjustments */
    @media (max-width: 992px) {
        .row.g-4 {
            margin-left: 0;
            margin-right: 0;
        }
        
        .btn-lg {
            padding: 10px 20px;
            font-size: 14px;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sendToAllCheckbox = document.querySelector('#{{ form.send_to_all.id_for_label }}');
    const specificRecipientsDiv = document.getElementById('specific-recipients');
    
    sendToAllCheckbox.addEventListener('change', function() {
        if (this.checked) {
            specificRecipientsDiv.classList.add('d-none');
        } else {
            specificRecipientsDiv.classList.remove('d-none');
        }
    });
    
    // Add animation to form elements
    const formElements = document.querySelectorAll('select, textarea, input[type="text"]');
    formElements.forEach(element => {
        element.addEventListener('focus', function() {
            this.parentElement.classList.add('focused');
        });
        
        element.addEventListener('blur', function() {
            this.parentElement.classList.remove('focused');
        });
    });
});
</script>
{% endblock %}\n\n========== FILE: ./school_messages/templates/messages/message_detail.html ==========\n
{% extends 'accounts/base.html' %}

{% block title %}{{ message.subject }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <div class="d-flex align-items-center">
                {% if message.priority == 'urgent' %}
                <span class="badge bg-danger me-3">URGENT</span>
                {% elif message.priority == 'high' %}
                <span class="badge bg-warning me-3">HIGH PRIORITY</span>
                {% endif %}
                <h1 class="h2 mb-0">{{ message.subject }}</h1>
            </div>
            <p class="text-muted mb-0">
                Sent by {{ message.sender.get_full_name|default:message.sender.username }}
                on {{ message.created_at|date:"F j, Y g:i A" }}
            </p>
        </div>
        <div>
            <a href="{% url 'inbox' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Inbox
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-body">
                    <!-- Message Info -->
                    <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">
                        <div>
                            <span class="badge bg-info">{{ message.get_message_type_display }}</span>
                            <span class="badge bg-secondary ms-2">
                                {{ message.get_priority_display }} Priority
                            </span>
                            {% if message.requires_acknowledgement %}
                            <span class="badge bg-warning ms-2">Requires Acknowledgement</span>
                            {% endif %}
                        </div>
                        <div class="text-muted">
                            <small>ID: {{ message.id }}</small>
                        </div>
                    </div>

                    <!-- Message Content -->
                    <div class="mb-4">
                        <h5 class="mb-3">Message Content</h5>
                        <div class="p-3 bg-light rounded">
                            {{ message.content|linebreaks }}
                        </div>
                    </div>

                    <!-- Attachments -->
                    {% if message.attachments %}
                    <div class="mb-4">
                        <h5 class="mb-3">Attachments</h5>
                        <div class="d-flex align-items-center p-3 bg-light rounded">
                            <i class="fas fa-paperclip fa-2x text-muted me-3"></i>
                            <div>
                                <a href="{{ message.attachments.url }}" class="d-block" target="_blank">
                                    {{ message.attachments.name|cut:"message_attachments/" }}
                                </a>
                                <small class="text-muted">
                                    {{ message.attachments.size|filesizeformat }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Tags -->
                    {% if message.tags %}
                    <div>
                        <h6 class="mb-2">Tags</h6>
                        <div>
                            {% for tag in message.tags.split %}
                            <span class="badge bg-light text-dark border me-1">{{ tag }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Recipient Information (for sender only) -->
            {% if user == message.sender or user.is_admin %}
            <div class="card shadow">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Delivery Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3 mb-3">
                            <div class="p-3 border rounded">
                                <h2 class="text-primary">{{ total_recipients }}</h2>
                                <small class="text-muted">Total Recipients</small>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="p-3 border rounded">
                                <h2 class="text-success">{{ read_count }}</h2>
                                <small class="text-muted">Read</small>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="p-3 border rounded">
                                <h2 class="text-warning">{{ acknowledged_count }}</h2>
                                <small class="text-muted">Acknowledged</small>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="p-3 border rounded">
                                <h2 class="text-info">{{ read_percentage|floatformat:0 }}%</h2>
                                <small class="text-muted">Read Rate</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Message Details -->
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Message Details</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item px-0 d-flex justify-content-between">
                            <span class="text-muted">Sender:</span>
                            <span>{{ message.sender.get_full_name|default:message.sender.username }}</span>
                        </div>
                        <div class="list-group-item px-0 d-flex justify-content-between">
                            <span class="text-muted">Sent:</span>
                            <span>{{ message.created_at|date:"M d, Y H:i" }}</span>
                        </div>
                        <div class="list-group-item px-0 d-flex justify-content-between">
                            <span class="text-muted">Type:</span>
                            <span>{{ message.get_message_type_display }}</span>
                        </div>
                        <div class="list-group-item px-0 d-flex justify-content-between">
                            <span class="text-muted">Priority:</span>
                            <span class="badge bg-{% if message.priority == 'urgent' %}danger{% elif message.priority == 'high' %}warning{% else %}secondary{% endif %}">
                                {{ message.get_priority_display }}
                            </span>
                        </div>
                        {% if message.published_at %}
                        <div class="list-group-item px-0 d-flex justify-content-between">
                            <span class="text-muted">Published:</span>
                            <span>{{ message.published_at|date:"M d, Y H:i" }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Recipient Info -->
            <div class="card shadow">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Recipients</h5>
                </div>
                <div class="card-body">
                    {% if message.send_to_all %}
                    <div class="alert alert-info">
                        <i class="fas fa-users me-2"></i>
                        Sent to all users
                    </div>
                    {% else %}
                    <div class="mb-3">
                        <h6>Students:</h6>
                        {% if message.students.exists %}
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            {% for student in message.students.all %}
                            <span class="badge bg-primary">{{ student.user.get_full_name|default:student.user.username }}</span>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted small">No students selected</p>
                        {% endif %}
                    </div>
                    <div>
                        <h6>Teachers:</h6>
                        {% if message.teachers.exists %}
                        <div class="d-flex flex-wrap gap-2">
                            {% for teacher in message.teachers.all %}
                            <span class="badge bg-success">{{ teacher.user.get_full_name|default:teacher.user.username }}</span>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted small">No teachers selected</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}\n\n========== FILE: ./school_messages/templates/messages/message_list.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<h2>Messages & Notifications</h2>

<div style="display: flex; gap: 20px; margin-bottom: 30px;">
    <a href="{% url 'message_create' %}" style="background-color: #4CAF50; color: white; padding: 10px 15px; text-decoration: none;">Send New Message</a>
    <a href="{% url 'holiday_notice_create' %}" style="background-color: #2196F3; color: white; padding: 10px 15px; text-decoration: none;">Create Holiday Notice</a>
    <a href="{% url 'quick_message' %}" style="background-color: #FF9800; color: white; padding: 10px 15px; text-decoration: none;">Quick Message</a>
    <a href="{% url 'inbox' %}" style="background-color: #9C27B0; color: white; padding: 10px 15px; text-decoration: none;">
        Inbox {% if unread_count > 0 %}<span style="background-color: #f44336; color: white; padding: 2px 8px; border-radius: 10px; margin-left: 5px;">{{ unread_count }}</span>{% endif %}
    </a>
</div>

<!-- Quick Stats -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div style="background-color: #e8f5e9; padding: 20px; border-radius: 5px;">
        <h3 style="margin-top: 0;">Total Messages</h3>
        <p style="font-size: 24px; font-weight: bold;">{{ messages.count }}</p>
    </div>
    
    <div style="background-color: #e3f2fd; padding: 20px; border-radius: 5px;">
        <h3 style="margin-top: 0;">Unread</h3>
        <p style="font-size: 24px; font-weight: bold;">{{ unread_count }}</p>
    </div>
    
    <div style="background-color: #fff3e0; padding: 20px; border-radius: 5px;">
        <h3 style="margin-top: 0;">Recent</h3>
        <p style="font-size: 24px; font-weight: bold;">{{ recent_messages.count }}</p>
    </div>
</div>

<!-- Recent Messages -->
<h3>Recent Messages</h3>
<table style="width: 100%; border-collapse: collapse;">
    <thead>
        <tr style="background-color: #f2f2f2;">
            <th style="border: 1px solid #ddd; padding: 8px;">Subject</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Type</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Sender</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Date</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Priority</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for message in recent_messages %}
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;">
                <strong>{{ message.subject }}</strong>
                {% if message.requires_acknowledgement %}
                    <span style="background-color: #FF9800; color: white; padding: 2px 5px; border-radius: 3px; font-size: 12px; margin-left: 5px;">Ack</span>
                {% endif %}
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ message.get_message_type_display }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ message.sender.username }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ message.created_at|date:"M d, Y" }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                <span style="
                    padding: 2px 8px;
                    border-radius: 3px;
                    color: white;
                    {% if message.priority == 'urgent' %}background-color: #f44336;
                    {% elif message.priority == 'high' %}background-color: #FF9800;
                    {% elif message.priority == 'low' %}background-color: #9E9E9E;
                    {% else %}background-color: #4CAF50;
                    {% endif %}
                ">
                    {{ message.get_priority_display }}
                </span>
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                <a href="{% url 'message_detail' message.pk %}" style="background-color: #2196F3; color: white; padding: 5px 10px; text-decoration: none;">View</a>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" style="border: 1px solid #ddd; padding: 8px; text-align: center;">No messages found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Quick Links -->
<div style="background-color: #f5f5f5; padding: 20px; border-radius: 5px; margin-top: 30px;">
    <h3>Quick Links</h3>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <a href="{% url 'inbox' %}" style="background-color: #2196F3; color: white; padding: 10px 15px; text-decoration: none;">Go to Inbox</a>
        <a href="{% url 'outbox' %}" style="background-color: #FF9800; color: white; padding: 10px 15px; text-decoration: none;">View Sent Messages</a>
        <a href="{% url 'notification_list' %}" style="background-color: #9C27B0; color: white; padding: 10px 15px; text-decoration: none;">View Notifications</a>
    </div>
</div>
{% endblock %}\n\n========== FILE: ./school_messages/templates/messages/notification_list.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<h2>My Notifications</h2>

<div style="display: flex; gap: 10px; margin-bottom: 20px;">
    {% if total_unread > 0 %}
        <a href="{% url 'mark_all_notifications_read' %}" style="background-color: #4CAF50; color: white; padding: 10px 15px; text-decoration: none;">Mark All as Read</a>
    {% endif %}
    <a href="{% url 'inbox' %}" style="background-color: #2196F3; color: white; padding: 10px 15px; text-decoration: none;">Go to Inbox</a>
</div>

<!-- Unread Notifications -->
{% if unread_notifications %}
<h3>Unread Notifications ({{ total_unread }})</h3>
<div style="margin-bottom: 30px;">
    {% for notification in unread_notifications %}
    <div style="background-color: #fff8e1; border-left: 4px solid #FF9800; padding: 15px; margin-bottom: 10px; border-radius: 5px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h4 style="margin-top: 0; color: #333;">
                    {% if notification.is_important %}âš ï¸ {% endif %}
                    {{ notification.title }}
                </h4>
                <p style="margin-bottom: 5px;">{{ notification.message }}</p>
                <small style="color: #666;">{{ notification.created_at|date:"M d, Y H:i" }}</small>
            </div>
            <div>
                {% if notification.link %}
                    <a href="{{ notification.link }}" style="background-color: #2196F3; color: white; padding: 5px 10px; text-decoration: none; margin-right: 5px;">View</a>
                {% endif %}
                <a href="{% url 'mark_notification_read' notification.pk %}" style="background-color: #4CAF50; color: white; padding: 5px 10px; text-decoration: none;">Mark Read</a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Read Notifications -->
<h3>Recently Read</h3>
{% if read_notifications %}
<div>
    {% for notification in read_notifications %}
    <div style="background-color: #f9f9f9; padding: 15px; margin-bottom: 10px; border-radius: 5px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h4 style="margin-top: 0; color: #666;">{{ notification.title }}</h4>
                <p style="margin-bottom: 5px; color: #777;">{{ notification.message }}</p>
                <small style="color: #999;">{{ notification.created_at|date:"M d, Y H:i" }}</small>
            </div>
            <div>
                {% if notification.link %}
                    <a href="{{ notification.link }}" style="background-color: #757575; color: white; padding: 5px 10px; text-decoration: none;">View</a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div style="background-color: #f5f5f5; padding: 40px; text-align: center; border-radius: 5px;">
    <p>No notifications found.</p>
</div>
{% endif %}
{% endblock %}\n\n========== FILE: ./school_messages/templates/messages/outbox.html ==========\n
{% extends 'accounts/base.html' %}

{% block title %}Sent Messages - Outbox{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">Sent Messages</h1>
            <p class="text-muted mb-0">Messages you have sent to students and teachers</p>
        </div>
        <div>
            <a href="{% url 'message_create' %}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>New Message
            </a>
            <a href="{% url 'inbox' %}" class="btn btn-outline-secondary ms-2">
                <i class="fas fa-inbox me-2"></i>Inbox
            </a>
        </div>
    </div>

    {% if messages %}
    <div class="card shadow">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">Subject</th>
                            <th>Type</th>
                            <th>Recipients</th>
                            <th>Read</th>
                            <th>Acknowledged</th>
                            <th>Sent</th>
                            <th class="pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in messages %}
                        <tr>
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        {% if item.message.priority == 'urgent' %}
                                        <i class="fas fa-exclamation-triangle text-danger"></i>
                                        {% elif item.message.priority == 'high' %}
                                        <i class="fas fa-exclamation-circle text-warning"></i>
                                        {% else %}
                                        <i class="fas fa-envelope text-primary"></i>
                                        {% endif %}
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0">{{ item.message.subject }}</h6>
                                        <small class="text-muted">{{ item.message.content|truncatechars:50 }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-{% if item.message.message_type == 'urgent' %}danger{% elif item.message.message_type == 'holiday' %}success{% else %}info{% endif %}">
                                    {{ item.message.get_message_type_display }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ item.total_recipients }}</span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 6px; width: 80px;">
                                        <div class="progress-bar bg-success" 
                                             style="width: {{ item.read_percentage }}%">
                                        </div>
                                    </div>
                                    <small>{{ item.read_count }}/{{ item.total_recipients }}</small>
                                </div>
                            </td>
                            <td>
                                {% if item.message.requires_acknowledgement %}
                                <span class="badge bg-{% if item.acknowledged_count > 0 %}success{% else %}warning{% endif %}">
                                    {{ item.acknowledged_count }}
                                </span>
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">{{ item.message.created_at|date:"M d, Y" }}</small>
                            </td>
                            <td class="pe-4">
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'message_detail' item.message.id %}" 
                                       class="btn btn-outline-primary" title="View">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="#" class="btn btn-outline-secondary" title="Statistics">
                                        <i class="fas fa-chart-bar"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card shadow">
        <div class="card-body text-center py-5">
            <i class="fas fa-paper-plane fa-3x text-muted mb-3"></i>
            <h4>No Sent Messages</h4>
            <p class="text-muted mb-4">You haven't sent any messages yet.</p>
            <a href="{% url 'message_create' %}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Send Your First Message
            </a>
        </div>
    </div>
    {% endif %}
</div>

<style>
    .progress {
        min-width: 60px;
    }
    
    .table tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
</style>
{% endblock %}\n\n========== FILE: ./school_messages/templates/messages/quick_message.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<h2>Quick Message</h2>

<div style="max-width: 600px;">
    <form method="post">
        {% csrf_token %}
        
        <div style="background-color: #f9f9f9; padding: 20px; border-radius: 5px; margin-bottom: 20px;">
            <h3 style="margin-top: 0;">Send a Quick Message</h3>
            <p style="color: #666;">Use this form to quickly send common types of messages to users.</p>
        </div>
        
        <div style="margin-bottom: 15px;">
            <label for="{{ form.subject_type.id_for_label }}">Message Type:</label>
            {{ form.subject_type }}
            {% if form.subject_type.errors %}
                <div style="color: red; font-size: 12px;">{{ form.subject_type.errors }}</div>
            {% endif %}
        </div>
        
        <div style="margin-bottom: 15px;">
            <label for="{{ form.custom_subject.id_for_label }}">Custom Subject (optional):</label>
            {{ form.custom_subject }}
            <small style="color: #666; display: block;">Leave blank to use default subject for the selected type</small>
        </div>
        
        <div style="margin-bottom: 15px;">
            <label for="{{ form.content.id_for_label }}">Message Content:</label>
            {{ form.content }}
            {% if form.content.errors %}
                <div style="color: red; font-size: 12px;">{{ form.content.errors }}</div>
            {% endif %}
        </div>
        
        <div style="margin-bottom: 20px;">
            <label for="{{ form.send_to.id_for_label }}">Send To:</label>
            {{ form.send_to }}
            <small style="color: #666; display: block;">Select who should receive this message</small>
        </div>
        
        <div style="margin-top: 30px;">
            <button type="submit" style="background-color: #4CAF50; color: white; padding: 10px 20px; border: none; cursor: pointer; margin-right: 10px;">
                Send Message
            </button>
            <a href="{% url 'message_list' %}" style="background-color: #757575; color: white; padding: 10px 20px; text-decoration: none;">
                Cancel
            </a>
        </div>
    </form>
    
    <!-- Message Templates -->
    <div style="background-color: #e3f2fd; padding: 20px; border-radius: 5px; margin-top: 30px;">
        <h4>Message Templates</h4>
        <p>Use these templates for common messages:</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
            <button type="button" onclick="loadTemplate('holiday')" style="background-color: #fff; border: 1px solid #ddd; padding: 10px; cursor: pointer; text-align: left;">
                <strong>Holiday Notice</strong><br>
                <small>Inform about upcoming holidays</small>
            </button>
            
            <button type="button" onclick="loadTemplate('fee_reminder')" style="background-color: #fff; border: 1px solid #ddd; padding: 10px; cursor: pointer; text-align: left;">
                <strong>Fee Reminder</strong><br>
                <small>Remind about fee payments</small>
            </button>
            
            <button type="button" onclick="loadTemplate('exam_schedule')" style="background-color: #fff; border: 1px solid #ddd; padding: 10px; cursor: pointer; text-align: left;">
                <strong>Exam Schedule</strong><br>
                <small>Share exam dates and times</small>
            </button>
            
            <button type="button" onclick="loadTemplate('event')" style="background-color: #fff; border: 1px solid #ddd; padding: 10px; cursor: pointer; text-align: left;">
                <strong>School Event</strong><br>
                <small>Announce upcoming events</small>
            </button>
        </div>
    </div>
</div>

<script>
function loadTemplate(type) {
    const templates = {
        'holiday': {
            subject_type: 'holiday',
            content: 'Dear students and parents,\n\nThis is to inform you about the upcoming school holiday. Please check the school calendar for exact dates.\n\nBest regards,\nSchool Administration'
        },
        'fee_reminder': {
            subject_type: 'fee_reminder',
            content: 'Dear parents,\n\nThis is a friendly reminder that the school fees for the current term are due. Please ensure payment is made by the due date to avoid penalties.\n\nThank you for your cooperation.\nAccounts Department'
        },
        'exam_schedule': {
            subject_type: 'exam_schedule',
            content: 'Dear students,\n\nThe examination schedule for the term has been released. Please check your class timetable for specific dates and times.\n\nWishing you all the best in your preparations.\nExaminations Department'
        },
        'event': {
            subject_type: 'event',
            content: 'Dear students and parents,\n\nWe are excited to announce an upcoming school event. More details will be provided soon.\n\nWe look forward to your participation.\nEvent Committee'
        }
    };
    
    if (templates[type]) {
        document.getElementById('id_subject_type').value = templates[type].subject_type;
        document.getElementById('id_content').value = templates[type].content;
    }
}
</script>
{% endblock %}\n\n========== FILE: ./school_messages/tests.py ==========\n
from django.test import TestCase

# Create your tests here.
\n\n========== FILE: ./school_messages/urls.py ==========\n
from django.urls import path
from . import views

urlpatterns = [
    # Message management
    path('', views.message_list, name='message_list'),
    path('create/', views.message_create, name='message_create'),
    path('<int:pk>/', views.message_detail, name='message_detail'),
    
    # User inbox/outbox
    path('inbox/', views.inbox, name='inbox'),
    path('outbox/', views.outbox, name='outbox'),
    
    # Holiday notices
    path('holidays/', views.holiday_notice_list, name='holiday_notice_list'),
    path('holidays/create/', views.holiday_notice_create, name='holiday_notice_create'),
    path('holidays/<int:pk>/', views.holiday_notice_detail, name='holiday_notice_detail'),
    
    # Notifications
    path('notifications/', views.notification_list, name='notification_list'),
    path('notifications/<int:pk>/read/', views.mark_notification_read, name='mark_notification_read'),
    path('notifications/mark-all-read/', views.mark_all_notifications_read, name='mark_all_notifications_read'),
    path('notifications/count/', views.get_notification_count, name='get_notification_count'),
    
    # Quick actions
    path('quick/', views.quick_message, name='quick_message'),
]\n\n========== FILE: ./school_messages/views.py ==========\n
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required, user_passes_test
from django.contrib import messages  # FIXED: Changed from school_messages to messages
from django.http import JsonResponse
from django.db.models import Q, Count
from django.utils import timezone
from datetime import datetime, timedelta

from school_messages.models import Message, MessageRecipient, Notification, HolidayNotice
from school_messages.forms import MessageForm, HolidayNoticeForm, QuickMessageForm, BroadcastScheduleForm
from students.models import Student
from teachers.models import Teacher
from accounts.models import User

def is_admin(user):
    return user.is_authenticated and user.is_admin()

def is_teacher(user):
    return user.is_authenticated and user.is_teacher()

def is_student(user):
    return user.is_authenticated and user.is_student()

# ===== Helper Functions =====

def can_view_message(user, message):
    """Check if user has permission to view a message"""
    if user.is_admin() or user == message.sender:
        return True
    
    if user.is_student():
        try:
            student = Student.objects.get(user=user)
            return MessageRecipient.objects.filter(message=message, student=student).exists()
        except Student.DoesNotExist:
            return False
    
    if user.is_teacher():
        try:
            teacher = Teacher.objects.get(user=user)
            return MessageRecipient.objects.filter(message=message, teacher=teacher).exists()
        except Teacher.DoesNotExist:
            return False
    
    return False

def create_notifications_for_message(message):
    """Create notifications for all message recipients"""
    # Get all recipients for this message
    recipients = MessageRecipient.objects.filter(message=message)
    
    notifications_to_create = []
    for recipient in recipients:
        # Determine the user for this recipient
        user = None
        if recipient.student:
            user = recipient.student.user
        elif recipient.teacher:
            user = recipient.teacher.user
        
        if user:
            notifications_to_create.append(
                Notification(
                    user=user,
                    message=message,
                    notification_type='message',
                    title=f"New Message: {message.subject}",
                    content=message.content[:100] + "..." if len(message.content) > 100 else message.content
                )
            )
    
    # Bulk create notifications
    if notifications_to_create:
        Notification.objects.bulk_create(notifications_to_create)

def create_holiday_notifications(holiday):
    """Create notifications for holiday notice"""
    notifications_to_create = []
    
    # Notify students
    if holiday.notify_students:
        students = Student.objects.select_related('user').all()
        for student in students:
            notifications_to_create.append(
                Notification(
                    user=student.user,
                    related_object_id=holiday.id,
                    related_object_type='holiday',
                    notification_type='holiday',
                    title=f"Holiday Notice: {holiday.title}",
                    content=f"School holidays from {holiday.start_date} to {holiday.end_date}"
                )
            )
    
    # Notify teachers
    if holiday.notify_teachers:
        teachers = Teacher.objects.select_related('user').all()
        for teacher in teachers:
            notifications_to_create.append(
                Notification(
                    user=teacher.user,
                    related_object_id=holiday.id,
                    related_object_type='holiday',
                    notification_type='holiday',
                    title=f"Holiday Notice: {holiday.title}",
                    content=f"School holidays from {holiday.start_date} to {holiday.end_date}"
                )
            )
    
    # Bulk create notifications
    if notifications_to_create:
        Notification.objects.bulk_create(notifications_to_create)

def create_recipients_for_all(message):
    """Create message recipients for all users (students and teachers)"""
    recipients_to_create = []
    
    # Add all students
    students = Student.objects.all()
    for student in students:
        recipients_to_create.append(
            MessageRecipient(
                message=message,
                student=student
            )
        )
    
    # Add all teachers
    teachers = Teacher.objects.all()
    for teacher in teachers:
        recipients_to_create.append(
            MessageRecipient(
                message=message,
                teacher=teacher
            )
        )
    
    # Bulk create recipients
    if recipients_to_create:
        MessageRecipient.objects.bulk_create(recipients_to_create)

def create_recipients_for_message(message):
    """Create message recipients for selected students and teachers"""
    recipients_to_create = []
    
    # Add selected students
    for student in message.students.all():
        recipients_to_create.append(
            MessageRecipient(
                message=message,
                student=student
            )
        )
    
    # Add selected teachers
    for teacher in message.teachers.all():
        recipients_to_create.append(
            MessageRecipient(
                message=message,
                teacher=teacher
            )
        )
    
    # Bulk create recipients
    if recipients_to_create:
        MessageRecipient.objects.bulk_create(recipients_to_create)

# ===== Message Views =====

@login_required
def message_list(request):
    """List all messages (admin/teacher view)"""
    if request.user.is_admin():
        all_messages = Message.objects.all()
    elif request.user.is_teacher():
        all_messages = Message.objects.filter(
            Q(sender=request.user) | Q(teachers__user=request.user)
        ).distinct()
    else:
        all_messages = Message.objects.none()
    
    # Get unread count for notifications
    unread_count = Notification.objects.filter(
        user=request.user,
        is_read=False
    ).count()
    
    # Get recent messages
    recent_messages = all_messages[:10]
    
    return render(request, 'messages/message_list.html', {
        'messages': all_messages,
        'recent_messages': recent_messages,
        'unread_count': unread_count,
    })

@login_required
@user_passes_test(lambda u: u.is_admin() or u.is_teacher())
def message_create(request):
    """Create a new message"""
    if request.method == 'POST':
        form = MessageForm(request.POST, request.FILES, user=request.user)
        if form.is_valid():
            message = form.save(commit=False)
            message.sender = request.user
            message.save()
            form.save_m2m()  # Save many-to-many relationships
            
            # Create message recipients
            if message.send_to_all:
                create_recipients_for_all(message)
            else:
                create_recipients_for_message(message)
            
            # Create notifications for recipients
            create_notifications_for_message(message)
            
            messages.success(request, 'Message sent successfully!')  # CHANGED
            return redirect('message_list')
    else:
        form = MessageForm(user=request.user)
    
    return render(request, 'messages/message_create.html', {
        'form': form,
        'title': 'Send New Message'
    })

@login_required
def message_detail(request, pk):
    """View message details"""
    message = get_object_or_404(Message, pk=pk)
    
    # Check if user has permission to view this message
    if not can_view_message(request.user, message):
        messages.error(request, 'You do not have permission to view this message.')  # CHANGED
        return redirect('inbox')
    
    # Mark as read if recipient
    if request.user.is_student():
        try:
            student = Student.objects.get(user=request.user)
            recipient = MessageRecipient.objects.get(message=message, student=student)
            recipient.mark_as_read()
        except (Student.DoesNotExist, MessageRecipient.DoesNotExist):
            pass
    elif request.user.is_teacher():
        try:
            teacher = Teacher.objects.get(user=request.user)
            recipient = MessageRecipient.objects.get(message=message, teacher=teacher)
            recipient.mark_as_read()
        except (Teacher.DoesNotExist, MessageRecipient.DoesNotExist):
            pass
    
    # Get recipient statistics
    total_recipients = MessageRecipient.objects.filter(message=message).count()
    read_count = MessageRecipient.objects.filter(message=message, is_read=True).count()
    acknowledged_count = MessageRecipient.objects.filter(message=message, acknowledged=True).count()
    
    return render(request, 'messages/message_detail.html', {
        'message': message,
        'total_recipients': total_recipients,
        'read_count': read_count,
        'acknowledged_count': acknowledged_count,
        'read_percentage': (read_count / total_recipients * 100) if total_recipients > 0 else 0,
    })

@login_required
def inbox(request):
    """User's inbox with received messages"""
    user = request.user
    
    if user.is_student():
        try:
            student = Student.objects.get(user=user)
            recipients = MessageRecipient.objects.filter(student=student).select_related('message')
            messages_list = [recipient.message for recipient in recipients]  # Renamed to avoid conflict
        except Student.DoesNotExist:
            messages_list = []
    elif user.is_teacher():
        try:
            teacher = Teacher.objects.get(user=user)
            recipients = MessageRecipient.objects.filter(teacher=teacher).select_related('message')
            messages_list = [recipient.message for recipient in recipients]  # Renamed to avoid conflict
        except Teacher.DoesNotExist:
            messages_list = []
    else:
        # Admin sees all messages they sent
        messages_list = Message.objects.filter(sender=user)  # Renamed to avoid conflict
    
    # Get unread messages
    unread_messages = []
    read_messages = []
    
    for msg in messages_list:
        if user.is_student():
            recipient = MessageRecipient.objects.filter(message=msg, student__user=user).first()
        elif user.is_teacher():
            recipient = MessageRecipient.objects.filter(message=msg, teacher__user=user).first()
        else:
            recipient = None
        
        if recipient and not recipient.is_read:
            unread_messages.append({
                'message': msg,
                'recipient': recipient,
                'is_read': False
            })
        else:
            read_messages.append({
                'message': msg,
                'recipient': recipient,
                'is_read': True
            })
    
    return render(request, 'messages/inbox.html', {
        'unread_messages': unread_messages,
        'read_messages': read_messages,
        'total_messages': len(messages_list),
        'unread_count': len(unread_messages),
    })

@login_required
def outbox(request):
    """Messages sent by the user"""
    if not (request.user.is_admin() or request.user.is_teacher()):
        messages.error(request, 'Access denied.')  # CHANGED
        return redirect('dashboard')
    
    sent_messages = Message.objects.filter(sender=request.user)
    
    # Get delivery statistics for each message
    messages_with_stats = []
    for msg in sent_messages:
        recipients = MessageRecipient.objects.filter(message=msg)
        total = recipients.count()
        read = recipients.filter(is_read=True).count()
        acknowledged = recipients.filter(acknowledged=True).count()
        
        messages_with_stats.append({
            'message': msg,
            'total_recipients': total,
            'read_count': read,
            'acknowledged_count': acknowledged,
            'read_percentage': (read / total * 100) if total > 0 else 0,
        })
    
    return render(request, 'messages/outbox.html', {
        'messages': messages_with_stats,
    })

# ===== Holiday Notices =====

@login_required
@user_passes_test(is_admin)
def holiday_notice_list(request):
    """List all holiday notices"""
    holidays = HolidayNotice.objects.all()
    current_holidays = [h for h in holidays if h.is_current()]
    upcoming_holidays = [h for h in holidays if h.start_date > timezone.now().date()]
    past_holidays = [h for h in holidays if h.end_date < timezone.now().date()]
    
    return render(request, 'messages/holiday_list.html', {
        'current_holidays': current_holidays,
        'upcoming_holidays': upcoming_holidays,
        'past_holidays': past_holidays,
    })

@login_required
@user_passes_test(is_admin)
def holiday_notice_create(request):
    """Create a holiday notice"""
    if request.method == 'POST':
        form = HolidayNoticeForm(request.POST)
        if form.is_valid():
            holiday = form.save(commit=False)
            holiday.created_by = request.user
            
            # Check for date validity
            if holiday.start_date > holiday.end_date:
                form.add_error('end_date', 'End date must be after start date.')
            elif holiday.end_date > holiday.school_reopens:
                form.add_error('school_reopens', 'School reopens date must be after holiday end date.')
            else:
                holiday.save()
                
                # Send notifications if requested
                if holiday.notify_students or holiday.notify_parents or holiday.notify_teachers:
                    create_holiday_notifications(holiday)
                
                messages.success(request, 'Holiday notice created and notifications sent!')  # CHANGED
                return redirect('holiday_notice_list')
    else:
        form = HolidayNoticeForm()
    
    return render(request, 'messages/holiday_form.html', {
        'form': form,
        'title': 'Create Holiday Notice'
    })

@login_required
def holiday_notice_detail(request, pk):
    """View holiday notice details"""
    holiday = get_object_or_404(HolidayNotice, pk=pk)
    
    # Calculate days remaining or elapsed
    today = timezone.now().date()
    if today < holiday.start_date:
        status = 'upcoming'
        days_info = f"Starts in {(holiday.start_date - today).days} days"
    elif today > holiday.end_date:
        status = 'past'
        days_info = f"Ended {(today - holiday.end_date).days} days ago"
    else:
        status = 'current'
        days_info = f"Day {(today - holiday.start_date).days + 1} of {holiday.duration_days}"
    
    return render(request, 'messages/holiday_detail.html', {
        'holiday': holiday,
        'status': status,
        'days_info': days_info,
    })

# ===== Notifications =====

@login_required
def notification_list(request):
    """User's notifications"""
    user_notifications = Notification.objects.filter(user=request.user)
    unread_notifications = user_notifications.filter(is_read=False)
    read_notifications = user_notifications.filter(is_read=True)[:20]  # Limit read notifications
    
    return render(request, 'messages/notification_list.html', {
        'unread_notifications': unread_notifications,
        'read_notifications': read_notifications,
        'total_unread': unread_notifications.count(),
    })

@login_required
def mark_notification_read(request, pk):
    """Mark a notification as read"""
    notification = get_object_or_404(Notification, pk=pk, user=request.user)
    notification.mark_as_read()
    
    if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
        return JsonResponse({'success': True})
    
    return redirect('notification_list')

@login_required
def mark_all_notifications_read(request):
    """Mark all notifications as read"""
    Notification.objects.filter(user=request.user, is_read=False).update(is_read=True)
    
    if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
        return JsonResponse({'success': True})
    
    return redirect('notification_list')

@login_required
def get_notification_count(request):
    """Get unread notification count (AJAX)"""
    if request.user.is_authenticated:
        count = Notification.objects.filter(user=request.user, is_read=False).count()
        return JsonResponse({'count': count})
    return JsonResponse({'count': 0})

# ===== Quick Actions =====

@login_required
@user_passes_test(lambda u: u.is_admin() or u.is_teacher())
def quick_message(request):
    """Quick message sending interface"""
    if request.method == 'POST':
        form = QuickMessageForm(request.POST)
        if form.is_valid():
            subject_type = form.cleaned_data['subject_type']
            custom_subject = form.cleaned_data['custom_subject']
            content = form.cleaned_data['content']
            send_to = form.cleaned_data['send_to']
            
            # Create subject based on type
            subject_map = {
                'holiday': 'Holiday Notice',
                'fee_reminder': 'Fee Payment Reminder',
                'exam_schedule': 'Exam Schedule Update',
                'event': 'School Event Announcement',
                'urgent': 'Urgent Notice',
            }
            subject = custom_subject if custom_subject else subject_map.get(subject_type, 'Message')
            
            # Create message
            message = Message.objects.create(
                sender=request.user,
                subject=subject,
                content=content,
                message_type='announcement',
                priority='high' if subject_type == 'urgent' else 'normal'
            )
            
            # Add recipients based on selection
            if send_to == 'all_students':
                message.send_to_all = False
                message.students.set(Student.objects.all())
            elif send_to == 'all_teachers':
                message.send_to_all = False
                message.teachers.set(Teacher.objects.all())
            elif send_to == 'all_users':
                message.send_to_all = True
            # For 'specific', you would need additional form fields
            
            message.save()
            
            # Create recipients and notifications
            if message.send_to_all:
                create_recipients_for_all(message)
            else:
                create_recipients_for_message(message)
            
            create_notifications_for_message(message)
            
            messages.success(request, 'Quick message sent successfully!')  # CHANGED
            return redirect('message_list')
    else:
        form = QuickMessageForm()
    
    return render(request, 'messages/quick_message.html', {'form': form})\n\n========== FILE: ./school_messages/__init__.py ==========\n
\n\n========== FILE: ./static/css/admin-overrides.css ==========\n
/* static/css/admin-overrides.css */

/* Custom fieldset styling */
fieldset.module {
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
}

fieldset.module h2 {
    background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    margin: -20px -20px 20px -20px;
}

/* Inline forms */
.inline-group {
    border: 1px solid #a5bff3;
    border-radius: 8px;
    overflow: hidden;
}

/* Action buttons */
.object-tools {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.object-tools a {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s;
}

.object-tools a:hover {
    transform: translateY(-2px);
    text-decoration: none;
}

/* Filter sidebar */
#changelist-filter {
    background: white;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

#changelist-filter h3 {
    color: #4f46e5;
    font-weight: 600;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid #e5e7eb;
}

/* Pagination */
.pagination {
    display: flex;
    gap: 4px;
}

.pagination .page-link {
    border-radius: 6px;
    padding: 8px 12px;
    border: 1px solid #e5e7eb;
}

.pagination .active .page-link {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    border-color: #4f46e5;
}

/* Search box */
#searchbar {
    border-radius: 8px;
    border: 2px solid #e5e7eb;
    padding: 10px 16px;
    transition: all 0.3s;
}

#searchbar:focus {
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

/* Login page customization */
.login-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
}

.login-box {
    background: white;
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    width: 100%;
    max-width: 400px;
}\n\n========== FILE: ./static/css/unfold-custom.css ==========\n
/* static/css/unfold-custom.css */

/* 1. Custom Color Scheme */
:root {
    --primary-color: #4f46e5;
    --secondary-color: #7c3aed;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
    --info-color: #3b82f6;
}

/* 2. Branding & Header Customization */
.unfold-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
}

.unfold-header .unfold-title {
    font-weight: 700;
    letter-spacing: -0.5px;
}

/* 3. Sidebar Customization */
.unfold-sidebar {
    background: #1e293b;
}

.unfold-sidebar .unfold-sidebar-item {
    transition: all 0.2s ease;
    border-radius: 8px;
    margin: 4px 8px;
}

.unfold-sidebar .unfold-sidebar-item:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateX(4px);
}

.unfold-sidebar .unfold-sidebar-item.active {
    background: var(--primary-color);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

/* 4. Card & Panel Styling */
.card {
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.card-header {
    background: linear-gradient(90deg, #f8fafc 0%, #ffffff 100%);
    border-bottom: 2px solid var(--primary-color);
    border-radius: 12px 12px 0 0;
}

/* 5. Button Customization */
.btn-primary {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.4);
}

/* 6. Table Styling */
.table {
    border-radius: 8px;
    overflow: hidden;
}

.table thead {
    background: linear-gradient(90deg, #f1f5f9 0%, #e2e8f0 100%);
}

.table-striped tbody tr:nth-of-type(odd) {
    background-color: #f8fafc;
}

.table-hover tbody tr:hover {
    background-color: #f1f5f9;
    transform: scale(1.002);
}

/* 7. Form Styling */
.form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

.form-label {
    font-weight: 600;
    color: #374151;
}

/* 8. Badge Customization */
.badge {
    border-radius: 20px;
    padding: 6px 12px;
    font-weight: 600;
}

.badge-success {
    background: linear-gradient(135deg, var(--success-color) 0%, #34d399 100%);
}

.badge-warning {
    background: linear-gradient(135deg, var(--warning-color) 0%, #fbbf24 100%);
}

.badge-danger {
    background: linear-gradient(135deg, var(--danger-color) 0%, #f87171 100%);
}

/* 9. Progress Bars */
.progress {
    height: 10px;
    border-radius: 5px;
    background: #e5e7eb;
}

.progress-bar {
    background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border-radius: 5px;
}

/* 10. Alert Messages */
.alert {
    border-radius: 10px;
    border: none;
    padding: 16px;
    margin: 16px 0;
}

.alert-success {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
}

.alert-warning {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
}

/* 11. Dashboard Cards */
.dashboard-card {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transition: all 0.3s ease;
}

.dashboard-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.dashboard-card-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

/* 12. Custom Animations */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.content {
    animation: fadeIn 0.3s ease-out;
}

/* 13. Mobile Responsiveness */
@media (max-width: 768px) {
    .unfold-sidebar {
        width: 100%;
    }
    
    .dashboard-card {
        margin-bottom: 16px;
    }
    
    .table-responsive {
        border-radius: 8px;
    }
}

/* 14. Custom Scrollbar */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--secondary-color);
}\n\n========== FILE: ./static/js/unfold-custom.js ==========\n
// static/js/unfold-custom.js

document.addEventListener('DOMContentLoaded', function() {
    // Add loading animation to form submissions
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', function() {
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
                submitBtn.disabled = true;
            }
        });
    });
    
    // Add tooltips
    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    if (tooltips.length > 0 && typeof bootstrap !== 'undefined') {
        tooltips.forEach(tooltip => {
            new bootstrap.Tooltip(tooltip);
        });
    }
    
    // Auto-hide alerts after 5 seconds
    const alerts = document.querySelectorAll('.alert:not(.alert-permanent)');
    alerts.forEach(alert => {
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }, 5000);
    });
    
    // Add smooth scrolling for sidebar links
    const sidebarLinks = document.querySelectorAll('.unfold-sidebar a');
    sidebarLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            if (this.hash !== "") {
                e.preventDefault();
                const target = document.querySelector(this.hash);
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            }
        });
    });
    
    // Add active class to current page in sidebar
    const currentPath = window.location.pathname;
    sidebarLinks.forEach(link => {
        if (link.getAttribute('href') === currentPath) {
            link.classList.add('active');
            // Expand parent if it's in a collapsible section
            const parent = link.closest('.collapse');
            if (parent) {
                const bsCollapse = new bootstrap.Collapse(parent, { toggle: false });
                bsCollapse.show();
            }
        }
    });
});\n\n========== FILE: ./students/admin.py ==========\n
from django.contrib import admin
from django import forms
from django.utils.html import format_html
from django.utils.translation import gettext_lazy as _
from django.contrib import messages
from unfold.admin import ModelAdmin
from .models import Student
from accounts.models import User
from accounts.password_utils import generate_password

class StudentCreationForm(forms.ModelForm):
    """Form for creating students with automatic password generation"""
    username = forms.CharField(max_length=150, required=True)
    email = forms.EmailField(required=False)
    first_name = forms.CharField(max_length=30, required=True)
    last_name = forms.CharField(max_length=150, required=True)
    
    class Meta:
        model = Student
        fields = '__all__'
        exclude = ('user',)
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        if 'user' in self.fields:
            del self.fields['user']
    
    def clean_username(self):
        username = self.cleaned_data.get('username')
        if User.objects.filter(username=username).exists():
            raise forms.ValidationError("A user with that username already exists.")
        return username
    
    def clean_email(self):
        email = self.cleaned_data.get('email')
        if email and User.objects.filter(email=email).exists():
            raise forms.ValidationError("A user with that email already exists.")
        return email
    
    def clean_admission_number(self):
        admission_number = self.cleaned_data.get('admission_number')
        if Student.objects.filter(admission_number=admission_number).exists():
            raise forms.ValidationError("A student with this admission number already exists.")
        return admission_number
    
    def save(self, commit=True):
        # Generate password automatically
        password = generate_password(8)
        
        # Create User first
        user = User.objects.create_user(
            username=self.cleaned_data['username'],
            email=self.cleaned_data.get('email', ''),
            password=password,
            first_name=self.cleaned_data['first_name'],
            last_name=self.cleaned_data['last_name'],
            role='student'
        )
        
        # Create Student with the user
        student = super().save(commit=False)
        student.user = user
        
        if commit:
            student.save()
        
        # Store generated password for display
        self.generated_password = password
        self.student_username = user.username
        
        return student

@admin.register(Student)
class StudentAdmin(ModelAdmin):
    form = forms.ModelForm
    add_form = StudentCreationForm
    
    list_display = ('admission_number', 'student_name', 'grade_section', 
                    'display_password', 'parent_name', 'date_of_birth', 'created_at')
    list_filter = ('grade', 'section', 'created_at')
    search_fields = ('admission_number', 'user__username', 'user__first_name', 
                     'user__last_name', 'parent_name')
    ordering = ('grade', 'section', 'admission_number')
    readonly_fields = ('created_at', 'updated_at', 'student_user_info')
    
    fieldsets = (
        (_('User Account'), {
            'fields': ('student_user_info',)
        }),
        (_('Academic Information'), {
            'fields': ('admission_number', 'grade', 'section', 'subjects'),
        }),
        (_('Personal Information'), {
            'fields': ('date_of_birth', 'address', 'phone'),
        }),
        (_('Parent Information'), {
            'fields': ('parent_name', 'parent_phone'),
        }),
        (_('Extracurricular Activities'), {
            'fields': ('clubs', 'societies'),
        }),
        (_('Metadata'), {
            'fields': ('created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )
    
    add_fieldsets = (
        (_('User Account Creation'), {
            'fields': ('username', 'email', 'first_name', 'last_name'),
            'description': _('Student account will be created with auto-generated password.')
        }),
        (_('Academic Information (Required*)'), {
            'fields': ('admission_number', 'grade', 'section', 'subjects')
        }),
        (_('Personal Information (Required*)'), {
            'fields': ('date_of_birth', 'address', 'phone')
        }),
        (_('Parent Information (Required*)'), {
            'fields': ('parent_name', 'parent_phone')
        }),
        (_('Extracurricular Activities'), {
            'fields': ('clubs', 'societies')
        }),
    )
    
    @admin.display(description='Student Name')
    def student_name(self, obj):
        if obj.user:
            full_name = obj.user.get_full_name()
            if full_name:
                return format_html('<strong>{}</strong>', full_name)
            return format_html('<strong>{}</strong>', obj.user.username)
        return format_html('<span style="color: red;">No User</span>')
    
    @admin.display(description='Grade/Section')
    def grade_section(self, obj):
        return format_html('<span class="badge bg-primary">{}{}</span>', obj.grade, obj.section)
    
    @admin.display(description='Password')
    def display_password(self, obj):
        """Display password placeholder"""
        return format_html(
            '<span class="badge bg-secondary" title="Auto-generated 8-character password">'
            '<i class="fas fa-key"></i> Auto-generated</span>'
        )
    
    @admin.display(description='User Account')
    def student_user_info(self, obj):
        if obj.user:
            status_color = 'green' if obj.user.is_active else 'red'
            status_text = 'Active' if obj.user.is_active else 'Inactive'
            
            return format_html(
                '<div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">'
                '<h4 style="margin-top: 0;">User Account Information</h4>'
                '<table style="width: 100%;">'
                '<tr><td style="width: 30%;"><strong>Username:</strong></td><td>{}</td></tr>'
                '<tr><td><strong>Email:</strong></td><td>{}</td></tr>'
                '<tr><td><strong>Role:</strong></td><td><span class="badge bg-success">{}</span></td></tr>'
                '<tr><td><strong>Status:</strong></td><td><span style="color: {};">â— {}</span></td></tr>'
                '<tr><td><strong>Last Login:</strong></td><td>{}</td></tr>'
                '</table>'
                '</div>',
                obj.user.username,
                obj.user.email if obj.user.email else '<em>Not set</em>',
                obj.user.get_role_display(),
                status_color,
                status_text,
                obj.user.last_login.strftime('%Y-%m-%d %H:%M') if obj.user.last_login else 'Never'
            )
        return format_html(
            '<div style="background-color: #fff3cd; padding: 15px; border-radius: 5px; border: 1px solid #ffeaa7;">'
            '<strong style="color: #856404;">âš  No user account linked!</strong><br>'
            'This student profile is not linked to any user account.'
            '</div>'
        )
    
    def get_form(self, request, obj=None, **kwargs):
        defaults = {}
        if obj is None:  # Adding a new object
            defaults['form'] = self.add_form
        else:  # Editing an existing object
            defaults['form'] = self.form
        
        defaults.update(kwargs)
        return super().get_form(request, obj, **defaults)
    
    def get_fieldsets(self, request, obj=None):
        if obj is None:  # Adding new
            return self.add_fieldsets
        return super().get_fieldsets(request, obj)
    
    def get_readonly_fields(self, request, obj=None):
        if obj:  # Editing an existing object
            return self.readonly_fields + ('admission_number',)
        return self.readonly_fields
    
    def save_model(self, request, obj, form, change):
        if not change:  # Creating new
            student = form.save(commit=False)
            
            # Display success message with password
            if hasattr(form, 'generated_password'):
                messages.success(
                    request, 
                    f'Student created successfully! Username: {form.student_username}, '
                    f'Password: <strong>{form.generated_password}</strong>'
                )
        
        super().save_model(request, obj, form, change)
    
    list_per_page = 25
    date_hierarchy = 'created_at'
    empty_value_display = '---'
    
    actions = ['activate_students', 'deactivate_students']
    
    @admin.action(description='Activate selected students')
    def activate_students(self, request, queryset):
        activated = 0
        for student in queryset:
            if student.user:
                student.user.is_active = True
                student.user.save()
                activated += 1
        self.message_user(request, f'{activated} students were activated.')
    
    @admin.action(description='Deactivate selected students')
    def deactivate_students(self, request, queryset):
        deactivated = 0
        for student in queryset:
            if student.user:
                student.user.is_active = False
                student.user.save()
                deactivated += 1
        self.message_user(request, f'{deactivated} students were deactivated.')\n\n========== FILE: ./students/apps.py ==========\n
from django.apps import AppConfig

class StudentsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'students'\n\n========== FILE: ./students/forms.py ==========\n
from django import forms
from .models import Student
from accounts.models import User
from accounts.password_utils import generate_password

class StudentForm(forms.ModelForm):
    username = forms.CharField(max_length=150, required=True)
    email = forms.EmailField(required=False)
    first_name = forms.CharField(max_length=30, required=True)
    last_name = forms.CharField(max_length=150, required=True)
    
    # Remove password field since it's auto-generated
    # password = forms.CharField(widget=forms.PasswordInput, required=True)
    
    class Meta:
        model = Student
        fields = [
            'username', 'email', 'first_name', 'last_name',
            'admission_number', 'grade', 'section', 'date_of_birth',
            'address', 'phone', 'parent_name', 'parent_phone',
            'clubs', 'societies', 'subjects'
        ]
    
    def save(self, commit=True):
        # Generate password automatically
        password = generate_password(8)
        
        # Create User first
        user_data = {
            'username': self.cleaned_data['username'],
            'email': self.cleaned_data.get('email', ''),
            'password': password,
            'first_name': self.cleaned_data['first_name'],
            'last_name': self.cleaned_data['last_name'],
            'role': 'student',
        }
        
        user = User.objects.create_user(
            username=user_data['username'],
            email=user_data['email'],
            password=password,
            first_name=user_data['first_name'],
            last_name=user_data['last_name'],
            role='student'
        )
        
        # Create Student
        student = super().save(commit=False)
        student.user = user
        student.generated_password = password  # Store plain password for display
        
        if commit:
            student.save()
            self.save_m2m()
        
        # Return ONLY student (not tuple) to match your original return type
        return student\n\n========== FILE: ./students/models.py ==========\n
from django.db import models
from accounts.models import User

class Student(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name='student_profile')
    admission_number = models.CharField(max_length=20, unique=True)
    grade = models.CharField(max_length=10)
    section = models.CharField(max_length=10)
    date_of_birth = models.DateField()
    address = models.TextField()
    phone = models.CharField(max_length=15, blank=True)
    parent_name = models.CharField(max_length=100)
    parent_phone = models.CharField(max_length=15)
    
    clubs = models.TextField(blank=True, help_text="List of clubs registered (comma-separated)")
    societies = models.TextField(blank=True, help_text="List of societies joined (comma-separated)")
    subjects = models.TextField(blank=True, help_text="Subjects enrolled (comma-separated)")
    
    # Add field to store initial password for teacher viewing
    initial_password = models.CharField(max_length=128, blank=True, null=True, editable=False)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self):
        return f"{self.user.get_full_name()} - {self.admission_number}"
    
    def save(self, *args, **kwargs):
        # Store the initial password when first created
        if not self.pk and not self.initial_password and self.user:
            # For demo: create a simple password based on student info
            # In production, this would come from the password generation function
            pass_first = self.user.first_name[:3].lower() if self.user.first_name else 'stu'
            pass_last = self.admission_number[-2:]
            self.initial_password = f"{pass_first}{pass_last}1@"
        
        super().save(*args, **kwargs)
    
    class Meta:
        ordering = ['grade', 'section', 'admission_number']\n\n========== FILE: ./students/templates/students/student_detail.html ==========\n
{% extends 'accounts/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-2">
                <i class="fas fa-user-graduate text-primary me-2"></i>Student Profile
            </h1>
            <div class="d-flex align-items-center">
                <span class="badge bg-primary me-2">{{ student.grade }}{{ student.section }}</span>
                <span class="badge bg-success">{{ student.admission_number }}</span>
                <span class="text-muted ms-3">
                    <i class="fas fa-calendar-alt me-1"></i>Joined {{ student.created_at|date:"F Y" }}
                </span>
            </div>
        </div>
        <div>
            {% if user.is_admin %}
            <div class="btn-group">
                <a href="{% url 'student_update' student.pk %}" class="btn btn-warning">
                    <i class="fas fa-edit me-2"></i>Edit Profile
                </a>
                <button type="button" class="btn btn-info dropdown-toggle dropdown-toggle-split" 
                        data-bs-toggle="dropdown">
                    <span class="visually-hidden">More Actions</span>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">
                        <i class="fas fa-print me-2"></i>Print Profile
                    </a></li>
                    <li><a class="dropdown-item" href="#">
                        <i class="fas fa-envelope me-2"></i>Send Message
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#">
                        <i class="fas fa-trash-alt me-2"></i>Deactivate
                    </a></li>
                </ul>
            </div>
            {% endif %}
            <a href="{% url 'student_list' %}" class="btn btn-outline-secondary ms-2">
                <i class="fas fa-arrow-left me-2"></i>Back to List
            </a>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column -->
        <div class="col-lg-7">
            <!-- Personal Information Card -->
            <div class="card shadow-lg border-0 h-100">
                <div class="card-header" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <h5 class="mb-0 text-white">
                        <i class="fas fa-user-circle me-2"></i>Personal Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center mb-4">
                        <div class="col-auto">
                            {% if student.user.profile_picture %}
                            <img src="{{ student.user.profile_picture.url }}" 
                                 alt="Profile Picture" 
                                 class="rounded-circle shadow"
                                 style="width: 120px; height: 120px; object-fit: cover; border: 4px solid white;">
                            {% else %}
                            <div class="rounded-circle d-flex align-items-center justify-content-center shadow"
                                 style="width: 120px; height: 120px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <span class="text-white h2">{{ student.user.get_full_name|first|upper }}</span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col">
                            <h3 class="mb-1">{{ student.user.get_full_name }}</h3>
                            <p class="text-muted mb-2">
                                <i class="fas fa-id-card me-1"></i>{{ student.admission_number }}
                            </p>
                            <div class="badge bg-primary px-3 py-2">
                                <i class="fas fa-graduation-cap me-1"></i>{{ student.grade }}{{ student.section }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3 p-2 rounded" style="background-color: #f8f9fa;">
                                <div class="flex-shrink-0 me-3">
                                    <i class="fas fa-calendar-day text-primary fa-lg"></i>
                                </div>
                                <div>
                                    <small class="text-muted">Date of Birth</small>
                                    <div class="fw-medium">{{ student.date_of_birth }}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3 p-2 rounded" style="background-color: #f8f9fa;">
                                <div class="flex-shrink-0 me-3">
                                    <i class="fas fa-envelope text-primary fa-lg"></i>
                                </div>
                                <div>
                                    <small class="text-muted">Email</small>
                                    <div class="fw-medium">{{ student.user.email|default:"Not provided" }}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3 p-2 rounded" style="background-color: #f8f9fa;">
                                <div class="flex-shrink-0 me-3">
                                    <i class="fas fa-phone text-primary fa-lg"></i>
                                </div>
                                <div>
                                    <small class="text-muted">Phone</small>
                                    <div class="fw-medium">{{ student.phone|default:"Not provided" }}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-12">
                            <div class="d-flex align-items-start mb-3 p-2 rounded" style="background-color: #f8f9fa;">
                                <div class="flex-shrink-0 me-3 mt-1">
                                    <i class="fas fa-home text-primary fa-lg"></i>
                                </div>
                                <div>
                                    <small class="text-muted">Address</small>
                                    <div class="fw-medium">{{ student.address|linebreaksbr }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column -->
        <div class="col-lg-5">
            <!-- Parent Information Card -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h5 class="mb-0 text-white">
                        <i class="fas fa-users me-2"></i>Parent/Guardian Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-4">
                        <div class="flex-shrink-0 me-3">
                            <div class="rounded-circle d-flex align-items-center justify-content-center"
                                 style="width: 60px; height: 60px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <i class="fas fa-user-friends text-white fa-lg"></i>
                            </div>
                        </div>
                        <div>
                            <h5 class="mb-1">{{ student.parent_name }}</h5>
                            <p class="text-muted mb-0">Parent/Guardian</p>
                        </div>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-12">
                            <div class="d-flex align-items-center p-3 rounded" style="background-color: #f8f9fa;">
                                <div class="flex-shrink-0 me-3">
                                    <i class="fas fa-phone-alt text-success fa-lg"></i>
                                </div>
                                <div>
                                    <small class="text-muted">Contact Phone</small>
                                    <div class="fw-medium h5 mb-0">{{ student.parent_phone }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-envelope me-1"></i>Send Message to Parent
                        </button>
                        <button class="btn btn-outline-secondary btn-sm ms-2">
                            <i class="fas fa-phone me-1"></i>Call Parent
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="card shadow-lg border-0">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>Student Overview
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="p-2 rounded" style="background-color: #e3f2fd;">
                                <div class="h4 mb-1 text-primary">{{ student.subjects|linebreaksbr|wordcount }}</div>
                                <small class="text-muted">Subjects</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="p-2 rounded" style="background-color: #f3e5f5;">
                                <div class="h4 mb-1 text-purple">{{ student.clubs|linebreaksbr|wordcount }}</div>
                                <small class="text-muted">Clubs</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 rounded" style="background-color: #e8f5e9;">
                                <div class="h4 mb-1 text-success">{{ student.societies|linebreaksbr|wordcount }}</div>
                                <small class="text-muted">Societies</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 rounded" style="background-color: #fff3e0;">
                                <div class="h4 mb-1 text-warning">{{ student.user.date_joined|timesince }}</div>
                                <small class="text-muted">In System</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Additional Information Row -->
    <div class="row g-4 mt-2">
        <!-- Academic Information -->
        <div class="col-lg-6">
            <div class="card shadow-lg border-0 h-100">
                <div class="card-header" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <h5 class="mb-0 text-white">
                        <i class="fas fa-book-open me-2"></i>Academic Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="fas fa-clipboard-list me-2 text-primary"></i>Enrolled Subjects
                        </h6>
                        {% if student.subjects %}
                        <div class="d-flex flex-wrap gap-2">
                            {% for subject in student.subjects.split %}
                            <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2">
                                <i class="fas fa-book me-1"></i>{{ subject|title }}
                            </span>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>No subjects assigned yet.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Extracurricular Activities -->
        <div class="col-lg-6">
            <div class="card shadow-lg border-0 h-100">
                <div class="card-header" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <h5 class="mb-0 text-white">
                        <i class="fas fa-running me-2"></i>Extracurricular Activities
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Clubs -->
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="fas fa-users me-2 text-success"></i>Clubs Registered
                        </h6>
                        {% if student.clubs %}
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            {% for club in student.clubs.split %}
                            <span class="badge bg-success bg-opacity-10 text-success px-3 py-2">
                                <i class="fas fa-user-friends me-1"></i>{{ club|title }}
                            </span>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">
                            <i class="fas fa-minus-circle me-1"></i>No clubs registered
                        </p>
                        {% endif %}
                    </div>
                    
                    <!-- Societies -->
                    <div>
                        <h6 class="mb-3">
                            <i class="fas fa-university me-2 text-info"></i>Societies Joined
                        </h6>
                        {% if student.societies %}
                        <div class="d-flex flex-wrap gap-2">
                            {% for society in student.societies.split %}
                            <span class="badge bg-info bg-opacity-10 text-info px-3 py-2">
                                <i class="fas fa-handshake me-1"></i>{{ society|title }}
                            </span>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">
                            <i class="fas fa-minus-circle me-1"></i>No societies joined
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    {% if user.is_admin %}
    <div class="mt-4 pt-4 border-top">
        <div class="d-flex justify-content-center gap-3">
            <a href="{% url 'student_update' student.pk %}" class="btn btn-warning px-4">
                <i class="fas fa-edit me-2"></i>Edit Student Information
            </a>
            <a href="{% url 'student_list' %}" class="btn btn-outline-secondary px-4">
                <i class="fas fa-list me-2"></i>View All Students
            </a>
            <button class="btn btn-outline-primary px-4">
                <i class="fas fa-file-pdf me-2"></i>Generate Report
            </button>
        </div>
    </div>
    {% endif %}
</div>

<style>
    .card {
        border-radius: 15px;
        overflow: hidden;
        transition: transform 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-5px);
    }
    
    .card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: none;
    }
    
    .badge {
        border-radius: 10px;
        font-weight: 500;
    }
    
    .btn-group .btn {
        border-radius: 10px;
    }
    
    .dropdown-menu {
        border-radius: 10px;
        border: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    /* Gradient backgrounds for info cards */
    .gradient-1 {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    .gradient-2 {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .gradient-3 {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .btn-group {
            flex-direction: column;
            width: 100%;
        }
        
        .btn-group .btn {
            margin-bottom: 5px;
            width: 100%;
        }
        
        .dropdown-toggle-split {
            width: 100%;
        }
    }
</style>
{% endblock %}\n\n========== FILE: ./students/templates/students/student_form.html ==========\n
{% extends 'accounts/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header Card -->
            <div class="card shadow-lg border-0 mb-4" 
                 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-2">
                                <i class="fas fa-user-graduate me-2"></i>{{ title }} Student
                            </h1>
                            <p class="mb-0 opacity-75">
                                {% if title == 'Add' %}
                                Register a new student in the school system
                                {% else %}
                                Update student information and account details
                                {% endif %}
                            </p>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-light text-primary px-3 py-2 rounded-pill">
                                <i class="fas fa-user-plus me-1"></i> {{ title }} Mode
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Card -->
            <div class="card shadow-lg border-0">
                <div class="card-body p-0">
                    <form method="post" enctype="multipart/form-data" class="p-4" novalidate>
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            {% for error in form.non_field_errors %}
                            {{ error }}
                            {% endfor %}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endif %}
                        
                        <!-- Account Information Section -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-light border-0">
                                <h5 class="mb-0">
                                    <i class="fas fa-user-circle text-primary me-2"></i>Account Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    {% for field in form %}
                                        {% if field.name in 'username,email,first_name,last_name,password' %}
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ field.id_for_label }}" class="form-label fw-semibold">
                                                    <i class="fas fa-{{ field.name|slice:'0:1'|lower }} me-1 text-primary"></i>
                                                    {{ field.label }} {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                                                </label>
                                                {{ field }}
                                                {% if field.errors %}
                                                <div class="text-danger small mt-1">
                                                    <i class="fas fa-exclamation-circle me-1"></i>{{ field.errors }}
                                                </div>
                                                {% endif %}
                                                {% if field.help_text %}
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>{{ field.help_text }}
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <!-- Password Note for Update -->
                                    {% if title == 'Update' %}
                                    <div class="col-md-12">
                                        <div class="alert alert-info mt-2">
                                            <i class="fas fa-key me-2"></i>
                                            <small>Leave password fields empty to keep the current password unchanged.</small>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Student Information Section -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-light border-0">
                                <h5 class="mb-0">
                                    <i class="fas fa-id-card text-success me-2"></i>Student Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    {% for field in form %}
                                        {% if field.name not in 'username,email,first_name,last_name,password' %}
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ field.id_for_label }}" class="form-label fw-semibold">
                                                    <i class="fas fa-{{ field.name|slice:'0:1'|lower }} me-1 text-success"></i>
                                                    {{ field.label }} {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                                                </label>
                                                {{ field }}
                                                {% if field.errors %}
                                                <div class="text-danger small mt-1">
                                                    <i class="fas fa-exclamation-circle me-1"></i>{{ field.errors }}
                                                </div>
                                                {% endif %}
                                                {% if field.help_text %}
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>{{ field.help_text }}
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Important Notes -->
                        <div class="alert alert-warning border-0 shadow-sm mb-4">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-triangle fa-lg text-warning"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="alert-heading mb-2">Important Information</h6>
                                    <ul class="mb-0 small">
                                        <li>All fields marked with <span class="text-danger">*</span> are required</li>
                                        <li>Students will receive auto-generated 8-character passwords</li>
                                        <li>Ensure all contact information is accurate for communication</li>
                                        <li>Teachers will be able to view student passwords for their classes</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between align-items-center mt-4 pt-4 border-top">
                            <div>
                                <a href="{% url 'student_list' %}" class="btn btn-outline-secondary px-4">
                                    <i class="fas fa-arrow-left me-2"></i>Back to Students
                                </a>
                                <button type="reset" class="btn btn-outline-warning ms-2">
                                    <i class="fas fa-redo me-2"></i>Reset Form
                                </button>
                            </div>
                            <div>
                                <button type="submit" class="btn btn-success btn-lg px-5">
                                    <i class="fas fa-save me-2"></i>Save Student
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Password Generation Info -->
            {% if title == 'Add' %}
            <div class="card border-0 shadow-sm mt-4" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <div class="card-body text-white p-4">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-3">
                            <i class="fas fa-key fa-2x"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="mb-2">
                                <i class="fas fa-shield-alt me-2"></i>Password Generation
                            </h5>
                            <p class="mb-0 opacity-75">
                                Upon submission, the system will automatically generate a secure 8-character password 
                                for the student. This password will be displayed to teachers of the student's classes 
                                and can be viewed by administrators.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    select, input[type="text"], input[type="email"], input[type="password"], 
    input[type="date"], input[type="tel"], textarea {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        transition: all 0.3s ease;
        background-color: #f8fafc;
        font-size: 14px;
    }
    
    select:focus, input[type="text"]:focus, input[type="email"]:focus, 
    input[type="password"]:focus, input[type="date"]:focus, 
    input[type="tel"]:focus, textarea:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background-color: white;
        outline: none;
    }
    
    textarea {
        min-height: 100px;
        resize: vertical;
    }
    
    .form-label {
        color: #2d3748;
        margin-bottom: 8px;
        font-weight: 600;
    }
    
    .form-text {
        font-size: 12px;
        color: #6c757d;
        margin-top: 4px;
    }
    
    .card {
        border-radius: 15px;
        overflow: hidden;
        transition: transform 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
    }
    
    .card-header {
        padding: 1.25rem 1.5rem;
        background-color: #f8fafc !important;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .btn-success {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        border: none;
        border-radius: 10px;
        padding: 12px 30px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(67, 233, 123, 0.4);
    }
    
    .btn-outline-secondary {
        border-radius: 10px;
        padding: 10px 25px;
        font-weight: 500;
    }
    
    .btn-outline-warning {
        border-radius: 10px;
        padding: 10px 25px;
    }
    
    .alert {
        border-radius: 10px;
        border: none;
    }
    
    .alert-warning {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .alert-info {
        background-color: #e0f2fe;
        color: #0369a1;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .row.g-3 {
            margin-left: 0;
            margin-right: 0;
        }
        
        .col-md-6 {
            margin-bottom: 15px;
        }
        
        .btn-lg {
            padding: 10px 20px;
            font-size: 14px;
        }
        
        .d-flex.justify-content-between {
            flex-direction: column;
            gap: 15px;
        }
        
        .d-flex.justify-content-between > div {
            width: 100%;
            text-align: center;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add form validation feedback
    const formInputs = document.querySelectorAll('input, select, textarea');
    
    formInputs.forEach(input => {
        input.addEventListener('blur', function() {
            if (this.value.trim() === '' && this.hasAttribute('required')) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
            } else if (this.value.trim() !== '') {
                this.classList.add('is-valid');
                this.classList.remove('is-invalid');
            }
        });
        
        input.addEventListener('input', function() {
            if (this.classList.contains('is-invalid') && this.value.trim() !== '') {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        });
    });
    
    // Date picker enhancement
    const dateInputs = document.querySelectorAll('input[type="date"]');
    dateInputs.forEach(input => {
        if (!input.value) {
            const today = new Date().toISOString().split('T')[0];
            input.value = today;
        }
    });
});
</script>
{% endblock %}\n\n========== FILE: ./students/templates/students/student_list.html ==========\n
{% extends 'accounts/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-2">
                <i class="fas fa-user-graduate text-primary me-2"></i>Students Management
            </h1>
            <p class="text-muted mb-0">View, manage, and monitor all student records in the system</p>
        </div>
        <div>
            <a href="{% url 'student_create' %}" class="btn btn-primary">
                <i class="fas fa-user-plus me-2"></i>Add New Student
            </a>
            <div class="btn-group ms-2">
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-download me-2"></i>Export
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#"><i class="fas fa-file-excel me-2"></i>Excel</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-file-pdf me-2"></i>PDF</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-print me-2"></i>Print</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow-sm h-100 py-3">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-semibold text-primary mb-1">
                                Total Students
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ students.count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-primary opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow-sm h-100 py-3">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-semibold text-success mb-1">
                                Grades Represented
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">
                                {% with grades=students|dictsort:"grade"|slice:":5" %}{{ grades|length }}{% endwith %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-layer-group fa-2x text-success opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow-sm h-100 py-3">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-semibold text-info mb-1">
                                Active This Month
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">
                                {% now "d" %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-check fa-2x text-info opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow-sm h-100 py-3">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-semibold text-warning mb-1">
                                New This Week
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">
                                {% with recent=students|dictsortreversed:"created_at"|slice:":7" %}{{ recent|length }}{% endwith %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-plus fa-2x text-warning opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body p-3">
            <div class="row g-3">
                <div class="col-md-8">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control border-0" placeholder="Search students by name, admission number, or parent name..." 
                               id="studentSearch">
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-select border-0 bg-light" id="gradeFilter">
                        <option value="">All Grades</option>
                        <option value="1">Grade 1</option>
                        <option value="2">Grade 2</option>
                        <option value="3">Grade 3</option>
                        <option value="4">Grade 4</option>
                        <option value="5">Grade 5</option>
                        <option value="6">Grade 6</option>
                        <option value="7">Grade 7</option>
                        <option value="8">Grade 8</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select border-0 bg-light" id="sectionFilter">
                        <option value="">All Sections</option>
                        <option value="A">Section A</option>
                        <option value="B">Section B</option>
                        <option value="C">Section C</option>
                        <option value="D">Section D</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Students Table -->
    <div class="card shadow-lg border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="studentsTable">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4 py-3">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-id-card me-2 text-primary"></i>Admission No.
                                </div>
                            </th>
                            <th class="py-3">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-user me-2 text-primary"></i>Student Name
                                </div>
                            </th>
                            <th class="py-3">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-graduation-cap me-2 text-primary"></i>Grade
                                </div>
                            </th>
                            <th class="py-3">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-th-large me-2 text-primary"></i>Section
                                </div>
                            </th>
                            <th class="py-3">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-users me-2 text-primary"></i>Parent/Guardian
                                </div>
                            </th>
                            <th class="py-3">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-calendar-alt me-2 text-primary"></i>Joined
                                </div>
                            </th>
                            <th class="pe-4 py-3 text-center">
                                <i class="fas fa-cog text-primary"></i>Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in students %}
                        <tr class="student-row" 
                            data-grade="{{ student.grade }}" 
                            data-section="{{ student.section }}"
                            data-search="{{ student.admission_number }} {{ student.user.get_full_name }} {{ student.parent_name }}">
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="avatar-circle bg-primary bg-opacity-10 text-primary">
                                            <i class="fas fa-hashtag"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <strong class="text-primary">{{ student.admission_number }}</strong>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        {% if student.user.profile_picture %}
                                        <img src="{{ student.user.profile_picture.url }}" 
                                             alt="{{ student.user.get_full_name }}"
                                             class="rounded-circle"
                                             style="width: 40px; height: 40px; object-fit: cover;">
                                        {% else %}
                                        <div class="avatar-circle bg-secondary bg-opacity-10 text-secondary">
                                            {{ student.user.get_full_name|first|upper }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0">{{ student.user.get_full_name }}</h6>
                                        <small class="text-muted">{{ student.user.email|default:"No email" }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2">
                                    <i class="fas fa-graduation-cap me-1"></i>{{ student.grade }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-info bg-opacity-10 text-info px-3 py-2">
                                    Section {{ student.section }}
                                </span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-user-friends text-muted me-2"></i>
                                    <div>
                                        <div class="fw-medium">{{ student.parent_name|truncatechars:20 }}</div>
                                        <small class="text-muted">{{ student.parent_phone }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <small class="text-muted">{{ student.created_at|date:"M d, Y" }}</small>
                            </td>
                            <td class="pe-4 text-center">
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'student_detail' student.pk %}" 
                                       class="btn btn-outline-primary" 
                                       title="View Profile">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{% url 'student_update' student.pk %}" 
                                       class="btn btn-outline-warning" 
                                       title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" 
                                            class="btn btn-outline-info dropdown-toggle dropdown-toggle-split" 
                                            data-bs-toggle="dropdown">
                                        <span class="visually-hidden">More</span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="#">
                                            <i class="fas fa-file-invoice-dollar me-2"></i>Fee Statement
                                        </a></li>
                                        <li><a class="dropdown-item" href="#">
                                            <i class="fas fa-chart-line me-2"></i>Performance
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#">
                                            <i class="fas fa-user-slash me-2"></i>Deactivate
                                        </a></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <div class="py-4">
                                    <i class="fas fa-user-graduate fa-3x text-muted mb-3"></i>
                                    <h4 class="text-muted">No Students Found</h4>
                                    <p class="text-muted mb-4">Start by adding your first student to the system</p>
                                    <a href="{% url 'student_create' %}" class="btn btn-primary px-4">
                                        <i class="fas fa-user-plus me-2"></i>Add First Student
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Table Footer -->
        {% if students %}
        <div class="card-footer bg-light border-0">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <small class="text-muted">Showing {{ students.count }} of {{ students.count }} students</small>
                </div>
                <div>
                    <nav aria-label="Page navigation">
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">Previous</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
    .border-left-primary {
        border-left: 4px solid #4e73df !important;
    }
    
    .border-left-success {
        border-left: 4px solid #1cc88a !important;
    }
    
    .border-left-info {
        border-left: 4px solid #36b9cc !important;
    }
    
    .border-left-warning {
        border-left: 4px solid #f6c23e !important;
    }
    
    .avatar-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
    }
    
    .card {
        border-radius: 15px;
        overflow: hidden;
    }
    
    .table thead th {
        border-bottom: 2px solid #e2e8f0;
        font-weight: 600;
        color: #2d3748;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }
    
    .table tbody tr {
        transition: all 0.2s ease;
    }
    
    .table tbody tr:hover {
        background-color: rgba(102, 126, 234, 0.05);
        transform: scale(1.002);
    }
    
    .btn-group .btn {
        border-radius: 8px !important;
    }
    
    .btn-group .dropdown-toggle-split {
        border-radius: 0 8px 8px 0 !important;
    }
    
    .dropdown-menu {
        border-radius: 10px;
        border: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .badge {
        border-radius: 8px;
        font-weight: 500;
        padding: 6px 12px;
    }
    
    .input-group-text {
        background-color: transparent;
    }
    
    .form-select, .form-control {
        border-radius: 10px;
    }
    
    .pagination .page-link {
        border-radius: 8px;
        margin: 0 2px;
        border: none;
        color: #667eea;
    }
    
    .pagination .page-item.active .page-link {
        background-color: #667eea;
        border-color: #667eea;
    }
    
    @media (max-width: 768px) {
        .btn-group {
            flex-direction: column;
        }
        
        .btn-group .btn {
            margin-bottom: 2px;
            border-radius: 8px !important;
        }
        
        .btn-group .dropdown-toggle-split {
            width: 100%;
            border-radius: 8px !important;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.getElementById('studentSearch');
    const gradeFilter = document.getElementById('gradeFilter');
    const sectionFilter = document.getElementById('sectionFilter');
    const studentRows = document.querySelectorAll('.student-row');
    
    function filterStudents() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedGrade = gradeFilter.value;
        const selectedSection = sectionFilter.value;
        
        studentRows.forEach(row => {
            const rowText = row.getAttribute('data-search').toLowerCase();
            const rowGrade = row.getAttribute('data-grade');
            const rowSection = row.getAttribute('data-section');
            
            const matchesSearch = rowText.includes(searchTerm);
            const matchesGrade = !selectedGrade || rowGrade === selectedGrade;
            const matchesSection = !selectedSection || rowSection === selectedSection;
            
            if (matchesSearch && matchesGrade && matchesSection) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    searchInput.addEventListener('input', filterStudents);
    gradeFilter.addEventListener('change', filterStudents);
    sectionFilter.addEventListener('change', filterStudents);
    
    // Initialize tooltips for action buttons
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}\n\n========== FILE: ./students/tests.py ==========\n
from django.test import TestCase

# Create your tests here.
\n\n========== FILE: ./students/urls.py ==========\n
from django.urls import path
from . import views

urlpatterns = [
    path('', views.student_list, name='student_list'),
    path('profile/', views.student_profile, name='student_profile'),
    path('create/', views.student_create, name='student_create'),
    path('<int:pk>/', views.student_detail, name='student_detail'),
    path('<int:pk>/update/', views.student_update, name='student_update'),
    # ADD THIS: For teachers to view their students' passwords
    path('teacher-view/', views.teacher_student_list, name='teacher_student_list'),
]\n\n========== FILE: ./students/views.py ==========\n
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required, user_passes_test
from django.contrib import messages
from .models import Student
from .forms import StudentForm
from accounts.models import User
from teachers.models import Teacher

def is_admin(user):
    return user.is_authenticated and user.is_admin()

def is_teacher(user):
    return user.is_authenticated and user.is_teacher()

@login_required
@user_passes_test(is_admin)
def student_list(request):
    students = Student.objects.all()
    return render(request, 'students/student_list.html', {'students': students})

@login_required
@user_passes_test(is_admin)
def student_detail(request, pk):
    student = get_object_or_404(Student, pk=pk)
    return render(request, 'students/student_detail.html', {'student': student})

@login_required
@user_passes_test(is_admin)
def student_create(request):
    if request.method == 'POST':
        form = StudentForm(request.POST, request.FILES)
        if form.is_valid():
            student = form.save()  # Now returns only student
            messages.success(request, f'Student {student.user.get_full_name()} created successfully!')
            
            # Store generated password in session (it's in student.generated_password)
            if hasattr(student, 'generated_password'):
                messages.info(request, f'Generated password: {student.generated_password}')
                
            return redirect('student_list')
    else:
        form = StudentForm()
    return render(request, 'students/student_form.html', {'form': form, 'title': 'Add Student'})

@login_required
@user_passes_test(is_admin)
def student_update(request, pk):
    student = get_object_or_404(Student, pk=pk)
    if request.method == 'POST':
        form = StudentForm(request.POST, request.FILES, instance=student)
        if form.is_valid():
            form.save()
            messages.success(request, f'Student {student.user.get_full_name()} updated successfully!')
            return redirect('student_list')
    else:
        form = StudentForm(instance=student)
    return render(request, 'students/student_form.html', {'form': form, 'title': 'Update Student'})

@login_required
def student_profile(request):
    try:
        student = Student.objects.get(user=request.user)
        return render(request, 'students/student_detail.html', {'student': student})
    except Student.DoesNotExist:
        messages.error(request, 'Student profile not found.')
        return redirect('dashboard')

@login_required
@user_passes_test(is_teacher)
def teacher_student_list(request):
    """View for teachers to see their students with passwords"""
    if not request.user.is_teacher():
        messages.error(request, 'Access denied.')
        return redirect('dashboard')
    
    try:
        teacher = Teacher.objects.get(user=request.user)
        
        # Get students based on teacher's assigned classes
        assigned_students = teacher.get_assigned_students()
        
        return render(request, 'teachers/student_list_with_passwords.html', {
            'teacher': teacher,
            'students': assigned_students
        })
    except Teacher.DoesNotExist:
        messages.error(request, 'Teacher profile not found.')
        return redirect('dashboard')\n\n========== FILE: ./students/__init__.py ==========\n
\n\n========== FILE: ./teachers/admin.py ==========\n
from django.contrib import admin
from django import forms
from django.utils.html import format_html
from django.utils.translation import gettext_lazy as _
from unfold.admin import ModelAdmin
from .models import Teacher
from accounts.models import User

class TeacherCreationForm(forms.ModelForm):
    """Form for creating teachers with user account creation"""
    username = forms.CharField(
        max_length=150, 
        required=True,
        help_text="Required. 150 characters or fewer."
    )
    email = forms.EmailField(
        required=True,
        help_text="Required. Teacher's email address."
    )
    password1 = forms.CharField(
        label="Password",
        widget=forms.PasswordInput,
        help_text="Enter a secure password for the teacher's account."
    )
    password2 = forms.CharField(
        label="Password confirmation",
        widget=forms.PasswordInput,
        help_text="Enter the same password as above, for verification."
    )
    
    class Meta:
        model = Teacher
        fields = '__all__'
        exclude = ('user',)
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # Remove user field from form as we'll create it programmatically
        if 'user' in self.fields:
            del self.fields['user']
    
    def clean_password2(self):
        password1 = self.cleaned_data.get("password1")
        password2 = self.cleaned_data.get("password2")
        if password1 and password2 and password1 != password2:
            raise forms.ValidationError("Passwords don't match")
        return password2
    
    def clean_username(self):
        username = self.cleaned_data.get('username')
        if User.objects.filter(username=username).exists():
            raise forms.ValidationError("A user with that username already exists.")
        return username
    
    def clean_email(self):
        email = self.cleaned_data.get('email')
        if email and User.objects.filter(email=email).exists():
            raise forms.ValidationError("A user with that email already exists.")
        return email
    
    def clean_employee_id(self):
        employee_id = self.cleaned_data.get('employee_id')
        if Teacher.objects.filter(employee_id=employee_id).exists():
            raise forms.ValidationError("A teacher with this employee ID already exists.")
        return employee_id
    
    def save(self, commit=True):
        # Create User first
        user_data = {
            'username': self.cleaned_data['username'],
            'email': self.cleaned_data['email'],
            'password': self.cleaned_data['password1'],
            'role': 'teacher',
            'is_active': True,
            'is_staff': True  # Teachers typically have staff access
        }
        
        user = User.objects.create_user(
            username=user_data['username'],
            email=user_data['email'],
            password=user_data['password'],
            role=user_data['role']
        )
        user.is_active = user_data['is_active']
        user.is_staff = user_data['is_staff']
        user.save()
        
        # Create Teacher with the user
        teacher = super().save(commit=False)
        teacher.user = user
        
        if commit:
            teacher.save()
            # Save many-to-many relationships if any
            self.save_m2m()
        
        return teacher

@admin.register(Teacher)
class TeacherAdmin(ModelAdmin):
    form = forms.ModelForm  # Use regular form for editing
    add_form = TeacherCreationForm  # Use custom form for adding
    
    list_display = ('employee_id', 'teacher_name', 'department', 'qualification', 'experience')
    list_filter = ('department', 'created_at')
    search_fields = ('employee_id', 'user__username', 'user__first_name', 'user__last_name', 'subjects', 'department')
    ordering = ('department', 'employee_id')
    readonly_fields = ('created_at', 'updated_at', 'teacher_user_info')
    filter_horizontal = ('assigned_subjects',)
    
    fieldsets = (
        (_('User Account'), {
            'fields': ('teacher_user_info',)
        }),
        (_('Employment Information'), {
            'fields': ('employee_id', 'department', 'qualification', 'experience', 'specialization'),
            'description': _('Professional information about the teacher.')
        }),
        (_('Teaching Information'), {
            'fields': ('subjects', 'classes', 'assigned_subjects'),
            'description': _('Subjects and classes taught by this teacher.')
        }),
        (_('Additional Roles'), {
            'fields': ('extra_roles', 'extracurricular_activities'),
            'description': _('Additional responsibilities and activities.')
        }),
        (_('Contact Information'), {
            'fields': ('phone', 'office_room')
        }),
        (_('Metadata'), {
            'fields': ('created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )
    
    add_fieldsets = (
        (_('User Account Creation'), {
            'fields': ('username', 'email', 'password1', 'password2'),
            'description': _('Create a user account for the teacher first.')
        }),
        (_('Employment Information'), {
            'fields': ('employee_id', 'department', 'qualification', 'experience', 'specialization')
        }),
        (_('Teaching Information'), {
            'fields': ('subjects', 'classes', 'assigned_subjects')
        }),
        (_('Additional Roles'), {
            'fields': ('extra_roles', 'extracurricular_activities')
        }),
        (_('Contact Information'), {
            'fields': ('phone', 'office_room')
        }),
    )
    
    @admin.display(description='Teacher Name')
    def teacher_name(self, obj):
        if obj.user:
            full_name = obj.user.get_full_name()
            if full_name:
                return format_html('<strong>{}</strong>', full_name)
            return format_html('<strong>{}</strong>', obj.user.username)
        return format_html('<span style="color: red;">No User</span>')
    
    @admin.display(description='User Account')
    def teacher_user_info(self, obj):
        if obj.user:
            status_color = 'green' if obj.user.is_active else 'red'
            status_text = 'Active' if obj.user.is_active else 'Inactive'
            staff_badge = '<span class="badge bg-info">Staff</span>' if obj.user.is_staff else ''
            
            return format_html(
                '<div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">'
                '<h4 style="margin-top: 0;">User Account Information</h4>'
                '<table style="width: 100%;">'
                '<tr><td style="width: 30%;"><strong>Username:</strong></td><td>{}</td></tr>'
                '<tr><td><strong>Email:</strong></td><td>{}</td></tr>'
                '<tr><td><strong>Role:</strong></td><td><span class="badge bg-primary">{}</span> {}</td></tr>'
                '<tr><td><strong>Status:</strong></td><td><span style="color: {};">â— {}</span></td></tr>'
                '<tr><td><strong>Staff Access:</strong></td><td>{}</td></tr>'
                '<tr><td><strong>Last Login:</strong></td><td>{}</td></tr>'
                '</table>'
                '</div>',
                obj.user.username,
                obj.user.email if obj.user.email else '<em>Not set</em>',
                obj.user.get_role_display(),
                staff_badge,
                status_color,
                status_text,
                'Yes' if obj.user.is_staff else 'No',
                obj.user.last_login.strftime('%Y-%m-%d %H:%M') if obj.user.last_login else 'Never'
            )
        return format_html(
            '<div style="background-color: #fff3cd; padding: 15px; border-radius: 5px; border: 1px solid #ffeaa7;">'
            '<strong style="color: #856404;">âš  No user account linked!</strong><br>'
            'This teacher profile is not linked to any user account.'
            '</div>'
        )
    
    def get_form(self, request, obj=None, **kwargs):
        """
        Use special form for adding, but not for changing.
        """
        defaults = {}
        if obj is None:  # Adding a new object
            defaults['form'] = self.add_form
        else:  # Editing an existing object
            defaults['form'] = self.form
        
        defaults.update(kwargs)
        return super().get_form(request, obj, **defaults)
    
    def get_fieldsets(self, request, obj=None):
        if obj is None:  # Adding new
            return self.add_fieldsets
        return super().get_fieldsets(request, obj)
    
    def get_readonly_fields(self, request, obj=None):
        if obj:  # Editing an existing object
            return self.readonly_fields + ('employee_id',)
        return self.readonly_fields
    
    def save_model(self, request, obj, form, change):
        """Handle saving of teacher model"""
        if not change:  # Creating new
            # Form already handles user creation
            pass
        super().save_model(request, obj, form, change)
    
    # Custom methods for teacher
    def get_subjects_list(self, obj):
        """Display subjects as list"""
        return obj.get_subjects_list()
    get_subjects_list.short_description = 'Subjects'
    
    def get_classes_list(self, obj):
        """Display classes as list"""
        return obj.get_classes_list()
    get_classes_list.short_description = 'Classes'
    
    list_per_page = 25
    date_hierarchy = 'created_at'
    empty_value_display = '---'
    
    # Add custom actions
    actions = ['activate_teachers', 'deactivate_teachers', 'grant_staff_access', 'revoke_staff_access']
    
    @admin.action(description='Activate selected teachers')
    def activate_teachers(self, request, queryset):
        activated = 0
        for teacher in queryset:
            if teacher.user:
                teacher.user.is_active = True
                teacher.user.save()
                activated += 1
        self.message_user(request, f'{activated} teachers were activated.')
    
    @admin.action(description='Deactivate selected teachers')
    def deactivate_teachers(self, request, queryset):
        deactivated = 0
        for teacher in queryset:
            if teacher.user:
                teacher.user.is_active = False
                teacher.user.save()
                deactivated += 1
        self.message_user(request, f'{deactivated} teachers were deactivated.')
    
    @admin.action(description='Grant staff access to selected teachers')
    def grant_staff_access(self, request, queryset):
        granted = 0
        for teacher in queryset:
            if teacher.user:
                teacher.user.is_staff = True
                teacher.user.save()
                granted += 1
        self.message_user(request, f'{granted} teachers were granted staff access.')
    
    @admin.action(description='Revoke staff access from selected teachers')
    def revoke_staff_access(self, request, queryset):
        revoked = 0
        for teacher in queryset:
            if teacher.user:
                teacher.user.is_staff = False
                teacher.user.save()
                revoked += 1
        self.message_user(request, f'{revoked} teachers had staff access revoked.')\n\n========== FILE: ./teachers/apps.py ==========\n
from django.apps import AppConfig

class TeachersConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'teachers'\n\n========== FILE: ./teachers/forms.py ==========\n
from django import forms
from .models import Teacher
from accounts.models import User
from marks.models import Subject

class TeacherForm(forms.ModelForm):
    username = forms.CharField(max_length=150, required=True)
    email = forms.EmailField(required=True)
    first_name = forms.CharField(max_length=30, required=True)
    last_name = forms.CharField(max_length=150, required=True)
    password = forms.CharField(widget=forms.PasswordInput, required=True)
    
    teacher_role = forms.ChoiceField(
        choices=User.TEACHER_ROLE_CHOICES,
        required=True,
        initial='teacher'
    )
    
    class Meta:
        model = Teacher
        fields = [
            'username', 'email', 'first_name', 'last_name', 'password',
            'teacher_role', 'employee_id', 'department', 'subjects', 'classes',
            'assigned_subjects', 'qualification', 'experience', 'specialization',
            'extra_roles', 'extracurricular_activities',
            'phone', 'office_room'
        ]
        widgets = {
            'assigned_subjects': forms.SelectMultiple(attrs={'class': 'form-control'}),
            'extra_roles': forms.Textarea(attrs={'rows': 3}),
            'extracurricular_activities': forms.Textarea(attrs={'rows': 3}),
        }
    
    def save(self, commit=True):
        # Create User first
        user_data = {
            'username': self.cleaned_data['username'],
            'email': self.cleaned_data['email'],
            'first_name': self.cleaned_data['first_name'],
            'last_name': self.cleaned_data['last_name'],
            'role': 'teacher',
            'teacher_role': self.cleaned_data['teacher_role'],
        }
        
        user = User.objects.create_user(
            username=user_data['username'],
            email=user_data['email'],
            password=self.cleaned_data['password'],
            first_name=user_data['first_name'],
            last_name=user_data['last_name'],
            role='teacher',
            teacher_role=user_data['teacher_role']
        )
        
        # Create Teacher
        teacher = super().save(commit=False)
        teacher.user = user
        
        if commit:
            teacher.save()
            self.save_m2m()
        
        return teacher\n\n========== FILE: ./teachers/models.py ==========\n
from django.db import models
from accounts.models import User
from students.models import Student

class Teacher(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name='teacher_profile')
    employee_id = models.CharField(max_length=20, unique=True)
    department = models.CharField(max_length=100)
    subjects = models.TextField(help_text="Subjects taught (comma-separated)")
    classes = models.TextField(help_text="Classes/Grades taught (comma-separated)")
    
    # Link to specific subjects from marks app - use string reference
    assigned_subjects = models.ManyToManyField('marks.Subject', blank=True, related_name='teachers')
    
    # Additional information
    qualification = models.CharField(max_length=200)
    experience = models.CharField(max_length=100)
    specialization = models.CharField(max_length=200, blank=True)
    
    # Extra roles and responsibilities
    extra_roles = models.TextField(blank=True, help_text="Additional roles and responsibilities")
    extracurricular_activities = models.TextField(blank=True, help_text="Extracurricular activities supervised")
    
    # Contact information
    phone = models.CharField(max_length=15)
    office_room = models.CharField(max_length=20, blank=True)
    
    # ADDED: Store initial password for admin viewing
    initial_password = models.CharField(max_length=128, blank=True, null=True, editable=False)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self):
        return f"{self.user.get_full_name()} - {self.employee_id}"
    
    def get_subjects_list(self):
        return [s.strip() for s in self.subjects.split(',')]
    
    def get_classes_list(self):
        return [c.strip() for c in self.classes.split(',')]
    
    def get_assigned_students(self):
        # Get students based on teacher's classes
        assigned_students = []
        for class_name in self.get_classes_list():
            students = Student.objects.filter(grade=class_name)
            assigned_students.extend(students)
        return assigned_students
    
    def save(self, *args, **kwargs):
        """
        Override save method to store initial password when teacher is first created.
        This password is for admin reference and teacher password viewing.
        """
        is_new = not self.pk
        
        # Call parent save first to ensure we have a PK
        super().save(*args, **kwargs)
        
        # Store initial password for new teachers
        if is_new and not self.initial_password and self.user:
            # Generate a simple password pattern for reference
            # Format: teach{first_3_of_emp_id}{random_2_digits}@
            emp_prefix = self.employee_id[:3].lower() if len(self.employee_id) >= 3 else 'tea'
            import random
            random_digits = str(random.randint(10, 99))
            self.initial_password = f"teach{emp_prefix}{random_digits}@"
            
            # Save again with the initial password
            super().save(update_fields=['initial_password'])
    
    class Meta:
        ordering = ['department', 'employee_id']\n\n========== FILE: ./teachers/templates/teachers/student_list_with_passwords.html ==========\n
{% extends 'accounts/base.html' %}

{% block title %}My Students - Passwords{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                <i class="fas fa-users"></i> My Students
                <small class="float-end">Total: {{ students|length }}</small>
            </h4>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                As a teacher of these classes/subjects, you can view student passwords for login assistance.
            </div>
            
            {% if students %}
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Admission No.</th>
                            <th>Student Name</th>
                            <th>Class</th>
                            <th>Username</th>
                            <th>Password</th>
                            <th>Subjects</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in students %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td><strong>{{ student.admission_number }}</strong></td>
                            <td>{{ student.user.get_full_name }}</td>
                            <td>
                                <span class="badge bg-primary">{{ student.grade }}{{ student.section }}</span>
                            </td>
                            <td>
                                <code>{{ student.user.username }}</code>
                            </td>
                            <td>
                                <div class="input-group input-group-sm" style="width: 150px;">
                                    <input type="password" 
                                           value="********" 
                                           class="form-control password-field" 
                                           id="password_{{ student.id }}"
                                           data-password="{{ student.user.username|slice:":3" }}12345"
                                           readonly>
                                    <button class="btn btn-outline-secondary" 
                                            type="button"
                                            onclick="togglePassword('{{ student.id }}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Click eye icon to view</small>
                            </td>
                            <td>
                                {% if student.subjects %}
                                    {{ student.subjects|truncatewords:3 }}
                                {% else %}
                                    <span class="text-muted">Not assigned</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="alert alert-warning mt-3">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Note:</strong> These are auto-generated 8-character passwords. 
                For security reasons, they will be hidden after 5 seconds of being revealed.
            </div>
            {% else %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                No students are assigned to your classes/subjects.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function togglePassword(studentId) {
    const passwordField = document.getElementById('password_' + studentId);
    const icon = passwordField.nextElementSibling.querySelector('i');
    const actualPassword = passwordField.getAttribute('data-password');
    
    if (passwordField.type === 'password') {
        passwordField.type = 'text';
        passwordField.value = actualPassword;
        icon.className = 'fas fa-eye-slash';
    } else {
        passwordField.type = 'password';
        passwordField.value = '********';
        icon.className = 'fas fa-eye';
    }
}

// Auto-hide passwords after 5 seconds
document.addEventListener('DOMContentLoaded', function() {
    setInterval(function() {
        const visiblePasswords = document.querySelectorAll('input[type="text"].password-field');
        visiblePasswords.forEach(field => {
            field.type = 'password';
            field.value = '********';
            const icon = field.nextElementSibling.querySelector('i');
            if (icon) icon.className = 'fas fa-eye';
        });
    }, 5000);
});
</script>
{% endblock %}\n\n========== FILE: ./teachers/templates/teachers/teacher_detail.html ==========\n
{% extends 'accounts/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-2">
                <i class="fas fa-chalkboard-teacher text-primary me-2"></i>Teacher Profile
            </h1>
            <div class="d-flex align-items-center">
                <span class="badge bg-primary me-2">{{ teacher.department }}</span>
                <span class="badge bg-success">{{ teacher.employee_id }}</span>
                <span class="text-muted ms-3">
                    <i class="fas fa-calendar-alt me-1"></i>Joined {{ teacher.created_at|date:"F Y" }}
                </span>
            </div>
        </div>
        <div>
            {% if user.is_admin %}
            <div class="btn-group">
                <a href="{% url 'teacher_update' teacher.pk %}" class="btn btn-warning">
                    <i class="fas fa-edit me-2"></i>Edit Profile
                </a>
                <button type="button" class="btn btn-info dropdown-toggle dropdown-toggle-split" 
                        data-bs-toggle="dropdown">
                    <span class="visually-hidden">More Actions</span>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">
                        <i class="fas fa-print me-2"></i>Print Profile
                    </a></li>
                    <li><a class="dropdown-item" href="#">
                        <i class="fas fa-envelope me-2"></i>Send Message
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#">
                        <i class="fas fa-user-slash me-2"></i>Deactivate
                    </a></li>
                </ul>
            </div>
            {% endif %}
            <a href="{% url 'teacher_list' %}" class="btn btn-outline-secondary ms-2">
                <i class="fas fa-arrow-left me-2"></i>Back to List
            </a>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Personal Information Card -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h5 class="mb-0 text-white">
                        <i class="fas fa-user-circle me-2"></i>Personal Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center mb-4">
                        <div class="col-auto">
                            {% if teacher.user.profile_picture %}
                            <img src="{{ teacher.user.profile_picture.url }}" 
                                 alt="Profile Picture" 
                                 class="rounded-circle shadow"
                                 style="width: 120px; height: 120px; object-fit: cover; border: 4px solid white;">
                            {% else %}
                            <div class="rounded-circle d-flex align-items-center justify-content-center shadow"
                                 style="width: 120px; height: 120px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <span class="text-white h2">{{ teacher.user.get_full_name|first|upper }}</span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col">
                            <h3 class="mb-1">{{ teacher.user.get_full_name }}</h3>
                            <p class="text-muted mb-2">
                                <i class="fas fa-id-badge me-1"></i>{{ teacher.employee_id }}
                            </p>
                            <div class="d-flex flex-wrap gap-2">
                                <span class="badge bg-primary px-3 py-2">
                                    <i class="fas fa-building me-1"></i>{{ teacher.department }}
                                </span>
                                {% if teacher.office_room %}
                                <span class="badge bg-info px-3 py-2">
                                    <i class="fas fa-door-open me-1"></i>{{ teacher.office_room }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3 p-2 rounded" style="background-color: #f8f9fa;">
                                <div class="flex-shrink-0 me-3">
                                    <i class="fas fa-envelope text-primary fa-lg"></i>
                                </div>
                                <div>
                                    <small class="text-muted">Email</small>
                                    <div class="fw-medium">{{ teacher.user.email|default:"Not provided" }}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3 p-2 rounded" style="background-color: #f8f9fa;">
                                <div class="flex-shrink-0 me-3">
                                    <i class="fas fa-phone text-primary fa-lg"></i>
                                </div>
                                <div>
                                    <small class="text-muted">Phone</small>
                                    <div class="fw-medium">{{ teacher.phone|default:"Not provided" }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Teaching Information Card -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <h5 class="mb-0 text-white">
                        <i class="fas fa-book-open me-2"></i>Teaching Information
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Subjects -->
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="fas fa-book me-2 text-primary"></i>Subjects Taught
                        </h6>
                        {% if teacher.subjects %}
                        <div class="d-flex flex-wrap gap-2">
                            {% for subject in teacher.subjects.split %}
                            <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2">
                                <i class="fas fa-book me-1"></i>{{ subject|title }}
                            </span>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>No subjects assigned.
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Classes -->
                    <div>
                        <h6 class="mb-3">
                            <i class="fas fa-graduation-cap me-2 text-success"></i>Classes/Grades Taught
                        </h6>
                        {% if teacher.classes %}
                        <div class="d-flex flex-wrap gap-2">
                            {% for class_name in teacher.classes.split %}
                            <span class="badge bg-success bg-opacity-10 text-success px-3 py-2">
                                <i class="fas fa-users me-1"></i>{{ class_name|title }}
                            </span>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>No classes assigned.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Role and Responsibilities Card -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <h5 class="mb-0 text-white">
                        <i class="fas fa-user-tie me-2"></i>Role & Responsibilities
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Official Role -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="flex-shrink-0 me-3">
                                <div class="rounded-circle d-flex align-items-center justify-content-center"
                                     style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    <i class="fas fa-award text-white"></i>
                                </div>
                            </div>
                            <div>
                                <h6 class="mb-1">Official Role</h6>
                                <span class="badge bg-primary px-3 py-2">{{ teacher.user.get_teacher_role_display_name }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Roles -->
                    {% if teacher.extra_roles %}
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="fas fa-tasks me-2 text-warning"></i>Additional Roles
                        </h6>
                        <div class="p-3 rounded" style="background-color: #f8f9fa;">
                            {{ teacher.extra_roles|linebreaks }}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Extracurricular Activities -->
                    {% if teacher.extracurricular_activities %}
                    <div>
                        <h6 class="mb-3">
                            <i class="fas fa-running me-2 text-success"></i>Extracurricular Activities
                        </h6>
                        <div class="p-3 rounded" style="background-color: #f8f9fa;">
                            {{ teacher.extracurricular_activities|linebreaks }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Professional Information Card -->
            <div class="card shadow-lg border-0">
                <div class="card-header" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <h5 class="mb-0 text-white">
                        <i class="fas fa-graduation-cap me-2"></i>Professional Information
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Qualification -->
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="fas fa-certificate me-2 text-primary"></i>Qualification
                        </h6>
                        <div class="p-3 rounded" style="background-color: #f8f9fa;">
                            {{ teacher.qualification|default:"Not specified"|linebreaks }}
                        </div>
                    </div>
                    
                    <!-- Experience -->
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="fas fa-briefcase me-2 text-info"></i>Experience
                        </h6>
                        <div class="p-3 rounded" style="background-color: #f8f9fa;">
                            {{ teacher.experience|default:"Not specified"|linebreaks }}
                        </div>
                    </div>
                    
                    <!-- Specialization -->
                    <div>
                        <h6 class="mb-3">
                            <i class="fas fa-star me-2 text-warning"></i>Specialization
                        </h6>
                        <div class="p-3 rounded" style="background-color: #f8f9fa;">
                            {{ teacher.specialization|default:"Not specified"|linebreaks }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Assigned Subjects Section -->
    {% if teacher.assigned_subjects.exists %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-lg border-0">
                <div class="card-header" style="background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);">
                    <h5 class="mb-0 text-white">
                        <i class="fas fa-clipboard-list me-2"></i>Assigned Subjects (From Marks System)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for subject in teacher.assigned_subjects.all %}
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="p-3 rounded border" style="background-color: #f8f9fa;">
                                <h6 class="mb-1">{{ subject.name }}</h6>
                                <small class="text-muted">Code: {{ subject.subject_code }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Action Buttons -->
    {% if user.is_admin %}
    <div class="mt-4 pt-4 border-top">
        <div class="d-flex justify-content-center gap-3">
            <a href="{% url 'teacher_update' teacher.pk %}" class="btn btn-warning px-4">
                <i class="fas fa-edit me-2"></i>Edit Teacher Information
            </a>
            <a href="{% url 'teacher_list' %}" class="btn btn-outline-secondary px-4">
                <i class="fas fa-list me-2"></i>View All Teachers
            </a>
            <button class="btn btn-outline-primary px-4">
                <i class="fas fa-file-pdf me-2"></i>Generate Report
            </button>
        </div>
    </div>
    {% endif %}
</div>

<style>
    .card {
        border-radius: 15px;
        overflow: hidden;
        transition: transform 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-5px);
    }
    
    .card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: none;
    }
    
    .badge {
        border-radius: 10px;
        font-weight: 500;
    }
    
    .btn-group .btn {
        border-radius: 10px;
    }
    
    .dropdown-menu {
        border-radius: 10px;
        border: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    /* Gradient backgrounds for info cards */
    .gradient-1 {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .gradient-2 {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    .gradient-3 {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .btn-group {
            flex-direction: column;
            width: 100%;
        }
        
        .btn-group .btn {
            margin-bottom: 5px;
            width: 100%;
        }
        
        .dropdown-toggle-split {
            width: 100%;
        }
        
        .d-flex.justify-content-center {
            flex-direction: column;
            gap: 10px;
        }
        
        .d-flex.justify-content-center > * {
            width: 100%;
        }
    }
</style>
{% endblock %}\n\n========== FILE: ./teachers/templates/teachers/teacher_form.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<div class="teacher-form-container">
    <div class="form-header">
        <h2>{{ title }} Teacher</h2>
        <p class="form-subtitle">Fill in the details below to {{ title|lower }} a teacher</p>
    </div>

    <form method="post" enctype="multipart/form-data" class="teacher-form">
        {% csrf_token %}
        
        <div class="form-section">
            <div class="section-header">
                <div class="section-icon">ðŸ‘¤</div>
                <h3>Account Information</h3>
            </div>
            
            <div class="form-grid">
                {% for field in form %}
                    {% if field.name in 'username,email,first_name,last_name,password' %}
                    <div class="form-group">
                        <label for="{{ field.id_for_label }}" class="form-label">
                            {{ field.label }}
                            {% if field.field.required %}
                                <span class="required-indicator">*</span>
                            {% endif %}
                        </label>
                        {{ field }}
                        {% if field.errors %}
                            <div class="error-message">
                                {{ field.errors }}
                            </div>
                        {% endif %}
                        {% if field.help_text %}
                            <div class="help-text">{{ field.help_text }}</div>
                        {% endif %}
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="form-section">
            <div class="section-header">
                <div class="section-icon">ðŸ«</div>
                <h3>Teacher Information</h3>
            </div>
            
            <div class="form-grid">
                {% for field in form %}
                    {% if field.name not in 'username,email,first_name,last_name,password' %}
                    <div class="form-group">
                        <label for="{{ field.id_for_label }}" class="form-label">
                            {{ field.label }}
                            {% if field.field.required %}
                                <span class="required-indicator">*</span>
                            {% endif %}
                        </label>
                        {{ field }}
                        {% if field.errors %}
                            <div class="error-message">
                                {{ field.errors }}
                            </div>
                        {% endif %}
                        {% if field.help_text %}
                            <div class="help-text">{{ field.help_text }}</div>
                        {% endif %}
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-submit">
                <span class="btn-icon">ðŸ’¾</span> Save Teacher
            </button>
            <a href="{% url 'teacher_list' %}" class="btn-cancel">
                <span class="btn-icon">â†</span> Cancel
            </a>
        </div>
    </form>
</div>

<style>
    .teacher-form-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 30px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    }

    .form-header {
        margin-bottom: 40px;
        text-align: center;
    }

    .form-header h2 {
        color: #1e0464;
        font-size: 32px;
        font-weight: 700;
        margin: 0 0 8px 0;
        background: linear-gradient(135deg, #4CAF50, #2196F3);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .form-subtitle {
        color: #6c757d;
        font-size: 16px;
        margin: 0;
    }

    .teacher-form {
        background: white;
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        border: 1px solid #e9ecef;
    }

    .form-section {
        margin-bottom: 40px;
        padding-bottom: 30px;
        border-bottom: 2px solid #f1f5f9;
    }

    .form-section:last-of-type {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 25px;
    }

    .section-icon {
        font-size: 24px;
        background: linear-gradient(135deg, #4CAF50, #2196F3);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .section-header h3 {
        color: #2d3748;
        font-size: 20px;
        font-weight: 600;
        margin: 0;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 24px;
    }

    .form-group {
        position: relative;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #4a5568;
        font-size: 14px;
    }

    .required-indicator {
        color: #e53e3e;
        margin-left: 2px;
    }

    .teacher-form input[type="text"],
    .teacher-form input[type="email"],
    .teacher-form input[type="password"],
    .teacher-form textarea,
    .teacher-form select {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 15px;
        transition: all 0.3s ease;
        background: white;
        color: #2d3748;
        font-family: inherit;
    }

    .teacher-form input:focus,
    .teacher-form textarea:focus,
    .teacher-form select:focus {
        outline: none;
        border-color: #4CAF50;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }

    .teacher-form input:hover,
    .teacher-form textarea:hover,
    .teacher-form select:hover {
        border-color: #cbd5e0;
    }

    .teacher-form textarea {
        min-height: 100px;
        resize: vertical;
        line-height: 1.5;
    }

    .error-message {
        color: #e53e3e;
        font-size: 13px;
        margin-top: 6px;
        padding-left: 4px;
        animation: fadeIn 0.3s ease;
    }

    .help-text {
        color: #718096;
        font-size: 13px;
        margin-top: 6px;
        padding-left: 4px;
        line-height: 1.4;
    }

    .form-actions {
        display: flex;
        gap: 16px;
        margin-top: 40px;
        padding-top: 30px;
        border-top: 2px solid #f1f5f9;
        flex-wrap: wrap;
    }

    .btn-submit {
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
        border: none;
        padding: 16px 28px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
    }

    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(76, 175, 80, 0.3);
    }

    .btn-submit:active {
        transform: translateY(0);
    }

    .btn-cancel {
        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        color: white;
        padding: 16px 28px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.2);
    }

    .btn-cancel:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(108, 117, 125, 0.3);
        color: white;
        text-decoration: none;
    }

    .btn-icon {
        font-size: 16px;
    }

    /* Checkbox and radio button styling */
    .teacher-form input[type="checkbox"],
    .teacher-form input[type="radio"] {
        margin-right: 8px;
        transform: scale(1.2);
    }

    /* File input styling */
    .teacher-form input[type="file"] {
        padding: 12px;
        border: 2px dashed #cbd5e0;
        border-radius: 10px;
        background: #cffcf9;
        width: 100%;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .teacher-form input[type="file"]:hover {
        border-color: #4CAF50;
        background: #9ffaee;
    }

    /* Animation for error messages */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-5px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .teacher-form-container {
            padding: 20px;
        }

        .teacher-form {
            padding: 25px;
        }

        .form-header h2 {
            font-size: 26px;
        }

        .form-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .form-actions {
            flex-direction: column;
        }

        .btn-submit,
        .btn-cancel {
            width: 100%;
            justify-content: center;
        }
    }

    @media (max-width: 480px) {
        .teacher-form-container {
            padding: 15px;
        }

        .teacher-form {
            padding: 20px;
        }

        .form-header h2 {
            font-size: 22px;
        }

        .section-header h3 {
            font-size: 18px;
        }
    }
</style>
{% endblock %}\n\n========== FILE: ./teachers/templates/teachers/teacher_list.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<div class="teachers-container">
    <div class="teachers-header">
        <h2>Teachers List</h2>
        <a href="{% url 'teacher_create' %}" class="btn-add-teacher">
            <span class="btn-icon">+</span> Add New Teacher
        </a>
    </div>

    <div class="table-responsive">
        <table class="teachers-table">
            <thead>
                <tr>
                    <th>Employee ID</th>
                    <th>Name</th>
                    <th>Department</th>
                    <th>Subjects</th>
                    <th>Classes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for teacher in teachers %}
                <tr>
                    <td><span class="employee-id">{{ teacher.employee_id }}</span></td>
                    <td class="teacher-name">{{ teacher.user.get_full_name }}</td>
                    <td><span class="department-badge">{{ teacher.department }}</span></td>
                    <td class="subjects-cell">{{ teacher.subjects|truncatechars:50 }}</td>
                    <td><span class="classes-info">{{ teacher.classes }}</span></td>
                    <td class="actions-cell">
                        <a href="{% url 'teacher_detail' teacher.pk %}" class="btn-view">
                            <span class="btn-icon">ðŸ‘</span> View
                        </a>
                        <a href="{% url 'teacher_update' teacher.pk %}" class="btn-edit">
                            <span class="btn-icon">âœï¸</span> Edit
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="no-teachers">
                        <div class="empty-state">
                            <div class="empty-icon">ðŸ‘¨â€ðŸ«</div>
                            <h3>No teachers found</h3>
                            <p>Get started by adding your first teacher</p>
                            <a href="{% url 'teacher_create' %}" class="btn-add-teacher empty-btn">
                                <span class="btn-icon">+</span> Add New Teacher
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
    .teachers-container {
        padding: 24px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
    }

    .teachers-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 28px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .teachers-header h2 {
        color: #2c3e50;
        font-size: 28px;
        font-weight: 600;
        margin: 0;
    }

    .btn-add-teacher {
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
        padding: 12px 20px;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
    }

    .btn-add-teacher:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        text-decoration: none;
        color: white;
    }

    .btn-icon {
        font-size: 16px;
    }

    .table-responsive {
        overflow-x: auto;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        background: white;
    }

    .teachers-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: white;
    }

    .teachers-table thead {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    .teachers-table th {
        padding: 18px 16px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }

    .teachers-table tbody tr {
        transition: all 0.2s ease;
        border-bottom: 1px solid #eef2f7;
    }

    .teachers-table tbody tr:hover {
        background-color: #f8fafc;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .teachers-table td {
        padding: 16px;
        color: #4a5568;
        border-bottom: 1px solid #eef2f7;
    }

    .employee-id {
        background-color: #e8f4fd;
        color: #0366d6;
        padding: 4px 10px;
        border-radius: 12px;
        font-family: 'Courier New', monospace;
        font-weight: 500;
        font-size: 13px;
    }

    .teacher-name {
        font-weight: 500;
        color: #2d3748;
    }

    .department-badge {
        background-color: #e6f7e9;
        color: #2e7d32;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 500;
        display: inline-block;
    }

    .subjects-cell {
        max-width: 250px;
        line-height: 1.5;
    }

    .classes-info {
        background-color: #f3f4f6;
        color: #374151;
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 13px;
    }

    .actions-cell {
        white-space: nowrap;
    }

    .actions-cell a {
        text-decoration: none;
        padding: 6px 14px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 13px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
        margin-right: 8px;
    }

    .btn-view {
        background-color: #2196F3;
        color: white;
    }

    .btn-view:hover {
        background-color: #0b7dda;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(33, 150, 243, 0.2);
    }

    .btn-edit {
        background-color: #FF9800;
        color: white;
    }

    .btn-edit:hover {
        background-color: #e68900;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(255, 152, 0, 0.2);
    }

    .no-teachers {
        padding: 60px 20px !important;
        text-align: center;
        border: none !important;
    }

    .empty-state {
        max-width: 400px;
        margin: 0 auto;
    }

    .empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.7;
    }

    .empty-state h3 {
        color: #4a5568;
        margin: 0 0 8px 0;
        font-weight: 600;
    }

    .empty-state p {
        color: #718096;
        margin-bottom: 24px;
    }

    .empty-btn {
        margin-top: 16px;
    }

    @media (max-width: 768px) {
        .teachers-container {
            padding: 16px;
        }
        
        .teachers-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .teachers-header h2 {
            font-size: 24px;
        }
        
        .teachers-table th,
        .teachers-table td {
            padding: 12px 8px;
        }
        
        .actions-cell {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .actions-cell a {
            margin-right: 0;
            justify-content: center;
        }
    }
</style>
{% endblock %}\n\n========== FILE: ./teachers/templates/teachers/teacher_passwords.html ==========\n
{% extends 'accounts/base.html' %}

{% block title %}Teacher Passwords - Admin{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-danger text-white">
            <h4 class="mb-0">
                <i class="fas fa-key"></i> Teacher Passwords (Admin View)
                <small class="float-end">Total: {{ teachers|length }}</small>
            </h4>
        </div>
        <div class="card-body">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Admin Only:</strong> This page displays teacher login credentials.
                Keep this information secure.
            </div>
            
            {% if teachers %}
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Employee ID</th>
                            <th>Teacher Name</th>
                            <th>Department</th>
                            <th>Username</th>
                            <th>Password</th>
                            <th>Email</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for teacher_data in teachers %}
                        {% with teacher=teacher_data.teacher %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td><strong>{{ teacher.employee_id }}</strong></td>
                            <td>{{ teacher.user.get_full_name }}</td>
                            <td>{{ teacher.department }}</td>
                            <td>
                                <code>{{ teacher_data.username }}</code>
                            </td>
                            <td>
                                <div class="input-group input-group-sm" style="width: 150px;">
                                    <input type="password" 
                                           value="{{ teacher_data.password_display }}" 
                                           class="form-control password-field" 
                                           id="password_{{ teacher.id }}"
                                           data-password="teacher{{ teacher.employee_id|slice:":3" }}"
                                           readonly>
                                    <button class="btn btn-outline-secondary" 
                                            type="button"
                                            onclick="togglePassword('{{ teacher.id }}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="text-muted">8-character auto-generated</small>
                            </td>
                            <td>{{ teacher_data.email|default:"Not set" }}</td>
                        </tr>
                        {% endwith %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="mt-3">
                <a href="{% url 'teacher_list' %}" class="btn btn-primary">
                    <i class="fas fa-list"></i> Back to Teacher List
                </a>
                <button onclick="window.print()" class="btn btn-secondary">
                    <i class="fas fa-print"></i> Print List
                </button>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                No teachers found in the system.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function togglePassword(teacherId) {
    const passwordField = document.getElementById('password_' + teacherId);
    const icon = passwordField.nextElementSibling.querySelector('i');
    const actualPassword = passwordField.getAttribute('data-password');
    
    if (passwordField.type === 'password') {
        passwordField.type = 'text';
        passwordField.value = actualPassword;
        icon.className = 'fas fa-eye-slash';
    } else {
        passwordField.type = 'password';
        passwordField.value = '********';
        icon.className = 'fas fa-eye';
    }
}
</script>
{% endblock %}\n\n========== FILE: ./teachers/templates/teachers/teacher_students.html ==========\n
{% extends 'accounts/base.html' %}

{% block content %}
<h2>My Students</h2>
<p><strong>Teacher:</strong> {{ teacher.user.get_full_name }}</p>
<p><strong>Classes Taught:</strong> {{ teacher.classes }}</p>

<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
    <thead>
        <tr style="background-color: #f2f2f2;">
            <th style="border: 1px solid #ddd; padding: 8px;">Admission No.</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Name</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Grade</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Section</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Parent</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for student in students %}
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ student.admission_number }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ student.user.get_full_name }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ student.grade }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ student.section }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ student.parent_name }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                <a href="{% url 'student_detail' student.pk %}" style="background-color: #2196F3; color: white; padding: 5px 10px; text-decoration: none;">View</a>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" style="border: 1px solid #ddd; padding: 8px; text-align: center;">No students found in your classes.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}\n\n========== FILE: ./teachers/tests.py ==========\n
from django.test import TestCase

# Create your tests here.
\n\n========== FILE: ./teachers/urls.py ==========\n
from django.urls import path
from . import views

urlpatterns = [
    path('', views.teacher_list, name='teacher_list'),
    path('create/', views.teacher_create, name='teacher_create'),
    path('<int:pk>/', views.teacher_detail, name='teacher_detail'),
    path('<int:pk>/update/', views.teacher_update, name='teacher_update'),
    path('my-students/', views.teacher_students, name='teacher_students'),
    # ADD THIS: For admin to view all teacher passwords
    path('passwords/', views.teacher_passwords_view, name='teacher_passwords_view'),
]\n\n========== FILE: ./teachers/views.py ==========\n
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required, user_passes_test
from django.contrib import messages
from .models import Teacher
from .forms import TeacherForm
from students.models import Student
from accounts.models import User

def is_admin(user):
    return user.is_authenticated and user.is_admin()

@login_required
@user_passes_test(is_admin)
def teacher_list(request):
    teachers = Teacher.objects.all()
    return render(request, 'teachers/teacher_list.html', {'teachers': teachers})

@login_required
@user_passes_test(is_admin)
def teacher_detail(request, pk):
    teacher = get_object_or_404(Teacher, pk=pk)
    return render(request, 'teachers/teacher_detail.html', {'teacher': teacher})

@login_required
@user_passes_test(is_admin)
def teacher_create(request):
    if request.method == 'POST':
        form = TeacherForm(request.POST, request.FILES)
        if form.is_valid():
            teacher = form.save()
            messages.success(request, f'Teacher {teacher.user.get_full_name()} created successfully!')
            return redirect('teacher_list')
    else:
        form = TeacherForm()
    return render(request, 'teachers/teacher_form.html', {'form': form, 'title': 'Add Teacher'})

@login_required
@user_passes_test(is_admin)
def teacher_update(request, pk):
    teacher = get_object_or_404(Teacher, pk=pk)
    if request.method == 'POST':
        form = TeacherForm(request.POST, request.FILES, instance=teacher)
        if form.is_valid():
            form.save()
            messages.success(request, f'Teacher {teacher.user.get_full_name()} updated successfully!')
            return redirect('teacher_list')
    else:
        form = TeacherForm(instance=teacher)
    return render(request, 'teachers/teacher_form.html', {'form': form, 'title': 'Update Teacher'})

@login_required
def teacher_students(request):
    if not request.user.is_teacher():
        messages.error(request, 'Access denied.')
        return redirect('dashboard')
    
    try:
        teacher = Teacher.objects.get(user=request.user)
        assigned_students = teacher.get_assigned_students()
        return render(request, 'teachers/teacher_students.html', {
            'teacher': teacher,
            'students': assigned_students
        })
    except Teacher.DoesNotExist:
        messages.error(request, 'Teacher profile not found.')
        return redirect('dashboard')
    

@login_required
@user_passes_test(is_admin)
def teacher_passwords_view(request):
    """Admin view to see all teacher passwords"""
    teachers = Teacher.objects.select_related('user').all()
    
    # Create a list with password information
    teachers_with_passwords = []
    for teacher in teachers:
        teachers_with_passwords.append({
            'teacher': teacher,
            'username': teacher.user.username,
            'password_display': '********',  # Placeholder - in reality would show actual
            'email': teacher.user.email,
            'employee_id': teacher.employee_id,
        })
    
    return render(request, 'teachers/teacher_passwords.html', {
        'teachers': teachers_with_passwords
    })\n\n========== FILE: ./teachers/__init__.py ==========\n
