=== MEDIA_PORTFOLIO APPS AND CONFIG FILES ===
Generated: Sat, Feb 14, 2026  8:14:33 PM
==============================================

>>> MEDIA_PORTFOLIO APPS FILES <<<

=================================================================
FILE: ./media_portfolio/categories/__init__.py
=================================================================



=================================================================
FILE: ./media_portfolio/categories/admin.py
=================================================================

from django.contrib import admin
from .models import Category


@admin.register(Category)
class CategoryAdmin(admin.ModelAdmin):
    list_display = ['name', 'category_type', 'parent', 'media_count', 'sort_order', 'is_active']
    list_filter = ['category_type', 'is_active', 'parent']
    search_fields = ['name', 'description']
    prepopulated_fields = {'slug': ('name',)}
    list_editable = ['sort_order', 'is_active']
    
    fieldsets = (
        ('Basic Information', {
            'fields': ('name', 'slug', 'category_type', 'parent', 'description')
        }),
        ('Visual', {
            'fields': ('cover_image', 'icon', 'sort_order', 'is_active')
        }),
        ('SEO', {
            'fields': ('meta_title', 'meta_description'),
            'classes': ('collapse',)
        }),
    )

=================================================================
FILE: ./media_portfolio/categories/apps.py
=================================================================

from django.apps import AppConfig


class CategoriesConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'media_portfolio.categories'
    verbose_name = 'Categories'

=================================================================
FILE: ./media_portfolio/categories/forms.py
=================================================================

from django import forms
from .models import Category


class CategoryForm(forms.ModelForm):
    """
    Form for creating and editing categories
    """
    class Meta:
        model = Category
        fields = [
            'name', 'slug', 'category_type', 'parent', 'description',
            'cover_image', 'icon', 'meta_title', 'meta_description',
            'sort_order', 'is_active'
        ]
        widgets = {
            'name': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': 'Enter category name'
            }),
            'slug': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': 'url-friendly-name'
            }),
            'category_type': forms.Select(attrs={
                'class': 'form-select'
            }),
            'parent': forms.Select(attrs={
                'class': 'form-select'
            }),
            'description': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 4,
                'placeholder': 'Describe this category...'
            }),
            'cover_image': forms.FileInput(attrs={
                'class': 'form-control',
                'accept': 'image/*'
            }),
            'icon': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': 'fa-camera'
            }),
            'meta_title': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': 'SEO title (optional)'
            }),
            'meta_description': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3,
                'placeholder': 'SEO description (optional)'
            }),
            'sort_order': forms.NumberInput(attrs={
                'class': 'form-control',
                'min': '0'
            }),
            'is_active': forms.CheckboxInput(attrs={
                'class': 'form-check-input'
            }),
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        
        # Make slug optional - will be auto-generated if not provided
        self.fields['slug'].required = False
        self.fields['slug'].help_text = "Leave blank to auto-generate from name"
        
        # Filter parent to only show categories of same type or no type restriction
        if self.instance and self.instance.pk:
            self.fields['parent'].queryset = Category.objects.filter(
                is_active=True
            ).exclude(pk=self.instance.pk)
        else:
            self.fields['parent'].queryset = Category.objects.filter(is_active=True)
        
        # Add help texts
        self.fields['icon'].help_text = "Font Awesome icon class (e.g., 'fa-camera', 'fa-video')"
        self.fields['category_type'].help_text = "Type of category for organization"
        self.fields['parent'].help_text = "Parent category (if this is a subcategory)"

    def clean_slug(self):
        """
        Ensure slug is unique
        """
        slug = self.cleaned_data.get('slug')
        name = self.cleaned_data.get('name')
        
        if not slug and name:
            from django.utils.text import slugify
            slug = slugify(name)
        
        if slug:
            # Check uniqueness
            qs = Category.objects.filter(slug=slug)
            if self.instance and self.instance.pk:
                qs = qs.exclude(pk=self.instance.pk)
            
            if qs.exists():
                raise forms.ValidationError("This slug is already in use. Please choose another.")
        
        return slug

    def clean(self):
        """
        Additional validation
        """
        cleaned_data = super().clean()
        category_type = cleaned_data.get('category_type')
        parent = cleaned_data.get('parent')
        
        # Prevent circular parent relationships
        if parent and self.instance and self.instance.pk:
            if parent.pk == self.instance.pk:
                self.add_error('parent', "A category cannot be its own parent")
            
            # Check if parent is actually a child of this category (circular)
            current_parent = parent
            while current_parent:
                if current_parent == self.instance:
                    self.add_error('parent', "Cannot create circular parent relationship")
                    break
                current_parent = current_parent.parent
        
        return cleaned_data


class CategoryFilterForm(forms.Form):
    """
    Form for filtering categories in list views
    """
    type = forms.ChoiceField(
        choices=[('', 'All Types')] + Category.CATEGORY_TYPES,
        required=False,
        widget=forms.Select(attrs={
            'class': 'form-select',
            'onchange': 'this.form.submit()'
        })
    )
    
    search = forms.CharField(
        required=False,
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': 'Search categories...'
        })
    )
    
    active_only = forms.BooleanField(
        required=False,
        initial=True,
        widget=forms.CheckboxInput(attrs={
            'class': 'form-check-input',
            'onchange': 'this.form.submit()'
        })
    )


class CategoryBulkActionForm(forms.Form):
    """
    Form for bulk actions on categories (admin)
    """
    ACTION_CHOICES = [
        ('activate', 'Activate selected'),
        ('deactivate', 'Deactivate selected'),
        ('delete', 'Delete selected'),
        ('change_type', 'Change category type'),
        ('move_to_parent', 'Move to parent category'),
    ]
    
    action = forms.ChoiceField(
        choices=ACTION_CHOICES,
        widget=forms.Select(attrs={'class': 'form-select'})
    )
    
    new_type = forms.ChoiceField(
        choices=Category.CATEGORY_TYPES,
        required=False,
        widget=forms.Select(attrs={'class': 'form-select'})
    )
    
    new_parent = forms.ModelChoiceField(
        queryset=Category.objects.filter(is_active=True),
        required=False,
        widget=forms.Select(attrs={'class': 'form-select'})
    )
    
    def clean(self):
        cleaned_data = super().clean()
        action = cleaned_data.get('action')
        
        if action == 'change_type' and not cleaned_data.get('new_type'):
            self.add_error('new_type', 'New type is required for change type action')
        
        if action == 'move_to_parent' and not cleaned_data.get('new_parent'):
            self.add_error('new_parent', 'New parent is required for move action')
        
        return cleaned_data

=================================================================
FILE: ./media_portfolio/categories/migrations/__init__.py
=================================================================



=================================================================
FILE: ./media_portfolio/categories/migrations/0001_initial.py
=================================================================

# Generated by Django 4.2.7 on 2026-02-13 23:21

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='Category',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('sort_order', models.IntegerField(default=0, help_text='Order for display')),
                ('name', models.CharField(max_length=100)),
                ('slug', models.SlugField(max_length=120, unique=True)),
                ('category_type', models.CharField(choices=[('medium', 'Medium (Photography/Video/3D/Design)'), ('genre', 'Genre (Portrait/Landscape/Abstract/Street)'), ('technique', 'Technique (Digital/Film/Analog/Timelapse)'), ('subject', 'Subject (People/Nature/Architecture/Products)'), ('collection', 'Collection/Series'), ('client', 'Client Work'), ('personal', 'Personal Projects')], max_length=20)),
                ('description', models.TextField(blank=True)),
                ('cover_image', models.ImageField(blank=True, help_text='Cover image for this category', null=True, upload_to='categories/covers/')),
                ('icon', models.CharField(blank=True, help_text="Font Awesome icon class (e.g., 'fa-camera')", max_length=50)),
                ('meta_title', models.CharField(blank=True, max_length=200)),
                ('meta_description', models.TextField(blank=True)),
                ('parent', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='children', to='categories.category')),
            ],
            options={
                'verbose_name': 'Category',
                'verbose_name_plural': 'Categories',
                'ordering': ['category_type', 'sort_order', 'name'],
            },
        ),
    ]


=================================================================
FILE: ./media_portfolio/categories/models.py
=================================================================

from django.db import models
from media_portfolio.core.models import BaseModel


class Category(BaseModel):
    """
    Category for media items with type classification
    """
    CATEGORY_TYPES = [
        ('medium', 'Medium (Photography/Video/3D/Design)'),
        ('genre', 'Genre (Portrait/Landscape/Abstract/Street)'),
        ('technique', 'Technique (Digital/Film/Analog/Timelapse)'),
        ('subject', 'Subject (People/Nature/Architecture/Products)'),
        ('collection', 'Collection/Series'),
        ('client', 'Client Work'),
        ('personal', 'Personal Projects'),
    ]

    name = models.CharField(max_length=100)
    slug = models.SlugField(max_length=120, unique=True)
    category_type = models.CharField(max_length=20, choices=CATEGORY_TYPES)
    description = models.TextField(blank=True)
    
    # Visual representation
    cover_image = models.ImageField(
        upload_to='categories/covers/',
        blank=True,
        null=True,
        help_text="Cover image for this category"
    )
    icon = models.CharField(
        max_length=50,
        blank=True,
        help_text="Font Awesome icon class (e.g., 'fa-camera')"
    )
    
    # SEO
    meta_title = models.CharField(max_length=200, blank=True)
    meta_description = models.TextField(blank=True)
    
    # Parent-child relationship for nested categories
    parent = models.ForeignKey(
        'self',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='children'
    )

    class Meta:
        verbose_name = "Category"
        verbose_name_plural = "Categories"
        ordering = ['category_type', 'sort_order', 'name']

    def __str__(self):
        return f"{self.get_category_type_display()}: {self.name}"

    def save(self, *args, **kwargs):
        if not self.slug:
            from django.utils.text import slugify
            self.slug = slugify(self.name)
        super().save(*args, **kwargs)

    @property
    def media_count(self):
        """Get count of media items in this category"""
        return self.media_items.count()

=================================================================
FILE: ./media_portfolio/categories/urls.py
=================================================================

from django.urls import path
from . import views

app_name = 'categories'

urlpatterns = [
    path('', views.CategoryListView.as_view(), name='list'),
    path('<slug:slug>/', views.CategoryDetailView.as_view(), name='detail'),
]

=================================================================
FILE: ./media_portfolio/categories/views.py
=================================================================

from django.shortcuts import render, get_object_or_404
from django.views.generic import ListView, DetailView
from .models import Category
from media_portfolio.media.models import MediaItem
from django.core.paginator import Paginator, EmptyPage, PageNotAnInteger



class CategoryListView(ListView):
    """
    View for listing all categories grouped by type
    """
    model = Category
    template_name = 'categories/category_list.html'
    context_object_name = 'categories'

    def get_queryset(self):
        return Category.objects.filter(is_active=True).prefetch_related('media_items')


class CategoryDetailView(DetailView):
    """
    View for displaying a single category and its media
    """
    model = Category
    template_name = 'categories/category_detail.html'
    context_object_name = 'category'
    slug_field = 'slug'
    slug_url_kwarg = 'slug'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        category = self.object
        
        # Get media items in this category
        media_items = MediaItem.objects.filter(
            is_published=True,
            categories=category
        ).select_related().prefetch_related('categories')
        
        # Paginate
        paginator = Paginator(media_items, 12)
        page = self.request.GET.get('page')
        
        try:
            media_items = paginator.page(page)
        except PageNotAnInteger:
            media_items = paginator.page(1)
        except EmptyPage:
            media_items = paginator.page(paginator.num_pages)
        
        context['media_items'] = media_items
        context['is_paginated'] = media_items.has_other_pages()
        
        return context

=================================================================
FILE: ./media_portfolio/collections/__init__.py
=================================================================



=================================================================
FILE: ./media_portfolio/collections/admin.py
=================================================================

from django.contrib import admin
from django.utils.html import format_html
from .models import Collection, CollectionItem


class CollectionItemInline(admin.TabularInline):
    model = CollectionItem
    extra = 5
    ordering = ['order']
    fields = ['media_item', 'order', 'custom_caption']
    autocomplete_fields = ['media_item']


@admin.register(Collection)
class CollectionAdmin(admin.ModelAdmin):
    list_display = ['title', 'collection_type', 'featured', 'is_published', 'media_count', 'created_at']
    list_filter = ['collection_type', 'featured', 'is_published', 'layout']
    search_fields = ['title', 'description']
    prepopulated_fields = {'slug': ('title',)}
    inlines = [CollectionItemInline]
    
    fieldsets = (
        ('Basic Information', {
            'fields': ('title', 'slug', 'collection_type', 'description')
        }),
        ('Media', {
            'fields': ('cover_image',)
        }),
        ('Display', {
            'fields': ('layout', 'featured', 'is_published', 'published_date', 'sort_order')
        }),
        ('SEO', {
            'fields': ('meta_title', 'meta_description'),
            'classes': ('collapse',)
        }),
    )
    
    def media_count(self, obj):
        return obj.media_items.count()
    media_count.short_description = 'Items'
    
    def cover_preview(self, obj):
        if obj.cover_image:
            return format_html(
                '<img src="{}" style="max-height: 50px; max-width: 50px;" />',
                obj.cover_image.url
            )
        return "No cover"
    cover_preview.short_description = 'Cover'

=================================================================
FILE: ./media_portfolio/collections/apps.py
=================================================================



=================================================================
FILE: ./media_portfolio/collections/migrations/__init__.py
=================================================================



=================================================================
FILE: ./media_portfolio/collections/migrations/0001_initial.py
=================================================================

# Generated by Django 4.2.7 on 2026-02-13 23:21

from django.db import migrations, models
import django.db.models.deletion
import django.utils.timezone


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('media', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='Collection',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('sort_order', models.IntegerField(default=0, help_text='Order for display')),
                ('title', models.CharField(max_length=200)),
                ('slug', models.SlugField(max_length=250, unique=True)),
                ('collection_type', models.CharField(choices=[('series', 'Series'), ('exhibition', 'Exhibition'), ('project', 'Project'), ('client', 'Client Work'), ('personal', 'Personal'), ('award', 'Award Winning')], default='series', max_length=20)),
                ('description', models.TextField(blank=True)),
                ('cover_image', models.ImageField(blank=True, help_text='Cover image for the collection', null=True, upload_to='collections/covers/')),
                ('layout', models.CharField(choices=[('grid', 'Grid'), ('masonry', 'Masonry'), ('slideshow', 'Slideshow'), ('carousel', 'Carousel')], default='grid', max_length=20)),
                ('is_published', models.BooleanField(default=True)),
                ('published_date', models.DateTimeField(default=django.utils.timezone.now)),
                ('meta_title', models.CharField(blank=True, max_length=200)),
                ('meta_description', models.TextField(blank=True)),
                ('featured', models.BooleanField(default=False)),
            ],
            options={
                'verbose_name': 'Collection',
                'verbose_name_plural': 'Collections',
                'ordering': ['-featured', '-published_date'],
            },
        ),
        migrations.CreateModel(
            name='CollectionItem',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('order', models.IntegerField(default=0)),
                ('custom_caption', models.TextField(blank=True, help_text="Override the media item's caption for this collection")),
                ('collection', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='collections.collection')),
                ('media_item', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='media.mediaitem')),
            ],
            options={
                'ordering': ['order'],
                'unique_together': {('collection', 'media_item')},
            },
        ),
        migrations.AddField(
            model_name='collection',
            name='media_items',
            field=models.ManyToManyField(blank=True, related_name='collections', through='collections.CollectionItem', to='media.mediaitem'),
        ),
    ]


=================================================================
FILE: ./media_portfolio/collections/models.py
=================================================================

from django.db import models
from django.utils import timezone
from media_portfolio.core.models import BaseModel
from media_portfolio.media.models import MediaItem


class Collection(BaseModel):
    """
    Model for grouping media items into collections/series
    """
    COLLECTION_TYPES = [
        ('series', 'Series'),
        ('exhibition', 'Exhibition'),
        ('project', 'Project'),
        ('client', 'Client Work'),
        ('personal', 'Personal'),
        ('award', 'Award Winning'),
    ]
    
    LAYOUT_CHOICES = [
        ('grid', 'Grid'),
        ('masonry', 'Masonry'),
        ('slideshow', 'Slideshow'),
        ('carousel', 'Carousel'),
    ]
    
    title = models.CharField(max_length=200)
    slug = models.SlugField(max_length=250, unique=True)
    collection_type = models.CharField(max_length=20, choices=COLLECTION_TYPES, default='series')
    description = models.TextField(blank=True)
    
    # Visual representation
    cover_image = models.ImageField(
        upload_to='collections/covers/',
        blank=True,
        null=True,
        help_text="Cover image for the collection"
    )
    
    # Media items in this collection
    media_items = models.ManyToManyField(
        MediaItem,
        through='CollectionItem',
        related_name='collections',
        blank=True
    )
    
    # Display options
    layout = models.CharField(
        max_length=20,
        choices=LAYOUT_CHOICES,
        default='grid'
    )
    is_published = models.BooleanField(default=True)
    published_date = models.DateTimeField(default=timezone.now)
    
    # SEO
    meta_title = models.CharField(max_length=200, blank=True)
    meta_description = models.TextField(blank=True)
    
    # Featured
    featured = models.BooleanField(default=False)
    
    class Meta:
        verbose_name = "Collection"
        verbose_name_plural = "Collections"
        ordering = ['-featured', '-published_date']

    def __str__(self):
        return self.title

    def save(self, *args, **kwargs):
        if not self.slug:
            from django.utils.text import slugify
            self.slug = slugify(self.title)
        super().save(*args, **kwargs)

    def get_absolute_url(self):
        from django.urls import reverse
        return reverse('collections:detail', args=[self.slug])


class CollectionItem(models.Model):
    """
    Through model for collection items with ordering and custom captions
    """
    collection = models.ForeignKey(Collection, on_delete=models.CASCADE)
    media_item = models.ForeignKey(MediaItem, on_delete=models.CASCADE)
    order = models.IntegerField(default=0)
    custom_caption = models.TextField(blank=True, help_text="Override the media item's caption for this collection")
    
    class Meta:
        ordering = ['order']
        unique_together = ['collection', 'media_item']

    def __str__(self):
        return f"{self.collection.title} - {self.media_item.title}"

=================================================================
FILE: ./media_portfolio/collections/urls.py
=================================================================

from django.urls import path
from . import views

app_name = 'collections'

urlpatterns = [
    path('', views.CollectionListView.as_view(), name='list'),
    path('<slug:slug>/', views.CollectionDetailView.as_view(), name='detail'),
]

=================================================================
FILE: ./media_portfolio/collections/views.py
=================================================================

from django.shortcuts import render, get_object_or_404
from django.views.generic import ListView, DetailView
from django.core.paginator import Paginator
from .models import Collection


class CollectionListView(ListView):
    """
    View for listing all collections
    """
    model = Collection
    template_name = 'collections/collection_list.html'
    context_object_name = 'collections'
    paginate_by = 12

    def get_queryset(self):
        return Collection.objects.filter(
            is_published=True
        ).prefetch_related('media_items')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        
        # Group collections by type for filtering
        collection_types = Collection.objects.filter(
            is_published=True
        ).values_list('collection_type', flat=True).distinct()
        
        context['collection_types'] = [(t, dict(Collection.COLLECTION_TYPES).get(t, t)) 
                                       for t in collection_types]
        
        # Featured collections
        context['featured_collections'] = Collection.objects.filter(
            is_published=True,
            featured=True
        )[:3]
        
        return context


class CollectionDetailView(DetailView):
    """
    View for displaying a single collection
    """
    model = Collection
    template_name = 'collections/collection_detail.html'
    context_object_name = 'collection'
    slug_field = 'slug'
    slug_url_kwarg = 'slug'

    def get_queryset(self):
        return Collection.objects.filter(
            is_published=True
        ).prefetch_related('media_items')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        
        # Get collection items with ordering
        collection_items = self.object.collectionitem_set.select_related(
            'media_item'
        ).order_by('order')
        
        context['collection_items'] = collection_items
        
        # Related collections (same type)
        context['related_collections'] = Collection.objects.filter(
            is_published=True,
            collection_type=self.object.collection_type
        ).exclude(
            id=self.object.id
        )[:3]
        
        return context

=================================================================
FILE: ./media_portfolio/comments/__init__.py
=================================================================



=================================================================
FILE: ./media_portfolio/comments/admin.py
=================================================================

from django.contrib import admin
from .models import Comment, Testimonial


@admin.register(Comment)
class CommentAdmin(admin.ModelAdmin):
    list_display = ['name', 'email', 'media_item', 'is_approved', 'is_featured', 'created_at']
    list_filter = ['is_approved', 'is_spam', 'is_featured', 'created_at']
    search_fields = ['name', 'email', 'content']
    readonly_fields = ['ip_address', 'user_agent', 'created_at', 'updated_at']  # Added updated_at here
    
    fieldsets = (
        ('Comment', {
            'fields': ('media_item', 'parent', 'name', 'email', 'website', 'content')
        }),
        ('Moderation', {
            'fields': ('is_approved', 'is_spam', 'is_featured', 'can_use_as_testimonial', 'testimonial_approved')
        }),
        ('Technical', {
            'fields': ('ip_address', 'user_agent', 'created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )
    
    actions = ['approve_comments', 'mark_as_spam', 'feature_comments']
    
    def approve_comments(self, request, queryset):
        queryset.update(is_approved=True)
    approve_comments.short_description = "Approve selected comments"
    
    def mark_as_spam(self, request, queryset):
        queryset.update(is_spam=True, is_approved=False)
    mark_as_spam.short_description = "Mark selected as spam"
    
    def feature_comments(self, request, queryset):
        queryset.update(is_featured=True)
    feature_comments.short_description = "Feature selected comments"


@admin.register(Testimonial)
class TestimonialAdmin(admin.ModelAdmin):
    list_display = ['name', 'company', 'rating', 'featured', 'created_at']
    list_filter = ['rating', 'featured']
    search_fields = ['name', 'company', 'content']
    
    fieldsets = (
        ('Testimonial', {
            'fields': ('name', 'title', 'company', 'content', 'rating')
        }),
        ('Source', {
            'fields': ('source_comment', 'photo')
        }),
        ('Display', {
            'fields': ('featured', 'sort_order')
        }),
    )

=================================================================
FILE: ./media_portfolio/comments/apps.py
=================================================================

from django.apps import AppConfig


class CommentsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'media_portfolio.comments'
    verbose_name = 'Comments'

=================================================================
FILE: ./media_portfolio/comments/forms.py
=================================================================

from django import forms
from .models import Comment


class CommentForm(forms.ModelForm):
    """
    Form for submitting comments
    """
    class Meta:
        model = Comment
        fields = ['name', 'email', 'website', 'content', 'can_use_as_testimonial']
        widgets = {
            'content': forms.Textarea(attrs={
                'rows': 4,
                'class': 'form-control',
                'placeholder': 'Share your thoughts...'
            }),
            'name': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': 'Your name'
            }),
            'email': forms.EmailInput(attrs={
                'class': 'form-control',
                'placeholder': 'your@email.com'
            }),
            'website': forms.URLInput(attrs={
                'class': 'form-control',
                'placeholder': 'https://yourwebsite.com (optional)'
            }),
            'can_use_as_testimonial': forms.CheckboxInput(attrs={
                'class': 'form-check-input'
            }),
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.fields['website'].required = False

=================================================================
FILE: ./media_portfolio/comments/migrations/__init__.py
=================================================================



=================================================================
FILE: ./media_portfolio/comments/migrations/0001_initial.py
=================================================================

# Generated by Django 4.2.7 on 2026-02-13 23:21

import django.core.validators
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('media', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='Comment',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('sort_order', models.IntegerField(default=0, help_text='Order for display')),
                ('name', models.CharField(max_length=100)),
                ('email', models.EmailField(max_length=254, validators=[django.core.validators.EmailValidator()])),
                ('website', models.URLField(blank=True, help_text='Optional: Your website or portfolio')),
                ('content', models.TextField()),
                ('is_approved', models.BooleanField(default=False, help_text='Approve for public display')),
                ('is_spam', models.BooleanField(default=False)),
                ('is_featured', models.BooleanField(default=False, help_text='Feature this comment as a testimonial')),
                ('ip_address', models.GenericIPAddressField(blank=True, null=True)),
                ('user_agent', models.TextField(blank=True)),
                ('can_use_as_testimonial', models.BooleanField(default=False, help_text='Can I feature this comment on my site?')),
                ('testimonial_approved', models.BooleanField(default=False, help_text='Approved to use as testimonial')),
                ('media_item', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='comments', to='media.mediaitem')),
                ('parent', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='replies', to='comments.comment')),
            ],
            options={
                'verbose_name': 'Comment',
                'verbose_name_plural': 'Comments',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='Testimonial',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('sort_order', models.IntegerField(default=0, help_text='Order for display')),
                ('name', models.CharField(max_length=100)),
                ('title', models.CharField(blank=True, help_text='e.g., Client, Art Director', max_length=200)),
                ('company', models.CharField(blank=True, max_length=200)),
                ('content', models.TextField()),
                ('photo', models.ImageField(blank=True, null=True, upload_to='testimonials/')),
                ('rating', models.IntegerField(choices=[(1, 1), (2, 2), (3, 3), (4, 4), (5, 5)], default=5, help_text='Rating out of 5')),
                ('featured', models.BooleanField(default=True)),
                ('source_comment', models.OneToOneField(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='testimonial', to='comments.comment')),
            ],
            options={
                'verbose_name': 'Testimonial',
                'verbose_name_plural': 'Testimonials',
            },
        ),
        migrations.AddIndex(
            model_name='comment',
            index=models.Index(fields=['media_item', 'is_approved'], name='comments_co_media_i_a3afee_idx'),
        ),
        migrations.AddIndex(
            model_name='comment',
            index=models.Index(fields=['is_featured'], name='comments_co_is_feat_85e01a_idx'),
        ),
    ]


=================================================================
FILE: ./media_portfolio/comments/models.py
=================================================================

from django.db import models
from django.core.validators import EmailValidator
from media_portfolio.core.models import BaseModel
from media_portfolio.media.models import MediaItem


class Comment(BaseModel):
    """
    Model for comments on media items with threading support
    """
    media_item = models.ForeignKey(
        MediaItem,
        on_delete=models.CASCADE,
        related_name='comments'
    )
    
    parent = models.ForeignKey(
        'self',
        null=True,
        blank=True,
        on_delete=models.CASCADE,
        related_name='replies'
    )
    
    # Commenter info
    name = models.CharField(max_length=100)
    email = models.EmailField(validators=[EmailValidator()])
    website = models.URLField(blank=True, help_text="Optional: Your website or portfolio")
    
    # Comment content
    content = models.TextField()
    
    # Moderation
    is_approved = models.BooleanField(
        default=False,
        help_text="Approve for public display"
    )
    is_spam = models.BooleanField(default=False)
    is_featured = models.BooleanField(
        default=False,
        help_text="Feature this comment as a testimonial"
    )
    
    # Tracking
    ip_address = models.GenericIPAddressField(null=True, blank=True)
    user_agent = models.TextField(blank=True)
    
    # For testimonials
    can_use_as_testimonial = models.BooleanField(
        default=False,
        help_text="Can I feature this comment on my site?"
    )
    testimonial_approved = models.BooleanField(
        default=False,
        help_text="Approved to use as testimonial"
    )

    class Meta:
        verbose_name = "Comment"
        verbose_name_plural = "Comments"
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['media_item', 'is_approved']),
            models.Index(fields=['is_featured']),
        ]

    def __str__(self):
        return f"Comment by {self.name} on {self.media_item.title}"

    def get_replies(self):
        """Get all approved replies to this comment"""
        return self.replies.filter(is_approved=True)


class Testimonial(BaseModel):
    """
    Featured testimonials (can be from comments or standalone)
    """
    name = models.CharField(max_length=100)
    title = models.CharField(max_length=200, blank=True, help_text="e.g., Client, Art Director")
    company = models.CharField(max_length=200, blank=True)
    
    # Optional link to original comment
    source_comment = models.OneToOneField(
        Comment,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='testimonial'
    )
    
    # Testimonial content
    content = models.TextField()
    
    # Optional photo
    photo = models.ImageField(
        upload_to='testimonials/',
        blank=True,
        null=True
    )
    
    # Display
    rating = models.IntegerField(
        choices=[(i, i) for i in range(1, 6)],
        default=5,
        help_text="Rating out of 5"
    )
    featured = models.BooleanField(default=True)

    class Meta:
        verbose_name = "Testimonial"
        verbose_name_plural = "Testimonials"

    def __str__(self):
        return f"Testimonial from {self.name}"

=================================================================
FILE: ./media_portfolio/comments/templatetags/__init__.py
=================================================================



=================================================================
FILE: ./media_portfolio/comments/templatetags/comment_tags.py
=================================================================

from django import template
from django.utils import timezone
from django.db.models import Count, Q
from django.core.cache import cache
from ..models import Comment

register = template.Library()


@register.filter
def days_since(value):
    """
    Return human-readable time since a date.
    Usage: {{ comment.created_at|days_since }}
    """
    if not value:
        return ''
    
    delta = timezone.now() - value
    seconds = delta.total_seconds()
    
    if seconds < 60:
        return 'just now'
    elif seconds < 3600:
        minutes = int(seconds // 60)
        return f'{minutes} minute' + ('s' if minutes > 1 else '') + ' ago'
    elif seconds < 86400:
        hours = int(seconds // 3600)
        return f'{hours} hour' + ('s' if hours > 1 else '') + ' ago'
    elif seconds < 604800:  # 7 days
        days = int(seconds // 86400)
        if days == 0:
            return 'today'
        elif days == 1:
            return 'yesterday'
        else:
            return f'{days} days ago'
    elif seconds < 2592000:  # 30 days
        weeks = int(seconds // 604800)
        return f'{weeks} week' + ('s' if weeks > 1 else '') + ' ago'
    elif seconds < 31536000:  # 365 days
        months = int(seconds // 2592000)
        return f'{months} month' + ('s' if months > 1 else '') + ' ago'
    else:
        years = int(seconds // 31536000)
        return f'{years} year' + ('s' if years > 1 else '') + ' ago'


@register.simple_tag
def get_comment_count(media_item, include_replies=False):
    """
    Get count of approved comments for a media item.
    
    Args:
        media_item: The media item object
        include_replies: If True, counts all comments including replies
                        If False, counts only top-level comments
    """
    queryset = Comment.objects.filter(
        media_item=media_item,
        is_approved=True
    )
    
    if not include_replies:
        queryset = queryset.filter(parent__isnull=True)
    
    return queryset.count()


@register.simple_tag
def get_recent_comments(limit=5, media_type=None):
    """
    Get most recent approved comments with optional media type filter.
    
    Args:
        limit: Maximum number of comments to return
        media_type: Optional filter by 'image' or 'video'
    """
    queryset = Comment.objects.filter(
        is_approved=True
    ).select_related('media_item')
    
    if media_type:
        queryset = queryset.filter(media_item__media_type=media_type)
    
    return queryset.order_by('-created_at')[:limit]


@register.simple_tag
def get_featured_comments(limit=3):
    """
    Get featured comments/testimonials.
    """
    return Comment.objects.filter(
        is_approved=True,
        is_featured=True
    ).select_related('media_item')[:limit]


@register.simple_tag
def get_user_comments(user, limit=None):
    """
    Get comments by a specific user (by email).
    """
    queryset = Comment.objects.filter(
        email=user.email if hasattr(user, 'email') else user,
        is_approved=True
    ).order_by('-created_at')
    
    if limit:
        queryset = queryset[:limit]
    
    return queryset


@register.simple_tag
def get_comment_stats(media_item=None):
    """
    Get comment statistics, optionally filtered by media item.
    Returns dictionary with counts.
    """
    cache_key = f'comment_stats_{media_item.id if media_item else "global"}'
    stats = cache.get(cache_key)
    
    if stats is None:
        queryset = Comment.objects.all()
        if media_item:
            queryset = queryset.filter(media_item=media_item)
        
        stats = queryset.aggregate(
            total=Count('id'),
            approved=Count('id', filter=Q(is_approved=True)),
            featured=Count('id', filter=Q(is_featured=True)),
            spam=Count('id', filter=Q(is_spam=True))
        )
        
        # Cache for 5 minutes
        cache.set(cache_key, stats, 300)
    
    return stats


@register.inclusion_tag('comments/comment_tree.html', takes_context=True)
def render_comment_tree(context, comments, media_item=None):
    """
    Render a tree of comments with replies.
    
    Args:
        comments: QuerySet or list of comments
        media_item: Optional media item for reply form
    """
    # Prefetch replies for efficiency
    if hasattr(comments, 'prefetch_related'):
        comments = comments.prefetch_related('replies')
    
    return {
        'comments': comments,
        'media_item': media_item or context.get('media_item'),
        'user': context.get('user'),
        'request': context.get('request')
    }


@register.inclusion_tag('comments/comment_form.html')
def render_comment_form(media_item, user=None):
    """
    Render comment form for a media item.
    """
    return {
        'media_item': media_item,
        'user': user,
        'can_comment': True  # Add your permission logic here
    }


@register.filter
def comment_depth(comment):
    """
    Get the depth of a comment in the thread.
    Useful for styling nested comments.
    """
    depth = 0
    current = comment
    while current.parent:
        depth += 1
        current = current.parent
        if depth > 10:  # Prevent infinite loops
            break
    return depth


@register.simple_tag
def can_moderate_comment(user, comment):
    """
    Check if user can moderate a comment.
    """
    if not user.is_authenticated:
        return False
    
    if user.is_staff or user.is_superuser:
        return True
    
    # Add custom moderation permissions here
    return False


@register.filter
def truncate_comment(content, words=30):
    """
    Truncate comment content to specified number of words.
    """
    if not content:
        return ''
    
    words_list = content.split()
    if len(words_list) <= words:
        return content
    
    truncated = ' '.join(words_list[:words])
    return truncated + '...'


@register.simple_tag
def get_comment_replies_count(comment):
    """
    Get count of replies for a comment.
    """
    return comment.replies.filter(is_approved=True).count()

=================================================================
FILE: ./media_portfolio/comments/urls.py
=================================================================

from django.urls import path
from . import views

app_name = 'comments'

urlpatterns = [
    path('add/<int:media_id>/', views.AddCommentView.as_view(), name='add'),
    path('load/<int:media_id>/', views.LoadCommentsView.as_view(), name='load'),
    path('moderate/<int:comment_id>/', views.ModerateCommentView.as_view(), name='moderate'),
]

=================================================================
FILE: ./media_portfolio/comments/views.py
=================================================================

from django.shortcuts import render, get_object_or_404, redirect
from django.views.generic import View
from django.contrib import messages
from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
from django.utils.decorators import method_decorator
from .models import Comment
from .forms import CommentForm
from media_portfolio.media.models import MediaItem


class AddCommentView(View):
    """
    View for adding a comment to a media item
    """
    
    def post(self, request, media_id):
        media_item = get_object_or_404(MediaItem, id=media_id, is_published=True)
        
        form = CommentForm(request.POST)
        if form.is_valid():
            comment = form.save(commit=False)
            comment.media_item = media_item
            
            # Set parent if this is a reply
            parent_id = request.POST.get('parent_id')
            if parent_id:
                try:
                    comment.parent = Comment.objects.get(id=parent_id)
                except Comment.DoesNotExist:
                    pass
            
            # Capture IP and user agent
            x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
            if x_forwarded_for:
                comment.ip_address = x_forwarded_for.split(',')[0]
            else:
                comment.ip_address = request.META.get('REMOTE_ADDR')
            
            comment.user_agent = request.META.get('HTTP_USER_AGENT', '')
            
            comment.save()
            
            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return JsonResponse({
                    'success': True,
                    'message': 'Comment submitted successfully and awaiting moderation.',
                    'comment': {
                        'name': comment.name,
                        'content': comment.content,
                        'created_at': comment.created_at.strftime('%B %d, %Y'),
                    }
                })
            else:
                messages.success(request, 'Your comment has been submitted and is awaiting moderation.')
                return redirect('media:detail', slug=media_item.slug)
        else:
            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return JsonResponse({
                    'success': False,
                    'errors': form.errors
                }, status=400)
            else:
                for field, errors in form.errors.items():
                    for error in errors:
                        messages.error(request, f"{field}: {error}")
                return redirect('media:detail', slug=media_item.slug)


class LoadCommentsView(View):
    """
    View for loading comments via AJAX
    """
    
    def get(self, request, media_id):
        media_item = get_object_or_404(MediaItem, id=media_id)
        
        # Get approved comments
        comments = Comment.objects.filter(
            media_item=media_item,
            is_approved=True,
            parent=None
        ).prefetch_related('replies')
        
        # Paginate if needed
        page = int(request.GET.get('page', 1))
        per_page = 10
        start = (page - 1) * per_page
        end = start + per_page
        
        comments_page = comments[start:end]
        has_next = comments.count() > end
        
        # Render comments HTML
        from django.template.loader import render_to_string
        html = render_to_string('comments/comment_list_items.html', {
            'comments': comments_page
        })
        
        return JsonResponse({
            'success': True,
            'html': html,
            'has_next': has_next,
            'next_page': page + 1 if has_next else None
        })


class ModerateCommentView(View):
    """
    View for comment moderation (admin only)
    """
    
    def post(self, request, comment_id):
        if not request.user.is_staff:
            return JsonResponse({'error': 'Unauthorized'}, status=403)
        
        comment = get_object_or_404(Comment, id=comment_id)
        action = request.POST.get('action')
        
        if action == 'approve':
            comment.is_approved = True
            comment.save()
            return JsonResponse({'success': True, 'message': 'Comment approved'})
        
        elif action == 'reject':
            comment.is_approved = False
            comment.save()
            return JsonResponse({'success': True, 'message': 'Comment rejected'})
        
        elif action == 'spam':
            comment.is_spam = True
            comment.is_approved = False
            comment.save()
            return JsonResponse({'success': True, 'message': 'Comment marked as spam'})
        
        elif action == 'feature':
            comment.is_featured = True
            comment.save()
            return JsonResponse({'success': True, 'message': 'Comment featured'})
        
        return JsonResponse({'error': 'Invalid action'}, status=400)

=================================================================
FILE: ./media_portfolio/core/__init__.py
=================================================================



=================================================================
FILE: ./media_portfolio/core/admin.py
=================================================================

from django.contrib import admin
from .models import SiteSettings


@admin.register(SiteSettings)
class SiteSettingsAdmin(admin.ModelAdmin):
    fieldsets = (
        ('Basic Info', {
            'fields': ('site_title', 'site_description')
        }),
        ('Contact', {
            'fields': ('contact_email', 'contact_phone')
        }),
        ('Social Media', {
            'fields': ('instagram_url', 'twitter_url', 'facebook_url', 
                      'linkedin_url', 'github_url', 'behance_url')
        }),
        ('SEO', {
            'fields': ('meta_keywords', 'meta_description', 'google_analytics_id')
        }),
        ('Branding', {
            'fields': ('logo', 'favicon')
        }),
        ('Legal', {
            'fields': ('copyright_text', 'privacy_policy', 'terms_of_service')
        }),
    )
    
    def has_add_permission(self, request):
        # Prevent adding multiple settings
        return not SiteSettings.objects.exists()

=================================================================
FILE: ./media_portfolio/core/apps.py
=================================================================

from django.apps import AppConfig


class CoreConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'media_portfolio.core'
    verbose_name = 'Core'

=================================================================
FILE: ./media_portfolio/core/context_processors.py
=================================================================

from .models import SiteSettings


def site_settings(request):
    """
    Add site settings to all templates
    """
    try:
        settings = SiteSettings.objects.first()
    except:
        settings = None
    
    return {
        'site_settings': settings
    }

=================================================================
FILE: ./media_portfolio/core/forms.py
=================================================================

from django import forms
from .models import SiteSettings


class SiteSettingsForm(forms.ModelForm):
    """
    Form for editing site settings in admin
    """
    class Meta:
        model = SiteSettings
        fields = '__all__'
        widgets = {
            'site_description': forms.Textarea(attrs={'rows': 3}),
            'meta_keywords': forms.TextInput(attrs={'placeholder': 'comma, separated, keywords'}),
            'meta_description': forms.Textarea(attrs={'rows': 3}),
            'privacy_policy': forms.Textarea(attrs={'rows': 10}),
            'terms_of_service': forms.Textarea(attrs={'rows': 10}),
        }


class SearchForm(forms.Form):
    """
    Global search form
    """
    q = forms.CharField(
        required=False,
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': 'Search...',
            'aria-label': 'Search'
        })
    )
    
    type = forms.ChoiceField(
        choices=[
            ('all', 'All'),
            ('image', 'Images'),
            ('video', 'Videos'),
        ],
        required=False,
        widget=forms.Select(attrs={'class': 'form-select'})
    )
    
    category = forms.IntegerField(
        required=False,
        widget=forms.HiddenInput()
    )

=================================================================
FILE: ./media_portfolio/core/migrations/__init__.py
=================================================================



=================================================================
FILE: ./media_portfolio/core/migrations/0001_initial.py
=================================================================

# Generated by Django 4.2.7 on 2026-02-13 23:21

from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='SiteSettings',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('site_title', models.CharField(default='Media Portfolio', max_length=200)),
                ('site_description', models.TextField(blank=True)),
                ('contact_email', models.EmailField(blank=True, max_length=254)),
                ('contact_phone', models.CharField(blank=True, max_length=20)),
                ('instagram_url', models.URLField(blank=True)),
                ('twitter_url', models.URLField(blank=True)),
                ('facebook_url', models.URLField(blank=True)),
                ('linkedin_url', models.URLField(blank=True)),
                ('github_url', models.URLField(blank=True)),
                ('behance_url', models.URLField(blank=True)),
                ('meta_keywords', models.CharField(blank=True, max_length=500)),
                ('meta_description', models.TextField(blank=True)),
                ('google_analytics_id', models.CharField(blank=True, max_length=50)),
                ('logo', models.ImageField(blank=True, null=True, upload_to='site/')),
                ('favicon', models.ImageField(blank=True, null=True, upload_to='site/')),
                ('copyright_text', models.CharField(default=' All Rights Reserved', max_length=200)),
                ('privacy_policy', models.TextField(blank=True)),
                ('terms_of_service', models.TextField(blank=True)),
            ],
            options={
                'verbose_name': 'Site Settings',
                'verbose_name_plural': 'Site Settings',
            },
        ),
    ]


=================================================================
FILE: ./media_portfolio/core/models.py
=================================================================

from django.db import models
from django.utils import timezone


class BaseModel(models.Model):
    """
    Abstract base model with common fields for all models
    """
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    is_active = models.BooleanField(default=True)
    sort_order = models.IntegerField(default=0, help_text="Order for display")

    class Meta:
        abstract = True
        ordering = ['sort_order', '-created_at']


class SiteSettings(models.Model):
    """
    Global site settings
    """
    site_title = models.CharField(max_length=200, default="Media Portfolio")
    site_description = models.TextField(blank=True)
    
    # Contact info
    contact_email = models.EmailField(blank=True)
    contact_phone = models.CharField(max_length=20, blank=True)
    
    # Social media links
    instagram_url = models.URLField(blank=True)
    twitter_url = models.URLField(blank=True)
    facebook_url = models.URLField(blank=True)
    linkedin_url = models.URLField(blank=True)
    github_url = models.URLField(blank=True)
    behance_url = models.URLField(blank=True)
    
    # SEO
    meta_keywords = models.CharField(max_length=500, blank=True)
    meta_description = models.TextField(blank=True)
    google_analytics_id = models.CharField(max_length=50, blank=True)
    
    # Logo and favicon
    logo = models.ImageField(upload_to='site/', blank=True, null=True)
    favicon = models.ImageField(upload_to='site/', blank=True, null=True)
    
    # Legal
    copyright_text = models.CharField(max_length=200, default=" All Rights Reserved")
    privacy_policy = models.TextField(blank=True)
    terms_of_service = models.TextField(blank=True)
    
    class Meta:
        verbose_name = "Site Settings"
        verbose_name_plural = "Site Settings"

    def __str__(self):
        return self.site_title

    def save(self, *args, **kwargs):
        # Ensure only one instance exists
        if not self.pk and SiteSettings.objects.exists():
            return
        super().save(*args, **kwargs)

=================================================================
FILE: ./media_portfolio/core/urls.py
=================================================================

from django.urls import path
from . import views

app_name = 'core'

urlpatterns = [
    path('', views.HomeView.as_view(), name='home'),
    path('about/', views.AboutView.as_view(), name='about'),
    path('privacy/', views.PrivacyPolicyView.as_view(), name='privacy'),
    path('terms/', views.TermsOfServiceView.as_view(), name='terms'),
    path('sitemap/', views.SitemapView.as_view(), name='sitemap'),
    path('robots.txt', views.RobotsTxtView.as_view(), name='robots'),
]

=================================================================
FILE: ./media_portfolio/core/utils.py
=================================================================

import os
import hashlib
from datetime import datetime
from django.core.files import File
from django.utils.text import slugify
from PIL import Image
from io import BytesIO


def generate_unique_slug(model_class, title, slug_field='slug'):
    """
    Generate a unique slug for a model instance
    """
    slug = slugify(title)
    unique_slug = slug
    counter = 1
    
    while model_class.objects.filter(**{slug_field: unique_slug}).exists():
        unique_slug = f"{slug}-{counter}"
        counter += 1
    
    return unique_slug


def get_file_hash(file):
    """
    Generate MD5 hash of a file
    """
    hash_md5 = hashlib.md5()
    for chunk in file.chunks():
        hash_md5.update(chunk)
    return hash_md5.hexdigest()


def create_thumbnail(image_file, size=(300, 300)):
    """
    Create a thumbnail from an image file
    """
    img = Image.open(image_file)
    img.thumbnail(size, Image.Resampling.LANCZOS)
    
    thumb_io = BytesIO()
    img.save(thumb_io, format='JPEG', quality=85)
    
    return File(thumb_io, name=f"thumb_{image_file.name}")


def format_file_size(size_bytes):
    """
    Format file size in human readable format
    """
    if size_bytes == 0:
        return "0 B"
    
    size_names = ["B", "KB", "MB", "GB", "TB"]
    i = 0
    
    while size_bytes >= 1024 and i < len(size_names) - 1:
        size_bytes /= 1024.0
        i += 1
    
    return f"{size_bytes:.2f} {size_names[i]}"


def get_video_duration(video_path):
    """
    Get video duration using ffprobe (requires ffmpeg)
    """
    import subprocess
    import json
    
    try:
        cmd = [
            'ffprobe',
            '-v', 'quiet',
            '-print_format', 'json',
            '-show_format',
            '-show_streams',
            video_path
        ]
        
        result = subprocess.run(cmd, capture_output=True, text=True)
        data = json.loads(result.stdout)
        
        if 'format' in data and 'duration' in data['format']:
            return float(data['format']['duration'])
    except:
        pass
    
    return None


def extract_exif(image_path):
    """
    Extract EXIF data from image
    """
    from PIL import Image
    from PIL.ExifTags import TAGS
    
    exif_data = {}
    
    try:
        image = Image.open(image_path)
        exif = image._getexif()
        
        if exif:
            for tag_id, value in exif.items():
                tag = TAGS.get(tag_id, tag_id)
                if isinstance(value, bytes):
                    try:
                        value = value.decode('utf-8')
                    except:
                        value = str(value)
                exif_data[tag] = value
    except:
        pass
    
    return exif_data


def send_email_notification(subject, message, recipient_list, from_email=None):
    """
    Send email notification
    """
    from django.core.mail import send_mail
    from django.conf import settings
    
    if not from_email:
        from_email = settings.DEFAULT_FROM_EMAIL
    
    try:
        send_mail(
            subject,
            message,
            from_email,
            recipient_list,
            fail_silently=True,
        )
        return True
    except:
        return False

=================================================================
FILE: ./media_portfolio/core/views.py
=================================================================

from django.shortcuts import render
from django.views.generic import TemplateView, ListView
from django.http import HttpResponse
from media_portfolio.media.models import MediaItem
from media_portfolio.categories.models import Category
from media_portfolio.comments.models import Testimonial
from django.db import models



class HomeView(TemplateView):
    """
    Homepage view with featured content
    """
    template_name = 'core/home.html'
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        
        # Get featured media
        context['featured_media'] = MediaItem.objects.filter(
            is_published=True,
            featured=True
        ).select_related().prefetch_related('categories')[:12]
        
        # Get recent media
        context['recent_media'] = MediaItem.objects.filter(
            is_published=True
        ).select_related().prefetch_related('categories')[:8]
        
        # Get categories with counts
        context['categories'] = Category.objects.filter(
            is_active=True
        ).annotate(
            media_count=models.Count('media_items')
        )[:10]
        
        # Get featured testimonials
        context['testimonials'] = Testimonial.objects.filter(
            featured=True
        )[:6]
        
        # Get statistics
        context['total_media'] = MediaItem.objects.filter(is_published=True).count()
        context['total_categories'] = Category.objects.filter(is_active=True).count()
        context['total_videos'] = MediaItem.objects.filter(
            is_published=True, 
            media_type='video'
        ).count()
        context['total_images'] = MediaItem.objects.filter(
            is_published=True, 
            media_type='image'
        ).count()
        
        return context


class AboutView(TemplateView):
    """
    About page view
    """
    template_name = 'core/about.html'
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        
        # Get some featured work for the about page
        context['featured_work'] = MediaItem.objects.filter(
            is_published=True,
            featured=True
        )[:6]
        
        return context


class PrivacyPolicyView(TemplateView):
    """
    Privacy policy page
    """
    template_name = 'core/privacy.html'


class TermsOfServiceView(TemplateView):
    """
    Terms of service page
    """
    template_name = 'core/terms.html'


class SitemapView(TemplateView):
    """
    XML sitemap for search engines
    """
    template_name = 'core/sitemap.xml'
    content_type = 'application/xml'
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        
        # Get all published media
        context['media_items'] = MediaItem.objects.filter(is_published=True)
        
        # Get all active categories
        context['categories'] = Category.objects.filter(is_active=True)
        
        # Get all published collections
        from media_portfolio.collections.models import Collection
        context['collections'] = Collection.objects.filter(is_published=True)
        
        return context


class RobotsTxtView(TemplateView):
    """
    robots.txt for search engine crawling instructions
    """
    template_name = 'core/robots.txt'
    content_type = 'text/plain'

=================================================================
FILE: ./media_portfolio/inquiries/__init__.py
=================================================================



=================================================================
FILE: ./media_portfolio/inquiries/admin.py
=================================================================

from django.contrib import admin
from django.utils import timezone
from .models import Inquiry


@admin.register(Inquiry)
class InquiryAdmin(admin.ModelAdmin):
    list_display = ['name', 'email', 'inquiry_type', 'subject', 'status', 'created_at']
    list_filter = ['inquiry_type', 'status', 'created_at']
    search_fields = ['name', 'email', 'subject', 'message']
    readonly_fields = ['ip_address', 'created_at', 'responded_at']
    
    fieldsets = (
        ('Inquiry Details', {
            'fields': ('inquiry_type', 'media_item', 'subject', 'message')
        }),
        ('Contact Information', {
            'fields': ('name', 'email', 'phone', 'company')
        }),
        ('Additional Information', {
            'fields': ('usage_type', 'deadline', 'budget_range'),
            'classes': ('collapse',)
        }),
        ('Status', {
            'fields': ('status', 'responded_at', 'response_notes')
        }),
        ('Legal', {
            'fields': ('accepted_terms', 'accepted_privacy')
        }),
        ('Technical', {
            'fields': ('ip_address', 'created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )
    
    actions = ['mark_as_read', 'mark_as_replied', 'mark_as_archived']
    
    def mark_as_read(self, request, queryset):
        queryset.update(status='read')
    mark_as_read.short_description = "Mark selected as read"
    
    def mark_as_replied(self, request, queryset):
        queryset.update(status='replied', responded_at=timezone.now())
    mark_as_replied.short_description = "Mark selected as replied"
    
    def mark_as_archived(self, request, queryset):
        queryset.update(status='archived')
    mark_as_archived.short_description = "Archive selected"

=================================================================
FILE: ./media_portfolio/inquiries/apps.py
=================================================================

from django.apps import AppConfig


class InquiriesConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'media_portfolio.inquiries'
    verbose_name = 'Inquiries'

=================================================================
FILE: ./media_portfolio/inquiries/forms.py
=================================================================

from django import forms
from .models import Inquiry
from ..media.models import MediaItem


class InquiryForm(forms.ModelForm):
    """
    Form for client inquiries
    """
    media_item = forms.ModelChoiceField(
        queryset=MediaItem.objects.filter(is_published=True),
        required=False,
        empty_label="Select a specific piece (optional)",
        widget=forms.Select(attrs={'class': 'form-select'})
    )
    
    class Meta:
        model = Inquiry
        fields = [
            'inquiry_type', 'media_item', 'name', 'email', 'phone',
            'company', 'subject', 'message', 'usage_type', 'deadline',
            'budget_range', 'accepted_terms', 'accepted_privacy'
        ]
        widgets = {
            'inquiry_type': forms.Select(attrs={'class': 'form-select'}),
            'name': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Your full name'}),
            'email': forms.EmailInput(attrs={'class': 'form-control', 'placeholder': 'your@email.com'}),
            'phone': forms.TextInput(attrs={'class': 'form-control', 'placeholder': '+1 234 567 8900'}),
            'company': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Company/Organization (optional)'}),
            'subject': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'What is this regarding?'}),
            'message': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 6,
                'placeholder': 'Please provide details about your inquiry...'
            }),
            'usage_type': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': 'e.g., Website, Print, Exhibition'
            }),
            'deadline': forms.DateInput(attrs={
                'class': 'form-control',
                'type': 'date'
            }),
            'budget_range': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': 'e.g., $500-$1000'
            }),
            'accepted_terms': forms.CheckboxInput(attrs={'class': 'form-check-input'}),
            'accepted_privacy': forms.CheckboxInput(attrs={'class': 'form-check-input'}),
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # Make optional fields clear
        self.fields['phone'].required = False
        self.fields['company'].required = False
        self.fields['usage_type'].required = False
        self.fields['deadline'].required = False
        self.fields['budget_range'].required = False

    def clean(self):
        cleaned_data = super().clean()
        inquiry_type = cleaned_data.get('inquiry_type')
        
        # Validate based on inquiry type
        if inquiry_type in ['license', 'print'] and not cleaned_data.get('media_item'):
            self.add_error('media_item', 'Please select the media item for licensing/print inquiry')
        
        if inquiry_type == 'commission' and not cleaned_data.get('budget_range'):
            self.add_error('budget_range', 'Please provide a budget range for commission work')
        
        # Validate legal acceptance
        if not cleaned_data.get('accepted_terms'):
            self.add_error('accepted_terms', 'You must accept the terms and conditions')
        
        if not cleaned_data.get('accepted_privacy'):
            self.add_error('accepted_privacy', 'You must accept the privacy policy')
        
        return cleaned_data

=================================================================
FILE: ./media_portfolio/inquiries/migrations/__init__.py
=================================================================



=================================================================
FILE: ./media_portfolio/inquiries/migrations/0001_initial.py
=================================================================

# Generated by Django 4.2.7 on 2026-02-13 23:21

import django.core.validators
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('media', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='Inquiry',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('sort_order', models.IntegerField(default=0, help_text='Order for display')),
                ('inquiry_type', models.CharField(choices=[('general', 'General Question'), ('license', 'Licensing Request'), ('print', 'Print Purchase'), ('commission', 'Commission Work'), ('collaboration', 'Collaboration'), ('interview', 'Interview Request'), ('workshop', 'Workshop/Teaching'), ('other', 'Other')], max_length=20)),
                ('name', models.CharField(max_length=100)),
                ('email', models.EmailField(max_length=254, validators=[django.core.validators.EmailValidator()])),
                ('phone', models.CharField(blank=True, max_length=20)),
                ('company', models.CharField(blank=True, max_length=200)),
                ('subject', models.CharField(max_length=200)),
                ('message', models.TextField()),
                ('usage_type', models.CharField(blank=True, help_text='How will the media be used? (for licensing)', max_length=200)),
                ('deadline', models.DateField(blank=True, help_text='Project deadline', null=True)),
                ('budget_range', models.CharField(blank=True, help_text='Budget range for the project', max_length=100)),
                ('status', models.CharField(choices=[('new', 'New'), ('read', 'Read'), ('replied', 'Replied'), ('in_progress', 'In Progress'), ('completed', 'Completed'), ('archived', 'Archived')], default='new', max_length=20)),
                ('ip_address', models.GenericIPAddressField(blank=True, null=True)),
                ('responded_at', models.DateTimeField(blank=True, null=True)),
                ('response_notes', models.TextField(blank=True, help_text='Internal notes about response')),
                ('accepted_terms', models.BooleanField(default=False)),
                ('accepted_privacy', models.BooleanField(default=False)),
                ('media_item', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='inquiries', to='media.mediaitem')),
            ],
            options={
                'verbose_name': 'Inquiry',
                'verbose_name_plural': 'Inquiries',
                'ordering': ['-created_at'],
                'indexes': [models.Index(fields=['status', '-created_at'], name='inquiries_i_status_152cc6_idx'), models.Index(fields=['inquiry_type', 'status'], name='inquiries_i_inquiry_a4e2f7_idx')],
            },
        ),
    ]


=================================================================
FILE: ./media_portfolio/inquiries/models.py
=================================================================

from django.db import models
from django.core.validators import EmailValidator
from media_portfolio.core.models import BaseModel
from media_portfolio.media.models import MediaItem


class Inquiry(BaseModel):
    """
    Model for client inquiries and messages
    """
    INQUIRY_TYPES = [
        ('general', 'General Question'),
        ('license', 'Licensing Request'),
        ('print', 'Print Purchase'),
        ('commission', 'Commission Work'),
        ('collaboration', 'Collaboration'),
        ('interview', 'Interview Request'),
        ('workshop', 'Workshop/Teaching'),
        ('other', 'Other'),
    ]
    
    STATUS_CHOICES = [
        ('new', 'New'),
        ('read', 'Read'),
        ('replied', 'Replied'),
        ('in_progress', 'In Progress'),
        ('completed', 'Completed'),
        ('archived', 'Archived'),
    ]
    
    # Inquiry type
    inquiry_type = models.CharField(max_length=20, choices=INQUIRY_TYPES)
    
    # Related media (if inquiring about specific work)
    media_item = models.ForeignKey(
        MediaItem,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='inquiries'
    )
    
    # Contact info
    name = models.CharField(max_length=100)
    email = models.EmailField(validators=[EmailValidator()])
    phone = models.CharField(max_length=20, blank=True)
    company = models.CharField(max_length=200, blank=True)
    
    # Subject and message
    subject = models.CharField(max_length=200)
    message = models.TextField()
    
    # Additional details based on inquiry type
    usage_type = models.CharField(
        max_length=200,
        blank=True,
        help_text="How will the media be used? (for licensing)"
    )
    deadline = models.DateField(
        null=True,
        blank=True,
        help_text="Project deadline"
    )
    budget_range = models.CharField(
        max_length=100,
        blank=True,
        help_text="Budget range for the project"
    )
    
    # Tracking
    status = models.CharField(
        max_length=20,
        choices=STATUS_CHOICES,
        default='new'
    )
    ip_address = models.GenericIPAddressField(null=True, blank=True)
    
    # Response tracking
    responded_at = models.DateTimeField(null=True, blank=True)
    response_notes = models.TextField(blank=True, help_text="Internal notes about response")
    
    # Legal consent
    accepted_terms = models.BooleanField(default=False)
    accepted_privacy = models.BooleanField(default=False)
    
    class Meta:
        verbose_name = "Inquiry"
        verbose_name_plural = "Inquiries"
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['status', '-created_at']),
            models.Index(fields=['inquiry_type', 'status']),
        ]

    def __str__(self):
        return f"{self.get_inquiry_type_display()}: {self.subject} - {self.name}"

=================================================================
FILE: ./media_portfolio/inquiries/urls.py
=================================================================

from django.urls import path
from . import views

app_name = 'inquiries'

urlpatterns = [
    path('contact/', views.ContactView.as_view(), name='contact'),
    path('success/', views.SuccessView.as_view(), name='success'),
]

=================================================================
FILE: ./media_portfolio/inquiries/views.py
=================================================================

from django.shortcuts import render, redirect
from django.views.generic import FormView, TemplateView
from django.contrib import messages
from django.core.mail import send_mail
from django.conf import settings
from .forms import InquiryForm


class ContactView(FormView):
    """
    View for contact/inquiry form
    """
    template_name = 'inquiries/contact.html'
    form_class = InquiryForm
    success_url = '/inquiries/success/'

    def form_valid(self, form):
        # Save the inquiry
        inquiry = form.save(commit=False)
        
        # Capture IP address
        x_forwarded_for = self.request.META.get('HTTP_X_FORWARDED_FOR')
        if x_forwarded_for:
            inquiry.ip_address = x_forwarded_for.split(',')[0]
        else:
            inquiry.ip_address = self.request.META.get('REMOTE_ADDR')
        
        inquiry.save()
        
        # Send email notification
        self.send_notification_email(inquiry)
        
        # Show success message
        messages.success(self.request, 'Thank you for your message. I will get back to you soon!')
        
        return super().form_valid(form)

    def send_notification_email(self, inquiry):
        """
        Send email notification about new inquiry
        """
        subject = f'New Inquiry: {inquiry.subject}'
        message = f"""
        New inquiry received:
        
        Type: {inquiry.get_inquiry_type_display()}
        Name: {inquiry.name}
        Email: {inquiry.email}
        Phone: {inquiry.phone}
        
        Message:
        {inquiry.message}
        
        View in admin: {settings.BASE_URL}/admin/inquiries/inquiry/{inquiry.id}/
        """
        
        try:
            send_mail(
                subject,
                message,
                settings.DEFAULT_FROM_EMAIL,
                [settings.ADMIN_EMAIL],
                fail_silently=True,
            )
        except:
            pass  # Fail silently in development


class SuccessView(TemplateView):
    """
    View for successful form submission
    """
    template_name = 'inquiries/success.html'

=================================================================
FILE: ./media_portfolio/media/__init__.py
=================================================================



=================================================================
FILE: ./media_portfolio/media/admin.py
=================================================================

from django.contrib import admin
from django.utils.html import format_html
from .models import MediaItem, MediaGallery, GalleryItem


class GalleryItemInline(admin.TabularInline):
    model = GalleryItem
    extra = 1
    ordering = ['order']


@admin.register(MediaItem)
class MediaItemAdmin(admin.ModelAdmin):
    list_display = ['title', 'media_type', 'featured', 'is_published', 'view_count', 'created_at']
    list_filter = ['media_type', 'featured', 'is_published', 'categories', 'created_at']
    search_fields = ['title', 'description', 'tags', 'caption']
    prepopulated_fields = {'slug': ('title',)}
    readonly_fields = ['view_count', 'file_size', 'exif_data', 'media_preview']
    
    fieldsets = (
        ('Basic Information', {
            'fields': ('title', 'slug', 'description', 'media_type')
        }),
        ('Media Files', {
            'fields': ('file', 'thumbnail', 'media_preview')
        }),
        ('Organization', {
            'fields': ('categories', 'tags', 'featured', 'is_published', 'published_date', 'sort_order')
        }),
        ('Metadata', {
            'fields': ('alt_text', 'caption', 'location', 'date_taken')
        }),
        ('Equipment', {
            'fields': ('camera_make', 'camera_model', 'lens', 'settings'),
            'classes': ('collapse',)
        }),
        ('Technical Details', {
            'fields': ('duration', 'width', 'height', 'file_size', 'exif_data'),
            'classes': ('collapse',)
        }),
        ('Copyright', {
            'fields': ('copyright_notice', 'license')
        }),
        ('Statistics', {
            'fields': ('view_count',),
            'classes': ('collapse',)
        }),
    )
    
    def media_preview(self, obj):
        if obj.file:
            if obj.media_type == 'image':
                return format_html(
                    '<img src="{}" style="max-height: 200px; max-width: 200px;" />',
                    obj.file.url
                )
            else:
                return format_html(
                    '<video width="200" controls><source src="{}" type="video/mp4"></video>',
                    obj.file.url
                )
        return "No file"
    media_preview.short_description = 'Preview'


@admin.register(MediaGallery)
class MediaGalleryAdmin(admin.ModelAdmin):
    list_display = ['title', 'layout', 'is_published', 'created_at']
    list_filter = ['layout', 'is_published']
    search_fields = ['title', 'description']
    prepopulated_fields = {'slug': ('title',)}
    inlines = [GalleryItemInline]
    
    fieldsets = (
        ('Basic Information', {
            'fields': ('title', 'slug', 'description')
        }),
        ('Cover Image', {
            'fields': ('cover_image',)
        }),
        ('Display Options', {
            'fields': ('layout', 'is_published', 'sort_order')
        }),
    )

=================================================================
FILE: ./media_portfolio/media/apps.py
=================================================================

from django.apps import AppConfig


class MediaConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'media_portfolio.media'
    verbose_name = 'Media Gallery'

=================================================================
FILE: ./media_portfolio/media/forms.py
=================================================================

from django import forms
from .models import MediaItem, MediaGallery
from ..categories.models import Category


class MediaItemForm(forms.ModelForm):
    """
    Form for uploading/editing media items
    """
    categories = forms.ModelMultipleChoiceField(
        queryset=Category.objects.filter(is_active=True),
        widget=forms.CheckboxSelectMultiple,
        required=False
    )
    
    class Meta:
        model = MediaItem
        fields = [
            'title', 'description', 'media_type', 'file', 'thumbnail',
            'categories', 'tags', 'location', 'date_taken',
            'camera_make', 'camera_model', 'lens', 'settings',
            'alt_text', 'caption', 'featured', 'is_published',
            'copyright_notice', 'license'
        ]
        widgets = {
            'description': forms.Textarea(attrs={'rows': 4, 'class': 'form-control'}),
            'caption': forms.Textarea(attrs={'rows': 3, 'class': 'form-control'}),
            'tags': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'comma, separated, tags'}),
            'date_taken': forms.DateInput(attrs={'type': 'date', 'class': 'form-control'}),
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # Add Bootstrap classes to all fields
        for field_name, field in self.fields.items():
            if not isinstance(field.widget, (forms.CheckboxSelectMultiple, forms.RadioSelect)):
                field.widget.attrs['class'] = 'form-control'
            if field.required:
                field.widget.attrs['required'] = 'required'


class MediaSearchForm(forms.Form):
    """
    Form for searching/filtering media
    """
    q = forms.CharField(
        required=False,
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': 'Search...'
        })
    )
    category = forms.ModelChoiceField(
        queryset=Category.objects.filter(is_active=True),
        required=False,
        empty_label="All Categories",
        widget=forms.Select(attrs={'class': 'form-select'})
    )
    media_type = forms.ChoiceField(
        choices=[('', 'All Types')] + MediaItem.MEDIA_TYPES,
        required=False,
        widget=forms.Select(attrs={'class': 'form-select'})
    )
    sort = forms.ChoiceField(
        choices=[
            ('-published_date', 'Newest First'),
            ('published_date', 'Oldest First'),
            ('title', 'Title A-Z'),
            ('-title', 'Title Z-A'),
            ('-view_count', 'Most Viewed'),
        ],
        required=False,
        widget=forms.Select(attrs={'class': 'form-select'})
    )

=================================================================
FILE: ./media_portfolio/media/migrations/__init__.py
=================================================================



=================================================================
FILE: ./media_portfolio/media/migrations/0001_initial.py
=================================================================

# Generated by Django 4.2.7 on 2026-02-13 23:21

import django.core.validators
from django.db import migrations, models
import django.db.models.deletion
import django.utils.timezone
import media_portfolio.media.models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('categories', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='GalleryItem',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('order', models.IntegerField(default=0)),
                ('caption', models.TextField(blank=True)),
            ],
            options={
                'ordering': ['order'],
            },
        ),
        migrations.CreateModel(
            name='MediaItem',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('sort_order', models.IntegerField(default=0, help_text='Order for display')),
                ('title', models.CharField(max_length=200)),
                ('slug', models.SlugField(max_length=250, unique=True)),
                ('description', models.TextField(blank=True)),
                ('media_type', models.CharField(choices=[('image', 'Image'), ('video', 'Video')], max_length=5)),
                ('file', models.FileField(upload_to=media_portfolio.media.models.media_upload_path, validators=[django.core.validators.FileExtensionValidator(allowed_extensions=['jpg', 'jpeg', 'png', 'gif', 'webp', 'mp4', 'mov', 'avi', 'webm'])])),
                ('thumbnail', models.ImageField(blank=True, help_text='Auto-generated for videos, optional for images', null=True, upload_to=media_portfolio.media.models.thumbnail_upload_path)),
                ('duration', models.DurationField(blank=True, help_text='Video duration (HH:MM:SS)', null=True)),
                ('width', models.IntegerField(blank=True, null=True)),
                ('height', models.IntegerField(blank=True, null=True)),
                ('file_size', models.IntegerField(editable=False, help_text='File size in bytes')),
                ('alt_text', models.CharField(blank=True, help_text='For accessibility and SEO', max_length=200)),
                ('caption', models.TextField(blank=True)),
                ('location', models.CharField(blank=True, help_text='Where this was created', max_length=200)),
                ('date_taken', models.DateField(blank=True, help_text='Date when media was created', null=True)),
                ('camera_make', models.CharField(blank=True, max_length=100)),
                ('camera_model', models.CharField(blank=True, max_length=100)),
                ('lens', models.CharField(blank=True, max_length=200)),
                ('settings', models.CharField(blank=True, help_text='f-stop, shutter speed, ISO, etc.', max_length=200)),
                ('tags', models.CharField(blank=True, help_text='Comma-separated tags', max_length=500)),
                ('featured', models.BooleanField(default=False, help_text='Show on homepage')),
                ('is_published', models.BooleanField(default=True, help_text='Visible to public')),
                ('published_date', models.DateTimeField(default=django.utils.timezone.now)),
                ('copyright_notice', models.CharField(default=' All Rights Reserved', max_length=200)),
                ('license', models.CharField(choices=[('copyright', 'All Rights Reserved'), ('cc-by', 'Creative Commons Attribution'), ('cc-by-sa', 'Creative Commons Attribution-ShareAlike'), ('cc-by-nd', 'Creative Commons Attribution-NoDerivs'), ('cc-by-nc', 'Creative Commons Attribution-NonCommercial'), ('cc-by-nc-sa', 'Creative Commons Attribution-NonCommercial-ShareAlike'), ('cc-by-nc-nd', 'Creative Commons Attribution-NonCommercial-NoDerivs'), ('public', 'Public Domain')], default='copyright', max_length=20)),
                ('exif_data', models.JSONField(blank=True, help_text='Camera EXIF data', null=True)),
                ('view_count', models.IntegerField(default=0, editable=False)),
                ('categories', models.ManyToManyField(blank=True, related_name='media_items', to='categories.category')),
            ],
            options={
                'verbose_name': 'Media Item',
                'verbose_name_plural': 'Media Items',
                'ordering': ['-featured', 'sort_order', '-published_date'],
            },
        ),
        migrations.CreateModel(
            name='MediaGallery',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('sort_order', models.IntegerField(default=0, help_text='Order for display')),
                ('title', models.CharField(max_length=200)),
                ('slug', models.SlugField(max_length=250, unique=True)),
                ('description', models.TextField(blank=True)),
                ('cover_image', models.ImageField(blank=True, null=True, upload_to='galleries/covers/')),
                ('layout', models.CharField(choices=[('grid', 'Grid'), ('masonry', 'Masonry'), ('slideshow', 'Slideshow')], default='grid', max_length=20)),
                ('is_published', models.BooleanField(default=True)),
                ('media_items', models.ManyToManyField(related_name='galleries', through='media.GalleryItem', to='media.mediaitem')),
            ],
            options={
                'verbose_name': 'Gallery',
                'verbose_name_plural': 'Galleries',
            },
        ),
        migrations.AddField(
            model_name='galleryitem',
            name='gallery',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='media.mediagallery'),
        ),
        migrations.AddField(
            model_name='galleryitem',
            name='media_item',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='media.mediaitem'),
        ),
        migrations.AddIndex(
            model_name='mediaitem',
            index=models.Index(fields=['media_type', 'is_published'], name='media_media_media_t_8c72bb_idx'),
        ),
        migrations.AddIndex(
            model_name='mediaitem',
            index=models.Index(fields=['featured', 'is_published'], name='media_media_feature_352fe1_idx'),
        ),
        migrations.AddIndex(
            model_name='mediaitem',
            index=models.Index(fields=['-published_date'], name='media_media_publish_7dc4d0_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='galleryitem',
            unique_together={('gallery', 'media_item')},
        ),
    ]


=================================================================
FILE: ./media_portfolio/media/models.py
=================================================================

import os
from django.db import models
from django.utils import timezone
from django.core.validators import FileExtensionValidator
from media_portfolio.core.models import BaseModel
from media_portfolio.categories.models import Category


def media_upload_path(instance, filename):
    """
    Generate upload path: media/type/year/month/filename
    """
    ext = filename.split('.')[-1]
    date_path = timezone.now().strftime('%Y/%m')
    
    if instance.media_type == 'image':
        return f'uploads/images/{date_path}/{filename}'
    else:
        return f'uploads/videos/{date_path}/{filename}'


def thumbnail_upload_path(instance, filename):
    """Upload path for thumbnails"""
    ext = filename.split('.')[-1]
    date_path = timezone.now().strftime('%Y/%m')
    return f'uploads/thumbnails/{date_path}/{filename}'


class MediaItem(BaseModel):
    """
    Core model for all media items (images and videos)
    """
    MEDIA_TYPES = [
        ('image', 'Image'),
        ('video', 'Video'),
    ]
    
    LICENSE_CHOICES = [
        ('copyright', 'All Rights Reserved'),
        ('cc-by', 'Creative Commons Attribution'),
        ('cc-by-sa', 'Creative Commons Attribution-ShareAlike'),
        ('cc-by-nd', 'Creative Commons Attribution-NoDerivs'),
        ('cc-by-nc', 'Creative Commons Attribution-NonCommercial'),
        ('cc-by-nc-sa', 'Creative Commons Attribution-NonCommercial-ShareAlike'),
        ('cc-by-nc-nd', 'Creative Commons Attribution-NonCommercial-NoDerivs'),
        ('public', 'Public Domain'),
    ]
    
    # Basic info
    title = models.CharField(max_length=200)
    slug = models.SlugField(max_length=250, unique=True)
    description = models.TextField(blank=True)
    media_type = models.CharField(max_length=5, choices=MEDIA_TYPES)
    
    # Files
    file = models.FileField(
        upload_to=media_upload_path,
        validators=[
            FileExtensionValidator(
                allowed_extensions=['jpg', 'jpeg', 'png', 'gif', 'webp', 'mp4', 'mov', 'avi', 'webm']
            )
        ]
    )
    thumbnail = models.ImageField(
        upload_to=thumbnail_upload_path,
        blank=True,
        null=True,
        help_text="Auto-generated for videos, optional for images"
    )
    
    # Media metadata
    duration = models.DurationField(
        null=True,
        blank=True,
        help_text="Video duration (HH:MM:SS)"
    )
    width = models.IntegerField(null=True, blank=True)
    height = models.IntegerField(null=True, blank=True)
    file_size = models.IntegerField(
        help_text="File size in bytes",
        editable=False
    )
    
    # Display metadata
    alt_text = models.CharField(
        max_length=200,
        blank=True,
        help_text="For accessibility and SEO"
    )
    caption = models.TextField(blank=True)
    location = models.CharField(
        max_length=200,
        blank=True,
        help_text="Where this was created"
    )
    date_taken = models.DateField(
        null=True,
        blank=True,
        help_text="Date when media was created"
    )
    
    # Equipment/Camera settings
    camera_make = models.CharField(max_length=100, blank=True)
    camera_model = models.CharField(max_length=100, blank=True)
    lens = models.CharField(max_length=200, blank=True)
    settings = models.CharField(
        max_length=200,
        blank=True,
        help_text="f-stop, shutter speed, ISO, etc."
    )
    
    # Organization
    categories = models.ManyToManyField(
        Category,
        related_name='media_items',
        blank=True
    )
    tags = models.CharField(
        max_length=500,
        blank=True,
        help_text="Comma-separated tags"
    )
    
    # Display control
    featured = models.BooleanField(
        default=False,
        help_text="Show on homepage"
    )
    is_published = models.BooleanField(
        default=True,
        help_text="Visible to public"
    )
    published_date = models.DateTimeField(
        default=timezone.now
    )
    
    # Licensing/Copyright
    copyright_notice = models.CharField(
        max_length=200,
        default=" All Rights Reserved"
    )
    license = models.CharField(
        max_length=20,
        choices=LICENSE_CHOICES,
        default='copyright'
    )
    
    # EXIF data stored as JSON
    exif_data = models.JSONField(
        null=True,
        blank=True,
        help_text="Camera EXIF data"
    )
    
    # View tracking
    view_count = models.IntegerField(default=0, editable=False)
    
    class Meta:
        verbose_name = "Media Item"
        verbose_name_plural = "Media Items"
        ordering = ['-featured', 'sort_order', '-published_date']
        indexes = [
            models.Index(fields=['media_type', 'is_published']),
            models.Index(fields=['featured', 'is_published']),
            models.Index(fields=['-published_date']),
        ]

    def __str__(self):
        return self.title

    def save(self, *args, **kwargs):
        # Auto-generate slug
        if not self.slug:
            from django.utils.text import slugify
            self.slug = slugify(self.title)
        
        # Auto-set alt text if empty
        if not self.alt_text:
            self.alt_text = self.title
        
        # Get file size if not set
        if not self.file_size and self.file:
            try:
                self.file_size = self.file.size
            except:
                pass
        
        super().save(*args, **kwargs)

    def get_absolute_url(self):
        from django.urls import reverse
        return reverse('media:detail', args=[self.slug])

    @property
    def tag_list(self):
        """Return tags as list"""
        if self.tags:
            return [tag.strip() for tag in self.tags.split(',') if tag.strip()]
        return []

    @property
    def is_video(self):
        return self.media_type == 'video'

    @property
    def is_image(self):
        return self.media_type == 'image'

    def increment_view_count(self):
        """Increment view count"""
        self.view_count += 1
        self.save(update_fields=['view_count'])


class MediaGallery(BaseModel):
    """
    Gallery grouping multiple media items
    """
    title = models.CharField(max_length=200)
    slug = models.SlugField(max_length=250, unique=True)
    description = models.TextField(blank=True)
    
    # Gallery cover
    cover_image = models.ImageField(
        upload_to='galleries/covers/',
        blank=True,
        null=True
    )
    
    # Media items in this gallery
    media_items = models.ManyToManyField(
        MediaItem,
        through='GalleryItem',
        related_name='galleries'
    )
    
    # Display options
    layout = models.CharField(
        max_length=20,
        choices=[
            ('grid', 'Grid'),
            ('masonry', 'Masonry'),
            ('slideshow', 'Slideshow'),
        ],
        default='grid'
    )
    
    is_published = models.BooleanField(default=True)

    class Meta:
        verbose_name = "Gallery"
        verbose_name_plural = "Galleries"

    def __str__(self):
        return self.title


class GalleryItem(models.Model):
    """
    Through model for gallery items with ordering
    """
    gallery = models.ForeignKey(MediaGallery, on_delete=models.CASCADE)
    media_item = models.ForeignKey(MediaItem, on_delete=models.CASCADE)
    order = models.IntegerField(default=0)
    caption = models.TextField(blank=True)

    class Meta:
        ordering = ['order']
        unique_together = ['gallery', 'media_item']

    def __str__(self):
        return f"{self.gallery.title} - {self.media_item.title}"

=================================================================
FILE: ./media_portfolio/media/urls.py
=================================================================

from django.urls import path
from . import views

app_name = 'media'

urlpatterns = [
    path('', views.MediaListView.as_view(), name='list'),
    path('gallery/', views.GalleryListView.as_view(), name='gallery_list'),
    path('gallery/<slug:slug>/', views.GalleryDetailView.as_view(), name='gallery_detail'),
    path('<slug:slug>/', views.MediaDetailView.as_view(), name='detail'),
]

=================================================================
FILE: ./media_portfolio/media/utils.py
=================================================================

import os
import logging
from PIL import Image
from io import BytesIO
from django.core.files.base import ContentFile
from django.conf import settings
import mimetypes

logger = logging.getLogger(__name__)


def process_uploaded_image(image_file, max_size=None, quality=85):
    """
    Process uploaded image: optimize, create thumbnail, extract metadata
    
    Args:
        image_file: Uploaded file object
        max_size: Tuple (max_width, max_height) for resizing, or None to skip
        quality: JPEG quality (1-100)
    
    Returns:
        dict: Processed image data
    """
    try:
        # Open image with PIL
        img = Image.open(image_file)
        
        # Get original format
        original_format = img.format
        
        # Convert to RGB if necessary (for PNG with transparency)
        if img.mode in ('RGBA', 'P'):
            img = img.convert('RGB')
        
        # Get original dimensions
        original_width, original_height = img.size
        
        # Resize if max_size specified
        if max_size:
            max_width, max_height = max_size
            img.thumbnail((max_width, max_height), Image.Resampling.LANCZOS)
        
        # Get new dimensions
        width, height = img.size
        
        # Save optimized image to BytesIO
        output = BytesIO()
        img.save(output, format='JPEG', quality=quality, optimize=True)
        output.seek(0)
        
        # Create thumbnail
        thumbnail = create_thumbnail_from_image(img, size=(300, 300))
        
        # Extract EXIF data
        exif_data = extract_exif_from_image(image_file)
        
        return {
            'processed_image': ContentFile(output.read(), name=image_file.name),
            'thumbnail': thumbnail,
            'width': width,
            'height': height,
            'original_width': original_width,
            'original_height': original_height,
            'format': 'JPEG',
            'exif_data': exif_data,
            'file_size': len(output.getvalue()),
        }
    
    except Exception as e:
        logger.error(f"Error processing image {image_file.name}: {str(e)}")
        return None


def create_thumbnail_from_image(image, size=(300, 300)):
    """
    Create thumbnail from PIL Image
    
    Args:
        image: PIL Image object
        size: Tuple (width, height)
    
    Returns:
        ContentFile: Thumbnail file
    """
    try:
        # Create a copy to avoid modifying original
        thumb = image.copy()
        
        # Convert to RGB if necessary
        if thumb.mode in ('RGBA', 'P'):
            thumb = thumb.convert('RGB')
        
        # Create thumbnail
        thumb.thumbnail(size, Image.Resampling.LANCZOS)
        
        # Save to BytesIO
        output = BytesIO()
        thumb.save(output, format='JPEG', quality=70, optimize=True)
        output.seek(0)
        
        return ContentFile(output.read(), name='thumbnail.jpg')
    
    except Exception as e:
        logger.error(f"Error creating thumbnail: {str(e)}")
        return None


def extract_exif_from_image(image_file):
    """
    Extract EXIF data from image file
    
    Args:
        image_file: Image file object
    
    Returns:
        dict: EXIF data or None
    """
    try:
        from PIL import Image
        from PIL.ExifTags import TAGS
        
        # Save current position
        current_pos = image_file.tell()
        
        # Open image with PIL
        img = Image.open(image_file)
        exif = img._getexif()
        
        # Restore file position
        image_file.seek(current_pos)
        
        if not exif:
            return None
        
        exif_data = {}
        for tag_id, value in exif.items():
            tag = TAGS.get(tag_id, tag_id)
            if isinstance(value, bytes):
                try:
                    value = value.decode('utf-8', errors='ignore')
                except:
                    value = str(value)
            exif_data[tag] = value
        
        # Extract common fields
        camera_make = exif_data.get('Make', '')
        camera_model = exif_data.get('Model', '')
        
        # Extract datetime
        datetime_original = exif_data.get('DateTimeOriginal', '')
        
        # Extract GPS if available
        gps_info = exif_data.get('GPSInfo', {})
        
        return {
            'make': camera_make,
            'model': camera_model,
            'datetime': datetime_original,
            'exif': exif_data,
            'gps': gps_info if gps_info else None,
        }
    
    except Exception as e:
        logger.error(f"Error extracting EXIF: {str(e)}")
        return None


def get_video_info(video_file):
    """
    Get video information using ffprobe (if available)
    
    Args:
        video_file: Video file object
    
    Returns:
        dict: Video information or None
    """
    try:
        import subprocess
        import json
        import tempfile
        import os
        
        # Save file temporarily
        with tempfile.NamedTemporaryFile(suffix='.mp4', delete=False) as tmp:
            for chunk in video_file.chunks():
                tmp.write(chunk)
            tmp_path = tmp.name
        
        # Run ffprobe
        cmd = [
            'ffprobe',
            '-v', 'quiet',
            '-print_format', 'json',
            '-show_format',
            '-show_streams',
            tmp_path
        ]
        
        result = subprocess.run(cmd, capture_output=True, text=True)
        
        # Clean up temp file
        os.unlink(tmp_path)
        
        if result.returncode != 0:
            return None
        
        data = json.loads(result.stdout)
        
        # Extract video info
        video_info = {
            'format': data.get('format', {}).get('format_name', ''),
            'duration': float(data.get('format', {}).get('duration', 0)),
            'size': int(data.get('format', {}).get('size', 0)),
            'bit_rate': int(data.get('format', {}).get('bit_rate', 0)),
            'streams': [],
        }
        
        # Extract video stream info
        for stream in data.get('streams', []):
            if stream.get('codec_type') == 'video':
                video_info['streams'].append({
                    'codec': stream.get('codec_name', ''),
                    'width': stream.get('width', 0),
                    'height': stream.get('height', 0),
                    'frame_rate': eval(stream.get('r_frame_rate', '0/1')),
                    'bit_rate': int(stream.get('bit_rate', 0)) if stream.get('bit_rate') else 0,
                })
            elif stream.get('codec_type') == 'audio':
                video_info['streams'].append({
                    'type': 'audio',
                    'codec': stream.get('codec_name', ''),
                    'channels': stream.get('channels', 0),
                    'sample_rate': int(stream.get('sample_rate', 0)) if stream.get('sample_rate') else 0,
                })
        
        return video_info
    
    except Exception as e:
        logger.error(f"Error getting video info: {str(e)}")
        return None


def generate_video_thumbnail(video_file, time_offset=1.0):
    """
    Generate thumbnail from video using ffmpeg
    
    Args:
        video_file: Video file object
        time_offset: Time in seconds to capture thumbnail
    
    Returns:
        ContentFile: Thumbnail image or None
    """
    try:
        import subprocess
        import tempfile
        import os
        
        # Save file temporarily
        with tempfile.NamedTemporaryFile(suffix='.mp4', delete=False) as tmp:
            for chunk in video_file.chunks():
                tmp.write(chunk)
            tmp_path = tmp.name
        
        # Create temp file for thumbnail
        thumb_path = tempfile.mktemp(suffix='.jpg')
        
        # Run ffmpeg to extract frame
        cmd = [
            'ffmpeg',
            '-i', tmp_path,
            '-ss', str(time_offset),
            '-vframes', '1',
            '-q:v', '2',
            '-y',
            thumb_path
        ]
        
        result = subprocess.run(cmd, capture_output=True)
        
        # Clean up temp video file
        os.unlink(tmp_path)
        
        if result.returncode != 0 or not os.path.exists(thumb_path):
            return None
        
        # Read thumbnail
        with open(thumb_path, 'rb') as f:
            thumb_data = f.read()
        
        # Clean up thumbnail file
        os.unlink(thumb_path)
        
        # Create ContentFile
        from django.core.files.base import ContentFile
        return ContentFile(thumb_data, name='thumbnail.jpg')
    
    except Exception as e:
        logger.error(f"Error generating video thumbnail: {str(e)}")
        return None


def optimize_video_for_web(video_file, target_size=None):
    """
    Optimize video for web delivery
    
    Args:
        video_file: Video file object
        target_size: Target size (e.g., '720p', '1080p') or None
    
    Returns:
        ContentFile: Optimized video or None
    """
    try:
        import subprocess
        import tempfile
        import os
        
        # Save file temporarily
        with tempfile.NamedTemporaryFile(suffix='.mp4', delete=False) as tmp:
            for chunk in video_file.chunks():
                tmp.write(chunk)
            tmp_path = tmp.name
        
        # Create temp file for output
        output_path = tempfile.mktemp(suffix='.mp4')
        
        # Build ffmpeg command
        cmd = ['ffmpeg', '-i', tmp_path]
        
        if target_size:
            scale_map = {
                '480p': 'scale=854:480',
                '720p': 'scale=1280:720',
                '1080p': 'scale=1920:1080',
                '4k': 'scale=3840:2160',
            }
            if target_size in scale_map:
                cmd.extend(['-vf', scale_map[target_size]])
        
        cmd.extend([
            '-c:v', 'libx264',
            '-crf', '23',
            '-preset', 'medium',
            '-c:a', 'aac',
            '-b:a', '128k',
            '-movflags', '+faststart',
            '-y',
            output_path
        ])
        
        result = subprocess.run(cmd, capture_output=True)
        
        # Clean up temp video file
        os.unlink(tmp_path)
        
        if result.returncode != 0 or not os.path.exists(output_path):
            return None
        
        # Read optimized video
        with open(output_path, 'rb') as f:
            video_data = f.read()
        
        # Clean up output file
        os.unlink(output_path)
        
        # Create ContentFile
        from django.core.files.base import ContentFile
        return ContentFile(video_data, name='optimized_' + os.path.basename(video_file.name))
    
    except Exception as e:
        logger.error(f"Error optimizing video: {str(e)}")
        return None


def get_media_dimensions(file_obj):
    """
    Get dimensions of image or video file
    
    Args:
        file_obj: File object
    
    Returns:
        tuple: (width, height) or (None, None)
    """
    if not file_obj:
        return None, None
    
    # Check if it's an image by mimetype
    mime_type, _ = mimetypes.guess_type(file_obj.name)
    
    if mime_type and mime_type.startswith('image'):
        try:
            from PIL import Image
            img = Image.open(file_obj)
            return img.size
        except:
            pass
    
    # For videos, try to get from ffprobe
    elif mime_type and mime_type.startswith('video'):
        try:
            info = get_video_info(file_obj)
            if info and info.get('streams'):
                for stream in info['streams']:
                    if 'width' in stream and 'height' in stream:
                        return stream['width'], stream['height']
        except:
            pass
    
    return None, None


def format_file_size(size_bytes):
    """
    Format file size in human readable format
    
    Args:
        size_bytes: Size in bytes
    
    Returns:
        str: Formatted size (e.g., "2.5 MB")
    """
    if size_bytes == 0:
        return "0 B"
    
    size_names = ["B", "KB", "MB", "GB", "TB"]
    i = 0
    
    while size_bytes >= 1024 and i < len(size_names) - 1:
        size_bytes /= 1024.0
        i += 1
    
    return f"{size_bytes:.2f} {size_names[i]}"


def generate_unique_filename(instance, filename):
    """
    Generate unique filename for uploaded files
    
    Args:
        instance: Model instance
        filename: Original filename
    
    Returns:
        str: Unique filename with path
    """
    import os
    from django.utils.timezone import now
    from django.utils.text import slugify
    
    # Get extension
    ext = filename.split('.')[-1].lower()
    
    # Get base name without extension
    base = os.path.splitext(filename)[0]
    base = slugify(base)[:50]
    
    # Add timestamp and random string
    timestamp = now().strftime("%Y%m%d_%H%M%S")
    import uuid
    random_str = uuid.uuid4().hex[:8]
    
    # Get upload path based on instance type
    if hasattr(instance, 'media_type'):
        path = f"{instance.media_type}s/{timestamp}/"
    else:
        path = f"uploads/{timestamp}/"
    
    new_filename = f"{base}_{random_str}.{ext}"
    
    return os.path.join(path, new_filename)


def validate_media_file(file_obj, max_size_mb=100):
    """
    Validate media file size and type
    
    Args:
        file_obj: File object
        max_size_mb: Maximum file size in MB
    
    Returns:
        tuple: (is_valid, error_message)
    """
    # Check file size
    if file_obj.size > max_size_mb * 1024 * 1024:
        return False, f"File size exceeds {max_size_mb}MB limit"
    
    # Check file type
    mime_type, _ = mimetypes.guess_type(file_obj.name)
    if not mime_type:
        return False, "Could not determine file type"
    
    allowed_image_types = ['image/jpeg', 'image/png', 'image/gif', 'image/webp']
    allowed_video_types = ['video/mp4', 'video/quicktime', 'video/x-msvideo', 'video/webm']
    
    if mime_type.startswith('image') and mime_type not in allowed_image_types:
        return False, f"Image type {mime_type} not allowed. Allowed: JPEG, PNG, GIF, WebP"
    
    if mime_type.startswith('video') and mime_type not in allowed_video_types:
        return False, f"Video type {mime_type} not allowed. Allowed: MP4, MOV, AVI, WebM"
    
    return True, "Valid file"

=================================================================
FILE: ./media_portfolio/media/views.py
=================================================================

from django.shortcuts import render, get_object_or_404
from django.core.paginator import Paginator, EmptyPage, PageNotAnInteger
from django.db.models import Q, Count
from django.views.generic import ListView, DetailView
from .models import MediaItem, MediaGallery
from .forms import MediaSearchForm
from ..categories.models import Category


class MediaListView(ListView):
    """
    View for listing all media items with filtering
    """
    model = MediaItem
    template_name = 'media/media_list.html'
    context_object_name = 'media_items'
    paginate_by = 12

    def get_queryset(self):
        queryset = MediaItem.objects.filter(is_published=True)
        
        # Apply search filters
        form = MediaSearchForm(self.request.GET)
        if form.is_valid():
            q = form.cleaned_data.get('q')
            category = form.cleaned_data.get('category')
            media_type = form.cleaned_data.get('media_type')
            sort = form.cleaned_data.get('sort')

            if q:
                queryset = queryset.filter(
                    Q(title__icontains=q) |
                    Q(description__icontains=q) |
                    Q(tags__icontains=q) |
                    Q(caption__icontains=q)
                )
            
            if category:
                queryset = queryset.filter(categories=category)
            
            if media_type:
                queryset = queryset.filter(media_type=media_type)
            
            if sort:
                queryset = queryset.order_by(sort)
        
        # Select related for efficiency
        return queryset.select_related().prefetch_related('categories')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['search_form'] = MediaSearchForm(self.request.GET or None)
        context['categories'] = Category.objects.filter(
            is_active=True
        ).annotate(
            media_count=Count('media_items')
        )
        context['featured_items'] = MediaItem.objects.filter(
            is_published=True,
            featured=True
        )[:6]
        return context


class MediaDetailView(DetailView):
    """
    View for displaying a single media item
    """
    model = MediaItem
    template_name = 'media/media_detail.html'
    context_object_name = 'media'
    slug_field = 'slug'
    slug_url_kwarg = 'slug'

    def get_queryset(self):
        return MediaItem.objects.filter(is_published=True)

    def get(self, request, *args, **kwargs):
        # Increment view count
        response = super().get(request, *args, **kwargs)
        self.object.increment_view_count()
        return response

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        
        # Get related media (same categories)
        media = self.object
        category_ids = media.categories.values_list('id', flat=True)
        
        related = MediaItem.objects.filter(
            is_published=True,
            categories__in=category_ids
        ).exclude(
            id=media.id
        ).distinct()[:6]
        
        context['related_media'] = related
        context['next_item'] = MediaItem.objects.filter(
            is_published=True,
            published_date__gt=media.published_date
        ).order_by('published_date').first()
        
        context['prev_item'] = MediaItem.objects.filter(
            is_published=True,
            published_date__lt=media.published_date
        ).order_by('-published_date').first()
        
        return context


class GalleryListView(ListView):
    """
    View for listing all galleries
    """
    model = MediaGallery
    template_name = 'media/gallery_list.html'
    context_object_name = 'galleries'
    paginate_by = 12

    def get_queryset(self):
        return MediaGallery.objects.filter(
            is_published=True
        ).prefetch_related('media_items')


class GalleryDetailView(DetailView):
    """
    View for displaying a single gallery
    """
    model = MediaGallery
    template_name = 'media/gallery_detail.html'
    context_object_name = 'gallery'
    slug_field = 'slug'
    slug_url_kwarg = 'slug'

    def get_queryset(self):
        return MediaGallery.objects.filter(
            is_published=True
        ).prefetch_related('media_items')

>>> CONFIG FOLDER FILES <<<

=================================================================
FILE: ./config/__init__.py
=================================================================



=================================================================
FILE: ./config/asgi.py
=================================================================

"""
ASGI config for media portfolio project.
"""

import os
from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_asgi_application()

=================================================================
FILE: ./config/settings.py
=================================================================

"""
Django settings for media portfolio project.
"""

from pathlib import Path
import os
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = os.getenv('SECRET_KEY', 'django-insecure-default-key-change-me')

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = os.getenv('DEBUG', 'True') == 'True'

ALLOWED_HOSTS = os.getenv('ALLOWED_HOSTS', 'localhost,127.0.0.1').split(',')

# Application definition
INSTALLED_APPS = [
    # Jazzmin must be before django.contrib.admin
    'jazzmin',
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    
    # Third-party apps
    'django_cleanup.apps.CleanupConfig',  # Auto-delete old files
    
    # Local apps
    'media_portfolio.core',
    'media_portfolio.media',
    'media_portfolio.categories',
    'media_portfolio.comments',
    'media_portfolio.inquiries',
    'media_portfolio.collections',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'config.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
                'media_portfolio.core.context_processors.site_settings',
            ],
        },
    },
]

WSGI_APPLICATION = 'config.wsgi.application'

# Database
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

# Password validation
AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]

# Internationalization
LANGUAGE_CODE = 'en-us'
TIME_ZONE = 'UTC'
USE_I18N = True
USE_TZ = True

# Static files (CSS, JavaScript, Images)
STATIC_URL = 'static/'
STATICFILES_DIRS = [BASE_DIR / 'static']
STATIC_ROOT = BASE_DIR / 'staticfiles'

# Media files
MEDIA_URL = '/media/'
MEDIA_ROOT = BASE_DIR / 'media'

# Default primary key field type
DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# File upload settings
FILE_UPLOAD_MAX_MEMORY_SIZE = 10485760  # 10MB
DATA_UPLOAD_MAX_MEMORY_SIZE = 10485760  # 10MB

# Security settings for production
if not DEBUG:
    SECURE_SSL_REDIRECT = True
    SESSION_COOKIE_SECURE = True
    CSRF_COOKIE_SECURE = True
    SECURE_BROWSER_XSS_FILTER = True
    SECURE_CONTENT_TYPE_NOSNIFF = True
    X_FRAME_OPTIONS = 'DENY'
    SECURE_HSTS_SECONDS = 31536000
    SECURE_HSTS_INCLUDE_SUBDOMAINS = True
    SECURE_HSTS_PRELOAD = True

# ============================================================================
# JAZZMIN CONFIGURATION - Professional Admin Theme with High Contrast Colors
# ============================================================================

JAZZMIN_SETTINGS = {
    # Title and branding
    "site_title": "Media Portfolio Admin",
    "site_header": "Media Portfolio",
    "site_brand": "MP Admin",
    "site_logo": None,  # Add path to your logo if available
    "login_logo": None,
    "login_logo_dark": None,
    "site_icon": None,
    "welcome_sign": "Welcome to Media Portfolio Administration",
    "copyright": "Media Portfolio  2026",
    "search_model": ["auth.User", "media.MediaItem", "comments.Comment"],
    
    # User avatar
    "user_avatar": None,
    
    # Top Menu
    "topmenu_links": [
        {"name": "Home", "url": "admin:index", "permissions": ["auth.view_user"]},
        {"name": "View Site", "url": "/", "new_window": True},
        {"name": "Media Gallery", "url": "/media/", "new_window": True},
        {"name": "Collections", "url": "/collections/", "new_window": True},
        {"app": "auth"},
        {"app": "media"},
    ],
    
    # User Menu
    "usermenu_links": [
        {"name": "Support", "url": "https://github.com/yourusername/media-portfolio/issues", "new_window": True},
        {"model": "auth.user"}
    ],
    
    # Side Menu
    "show_sidebar": True,
    "navigation_expanded": True,
    "hide_apps": [],
    "hide_models": [],
    
    # Order of apps and models in the menu
    "order_with_respect_to": ["auth", "core", "media", "categories", "comments", "inquiries", "collections"],
    
    # Custom icons for apps and models
    "icons": {
        "auth": "fas fa-users-cog",
        "auth.user": "fas fa-user",
        "auth.group": "fas fa-users",
        "core": "fas fa-home",
        "core.sitesettings": "fas fa-cog",
        "media": "fas fa-image",
        "media.mediaitem": "fas fa-film",
        "categories": "fas fa-folder-open",
        "categories.category": "fas fa-tags",
        "comments": "fas fa-comment",
        "comments.comment": "fas fa-comments",
        "comments.testimonial": "fas fa-star",
        "inquiries": "fas fa-envelope",
        "inquiries.inquiry": "fas fa-inbox",
        "collections": "fas fa-layer-group",
        "collections.collection": "fas fa-th-large",
    },
    
    # Default icons for parent/child menu items
    "default_icon_parents": "fas fa-chevron-circle-right",
    "default_icon_children": "fas fa-circle",
    
    # Related modal
    "related_modal_active": True,
    
    # Custom links to append to side menu
    "custom_links": {
        "media": [{
            "name": "Upload Media", 
            "url": "admin:media_mediaitem_add", 
            "icon": "fas fa-upload",
            "permissions": ["media.add_mediaitem"]
        }],
        "comments": [{
            "name": "Pending Moderation", 
            "url": "/admin/comments/comment/?is_approved__exact=0", 
            "icon": "fas fa-clock",
            "permissions": ["comments.change_comment"]
        }]
    },
    
    # UI Customizer - Enable if you want to customize via UI
    "show_ui_builder": False,
    
    # Change form formatting
    "changeform_format": "horizontal_tabs",
    "changeform_format_overrides": {
        "auth.user": "collapsible",
        "auth.group": "vertical_tabs",
        "media.mediaitem": "horizontal_tabs",
    },
}

# ============================================================================
# JAZZMIN UI THEME - High Contrast Professional Colors
# ============================================================================

JAZZMIN_UI_TWEAKS = {
    # Theme: Choose from available themes
    "theme": "darkly",  # Dark theme with high contrast
    
    # Color scheme
    "navbar": "navbar-dark",  # Options: navbar-dark, navbar-light
    "navbar_fixed": True,
    "navbar_color": "#1a1a2e",  # Deep midnight blue/purple
    
    # Sidebar
    "sidebar": "sidebar-dark-primary",
    "sidebar_fixed": True,
    "sidebar_color": "#16213e",  # Rich dark blue with purple undertones
    
    # Brand/text colors
    "brand_color": "#ffffff",  # White brand text
    "brand_small_text": False,
    "text_color": "#e9ecef",  # Light gray text
    "text_muted_color": "#adb5bd",  # Muted text color
    
    # Links - Purple/Blue gradient effect
    "link_color": "#9d4edd",  # Vibrant purple
    "link_hover_color": "#c77dff",  # Light purple on hover
    
    # Primary accent color (buttons, active items)
    "primary": "#6a4c9c",  # Royal purple
    "primary_hover": "#7d5fb0",  # Lighter purple on hover
    
    # Secondary accent
    "secondary": "#4a6fa5",  # Steel blue
    "secondary_hover": "#5d82b8",  # Lighter blue
    
    # Info/Success/Warning/Danger colors
    "info": "#3b8ea5",  # Teal blue
    "success": "#2a9d8f",  # Green-blue
    "warning": "#e9c46a",  # Warm yellow
    "danger": "#e76f51",  # Coral
    
    # Custom accent colors for specific elements
    "accent_blue": "#4361ee",  # Bright blue
    "accent_purple": "#9d4edd",  # Purple
    "accent_violet": "#7209b7",  # Deep violet
    "accent_indigo": "#3a0ca3",  # Indigo
    
    # Buttons
    "button_classes": {
        "primary": "btn-primary",
        "secondary": "btn-secondary",
        "info": "btn-info",
        "warning": "btn-warning",
        "danger": "btn-danger",
        "success": "btn-success",
    },
    
    # Tables
    "table_classes": "table table-striped table-hover",
    "table_striped": True,
    "table_hover": True,
    "table_bordered": False,
    "table_condensed": False,
    
    # Cards
    "card_border_radius": "8px",
    "card_shadow": "0 4px 12px rgba(106, 76, 156, 0.15)",  # Purple-tinted shadow
    "card_highlight": "#6a4c9c",  # Purple highlight for cards
    
    # Input fields
    "input_border_radius": "6px",
    "input_shadow": "inset 0 1px 3px rgba(0,0,0,0.1)",
    "input_focus_border": "#9d4edd",  # Purple focus border
    "input_focus_shadow": "0 0 0 3px rgba(157, 78, 221, 0.25)",  # Purple focus glow
    
    # Alerts
    "alert_border_radius": "8px",
    "alert_shadow": "0 2px 6px rgba(0,0,0,0.1)",
    
    # Dropdowns
    "dropdown_border_radius": "6px",
    "dropdown_shadow": "0 4px 12px rgba(0,0,0,0.2)",
    "dropdown_item_hover": "#6a4c9c",  # Purple hover for dropdown items
    "dropdown_item_hover_color": "#ffffff",  # White text on hover
    
    # Badges
    "badge_border_radius": "4px",
    "badge_primary_bg": "#6a4c9c",  # Purple badge background
    "badge_secondary_bg": "#4a6fa5",  # Blue badge background
    
    # Progress bars
    "progress_bar_primary": "#6a4c9c",  # Purple progress bar
    
    # List groups
    "list_group_active_bg": "#6a4c9c",  # Purple active list item
    "list_group_active_color": "#ffffff",  # White text on active
    
    # Action buttons
    "actions_sticky_top": True,
    
    # Dark mode toggle
    "dark_mode_theme": "cyborg",  # Optional dark mode theme
    
    # Custom CSS classes for specific elements
    "custom_css": """
        /* Custom purple/blue gradient for headers */
        .main-header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%) !important;
        }
        
        /* Purple glow for active menu items */
        .nav-sidebar .nav-item .nav-link.active {
            background: linear-gradient(90deg, #6a4c9c 0%, #4a6fa5 100%) !important;
            box-shadow: 0 2px 10px rgba(106, 76, 156, 0.3);
        }
        
        /* Blue hover effect for menu items */
        .nav-sidebar .nav-item .nav-link:hover {
            background: rgba(74, 111, 165, 0.2) !important;
        }
        
        /* Purple borders for cards */
        .card {
            border-top: 3px solid #6a4c9c !important;
        }
        
        /* Blue buttons */
        .btn-primary {
            background: linear-gradient(135deg, #6a4c9c 0%, #4a6fa5 100%) !important;
            border: none !important;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #7d5fb0 0%, #5d82b8 100%) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(106, 76, 156, 0.3);
        }
        
        /* Purple badges */
        .badge-primary {
            background: linear-gradient(135deg, #9d4edd 0%, #6a4c9c 100%) !important;
        }
        
        /* Blue badges */
        .badge-info {
            background: linear-gradient(135deg, #3a86ff 0%, #4a6fa5 100%) !important;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1a2e;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #6a4c9c;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #9d4edd;
        }
    """,
}
    
# Alternative HIGH CONTRAST themes you can try by changing "theme" above:
# "theme": "cyborg"     # High contrast dark theme with neon accents
# "theme": "darkly"     # Professional dark theme (current)
# "theme": "slate"      # Blue-gray dark theme
# "theme": "superhero"  # Navy blue theme with orange accents
# "theme": "materia"    # Material design with good contrast

# Remove or comment out the old SUIT_CONFIG since we're using Jazzmin now
# SUIT_CONFIG = { ... }

=================================================================
FILE: ./config/urls.py
=================================================================

"""
URL configuration for media portfolio project.
"""
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('media_portfolio.core.urls')),
    path('media/', include('media_portfolio.media.urls')),
    path('categories/', include('media_portfolio.categories.urls')),
    path('collections/', include('media_portfolio.collections.urls')),
    path('inquiries/', include('media_portfolio.inquiries.urls')),
]

# Serve media files in development
if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
    urlpatterns += static(settings.STATIC_URL, document_root=settings.STATIC_ROOT)

=================================================================
FILE: ./config/wsgi.py
=================================================================

"""
WSGI config for media portfolio project.
"""

import os
from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_wsgi_application()

>>> ROOT FILES <<<

=================================================================
FILE: ./manage.py
=================================================================

#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys
from dotenv import load_dotenv


def main():
    """Run administrative tasks."""
    # Load environment variables
    load_dotenv()
    
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()
Dump completed at Sat, Feb 14, 2026  8:14:42 PM
